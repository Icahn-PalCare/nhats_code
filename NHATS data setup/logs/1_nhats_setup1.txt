-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  E:\nhats\nhats_code\NHATS data setup\logs\1_nhats_setup1.txt
  log type:  text
 opened on:  31 May 2016, 11:10:14

. local r1raw E:\nhats\data\NHATS Public\round_1\

. local r2raw E:\nhats\data\NHATS Public\round_2\

. local r3raw E:\nhats\data\NHATS Public\round_3\

. local r4raw E:\nhats\data\NHATS Public\round_4\

. local work E:\nhats\data\NHATS working data

. local r1s E:\nhats\data\NHATS Sensitive\r1_sensitive\

. local r2s E:\nhats\data\NHATS Sensitive\r2_sensitive\

. local r3s E:\nhats\data\NHATS Sensitive\r3_sensitive\

. local r4s E:\nhats\data\NHATS Sensitive\r4_sensitive\

. local logs E:\nhats\nhats_code\NHATS data setup\logs\

. 
. cd "`work'"
E:\nhats\data\NHATS working data

. *********************************************
. 
. //round 1
. use "`r1raw'NHATS_Round_1_SP_File.dta"

. //check to make sure sample ids are unique
. sort spid 

. quietly by spid: gen dup = cond(_N==1,0,_n)

. tab dup

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      8,245      100.00      100.00
------------+-----------------------------------
      Total |      8,245      100.00

. gen wave=1

. la var wave "Survey wave"

. save round_1_1.dta, replace
file round_1_1.dta saved

. clear

. 
. //round 2
. use "`r2raw'NHATS_Round_2_SP_File_v2.dta"

. //check to make sure sample ids are unique
. sort spid 

. quietly by spid: gen dup = cond(_N==1,0,_n)

. tab dup

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      7,075      100.00      100.00
------------+-----------------------------------
      Total |      7,075      100.00

. gen wave=2

. la var wave "Survey wave"

. save round_2_1.dta, replace
file round_2_1.dta saved

. clear 

. 
. //round 3
. use "`r3raw'NHATS_Round_3_SP_File.dta"

. //check to make sure sample ids are unique
. sort spid 

. quietly by spid: gen dup = cond(_N==1,0,_n)

. tab dup

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      5,799      100.00      100.00
------------+-----------------------------------
      Total |      5,799      100.00

. gen wave=3

. la var wave "Survey wave"

. save round_3_1.dta, replace
file round_3_1.dta saved

. clear 

. 
. //round 4
. use "`r4raw'NHATS_Round_4_SP_File.dta"

. //check to make sure sample ids are unique
. sort spid 

. quietly by spid: gen dup = cond(_N==1,0,_n)

. tab dup

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      4,737      100.00      100.00
------------+-----------------------------------
      Total |      4,737      100.00

. gen wave=4

. la var wave "Survey wave"

. save round_4_1.dta, replace
file round_4_1.dta saved

. clear 

. 
. //round 1
. foreach w in 1 2 3 4{
  2. use round_`w'_1.dta
  3. 
. //keep selected variables only
. local keepallwaves spid wave r`w'dresid w`w'varunit w`w'anfinwgt0 w`w'varstrat  ///
>         mo* r`w'd2intvrage hh`w'martlstat ///
>         ip`w'cmedicaid ip`w'mgapmedsp ip`w'nginsnurs ip`w'covmedcad ip`w'covtricar ///
>         hh* hc* ss* pc* cp* cg* ha* sc* mc* sd* pa* hw* ///
>         is`w'* ht`w'placedesc fl`w'* 
  4. 
. if `w'==1 {     
  5. keep `keepallwaves' r`w'dgender rl`w'dracehisp rl`w'spkothlan rl`w'condspanh el`w'higstschl ///
> ia`w'* ia1totinc re`w'resistrct 
  6. }
  7. 
. if `w'==2 {     
  8. keep `keepallwaves' re2intplace re2newstrct re2spadrsnew re2dresistrct ///
>         re2dadrscorr re2dcensdiv ip2nginslast
  9. }
 10. 
. if `w'==3 {     
 11. keep `keepallwaves' re3intplace re3newstrct re3spadrsnew re3dresistrct ///
>         re3dcensdiv ip3nginslast
 12. }
 13. if `w'==4 {     
 14. keep `keepallwaves' re4intplace re4newstrct re4spadrsnew re4dresistrct ///
>         re4dcensdiv ip4nginslast
 15. }
 16. 
. save round_`w'_ltd.dta, replace
 17. }
file round_1_ltd.dta saved
file round_2_ltd.dta saved
file round_3_ltd.dta saved
file round_4_ltd.dta saved

. 
. //check sensitive data files, keep only some variables, merge with ltd datasets
. foreach w in 1 2 3 4{
  2.         use "`r`w's'NHATS_Round_`w'_SP_Sen_Dem_File.dta"
  3.         sort spid 
  4.         quietly by spid: gen dup = cond(_N==1,0,_n)
  5.         tab dup 
  6.         clear
  7. }

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      8,245      100.00      100.00
------------+-----------------------------------
      Total |      8,245      100.00

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      7,075      100.00      100.00
------------+-----------------------------------
      Total |      7,075      100.00

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      5,799      100.00      100.00
------------+-----------------------------------
      Total |      5,799      100.00

        dup |      Freq.     Percent        Cum.
------------+-----------------------------------
          0 |      4,737      100.00      100.00
------------+-----------------------------------
      Total |      4,737      100.00

. 
. //combine 3 waves into single dataset
. use round_1_ltd.dta

. append using round_2_ltd.dta

. append using round_3_ltd.dta
(label pa1dv2favact already defined)

. append using round_4_ltd.dta
(label pa1dv2favact already defined)

. 
. //merge in sensitive data, use r1 as basis
. merge m:1 spid using "`r1s'NHATS_Round_1_SP_Sen_Dem_File.dta", ///
>         keepusing(r1dbirthmth r1dbirthyr r1dintvwrage hh1modob hh1yrdob hh1dspousage ///
>         rl1primarace rl1hisplatno)      

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                            25,856  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. //merge in additional r2 sensitive data
. merge m:1 spid using "`r2s'NHATS_Round_2_SP_Sen_Dem_File.dta", ///
>         keepusing(r2dintvwrage hh2dspousage r2ddeathage pd2mthdied pd2yrdied)
(label r1dbirthmth already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                         1,170
        from master                     1,170  (_merge==1)
        from using                          0  (_merge==2)

    matched                            24,686  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. //merge in additional r3 sensitive data
. merge m:1 spid using "`r3s'NHATS_Round_3_SP_Sen_Dem_File.dta", ///
>         keepusing(r3dintvwrage hh3dspousage r3ddeathage pd3mthdied pd3yrdied)
(label r1dbirthmth already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                         3,722
        from master                     3,722  (_merge==1)
        from using                          0  (_merge==2)

    matched                            22,134  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. //merge in additional r4 sensitive data
. merge m:1 spid using "`r4s'NHATS_Round_4_SP_Sen_Dem_File.dta", ///
>         keepusing(r4dintvwrage hh4dspousage r4ddeathage pd4mthdied pd4yrdied)
(label r1dbirthyr already defined)
(label r1dbirthmth already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                         6,908
        from master                     6,908  (_merge==1)
        from using                          0  (_merge==2)

    matched                            18,948  (_merge==3)
    -----------------------------------------

. drop _merge

. 
. //3B?
. //merge in tracker status information
. merge m:1 spid using "`r4raw'NHATS_Round_4_Tracker_File", ///
>         keepusing(yearsample r4status r4spstat r4spstatdtmt r4spstatdtyr r3status r3spstat r3spstatdtmt r3spstatdtyr ///
>                 r2status r2spstat r2spstatdtmt r2spstatdtyr r1status r1spstat r1spstatdtmt r1spstatdtyr)

    Result                           # of obs.
    -----------------------------------------
    not matched                         4,166
        from master                         0  (_merge==1)
        from using                      4,166  (_merge==2)

    matched                            25,856  (_merge==3)
    -----------------------------------------

. 
. //merge in nsoc tracker information
. merge m:1 spid using "`r1s'NSOC_Round_1_SP_tracker_file", nogen

    Result                           # of obs.
    -----------------------------------------
    not matched                         4,166
        from master                     4,166  
        from using                          0  

    matched                            25,856  
    -----------------------------------------

. //drop obs that are in tracker file but not sp file
. drop if _merge==2
(4166 observations deleted)

. drop _merge     

. save round_1_to_4.dta, replace
file round_1_to_4.dta saved

. 
. *********************************************
. log close
      name:  <unnamed>
       log:  E:\nhats\nhats_code\NHATS data setup\logs\1_nhats_setup1.txt
  log type:  text
 closed on:  31 May 2016, 11:10:27
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------
