= V4 Outline MultiLine NoSorting TabWidth=30

H="MA and disability"
* Project examining trajectories of utilization after functional disability
* PI: claire ankuda, buddy coder: evan bollens-lund


version 15
set more off
set maxvar 120000  
clear all
set linesize 80
macro drop _all
capture log close



H="making file for date of first needing help"
*making a new variable that is wide
*clean up month of first disability-

*1) merge round 7 data in with already prepared data file
use "E:\nhats\data\Logs - NHATS setup\claire nhats setup files\pubnhats_1_6_raw.dta"
drop _merge
merge 1:1 spid using "E:\nhats\data\NHATS Public\round_7\NHATS_Round_7_SP_File.dta" 

keep spid 	dm2helpstmo dm2helpstyr ds2helpstmo ds2helpstyr ///
			dm3helpstmo dm3helpstyr ds3helpstmo ds3helpstyr ///
			dm4helpstmo dm4helpstyr ds4helpstmo ds4helpstyr ///
			dm5helpstmo dm5helpstyr ds5helpstmo ds5helpstyr ///
			dm6helpstmo dm6helpstyr ds6helpstmo ds6helpstyr ///
			dm7helpstmo dm7helpstyr ds7helpstmo ds7helpstyr ///
			dm2helpendmo dm2helpendyr ds2helpendmo ds2helpendyr ///
			dm3helpendmo dm3helpendyr ds3helpendmo ds3helpendyr ///
			dm4helpendmo dm4helpendyr ds4helpendmo ds4helpendyr ///
			dm5helpendmo dm5helpendyr ds5helpendmo ds5helpendyr  ///
			dm6helpendmo dm6helpendyr ds6helpendmo ds6helpendyr ///
			dm7helpendmo dm7helpendyr ds7helpendmo ds7helpendyr

*make missing if "inapplicable"
foreach var of varlist 	dm2helpstmo dm2helpstyr ds2helpstmo ds2helpstyr ///
						dm3helpstmo dm3helpstyr ds3helpstmo ds3helpstyr ///
						dm4helpstmo dm4helpstyr ds4helpstmo ds4helpstyr ///
						dm5helpstmo dm5helpstyr ds5helpstmo ds5helpstyr ///
						dm6helpstmo dm6helpstyr ds6helpstmo ds6helpstyr ///
						dm7helpstmo dm7helpstyr ds7helpstmo ds7helpstyr ///
						dm2helpendmo dm2helpendyr ds2helpendmo ds2helpendyr ///
						dm3helpendmo dm3helpendyr ds3helpendmo ds3helpendyr ///
						dm4helpendmo dm4helpendyr ds4helpendmo ds4helpendyr  ///
						dm5helpendmo dm5helpendyr ds5helpendmo ds5helpendyr  ///
						dm6helpendmo dm6helpendyr ds6helpendmo ds6helpendyr  ///
						dm7helpendmo dm7helpendyr ds7helpendmo ds7helpendyr {
		replace `var'=. if `var'==-1
		replace `var'=. if `var'==-9
		replace `var'=. if `var'==-8
		replace `var'=. if `var'==90
		}
		
*fix the wave 2 year variables
replace dm2helpstyr= 2011 if dm2helpstyr==1
replace dm2helpstyr= 2012 if dm2helpstyr==2
replace dm2helpendyr= 2011 if dm2helpendyr==1
replace dm2helpendyr= 2012 if dm2helpendyr==2
replace ds2helpstyr= 2011 if ds2helpstyr==1
replace ds2helpstyr= 2012 if ds2helpstyr==2
replace ds2helpendyr= 2011 if ds2helpendyr==1
replace ds2helpendyr= 2012 if ds2helpendyr==2

*make an indicator for never needing help
gen indhelp=0 
foreach var of varlist dm2helpstmo dm2helpstyr ds2helpstmo ds2helpstyr dm3helpstmo dm3helpstyr ds3helpstmo ds3helpstyr dm4helpstmo dm4helpstyr ds4helpstmo ds4helpstyr dm5helpstmo dm5helpstyr ds5helpstmo ds5helpstyr dm6helpstmo dm6helpstyr ds6helpstmo ds6helpstyr dm7helpstmo dm7helpstyr ds7helpstmo ds7helpstyr {
		replace indhelp=1 if `var'!=.
		}
		
*drop people who never report a start date for help
drop if indhelp==0
*left with 3,631 observations

*make an indicator for the people with a stop date
gen indhelpstop=0 
foreach var of varlist dm2helpendmo dm2helpendyr ds2helpendmo ds2helpendyr dm3helpendmo dm3helpendyr ds3helpendmo ds3helpendyr ///
		dm4helpendmo dm4helpendyr ds4helpendmo ds4helpendyr dm5helpendmo dm5helpendyr ds5helpendmo ds5helpendyr  ///
		dm6helpendmo dm6helpendyr ds6helpendmo ds6helpendyr dm7helpendyr ds7helpendyr {
		replace indhelpstop=1 if `var'!=.
		}
		
*turn the variables for dates of help starting into a date format
foreach n of numlist 2 3 4 5 6 7 {
gen dm`n'datehelp=mdy(dm`n'helpstmo, 1, dm`n'helpstyr)
format dm`n'datehelp %td
}

foreach n of numlist 2 3 4 5 6 7 {
gen ds`n'datehelp=mdy(ds`n'helpstmo, 1, ds`n'helpstyr)
format ds`n'datehelp %td
}

*turn the variables for dates of help ending into a date format
foreach n of numlist 2 3 4 5 6 7 {
gen dm`n'datehelpend=mdy(dm`n'helpendmo, 1, dm`n'helpendyr)
format dm`n'datehelpend %td
}

foreach n of numlist 2 3 4 5 6 7 {
gen ds`n'datehelpend=mdy(ds`n'helpendmo, 1, ds`n'helpendyr)
format ds`n'datehelpend %td
}

*drop the other date variables
drop dm2helpstmo dm2helpstyr ds2helpstmo ds2helpstyr dm3helpstmo dm3helpstyr ds3helpstmo ds3helpstyr dm4helpstmo dm4helpstyr ds4helpstmo ds4helpstyr dm5helpstmo dm5helpstyr ds5helpstmo ds5helpstyr dm6helpstmo dm6helpstyr ds6helpstmo ds6helpstyr dm2helpendmo dm2helpendyr ds2helpendmo ds2helpendyr dm3helpendmo dm3helpendyr ds3helpendmo ds3helpendyr ///
		dm4helpendmo dm4helpendyr ds4helpendmo ds4helpendyr dm5helpendmo dm5helpendyr ds5helpendmo ds5helpendyr  ///
		dm6helpendmo dm6helpendyr ds6helpendmo ds6helpendyr dm7helpendmo dm7helpendyr ds7helpendmo ds7helpendyr 

*make the date of first help the first ds or dm help date for the person
gen datefirsthelp= dm7datehelp 
	replace datefirsthelp= ds7datehelp if ds7datehelp!=. & ds7datehelp<datefirsthelp
	
	replace datefirsthelp= dm6datehelp if dm6datehelp!=. & dm6datehelp<datefirsthelp
	replace datefirsthelp= ds6datehelp if ds6datehelp!=. & ds6datehelp<datefirsthelp

	replace datefirsthelp= dm5datehelp if dm5datehelp!=. & dm5datehelp<datefirsthelp
	replace datefirsthelp= ds5datehelp if ds5datehelp!=. & ds5datehelp<datefirsthelp

	replace datefirsthelp= dm4datehelp if dm4datehelp!=. & dm4datehelp<datefirsthelp
	replace datefirsthelp= ds4datehelp if ds4datehelp!=. & ds4datehelp<datefirsthelp

	replace datefirsthelp= dm3datehelp if dm3datehelp!=. & dm3datehelp<datefirsthelp
	replace datefirsthelp= ds3datehelp if ds3datehelp!=. & ds3datehelp<datefirsthelp
	
	replace datefirsthelp= dm2datehelp if dm2datehelp!=. & dm2datehelp<datefirsthelp
	replace datefirsthelp= ds2datehelp if ds2datehelp!=. & ds2datehelp<datefirsthelp
format datefirsthelp %td	

drop if datefirsthelp==.
*drops two observations: 10004347 and 10004340: one is a -7 (refused), another is missing the year of disability start- just has month

*make a variable called repfirsthelp that is the wave of first reporting help
gen repfirsthelp=.
foreach n of numlist 2 3 4 5 6 7 {
	replace repfirsthelp=`n' if datefirsthelp==dm`n'datehelp
	replace repfirsthelp=`n' if datefirsthelp==ds`n'datehelp
	}

*make a variable called repsecondhelp that is the wave after the one first reporting help	
	gen repsecondhelp=repfirsthelp+1
	replace repsecondhelp=. if repsecondhelp==8

save "E:\nhats\data\Projects\traj util after disability\date of first disability.dta"