clear all
set more off
capture log close

cd "E:\nhats\data\projects\Homebound\logs"
use "E:\nhats\data\NHATS cleaned\sp_round_1_5.dta" if year==2011 & lml==0, clear
xtset spid wave
gen homebound=homebound==1 if !missing(homebound)
gen hbw=wave if homebound==1
gen nhw=wave if nhres==1
by spid, sort: egen firsthb=min(hbw)
by spid, sort: egen firstnh=min(nhw)
*drop if firsthb==1 | missing(homebou)
by spid: gen hbnextwave=homebound[_n+1]
by spid: gen nhnextwave=nhres[_n+1]
gen inchbnextwave=firsthb==wave+1 & homebound==0
gen incnhnextwave=firstnh==wave+1 & nhres==0

gen wherelandgroup=1 if missing(firsthb) & missing(firstnh)
replace wherelandgroup=2 if !missing(firsthb) 
replace wherelandgroup=3 if !missing(firstnh) 
replace wherelandgroup=4 if !missing(firstnh) & firsthb<firstnh
label define wherelandgroup 1 "Never homebound or NH resident" 2 "Future HB" ///
3 "Future NH resident" 4 "Homebound, then NH"
label values wherelandgroup wherelandgroup

sort spid wave

gen nwstatus=.
forvalues i=1/4 {
replace nwstatus=r`=`i'+1'status if wave==`i'
}
tab nwstat
tab r2status
replace nwstatus=1 if inlist(nwstatus,60,63) & !missing(hbne)
replace nwstatus=4 if inlist(nwstatus,61)
replace nwstatus=6 if inlist(nwstatus,62,86)
replace nwstatus=7 if nwstatus>7
replace nwstatus=6 if died_12==1 & nwstatus==7
label define nwstatus 1 "Community, not homebound" 2 "Homebound, not incident" ///
3 "Incident homebound" 4 "NH Resident, not incident" ///
5 "Incident NH" 6 "Died" 7 "LFU"
label values nwstatus nwstatus
replace nwstatus=2 if hbne==1
replace nwstatus=3 if inchb==1
replace nwstat=4 if nhne==1
replace nwstat=5 if incnhne==1
label var nwstat "Status next wave"

gen status=1 if sp_ivw==1 & !missing(homebound)
replace status=2 if homebound==1
replace status=3 if nhres==1
label define status 1 "Community, not HB" 2 "Homebound" 3 "NH resident"
label values status status
label var status "Status this wave"

tab wave nwstat if wave<=4, row
tab nwsta status if wave==1

sum aveincome
forvalues i=1/4 {
gen inccat`i'=income_cat==`i'-1
local lab : label income_cat `=`i'-1'
label var inccat`i' "Income: `lab'"
}
gen prob_dementia=dem_3==1 if !missing(dem_3)
label var prob_dementia "Probable dementia"
local cvars1 age
local cvars2 aveincome n_helpers n_paid_helpers tot_hrsmonth_help_i ///
tot_hrsmonth_paid_i 
local ivars1 female white black hisp other_race married educ_hs_ind proxy
local ivars2 ind_any_helpers ind_paid_helper top_quartile_help_helped ///
medicaid medigap srh_fp nhres ///
sr_ami_ever sr_stroke_ever sr_cancer_ever sr_hip_ever sr_heart_dis_ever ///
sr_htn_ever sr_ra_ever sr_osteoprs_ever sr_diabetes_ever sr_lung_dis_ever ///
prob_dementia dem_2_cat adl_diff_ind adl_independent iadl_diff_ind iadl_independent 
local ivars3 adl1 adl2 adl3 iadl1 iadl2 iadl3 adl_eat_help adl_bath_help adl_toil_help ///
adl_dres_help adl_ins_help adl_bed_help iadl_laun_help ///
iadl_shop_help iadl_meal_help iadl_bank_help iadl_meds_help ///
 reg_doc_seen sr_hosp_ind
 
local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married 
label var inchb "Incident Homebound Next Wave"
label var incnh "Incident Nursing Home Next Wave"
local ivars2 inccat1 inccat2 inccat3 inccat4 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_impair iadl_impair ///
sr_ami_ever sr_stroke_ever sr_cancer_ever sr_hip_ever sr_heart_dis_ever ///
sr_htn_ever sr_ra_ever sr_osteoprs_ever sr_diabetes_ever sr_lung_dis_ever ///
prob_dementia dem_2_cat adl_diff_ind adl_independent inchbnextwave incnhnextwave 
gen n=1

forvalues i=1/7 {
gen group`i'=nwstatus==`i'
}


preserve
drop group*
forvalues i=1/3 {
gen group`i'=status==`i'
}
gen group_all=1
local rn : word count 1 `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',7,.)
mat stars=J(`rn',5,0)
local r=1
local c=1
foreach i in _all 1 2 3 {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			qui sum `x' if group`i'==1  [aw=anfin]
			mat tab1[`r',`c']=r(mean)
/*			if inlist("`i'","a","b","c") {
				qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		qui sum `x' if group`i'==1 [aw=anfin],d
		mat tab1[`r',`c']=r(mean)
	/*	if inlist("`i'","a","b","c") {
			qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			qui sum `x' if group`i'==1 [aw=anfin],d 
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		qui sum `x' if group`i'==1 [aw=anfin]
		mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
	qui sum n if group`i'==1 [aw=anfin]
	mat tab1[`r',`c']=r(N)
	mat tab1[`r'+1,`c']=r(sum)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "_" N "Estimate"

frmttable using sample_characteristics.doc, replace statmat(tab1) ///
 title("Sample Characteristics by Status at Wave") ///
 ctitles("" "All" "Community" "Homebound" "Nursing Home") ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("Cross-wave NHATS sample")
 restore
preserve
keep if status==1
local rn : word count 1 `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',7,.)
mat stars=J(`rn',5,0)
local r=1
local c=1
forvalues i=1/7 {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)
/*			if inlist("`i'","a","b","c") {
				qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		qui sum `x' if group`i'==1,d
		mat tab1[`r',`c']=r(mean)
	/*	if inlist("`i'","a","b","c") {
			qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			qui sum `x' if group`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		qui sum `x' if group`i'==1
		mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
	qui sum n if group`i'==1 [aw=anfin]
	
	mat tab1[`r',`c']=r(N)
	mat tab1[`r'+1,`c']=r(sum)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "_" N "Estimate"

frmttable using sample_characteristics.doc, addtable statmat(tab1) ///
 title("Sample Characteristics by next wave status") ///
 ctitles("" "Community" "HB, Not Incident" "Incident HB" "NH, Not Incident" "Incident NH" ///
 "Died" "LFU") ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("Cross-wave NHATS community-dwelling sample, by next-wave status")

restore
preserve
keep if status==1
local rn : word count 1 `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',4,.)
mat stars=J(`rn',4,0)
local r=1
local c=1

drop group*
forvalues i=1/4 {
gen group`i'=inccat`i'
local lab`i' : var label inccat`i'
}

forvalues i=1/4 {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)
/*			if inlist("`i'","a","b","c") {
				qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		qui sum `x' if group`i'==1,d
		mat tab1[`r',`c']=r(mean)
	/*	if inlist("`i'","a","b","c") {
			qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			qui sum `x' if group`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		qui sum `x' if group`i'==1
		mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
	qui sum n if group`i'==1 [aw=anfin]
	
	mat tab1[`r',`c']=r(N)
	mat tab1[`r'+1,`c']=r(sum)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "_" N "Estimate"

frmttable using sample_characteristics.doc, addtable statmat(tab1) ///
 title("Sample Characteristics by Income category") ///
 ctitles("" "`lab1'" "`lab2'" "`lab3'" "`lab4'") ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("Cross-wave NHATS community-dwelling sample, by income group")
restore
preserve
keep if wave==1 & nwstatus<=5 & !homebound
drop group*


tab wherela, gen(group)


local rn : word count 1 `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',4,.)
mat stars=J(`rn',4,0)
local r=1
local c=1
forvalues i=1/4 {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)
/*			if inlist("`i'","a","b","c") {
				qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		qui sum `x' if group`i'==1,d
		mat tab1[`r',`c']=r(mean)
	/*	if inlist("`i'","a","b","c") {
			qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			qui sum `x' if group`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		qui sum `x' if group`i'==1
		mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
	qui sum n if group`i'==1 [aw=anfin]
	
	mat tab1[`r',`c']=r(N)
	mat tab1[`r'+1,`c']=r(sum)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "_" N "Estimate"

frmttable using sample_characteristics.doc, addtable statmat(tab1) ///
 title("Sample Characteristics by next wave status") ///
 ctitles("" "Never Homebound or NH res" "Future HB" "Furture NH" "Future HB, then NH") ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("Wave 1 community-dwelling sample, by ultimate homebound status")

 restore
preserve
keep if status==1 & wave==1 & nwstatus<=5
tab wherela, gen(whereland)
forvalues i=1/4 {
local lab : label wherelandgroup `i'
label var whereland`i' "`lab'"
}

local ivars2 inccat1 inccat2 inccat3 inccat4 whereland1 whereland2 whereland3 ///
whereland4 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_impair iadl_impair ///
sr_ami_ever sr_stroke_ever sr_cancer_ever sr_hip_ever sr_heart_dis_ever ///
sr_htn_ever sr_ra_ever sr_osteoprs_ever sr_diabetes_ever sr_lung_dis_ever ///
prob_dementia dem_2_cat adl_diff_ind adl_independent inchbnextwave incnhnextwave 

local rn : word count 1 `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',4,.)
mat stars=J(`rn',4,0)
local r=1
local c=1

drop group*
forvalues i=1/4 {
gen group`i'=inccat`i'
local lab`i' : var label inccat`i'
}

forvalues i=1/4 {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)
/*			if inlist("`i'","a","b","c") {
				qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if group`i'==1 [aw=anfin]
			mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		qui sum `x' if group`i'==1,d
		mat tab1[`r',`c']=r(mean)
	/*	if inlist("`i'","a","b","c") {
			qui ttest `x' if group`i'==1 | criteria_none==1, by(group`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			qui sum `x' if group`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		qui sum `x' if group`i'==1
		mat tab1[`r',`c']=r(mean)*100
	/*		if inlist("`i'","a","b","c") {
				qui tab `x' group`i' if group`i'==1 | criteria_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}*/
			local r=`r'+1
}
	qui sum n if group`i'==1 [aw=anfin]
	
	mat tab1[`r',`c']=r(N)
	mat tab1[`r'+1,`c']=r(sum)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "_" N "Estimate"

frmttable using sample_characteristics.doc, addtable statmat(tab1) ///
 title("Sample Characteristics by Income category") ///
 ctitles("" "`lab1'" "`lab2'" "`lab3'" "`lab4'") ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("Wave 1 community-dwelling sample, by income group")


