= V4 Outline MultiLine NoSorting TabWidth=30

H="Serious Illness Definition Project, Spring 2017"
/*

1) get index (ivw/fq) date
2) get ffs status
3) get conditions 6m prior
   a) dartmouth
   b) smi
   c) elixhauser
   d) charlson
   e) ccw
4) get utilization 6m prior
   a) hospitalization
5) merge

*/
******************************************************************;

/*nhats cleaned path*/
libname nhats 'E:\nhats\data\NHATS cleaned';

/*medicare xwalk and claims path*/
libname medi 'E:\nhats\data\cms_DUA_28016\merged';

/*project data paths*/
libname proj_int 'E:\nhats\data\projects\pal_perf_scale\int_data';
libname proj_fin 'E:\nhats\data\projects\pal_perf_scale\final_data';
libname proj_ref 'E:\nhats\data\projects\pal_perf_scale\ref_data';



H="get index date"
/*Import NHATS Cleaned Dataset for Rounds 1-5*/
/*Note--only runs if use saveold in stata 13*/
proc import datafile="E:\nhats\data\NHATS cleaned\sp_round_1_5.dta" out=proj_int.nhats replace; run;


data index1;
set proj_int.nhats (keep=spid ivw_date ivw_month ivw_year);
index_date=ivw_date;
index_month=ivw_month;
index_year=ivw_year;
run;

proc import out=xwalka
	    datafile = "E:\nhats\data\CMS_DUA_28016\Kelley_crosswalk_NHATS_old.dta" replace;
run;

data xwalkb;
set medi.nhats2bene_xwalk_11;
run;

proc sql;
create table xwalk as select * from
xwalka a inner join 
xwalkb b
on a.nhats_cms_num=b.nhats_cms_num;
quit;
 
proc sql;
create table index as select a.*, b.bene_id
from index1 a left join
xwalk b 
on a.spid=b.spid;
quit;

proc sort data=index out=proj_int.index nodupkey;
by spid bene_id index_year;
run;

H="get continuous ffs after index"
/*determine Spouse ffs medicare before R's death using the 
claims denominator files

Several sets of variables created, looking back 6m, 12m, 18m, 24m from R's death

Also pulls in spouse date of death where available in the claims s_claims_dod*/

/*sort claims denominator file*/

proc sort data=medi.mbsf_06_14 out=mbsf  nodupkey;
by bene_id year;
run;

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/*get mbsf just for interview year*/

proc sql; 
create table mbsf_index_year as select
a.*,b.buyin12,b.year,b.hmoind12
from index1 a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id)) 
and a.index_year=b.year;
quit;


proc sql;
select count(distinct bene_id) from mbsf_index_year;
quit;



data mbsf_index_year2;
set mbsf_index_year;
if length(trim(left(buyin12)))=12 and index_month>0 then do;
buyin_iy=substr(trim(left(buyin12)),1,index_month);
hmo_iy=substr(trim(left(HMOIND12)),1,index_month);
end;
else do;
buyin_iy=trim(left(buyin12));
hmo_iy=trim(left(HMOIND12));
end;
format index_date date9.;
run;
proc means n;
var index_month;
run;

proc sql;
create table mbsf_index_year_bef as select
a.bene_id,a.year as index_year,
b.year as index_year_bef,
b.year, b.buyin12,b.HMOIND12
from mbsf_index_year a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and 0<a.year-b.year<=1 order by bene_id,year;
quit;


/* and the year before... 1922 have the -2 year dn file*/
proc sql;
create table mbsf_index_year_2bef as select
a.bene_id,a.bene_id,a.index_year,a.index_year_bef,
b.year as index_year_2bef,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year_bef a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and 0<a.index_year_bef-b.year<=1 order by bene_id,year;
quit;

/*merge the insurance data for death year, -1 and -2 years into single dataset*/
proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
mbsf_index_year2 a
left join
mbsf_index_year_bef b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sql;
create table all_insurance2 as select a.*,b.buyin12 as buyin_2bef,b.HMOIND12 as hmo_2bef from
all_insurance a
left join
mbsf_index_year_2bef b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year; 
quit;


/*merge death year and year before death buy-in and hmo variables
Trim so the final variable _6m is 6 months pre-death
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 6 months pre-death*/
data all_insurance3;
set all_insurance2;
buyin_2y=trimn(left(buyin_2bef))||trimn(left(buyin_bef))||trimn(left(buyin_iy));
hmo_2y=trimn(left(hmo_2bef))||trimn(left(hmo_bef))||trimn(left(hmo_iy));

buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));


/*create length of continous a&b and non-hmo coverage vars*/
if indexc(buyin_2y_r,"0","1","2","A","B")=0 then part_ab_n_mos=length(buyin_2y_r)-1;
if indexc(buyin_2y_r,"0","1","2","A","B") then part_ab_n_mos=indexc(buyin_2y_r,"0","1","2","A","B")-1;
if indexc(hmo_2y_r,"1","2","4","A","B","C")=0 then non_hmo_d_n_mos=length(hmo_2y_r)-1;
if indexc(hmo_2y_r,"1","2","4","A","B","C") then non_hmo_d_n_mos=indexc(hmo_2y_r,"1","2","4","A","B","C")-1;
if part_ab_n_mos<=non_hmo_d_n_mos then cont_ffs_n_mos=part_ab_n_mos;
if non_hmo_d_n_mos<part_ab_n_mos then cont_ffs_n_mos=non_hmo_d_n_mos;
run;


data proj_int.ffs_before;
set all_insurance3;
run;


H="get continous ffs before index"
/*determine Spouse ffs medicare before R's death using the 
claims denominator files

Several sets of variables created, looking back 6m, 12m, 18m, 24m from R's death

Also pulls in spouse date of death where available in the claims s_claims_dod*/

/*sort claims denominator file*/

proc sort data=medi.mbsf_06_14 out=mbsf  nodupkey;
by bene_id year;
run;

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/*get mbsf just for interview year*/

proc sql; 
create table mbsf_index_year as select
a.*,b.buyin12,b.year,b.hmoind12
from index1 a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id)) 
and a.index_year=b.year;
quit;


proc sql;
select count(distinct bene_id) from mbsf_index_year;
quit;



data mbsf_index_year2;
set mbsf_index_year;
if length(trim(left(buyin12)))=12 and index_month>0 then do;
buyin_iy=substr(trim(left(buyin12)),index_month,13-index_month);
hmo_dy=substr(trim(left(HMOIND12)),index_month,13-index_month);
buyin_at_death=substr(trim(left(buyin12)),index_month,1);
hmo_at_death=substr(trim(left(HMOIND12)),index_month,1);
end;
else do;
buyin_iy=trim(left(buyin12));
hmo_iy=trim(left(HMOIND12));
end;
format index_date date9.;
run;
proc means n;
var index_month;
run;


proc sql;
create table mbsf_index_year_aft as select
a.bene_id,a.bene_id,a.year as index_year,
b.year as index_year_aft,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.year-b.year=-1 order by bene_id,year;
quit;


/* and the year aftore... 1790 have the +2 year dn file*/
proc sql;
create table mbsf_index_year_2aft as select
a.bene_id,a.bene_id,a.index_year,a.index_year_aft,
b.year as index_year_2aft,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year_aft a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year_aft-b.year=-1 order by bene_id,year;
quit;

/*merge the insurance data for death year, +1 and +2 years into single dataset*/
proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_aft,b.HMOIND12 as hmo_aft from
mbsf_index_year2 a
left join
mbsf_index_year_aft b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sql;
create table all_insurance2 as select a.*,b.buyin12 as buyin_2aft,b.HMOIND12 as hmo_2aft from
all_insurance a
left join
mbsf_index_year_2aft b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;


/*merge death year and year aftore death buy-in and hmo variables
Trim so the final variable _p6m is 6 months post-death
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 6 months post-death*/
data all_insurance3;
set all_insurance2;
buyin_2y=trimn(left(buyin_iy))||trimn(left(buyin_aft))||trimn(left(buyin_2aft));
hmo_2y=trimn(left(hmo_dy))||trimn(left(hmo_aft))||trimn(left(hmo_2aft));

/*create length of continous a&b and non-hmo coverage vars*/
if indexc(buyin_2y,"0","1","2","A","B")=0 then part_ab_p_mos=length(buyin_2y);
if indexc(buyin_2y,"0","1","2","A","B") then part_ab_p_mos=indexc(buyin_2y,"0","1","2","A","B");
if indexc(hmo_2y,"1","2","4","A","B","C")=0 then non_hmo_d_p_mos=length(hmo_2y);
if indexc(hmo_2y,"1","2","4","A","B","C") then non_hmo_d_p_mos=indexc(hmo_2y,"1","2","4","A","B","C");
if indexc(buyin_at_death,"0","1","2","A","B")=1 then part_ab_at_death=0;
if indexc(buyin_at_death,"0","1","2","A","B")=0 then part_ab_at_death=1;
if indexc(hmo_at_death,"1","2","4","A","B","C")=1 then hmo_d_at_death=1;
if indexc(hmo_at_death,"1","2","4","A","B","C")=0 then hmo_d_at_death=0;

if part_ab_p_mos<=non_hmo_d_p_mos then cont_ffs_p_mos=part_ab_p_mos;
if non_hmo_d_p_mos<part_ab_p_mos then cont_ffs_p_mos=non_hmo_d_p_mos;
run;

data proj_int.ffs_after;
set all_insurance3;
run;

H="get claims before index"
/*Get claims 1 year and 2 year before each interview*/
/*Step 2: pull claims lists using xwalk and ivw date*/

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/
%macro claims_pre(days_start=,days_bef_index=,yrs=,source=);

proc sql;
create table &source._meet_&days_bef_index. as select a.index_date,a.index_year,b.*
from proj_int.index a inner join
medi.&source._&yrs. b 
on trim(left(a.bene_id))=trim(left(b.bene_id))
and &days_start<=a.index_date-b.disch_date<=&days_bef_index;
quit;

%mend;

/*run to get claims list 6 mo pre-ivw for ip*/
%claims_pre(days_start=0,days_bef_index=183,yrs=06_14,source=ip);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_14,source=snf);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_14,source=op);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_14,source=pb);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_14,source=hh);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_14,source=hs);
%claims_pre(days_start=0,days_bef_index=183,yrs=09_14,source=dm);
/*1yr*/
%claims_pre(days_start=0,days_bef_index=365,yrs=06_14,source=ip);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_14,source=snf);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_14,source=op);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_14,source=pb);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_14,source=hh);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_14,source=hs);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_14,source=dm);

/*2yrs*/
%claims_pre(days_start=0,days_bef_index=730,yrs=06_14,source=ip);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_14,source=snf);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_14,source=op);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_14,source=pb);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_14,source=hh);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_14,source=hs);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_14,source=dm);

%macro ip_drop(days_bef_index=);
data proj_int.ip_meet_&days_bef_index.;
set ip_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 icarecnt crnrydaycnt erdaycnt clm_ip_admsn_type_cd
  PRCDR_DT1-PRCDR_DT25 hcpcscd1-hcpcscd49);
run;
%mend ip_drop;

%macro snf_drop(days_bef_index=);
data proj_int.snf_meet_&days_bef_index.;
set snf_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 
 PRCDR_DT1-PRCDR_DT25 );
run;
%mend snf_drop;


/*hh*/
%macro hh_drop(days_bef_index=);
data proj_int.hh_meet_&days_bef_index.;
set hh_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
run;
%mend hh_drop;

/*hs*/
%macro hs_drop(days_bef_index=);
data proj_int.hs_meet_&days_bef_index.;
set hs_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25);
run;
%mend hs_drop;

/*dme*/
%macro dm_drop(days_bef_index=);
data proj_int.dm_meet_&days_bef_index.;
set dm_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date 
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 h_o2);
run;
%mend dm_drop;

/*op*/
%macro op_drop(days_bef_index=);
data proj_int.op_meet_&days_bef_index.;
set op_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 erdaycnt obs_stay);
run;
%mend op_drop;

/*carrier*/
%macro pb_drop(days_bef_index=);
data proj_int.pb_meet_&days_bef_index.;
set pb_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 hcpcscd1-hcpcscd13);
run;
%mend pb_drop;

%ip_drop(days_bef_index=183);
%op_drop(days_bef_index=183);
%pb_drop(days_bef_index=183);
%snf_drop(days_bef_index=183);
%hh_drop(days_bef_index=183);
%dm_drop(days_bef_index=183);
%hs_drop(days_bef_index=183);
%ip_drop(days_bef_index=365);
%ip_drop(days_bef_index=730);
%snf_drop(days_bef_index=365);
%snf_drop(days_bef_index=730);
%hh_drop(days_bef_index=365);
%hh_drop(days_bef_index=730);
%hs_drop(days_bef_index=365);
%hs_drop(days_bef_index=730);
%dm_drop(days_bef_index=365);
%dm_drop(days_bef_index=730);
%op_drop(days_bef_index=365);
%op_drop(days_bef_index=730);
%pb_drop(days_bef_index=365);
%pb_drop(days_bef_index=730);



/****************************************************************************/
/****************************************************************************/
/* Macro to pull dx from claims lists, saves dx lists to int_data folder    */
/****************************************************************************/

%macro dx_time_range(range1=, range2=, days_bef_core=);

/*Process carrier medicare claims to pull out dx codes
Multiple lines per each BID*/
data pb_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.pb_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 hcpcscd1-hcpcscd13);
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12;
do over dx;
diag=dx ;
output;
end;
run;
/*check for and remove duplicates, note this doesn't remove blanks*/
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;


/*Process outpatient medicare claims to pull out dx codes
Dataset being created: op_last_&range2._dx2*/
data op_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.op_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25  );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

proc contents data=proj_int.ip_meet_365; run;


/*Dataset being created: ip_last_&range2._dx2*/
data ip_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.ip_meet_&days_bef_core.(keep=bene_id index_year ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 hcpcscd1-hcpcscd49);
array dx ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=ip_last_&range2._dx out=ip_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Dataset being created: snf_last_&range2._dx2*/
data snf_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.snf_meet_&days_bef_core.(keep=bene_id index_year ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=snf_last_&range2._dx out=snf_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process dme medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data dm_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.dm_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process hh medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hh_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.hh_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process hs medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hs_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.hs_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;


/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data ip_last_&range2._dx3;
length diag $7;
set ip_last_&range2._dx2;
run;
data snf_last_&range2._dx3;
length diag $7;
set snf_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;


/*merge diagnoses from each claim type into single dataset*/
data dx_all_last_1&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
ip_last_&range2._dx3
snf_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;

proc sql;
create table dx_all_last_&range2. as select * from
proj_int.index a 
left join 
dx_all_last_1&range2. b
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit; 

proc sort data=dx_all_last_&range2.(where=(diag~="")) out=proj_int.dx_&range1._&range2 nodupkey;
by bene_id index_year diag;
run;


%mend;

/*1 and 2 years pre-interview: proj_int.dx_0_1yr, proj_int.dx_0_2yr */
%dx_time_range(range1=0, range2=6m, days_bef_core=183);
%dx_time_range(range1=0, range2=1yr, days_bef_core=365);
%dx_time_range(range1=0, range2=2yr, days_bef_core=730);



data dx_all_last_6m_w_dups;
set hs_last_6m_dx
hh_last_6m_dx
ip_last_6m_dx
snf_last_6m_dx
dm_last_6m_dx
op_last_6m_dx
pb_last_6m_dx;
if diag~='.';
run;



/*****************************************/
/*check dementia diagnosis frequencies, need to pull this into main dataset
dx list is from Elixhauser code*/
data proj_int.dem_dx_freq;
set dx_all_last_6m_w_dups;
	dementia=0;
	if (substr(diag,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(diag,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;
run;



H="get claims after index"
/*Get claims 1 year and 2 year before each interview*/
/*Step 2: pull claims lists using xwalk and ivw date*/

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/
%macro claims_post(days_start=,days_aft_index=,yrs=,source=);

proc sql;
create table &source._meet_&days_aft_index.p as select a.*,b.index_date,b.index_year
from medi.&source._&yrs. a inner join
proj_int.index b 
on trim(left(a.bene_id))=trim(left(b.bene_id))
and &days_start<=a.admit_date-b.index_date<=&days_aft_index;
quit;

%mend;

/*run to get claims list 6 mo pre-ivw for ip*/
%claims_post(days_start=0,days_aft_index=183,yrs=06_14,source=ip);

/*6m*/
%claims_post(days_start=0,days_aft_index=183,yrs=06_14,source=ip);
%claims_post(days_start=0,days_aft_index=183,yrs=09_14,source=snf);
%claims_post(days_start=0,days_aft_index=183,yrs=09_14,source=op);
%claims_post(days_start=0,days_aft_index=183,yrs=09_14,source=pb);
%claims_post(days_start=0,days_aft_index=183,yrs=09_14,source=hh);
%claims_post(days_start=0,days_aft_index=183,yrs=09_14,source=hs);
%claims_post(days_start=0,days_aft_index=183,yrs=09_14,source=dm);

/*1yr*/
%claims_post(days_start=0,days_aft_index=365,yrs=06_14,source=ip);
%claims_post(days_start=0,days_aft_index=365,yrs=09_14,source=snf);
%claims_post(days_start=0,days_aft_index=365,yrs=09_14,source=op);
%claims_post(days_start=0,days_aft_index=365,yrs=09_14,source=pb);
%claims_post(days_start=0,days_aft_index=365,yrs=09_14,source=hh);
%claims_post(days_start=0,days_aft_index=365,yrs=09_14,source=hs);
%claims_post(days_start=0,days_aft_index=365,yrs=09_14,source=dm);

/*2yrs*/
%claims_post(days_start=0,days_aft_index=730,yrs=06_14,source=ip);
%claims_post(days_start=0,days_aft_index=730,yrs=09_14,source=snf);
%claims_post(days_start=0,days_aft_index=730,yrs=09_14,source=op);
%claims_post(days_start=0,days_aft_index=730,yrs=09_14,source=pb);
%claims_post(days_start=0,days_aft_index=730,yrs=09_14,source=hh);
%claims_post(days_start=0,days_aft_index=730,yrs=09_14,source=hs);
%claims_post(days_start=0,days_aft_index=730,yrs=09_14,source=dm);

%macro ip_drop(days_aft_index=);
data proj_int.ip_meet_&days_aft_index.p;
set ip_meet_&days_aft_index.p(keep=clm_pmt_amt clm_pass_thru_per_diem_amt bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 crnrydaycnt icarecnt erdaycnt clm_ip_admsn_type_cd
  PRCDR_DT1-PRCDR_DT25 PRNCPAL_DGNS_CD);
run;
%mend ip_drop;

%macro snf_drop(days_aft_index=);
data proj_int.snf_meet_&days_aft_index.p;
set snf_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 
 PRCDR_DT1-PRCDR_DT25 PRNCPAL_DGNS_CD);
run;
%mend snf_drop;


/*hh*/
%macro hh_drop(days_aft_index=);
data proj_int.hh_meet_&days_aft_index.p;
set hh_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
run;
%mend hh_drop;

/*hs*/
%macro hs_drop(days_aft_index=);
data proj_int.hs_meet_&days_aft_index.p;
set hs_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25);
run;
%mend hs_drop;

/*dme*/
%macro dm_drop(days_aft_index=);
data proj_int.dm_meet_&days_aft_index.p;
set dm_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
run;
%mend dm_drop;

/*op*/
%macro op_drop(days_aft_index=);
data proj_int.op_meet_&days_aft_index.p;
set op_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 erdaycnt);
run;
%mend op_drop;

/*carrier*/
%macro pb_drop(days_aft_index=);
data proj_int.pb_meet_&days_aft_index.p;
set pb_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
run;
%mend pb_drop;

%ip_drop(days_aft_index=183);
%ip_drop(days_aft_index=365);
%ip_drop(days_aft_index=730);
%snf_drop(days_aft_index=183);
%snf_drop(days_aft_index=365);
%snf_drop(days_aft_index=730);
%hh_drop(days_aft_index=183);
%hh_drop(days_aft_index=365);
%hh_drop(days_aft_index=730);
%hs_drop(days_aft_index=183);
%hs_drop(days_aft_index=365);
%hs_drop(days_aft_index=730);
%dm_drop(days_aft_index=183);
%dm_drop(days_aft_index=365);
%dm_drop(days_aft_index=730);
%op_drop(days_aft_index=183);
%op_drop(days_aft_index=365);
%op_drop(days_aft_index=730);
%pb_drop(days_aft_index=183);
%pb_drop(days_aft_index=365);
%pb_drop(days_aft_index=730);
 

H="Dartmouth chronic conditions"
/*Add indicator variables for the Dartmouth chronic diseases */

/*Dartmouth code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 9 different chronic 
	diseases from the Dartmouth Index.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes from pdf "List of ICD-9_CM codes by Chronic Disease Category 
	(Nine chronic conditions used in the dartmouth atlas of health care 2008) from March 3, 2008*/


/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


%macro dartmouth(range1=,range2=);

data dx_dartmouth;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   dartmouth_1=0;
   dartmouth_1a=0;
   dartmouth_1b=0;
   dartmouth_2=0;
   dartmouth_3=0;
   dartmouth_4=0;
   dartmouth_5=0;
   dartmouth_6=0;
      dartmouth_7=0;
	     dartmouth_8=0;
		    dartmouth_9=0;
			   dartmouth_10=0;
			      dartmouth_11=0;
				     dartmouth_12=0;
					    dartmouth_13=0;
						   dartmouth_14=0;
						      dartmouth_15=0;
							     dartmouth_16=0;
								    dartmouth_17=0;

*do over dx;
	*Cancer with poor prognosis;
	if (substr(dx,1,4) in('1500','1501','1502','1503','1504','1505','1508','1509','1510','1511','1512',
			 	'1513','1514','1515','1516','1518','1519','1550','1551','1552','1570','1571',
			 	'1572','1573','1574','1578','1579','1580','1588','1589','1620','1622','1623',
			 	'1624','1625','1628','1629','1630','1631','1638','1639','1830','1832','1833',
			 	'1834','1835','1838','1839','1910','1911','1912','1913','1914','1915','1916',
			 	'1917','1918','1919','2890') 
		or substr(dx,1,5) in('20400','20410','20420','20480','20490','20500','20510',
				'20520','20530','20580','20590','20600','20610','20620','20680','20690','20700',
				'20710','20720','20780','20800','20810','20820','20880'))
               and dartmouth_1a=0
               then dartmouth_1a=1;
	*Metastatic Cancer;
	if (substr(dx,1,4) in('1960','1961','1962','1963','1965','1966','1968','1969','1970','1971','1972',
				'1973','1974','1975','1976','1977','1978','1980','1981','1982','1983','1984',
				'1985','1986','1987','1990','1991') or 
		substr(dx,1,5) in('19881','19882','19889'))
				and dartmouth_1b=0
				then dartmouth_1b=1;
	*Malignant Cancer, Leukemia;
	if dartmouth_1a=1 or dartmouth_1b=1 then dartmouth_1=1;
	*COPD;
	if (substr(dx,1,3) in('494','496','501','515') or
		substr(dx,1,4) in('4911,4918,4919,4920,4928,4940,4941,5064') or
		substr(dx,1,5) in('49120,49121,49122,49310,49311,49312,49320,49321,49322,49390,49391,49392'))
				and dartmouth_2=0
				then dartmouth_2=1;
	*CAD;
	if (substr(dx,1,3)='412' or
		substr(dx,1,4) in('4111','4118','4130','4139','4140','4148','4149') or
		substr(dx,1,5) in('41181','41189','41400','41401','41402','41403','41404','41405','41406','41407'))
				and dartmouth_3=0
				then dartmouth_3=1;
	*CHF;
	if (substr(dx,1,4) in('4280','4281','4282','4283','4284','4289') or
		substr(dx,1,5) in('42820','42821','42822','42823','42830','42831','42832','42833','42840','42841',
								'42842','42843','40201','40211','40291','39891','40401','40403','40411','40491',
								'40493'))
				and dartmouth_4=0
				then dartmouth_4=1;
	*PVD;
	if (substr(dx,1,4) in('4400','4401','4403','4408','4409','4410','4411','4412','4413','4414','4415','4416',
								'4417','4419','4439') or
		substr(dx,1,5) in('44020','44021','44022','44023','44024','44029','44030','44031','44032','44100','44101','44102','44103'))
				and dartmouth_5=0
				then dartmouth_5=1;
	*Severe Chronic Liver Disease;
	if substr(dx,1,4) in('5712','5715','5716','5723')
				and dartmouth_6=0
				then dartmouth_6=1;
	*Diabetes w/ End Organ Damage;
	if ((substr(dx,1,3)='250' and substr(dx,4,1) in('4','5','6','7','9') and substr(dx,5,1) in('0','1','2','3')) or
		substr(dx,1,4)='3572' or
		substr(dx,1,5) in('36641','36201','36202'))
				and dartmouth_7=0
				then dartmouth_7=1;
	*Renal Failure;
	if (substr(dx,1,3)='585' or
		substr(dx,1,4) in('5851','5852','5853','5854','5855','5856','5859','V451','V560','V568') or
		substr(dx,1,5) in('40301','40311','40391'))
				and dartmouth_8=0
				then dartmouth_8=1;
	*Dementia;
	if (substr(dx,1,3)='797' or
		substr(dx,1,4) in('2900','2903','2908','2909','2940','2941','2948','2949','3310','3312') or
		substr(dx,1,5) in('29101','29011','29012','29013','29020','29021','29040','29041','29042',
								'29043','29410','29411'))
				and dartmouth_9=0
				then dartmouth_9=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct bene_id,index_year,
sum(dartmouth_1a) as dmouth_a,
sum(dartmouth_1b) as dmouth_b,
sum(dartmouth_1) as cha_1,
sum(dartmouth_2) as cha_2,
sum(dartmouth_3) as cha_3,
sum(dartmouth_4) as cha_4,
sum(dartmouth_5) as cha_5,
sum(dartmouth_6) as cha_6,
sum(dartmouth_7) as cha_7,
sum(dartmouth_8) as cha_8,
sum(dartmouth_9) as cha_9
from dx_dartmouth
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data dartmouth_1(keep=bene_id index_year dmouth_1-dmouth_9 dmouth_index dmouth_index_wt);
set cha_test1;
array list_cha cha_1-cha_9;
array list_cha_bin dmouth_1-dmouth_9 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*replace cancer subtypes with indicators*/
if dmouth_a>1 then dmouth_a=1;
if dmouth_b>1 then dmouth_b=1;
/*note this dmouth_index count count is not weighted for morbidity*/
dmouth_index=dmouth_1+dmouth_2+dmouth_3+dmouth_4+dmouth_5+dmouth_6+dmouth_7+dmouth_8+dmouth_9;


label dmouth_a ="Poor prognosis cancer, Dartmouth";
label dmouth_b ="Metastatic cancer, Dartmouth";
label dmouth_1 ="Malignant Cancer or Leukemia, Dartmouth";
label dmouth_2 ="Chronic Pulmonary Disease, Dartmouth";
label dmouth_3 ="CAD, Dartmouth";
label dmouth_4 ="CHF, Dartmouth";
label dmouth_5 ="PVD, Dartmouth";
label dmouth_6 ="Severe Chronic Liver Disease, Dartmouth";
label dmouth_7 ="Diabetes w/ End Organ Damage, Dartmouth";
label dmouth_8 ="Renal Failure, Dartmouth";
label dmouth_9 ="Dementia, Dartmouth";
label dmouth_index ="Count Chronic Diseases, Dartmouth";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=dartmouth_1 out=test nodupkey;
by bene_id index_year;
run;



%rename(WORK,TEST,&range1._&range2);

data proj_int.dmouth_&range1._&range2.(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 dmouth: index_year:;
run;
proc sort data=proj_int.dmouth_&range1._&range2.;
by bene_id index_year;
run;

%mend;

%dartmouth(range1=0, range2=6m);
%dartmouth(range1=0, range2=1yr);



proc freq; run;

H="Elixhauser"
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!
*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;




/****************************************************************************/
/* Elixhauser comorbidities macro                                           */
/****************************************************************************/
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!*/

%macro elixhauser(range1=, range2=);

data dx_31_comor;
set proj_int.dx_&range1._&range2(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD and ALS;
dementia=0;
cad=0;
als=0;
renal_dis=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	*Cariac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,5)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	*Renal Failure;
	*Original list modified to drop 2 codes  585 and V568;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Advanced Liver Disease or Cirrhosis;
	*Code list modified from orig Elix;
	*572.4 hepatorenal syndrome must be added; 
	*Remove '07032' or – chronic hep B, '07033' or – chronic hep B, '07054' or – chronic hep C, '5713' or – alcoholic liver damage, '5714' or – chronic hepatitis;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,4)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,5)='V1071' or
		substr(dx,1,5)='V1072' or
		substr(dx,1,5)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	*Metastatic Cancer or Hematologic Cancer;
	*Modified to add lukemias;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' or
		substr(dx,1,3)='204' or
		substr(dx,1,3)='205' or
		substr(dx,1,3)='206' or
		substr(dx,1,3)='207' or
		substr(dx,1,3)='208') 
			and comorbi_18=0 
		then comorbi_18=1;	
	*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263') 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276') 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800') 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859') 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991') 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311')
			and comorbi_30=0 
		then comorbi_30=1;

	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;

	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

	*ALS Amyotrophic lateral sclerosis;
	if (substr(dx,1,5)='33520') and als=0 
		then als=1;

*Renal Disease, new variable;
	*To identify diabetese with complications;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and renal_dis=0 
		then renal_dis=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table com_test1 as
select distinct bene_id,index_year,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as dementia,
sum(cad) as cad,
sum(als) as als,
sum(renal_dis) as renal_dis
from dx_31_comor
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data comorbidity_1(keep=bene_id index_year comorb_1-comorb_34 comorb_all);
set com_test1;
array list_com com_1-com_30 dementia cad als renal_dis;
array list_com_bin comorb_1-comorb_34 ;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;
/*note this comorb_all count does not include CAD or ALS or Renal disease*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+comorb_8+comorb_9+comorb_10
+comorb_11+comorb_12+comorb_13+comorb_14+comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20
+comorb_21+comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+comorb_29+comorb_30
+comorb_31;

run;

/*merge in to list of core ivw dates for those with ffs mc, age=65+ */
proc sort data=comorbidity_1 nodupkey;
by bene_id index_year;
run;

data proj_int.elix_&range1._&range2;
set comorbidity_1 ;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Advanced Liver Disease or Cirrhosis";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic or Hematologic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="CAD";
label comorb_33 ="ALS";
label comorb_34 ="Renal Disease";
label comorb_all ="Count of Elix comorbidities";
run;

data test;
set proj_int.elix_&range1._&range2;
run;

%rename(WORK,TEST,&range1._&range2);

data proj_int.elix_&range1._&range2._2(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 comorb: index_year:;
run;
proc sort data=proj_int.elix_&range1._&range2._2;
by bene_id index_year;
run;

%mend;

/*Run for 1 year, 2 year datasets, resulting datasets are proj_int.elix_0_1yr_2, proj_int.elix_0_2yr_2*/
%elixhauser(range1=0, range2=6m);
%elixhauser(range1=0, range2=1yr);
%elixhauser(range1=0, range2=2yr);

proc freq data=proj_int.elix_0_1yr_2;
table comorb:;
run;

proc freq data=proj_int.elix_0_2yr_2;
table comorb:;
run;




/*this is merged into the main dataset when the elixhauser indicator variables 
in the next section*/
proc sql;
create table dem_dx_freq_2 as select distinct bene_id,index_year,
sum(dementia) as dem_dx_6m label="count dementia dx 6m pre core ivw"
 from proj_int.dem_dx_freq group by bene_id,index_year;
quit;

/* merge in the 1 year count of dementia diagnoses from the previous section*/
proc sql;
create table elix_6m_dm_dx_count as select a.*,b.dem_dx_6m from
proj_int.elix_0_6m_2 a left join
dem_dx_freq_2 b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

/*overwrite the previously saved dataset with one with the additional dementia variable added*/
data proj_int.elix_0_6m_2;
set elix_6m_dm_dx_count;
if comorb_31_0_6m=0 then dem_dx_6m=0;
run;

proc freq data=proj_int.elix_0_6m_2;
table comorb:;
run;

 

H="Charlson"
/*Add indicator variables for the Charlson comorbidities
and Charlson weighted and unweighted index */

/*Charlson code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 17 different Charlson
    Comorbidity Index (CCI) groups.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes listed in Quan et al., "Coding Algorithms for Defining Comorbidities
    in ICD-9-CM and ICD-10 Administrative Data", Medical Care:43(11), Nov. 2005 p1130-1139.*/

/*final datasets to be merged are proj_int.charls_0_1yr and proj_int.charls_0_2yr*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


%macro charlson(range1=,range2=);

data dx_charlson;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   charlson_1=0;
   charlson_2=0;
   charlson_3=0;
   charlson_4=0;
   charlson_5=0;
   charlson_6=0;
      charlson_7=0;
	     charlson_8=0;
		    charlson_9=0;
			   charlson_10=0;
			      charlson_11=0;
				     charlson_12=0;
					    charlson_13=0;
						   charlson_14=0;
						      charlson_15=0;
							     charlson_16=0;
								    charlson_17=0;

*do over dx;
   *Myocardial Infarction;
   if(substr(dx,1,3)='410' or
               substr(dx,1,3)='412')
               and charlson_1=0
               then charlson_1=1;
   *Congestive heart failure;
   if(substr(dx,1,5)='39891' or
               substr(dx,1,5)='40201' or
               substr(dx,1,5)='40211' or
               substr(dx,1,5)='40291' or
               substr(dx,1,5)='40401' or
               substr(dx,1,5)='40403' or
               substr(dx,1,5)='40411' or
               substr(dx,1,5)='40413' or
               substr(dx,1,5)='40491' or
               substr(dx,1,5)='40493' or
               substr(dx,1,4)='4254' or
               substr(dx,1,4)='4255' or
               substr(dx,1,4)='4256' or
               substr(dx,1,4)='4257' or
               substr(dx,1,4)='4258' or
               substr(dx,1,4)='4259' or
               substr(dx,1,3)='428')
               and charlson_2=0
               then charlson_2=1;
   *Periphral Vascular Disease;
    if(substr(dx,1,4)='0930' or
               substr(dx,1,4)='4373' or
               substr(dx,1,3)='440' or
               substr(dx,1,3)='441' or
               substr(dx,1,4)='4431' or
               substr(dx,1,4)='4432' or
               substr(dx,1,4)='4438' or
               substr(dx,1,4)='4439' or
               substr(dx,1,4)='4471' or
               substr(dx,1,4)='5571' or
               substr(dx,1,4)='5579' or
               substr(dx,1,4)='V434')
               and charlson_3=0
               then charlson_3=1;
    *Cerebrovascular Disease ;
        if(substr(dx,1,5)='36234' or
               substr(dx,1,3)='430' or
               substr(dx,1,3)='431' or
               substr(dx,1,3)='432' or
               substr(dx,1,3)='433' or
               substr(dx,1,3)='434' or
               substr(dx,1,3)='435' or
               substr(dx,1,3)='436' or
               substr(dx,1,3)='437' or
               substr(dx,1,3)='438')
               and charlson_4=0
               then charlson_4=1;
    *Dementia ;
       if(substr(dx,1,3)='290' or
               substr(dx,1,4)='2941' or
               substr(dx,1,4)='3312')
               and charlson_5=0
               then charlson_5=1;
   *Chronic Pulmonary Disease ;
        if(substr(dx,1,5)='4168' or
               substr(dx,1,4)='4169' or
               substr(dx,1,3)='490' or
               substr(dx,1,3)='491' or
               substr(dx,1,3)='492' or
               substr(dx,1,3)='493' or
               substr(dx,1,3)='494' or
               substr(dx,1,3)='495' or
               substr(dx,1,3)='496' or
               substr(dx,1,3)='500' or
               substr(dx,1,3)='501' or
               substr(dx,1,3)='502' or
               substr(dx,1,3)='503' or
               substr(dx,1,3)='504' or
               substr(dx,1,3)='505' or
               substr(dx,1,4)='5064' or
               substr(dx,1,4)='5081' or
               substr(dx,1,4)='5088')
               and charlson_6=0
               then charlson_6=1;
*Connective Tissue Disease-Rheumatic Disease;
         if(substr(dx,1,4)='4465' or
               substr(dx,1,4)='7100' or
               substr(dx,1,4)='7101' or
               substr(dx,1,4)='7102' or
               substr(dx,1,4)='7103' or
               substr(dx,1,4)='7104' or
               substr(dx,1,4)='7140' or
               substr(dx,1,4)='7141' or
               substr(dx,1,4)='7142' or
               substr(dx,1,4)='7148' or
               substr(dx,1,3)='725')
               and charlson_7=0
               then charlson_7=1;
 *Peptic Ulcer Disease;
         if(substr(dx,1,3)='531' or
               substr(dx,1,3)='532' or
               substr(dx,1,3)='533' or
               substr(dx,1,3)='534')
               and charlson_8=0
               then charlson_8=1;
*Mild Liver Disease ;
         if(substr(dx,1,5)='07022' or
               substr(dx,1,5)='07023' or
               substr(dx,1,5)='07032' or
               substr(dx,1,5)='07033' or
               substr(dx,1,5)='07044' or
               substr(dx,1,5)='07054' or
               substr(dx,1,4)='0706' or
               substr(dx,1,4)='0709' or
               substr(dx,1,3)='570' or
               substr(dx,1,3)='571' or
               substr(dx,1,4)='5733' or
               substr(dx,1,4)='5734' or
               substr(dx,1,4)='5738' or
               substr(dx,1,4)='5739' or
               substr(dx,1,4)='V427')
               and charlson_9=0
               then charlson_9=1;
*Diabetes without complications ;
         if(substr(dx,1,4)='2500' or
               substr(dx,1,4)='2501' or
               substr(dx,1,4)='2502' or
               substr(dx,1,4)='2503' or
               substr(dx,1,4)='2508' or
               substr(dx,1,4)='2509')
               and charlson_10=0
               then charlson_10=1;
*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507')
		and charlson_11=0
                then charlson_11=1;
*Paraplegia and Hemiplegia ;
	if (substr(dx,1,4)='3341' or
		substr(dx,1,3)='342' or
		substr(dx,1,3)='343' or
		substr(dx,1,4)='3440' or
		substr(dx,1,4)='3441' or
		substr(dx,1,4)='3442' or
		substr(dx,1,4)='3443' or
                substr(dx,1,4)='3444' or
		substr(dx,1,4)='3445' or
		substr(dx,1,4)='3446' or
		substr(dx,1,4)='3449')
		and charlson_12=0
                then charlson_12=1;
* Renal Disease ;
	if (substr(dx,1,5)='40301' or
		substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40402' or
		substr(dx,1,5)='40403' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40413' or
                substr(dx,1,5)='40492' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='582' or
		substr(dx,1,4)='5830' or
                substr(dx,1,4)='5831' or
                substr(dx,1,4)='5832' or
                substr(dx,1,4)='5834' or
                substr(dx,1,4)='5836' or
                substr(dx,1,4)='5837' or
                substr(dx,1,3)='585' or
                substr(dx,1,3)='586' or
                substr(dx,1,4)='5880' or
                substr(dx,1,4)='V420' or
                substr(dx,1,4)='V451' or
                substr(dx,1,3)='V56' )
		and charlson_13=0
                then charlson_13=1;
*Cancer ;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='176' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
                substr(dx,1,3)='200' or
                substr(dx,1,3)='201' or
                substr(dx,1,3)='202' or
                substr(dx,1,3)='203' or
                substr(dx,1,3)='204' or
                substr(dx,1,3)='205' or
                substr(dx,1,3)='206' or
                substr(dx,1,3)='207' or
                substr(dx,1,3)='208' or
                substr(dx,1,3)='2386' )
		and charlson_14=0
                then charlson_14=1;
* Moderate or Severe Liver Disease ;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,4)='4562' or
		substr(dx,1,4)='5722' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
      		substr(dx,1,4)='5728' )
		and charlson_15=0
                then charlson_15=1;
  * Metastatic Carcinoma ;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' )
		and charlson_16=0
                then charlson_16=1;
  * AIDS/HIV ;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044' )
		and charlson_17=0
                then charlson_17=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct bene_id,index_year,
sum(charlson_1) as cha_1,
sum(charlson_2) as cha_2,
sum(charlson_3) as cha_3,
sum(charlson_4) as cha_4,
sum(charlson_5) as cha_5,
sum(charlson_6) as cha_6,
sum(charlson_7) as cha_7,
sum(charlson_8) as cha_8,
sum(charlson_9) as cha_9,
sum(charlson_10) as cha_10,
sum(charlson_11) as cha_11,
sum(charlson_12) as cha_12,
sum(charlson_13) as cha_13,
sum(charlson_14) as cha_14,
sum(charlson_15) as cha_15,
sum(charlson_16) as cha_16,
sum(charlson_17) as cha_17
from dx_charlson
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data charlson_1(keep=bene_id index_year charls_1-charls_17 charls_index charls_index_wt);
set cha_test1;
array list_cha cha_1-cha_17;
array list_cha_bin charls_1-charls_17 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*note this charls_index count count is not weighted for morbidity*/
charls_index=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+charls_11+charls_12+charls_13+charls_14+charls_15+charls_16+charls_17;
/*now morbidity weighted*/
charls_index_wt=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+2*charls_11+2*charls_12+2*charls_13+2*charls_14+3*charls_15+6*charls_16+6*charls_17;

label charls_1 ="Myocardial infarction, Charlson";
label charls_2 ="Congestive Heart Failure, Charlson";
label charls_3 ="Peripheral Vascular Disease, Charlson";
label charls_4 ="Cerebrovascular disease, Charlson";
label charls_5 ="Dementia, Charlson";
label charls_6 ="Chronic Pulmonary Disease, Charlson";
label charls_7 ="Rheumatic disease, Charlson";
label charls_8 ="Peptic ulcer disease, Charlson";
label charls_9 ="Mild liver disease, Charlson";
label charls_10 ="Diabetes, uncomplicated, Charlson";
label charls_11 ="Diabetes, complicated, Charlson";
label charls_12 ="Hemiplegia or paraplegia, Charlson";
label charls_13 ="Renal disease, Charlson";
label charls_14 ="Any malignancy except neoplasm of skin, Charlson";
label charls_15 ="Mod or severe liver disease, Charlson";
label charls_16 ="Metastatic solid tumor, Charlson";
label charls_17 ="AIDS/HIV, Charlson";
label charls_index ="Charlson score index, not weighted";
label charls_index_wt ="Charlson score index, weighted";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=charlson_1 out=test nodupkey;
by bene_id index_year;
run;



%rename(WORK,TEST,&range1._&range2);

data proj_int.charls_&range1._&range2.(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 charls: index_year:;
run;
proc sort data=proj_int.charls_&range1._&range2.;
by bene_id index_year;
run;

%mend;

%charlson(range1=0, range2=6m);
%charlson(range1=0, range2=1yr);
%charlson(range1=0, range2=2yr);

proc freq data=proj_int.charls_0_1yr;
table charls:;
run;

proc freq data=proj_int.charls_0_6m;
table charls:;
run;



H="CCW"
/*CMS Data Warehouse Chronic Conditions*/
/*final datasets to merge are proj_int.chronic_21_1yr3_0 & proj_int.chronic_21_2yr3_0*/
/****************************************************************************/
/*First get the dx list into dot format using Stata*/
/****************************************************************************/

/*export to Stata*/
proc export data=proj_int.dx_0_6m
outfile="E:\nhats\data\projects\pal_perf_scale\int_data\dx_0_6m.dta" replace;
run;

proc export data=proj_int.dx_0_1yr
outfile="E:\nhats\data\projects\pal_perf_scale\int_data\dx_0_1yr.dta" replace;
run;

proc export data=proj_int.dx_0_2yr
outfile="E:\nhats\data\projects\pal_perf_scale\int_data\dx_0_2yr.dta" replace;
run;

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO STATA HERE*/
/****************************************************************************/
/****************************************************************************/

capture log close
clear
set more off
local datapath E:\nhats\data\projects\pal_perf_scale\int_data

use `datapath'\dx_0_6m.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_6m_2.dta,replace
outsheet using `datapath'\dx_0_6m_2.csv, comma replace


use `datapath'\dx_0_1yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_1yr_2.dta,replace
outsheet using `datapath'\dx_0_1yr_2.csv, comma replace


clear all

use `datapath'\dx_0_2yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_2yr_2.dta,replace
outsheet using `datapath'\dx_0_2yr_2.csv, comma replace


/****************************************************************************/
/****************************************************************************/
/*SWITCH TO SAS HERE*/
/****************************************************************************/
/****************************************************************************/
/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


proc import 
datafile="E:\nhats\data\projects\pal_perf_scale\int_data\dx_0_1yr_2.csv" 
out=dx_0_1yr_2 replace;
run;

proc import 
datafile="E:\nhats\data\projects\pal_perf_scale\int_data\dx_0_6m_2.csv" 
out=dx_0_6m_2 replace;
run;

proc import 
datafile="E:\nhats\data\projects\pal_perf_scale\int_data\dx_0_2yr_2.csv" 
out=dx_0_2yr_2 replace;
run;

/*bring in excel list of dx codes associated with each chronic condition*/
proc import 
datafile='E:\nhats\data\projects\serious_ill\ref_data\chronic_21_condition_icd9.xls'
out=icd9_21_chronic dbms=xls replace;
run;

proc contents data=icd9_21_chronic;
run;

/*creates macro variables of each of the chronic conditions listing of dx codes*/
proc sql;
select icd_9 into :chronic_desc1-:chronic_desc21 from icd9_21_chronic;
quit;
%put &chronic_desc10;
%put &chronic_desc5;

/*******************************************************************/
/*Macro to generate chronic conditions indicators using dx codes   */
/*******************************************************************/

%macro cc(precore=);

data list_&precore._dx;
set dx_0_&precore._2;
array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
do over list ;
list=0;
end;

diag_string=diag;

/* for dx codes that begin with numbers, process chronic cond variables*/
if anydigit(substr(trim(left(diag_string)),1,1))=1 then do;
diag=diag_string+0;

if diag in (&chronic_desc1) then CC_1_AMI=1;
if diag in (&chronic_desc2)  then CC_2_ALZH=1;
if diag in (&chronic_desc3)  then CC_3_ALZHDMTA=1;
if diag in (&chronic_desc4) then CC_4_ATRIALFB=1;
if diag in (&chronic_desc5) then CC_5_CATARACT=1;
if diag in (&chronic_desc6) then CC_6_CHRNKIDN=1;
if diag in (&chronic_desc7) then CC_7_COPD=1;
if diag in (&chronic_desc8) then CC_8_CHF=1;
if diag in (&chronic_desc9) then CC_9_DIABETES=1;
if diag in (&chronic_desc10) then CC_10_GLAUCOMA=1;
if diag in (&chronic_desc11) then CC_11_HIPFRAC=1;
if diag in (&chronic_desc12) then CC_12_ISCHMCHT=1;
if diag in (&chronic_desc13) then CC_13_DEPRESSN=1;
if diag in (&chronic_desc14) then CC_14_OSTEOPRS=1;
if diag in (&chronic_desc15) then CC_15_RA_OA=1;
if diag in (&chronic_desc16) then CC_16_STRKETIA=1;
if diag in (&chronic_desc17) then CC_17_CNCRBRST=1;
if diag in (&chronic_desc18) then CC_18_CNCRCLRC=1;
if diag in (&chronic_desc19) then CC_19_CNCRPRST=1;
if diag in (&chronic_desc20) then CC_20_CNCRLUNG=1;
if diag in (&chronic_desc21) then CC_21_CNCREndM=1;
end;

/*Process with dx codes that start with letters
Only two of them in the list*/
if anydigit(substr(trim(left(diag_string)),1,1))=0 then do;
if trim(left(diag_string)) in ("V431") then CC_5_CATARACT=1;
if trim(left(diag_string)) in ("V801") then CC_10_GLAUCOMA=1;
end;

run;


proc sql;
create table bid_dx_0_&precore. as
select distinct bene_id,index_year,
sum(CC_1_AMI) as CC_1_AMI,
sum(CC_2_ALZH) as CC_2_ALZH,
sum(CC_3_ALZHDMTA) as CC_3_ALZHDMTA,
sum(CC_4_ATRIALFB) as CC_4_ATRIALFB,
sum(CC_5_CATARACT) as CC_5_CATARACT,
sum(CC_6_CHRNKIDN) as CC_6_CHRNKIDN,
sum(CC_7_COPD) as CC_7_COPD,
sum(CC_8_CHF) as CC_8_CHF,
sum(CC_9_DIABETES) as CC_9_DIABETES,
sum(CC_10_GLAUCOMA) as CC_10_GLAUCOMA,
sum(CC_11_HIPFRAC) as CC_11_HIPFRAC,
sum(CC_12_ISCHMCHT) as CC_12_ISCHMCHT,
sum(CC_13_DEPRESSN) as CC_13_DEPRESSN,
sum(CC_14_OSTEOPRS) as CC_14_OSTEOPRS,
sum(CC_15_RA_OA) as CC_15_RA_OA,
sum(CC_16_STRKETIA) as CC_16_STRKETIA,
sum(CC_17_CNCRBRST) as CC_17_CNCRBRST,
sum(CC_18_CNCRCLRC) as CC_18_CNCRCLRC,
sum(CC_19_CNCRPRST) as CC_19_CNCRPRST,
sum(CC_20_CNCRLUNG) as CC_20_CNCRLUNG,
sum(CC_21_CNCREndM) as CC_21_CNCREndM

from list_&precore._dx group by bene_id,index_year;
quit;

proc sort data=bid_dx_0_&precore. nodupkey;
by bene_id index_year;
run;

/*convert to chronic condition vars. to binary variables*/
 data bid_dx_0_&precore.3;
 set bid_dx_0_&precore.;
 array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
if list>0 then list=1;
if list<=0 then list=0;
end;

/*create aggregated indicators*/
CC_AMI_isch=CC_1_AMI|CC_12_ISCHMCHT;
CC_alzheim=CC_2_ALZH|CC_3_ALZHDMTA;
CC_cncr_chronic=CC_17_CNCRBRST | CC_18_CNCRCLRC | CC_19_CNCRPRST | CC_20_CNCRLUNG | 
	CC_21_CNCREndM ;
run;

proc means;
var CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
run;

/*run rename macro*/
data test;
set bid_dx_0_&precore.3;
run;

%rename(WORK,TEST,&precore.);

data proj_int.chronic_21_&precore.3_0;
set test;
bene_id=bene_id_&precore.;
index_year=index_year_&precore.;
drop bene_id_&precore. index_year_&precore.;
run;

%mend;

/*2 datasets are proj_int.chronic_21_1yr_0 and proj_int.chronic_21_2yr_0*/
%cc(precore=6m);
%cc(precore=1yr);
%cc(precore=2yr);

data proj_int.ccw;
set proj_int.chronic_21_6m3_0;
index_year2=input(index_year,8.);
drop index_year;
rename index_year2=index_year;
run;


H="additional comorbidities"
/*7/24/17--add neurological diseases and stroke*/

data dxa;
set proj_int.dx_0_6m(rename=(diag=dx_0));
dx=trim(left(dx_0));

neurodeg1=0;
cva1=0;
park1=0;
if substr(dx,1,4)='3330' 
or substr(dx,1,4)='3334' 
or substr(dx,1,4)='3320'
then neurodeg1=1;

if substr(dx,1,4)='3320'
then park1=1;

if substr(dx,1,3)='430'
or substr(dx,1,3)='431'
or substr(dx,1,5)='43411' 
or substr(dx,1,5)='43491'
or substr(dx,1,3)='436'
or substr(dx,1,5)='99702'
then cva1=1;
run;

proc sql;
create table addl as select distinct bene_id, index_year,
sum(neurodeg1) as neurodeg_count,
sum(cva1) as cva_count,
sum(park1) as park_count 
from dxa group by bene_id, index_year;
quit;

data proj_int.addl_comorb;
set addl;
neurodeg=neurodeg_count>=1;
cva=cva_count>=1;
park=park_count>=1;
run;

H="get utilization before index"
/*These additional variables are just added to the dataset with the
elixhauser and cc's 1 year preceeding the interview, can add them
later when required to get the 2 year look-back dataset*/

/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set proj_int.ip_meet_&days.;
run;
data ip_&days._2;
set ip_meet_&days.;
type_adm=clm_ip_admsn_type_cd;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if erdaycnt>0 & erdaycnt~=. then ind_ed_charge=1;
if erdaycnt=0 | erdaycnt=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if index_date-admit_date>&days. then do;
	admit_date=index_date-&days.;
	admit_trunc=1;
	end;
if index_date<disch_date then do;
	disch_date=index_date;
	disch_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by bene_id index_year;
run;

proc sql;
create table ip_&days._3 as select distinct bene_id,index_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. pre ivw ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. pre ivw ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. pre ivw ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. pre ivw ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. pre ivw ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. pre ivw ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. pre ivw ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. pre ivw ivw"

 from ip_&days._2 group by bene_id,index_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=6m);
%admissions(days=365,suffix=1yr);

proc sort data=ip_183_3 nodupkey;
by bene_id index_year;
run;


proc sql;
create table ip_6m as select a.*,b.icu_days_6m,
b.n_ip_admit_6m,b.n_hospd_6m,b.n_em_urgent_admit_6m,b.n_em_admit_6m,
b.n_urgent_admit_6m,b.n_elect_admit_6m,b.n_ED_ip_6m
from proj_int.index a
left join
ip_183_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sort data=ip_365_3 nodupkey;
by bene_id index_year;
run;
/*
proc sql;
create table ip1 as select a.*,b.icu_days_6m,
b.n_ip_admit_6m,b.n_hospd_6m,b.n_em_urgent_admit_6m,b.n_em_admit_6m,
b.n_urgent_admit_6m,b.n_elect_admit_6m,b.n_ED_ip_6m
from ip_6m a
left join
ip_365_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;
*/
/*Dataset just contains obs with ffs mc 6m and age 65+
So if missing, set var to 0*/
 data ip ;
 set ip_6m ;
 array list icu_days_6m n_ip_admit_6m n_hospd_6m n_em_urgent_admit_6m 
	n_em_admit_6m n_urgent_admit_6m n_elect_admit_6m n_ED_ip_6m
	icu_days_6m n_ip_admit_6m n_hospd_6m n_em_urgent_admit_6m
	n_em_admit_6m n_urgent_admit_6m n_elect_admit_6m n_ED_ip_6m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_6m=0 then ind_hosp_adm_6m=0;
 if n_ip_admit_6m>0 & n_ip_admit_6m~=. then ind_hosp_adm_6m=1;
 label ind_hosp_adm_6m="Indicator for any hospital admission 6m pre ivw";

 if n_em_urgent_admit_6m=0 then ind_em_ur_adm_6m=0;
 if n_em_urgent_admit_6m>0 & n_em_urgent_admit_6m~=. then ind_em_ur_adm_6m=1;
 label ind_em_ur_adm_6m="Ind any urgent or emergent hospital admission 6m pre ivw";

 if n_em_admit_6m=0 then ind_em_adm_6m=0;
 if n_em_admit_6m>0 & n_em_admit_6m~=. then ind_em_adm_6m=1;
 label ind_em_adm_6m="Ind any emergency hospital admission 6m pre ivw";

 if n_urgent_admit_6m=0 then ind_ur_adm_6m=0;
 if n_urgent_admit_6m>0 & n_urgent_admit_6m~=. then ind_ur_adm_6m=1;
 label ind_ur_adm_6m="Ind any urgent hospital admission 6m pre ivw";

 if n_elect_admit_6m =0 then ind_elect_adm_6m=0;
 if n_elect_admit_6m >0 & n_elect_admit_6m ~=. then ind_elect_adm_6m=1;
 label ind_elect_adm_6m="Ind any elective hospital admission 6m pre ivw";

 if (n_ip_admit_6m - n_elect_admit_6m)=0 then ind_nonelect_adm_6m=0;
 if (n_ip_admit_6m - n_elect_admit_6m)>0 & n_elect_admit_6m~=. then ind_nonelect_adm_6m=1;
 label ind_nonelect_adm_6m="Ind any non-elective hospital admission 6m pre ivw";

 n_nonelect_adm_6m=(n_ip_admit_6m - n_elect_admit_6m);
 label n_nonelect_adm_6m="total n non-elective ip admit 6m pre ivw";

 if n_ED_ip_6m=0 then ind_ED_adm_6m=0;
 if n_ED_ip_6m>0 & n_ED_ip_6m~=. then ind_ED_adm_6m=1;
 label ind_ED_adm_6m="Ind ED use with hospital admission 6m pre ivw, from charges";

 if n_ip_admit_6m=0 then ind_hosp_adm_6m=0;
 if n_ip_admit_6m>0 & n_ip_admit_6m~=. then ind_hosp_adm_6m=1;
 label ind_hosp_adm_6m="Indicator for any hospital admission 6m pre ivw";

 if n_em_urgent_admit_6m=0 then ind_em_ur_adm_6m=0;
 if n_em_urgent_admit_6m>0 & n_em_urgent_admit_6m~=. then ind_em_ur_adm_6m=1;
 label ind_em_ur_adm_6m="Ind any urgent or emergent hospital admission 6m pre ivw";

 if n_em_admit_6m=0 then ind_em_adm_6m=0;
 if n_em_admit_6m>0 & n_em_admit_6m~=. then ind_em_adm_6m=1;
 label ind_em_adm_6m="Ind any emergency hospital admission 6m pre ivw";

 if n_urgent_admit_6m=0 then ind_ur_adm_6m=0;
 if n_urgent_admit_6m>0 & n_urgent_admit_6m~=. then ind_ur_adm_6m=1;
 label ind_ur_adm_6m="Ind any urgent hospital admission 6m pre ivw";

 if n_elect_admit_6m =0 then ind_elect_adm_6m=0;
 if n_elect_admit_6m >0 & n_elect_admit_6m ~=. then ind_elect_adm_6m=1;
 label ind_elect_adm_6m="Ind any elective hospital admission 6m pre ivw";

 if (n_ip_admit_6m - n_elect_admit_6m)=0 then ind_nonelect_adm_6m=0;
 if (n_ip_admit_6m - n_elect_admit_6m)>0 & n_elect_admit_6m~=. then ind_nonelect_adm_6m=1;
 label ind_nonelect_adm_6m="Ind any non-elective hospital admission 6m pre ivw";

 n_nonelect_adm_6m=(n_ip_admit_6m - n_elect_admit_6m);
 label n_nonelect_adm_6m="total n non-elective ip admit 6m pre ivw";

 if n_ED_ip_6m=0 then ind_ED_adm_6m=0;
 if n_ED_ip_6m>0 & n_ED_ip_6m~=. then ind_ED_adm_6m=1;
 label ind_ED_adm_6m="Ind ED use with hospital admission 6m pre ivw, from charges";

run;

 proc freq;
 table icu_days_6m n_ip_admit_6m n_hospd_6m ind_hosp_adm_6m n_em_urgent_admit_6m ind_em_ur_adm_6m 
	ind_em_adm_6m ind_ur_adm_6m ind_nonelect_adm_6m n_nonelect_adm_6m n_ED_ip_6m ind_ED_adm_6m 
	ind_em_adm_6m*ind_ED_adm_6m /missprint;
 run;

proc freq;
table icu_days_6m n_ip_admit_6m n_hospd_6m ind_hosp_adm_6m n_em_urgent_admit_6m ind_em_ur_adm_6m
	ind_em_adm_6m ind_ur_adm_6m ind_nonelect_adm_6m n_nonelect_adm_6m n_ED_ip_6m ind_ED_adm_6m 
	ind_em_adm_6m*ind_ED_adm_6m /missprint;
run;

/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months preceding the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months pre-interview*/
data snf_meet_365;
set proj_int.snf_meet_365;
run;

proc sort data=snf_meet_365;
by bene_id admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *1797*/
proc sql;
create table snf_meet1_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date - disch_date)>=0; 
quit;


/*meet time window 2 *152*/
proc sql;
create table snf_meet2_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_pre_365_1;
set snf_meet2_pre_365;
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *135 */
proc sql;
create table snf_meet3_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_pre_365_1;
set snf_meet3_pre_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 , overlap both start and end dates n=7*/
proc sql;
create table snf_meet4_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_pre_365_1;
set snf_meet4_pre_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_pre_365;
set snf_meet1_pre_365 snf_meet2_pre_365_1 snf_meet3_pre_365_1 snf_meet4_pre_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data proj_int.snf_meet_pre_365 ;
set  snf_meet_pre_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data pre_snf_days_1;
set proj_int.snf_meet_pre_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=pre_snf_days_1;
by bene_id index_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bene_id,index_year,
sum(calc_snf_LOS)
	as n_snf_days_6m
	from pre_snf_days_1 group by bene_id,index_year;
quit;


/*merge into full ffs 6m, age 65+ dataset*/
proc sort data=snf_days_pre nodupkey;
by bene_id index_year;
run;



 data snf ;
 set snf_days_pre ;
 array list n_snf_days_6m;
 do over list;
 if list=. then list=0;
 end; 

if n_snf_days_6m=0 then ind_snf_use_6m=0;
 if n_snf_days_6m>0 & n_snf_days_6m~=. then ind_snf_use_6m=1;
 label ind_snf_use_6m="Indicator for any SNF stay 6m pre ivw";
 label n_snf_days_6m="SNF Days 6m pre ivw";

run;

/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.mbsf_06_14 out=dn_2000_20122  nodupkey;
by bene_id year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table esrd1 as select
a.*,b.Bene_ESRD_IND from 
proj_int.index a left join
dn_2000_20122 b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year=b.year;
quit;

proc freq;
table bene_esrd_ind /missprint;
run;

data esrd;
set esrd1 ;
if bene_esrd_ind='Y' then esrd_ind_n=1;
if bene_esrd_ind='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop bene_esrd_ind;
run;

proc freq;
table esrd_ind_n /missprint;
run;

/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen1(keep=bene_id index_year oxygen);
set proj_int.dm_meet_183;
oxygen=0;
if h_o2>0 then oxygen=1;
run;

proc sort data=oxygen1 out=oxygen nodupkey;
by bene_id index_year;
run;
proc contents data=medi.op_09_14; run;

proc contents data=proj_int.op_meet_183; run;
/*added 7/27/17--Observation stays from OP file*/
data ed_op_1;
set proj_int.op_meet_183(keep=bene_id admit_date disch_date index_date index_year erdaycnt obs_stay);
if erdaycnt>0 then ed_op=1;
if erdaycnt=0 then ed_op=0;
if obs_stay=. then obs_stay=0;
if obs_stay>1 then obs_stay=1;
label obs_stay="Observation stay, 6m";
run;

/*added 7/7/17; pull indicator for ER OP visit that doesn't lead to admission*/
/*
data ed_op_1a;
set ed_op_1;
where ed_op=1;
run;*/

data ip_for_op (keep=bene_id index_date admit_date match);
set proj_int.ip_meet_183;
match=1;
run;

proc sql;
create table ed_op_1b as select * from
ed_op_1 a
left join 
ip_for_op b
on a.bene_id=b.bene_id and a.disch_date=b.admit_date;
quit;
data ed_op_1b2;
set ed_op_1b;
if match~=1;
run;

proc sql;
create table ed_op_1d as select distinct bene_id,index_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_no_adm
	from ed_op_1b2 group by bene_id,index_year;
quit;

proc sort data=ed_op_1d nodupkey;
by bene_id index_year;
run;
/*
data ed_op_1c(keep=bene_id ed_op_wout_adm_ind);
set ed_op_1b;
ed_op_wout_adm_ind=1;
where match~=1;
run;
proc freq;
tables ind_ed_op_6m*ed_op_wout_adm_ind;
run;
proc sort nodupkey data=ed_op_1c out=ed_op_1d;
by bene_id;
run;
*/

proc sql;
create table ed_op_2 as select distinct bene_id,index_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_6m,
max(obs_stay) as obs_stay
	from ed_op_1 group by bene_id,index_year;
quit;

proc freq;
table n_ed_op_visits_6m obs_stay;
run;


proc sort data=ed_op_2 nodupkey;
by bene_id index_year;
run;

proc sql;
create table ed_op_3 as select * from
ed_op_2 a
left join ed_op_1d b
on a.bene_id=b.bene_id;
quit;

data ed ;
set ed_op_3;
if n_ed_op_visits_6m=. and comorb_1_0_6m~=. then n_ed_op_visits_6m=0;
label n_ed_op_visits_6m="Count ED OP visits, 6m pre ivw";

if n_ed_op_visits_6m=0 then ind_ed_op_6m=0;
if n_ed_op_visits_6m>0 & n_ed_op_visits_6m~=. then ind_ed_op_6m=1;
label ind_ed_op_6m="Indicator any ED OP visits, 6m pre ivw";

if n_ed_op_no_adm=0 then ed_op_wout_adm_ind=0;
if n_ed_op_no_adm>0 & n_ed_op_no_adm~=. then ed_op_wout_adm_ind=1;
if ed_op_wout_adm_ind=. then ed_op_wout_adm_ind=0;
label ed_op_wout_adm_ind="Indicator ED visit not leading to admission";
run;

proc freq;
table n_ed_op_visits_6m*ind_ed_op_6m;
run;

/*pull indicator for snf and hh use 6m prior*/

proc sql;
create table snf_6m as select * from
proj_int.index a
left join
proj_int.snf_meet_183 b
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit;

data snf_6ma(keep=bene_id index_year ind_snf_6m);
set snf_6m;
if admit_date~=. then ind_snf_6m=1;
if admit_date=. then ind_snf_6m=0;
run;

proc sort data=snf_6ma out=snf_6mb nodupkey;
by bene_id index_year; 
run;

proc sql;
create table hh_6m as select * from
proj_int.index a
left join
proj_int.hh_meet_183 b
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit;

data hh_6ma(keep=bene_id index_year ind_hh_6m);
set hh_6m;
if admit_date~=. then ind_hh_6m=1;
if admit_date=. then ind_hh_6m=0;
run;

proc sort data=hh_6ma out=hh nodupkey;
by bene_id index_year; 
run;

proc sort data=ip out=ip nodupkey; by bene_id index_year; run;
proc sort data=snf out=snf nodupkey; by bene_id index_year; run;
proc sort data=esrd out=esrd nodupkey; by bene_id index_year; run;
proc sort data=oxygen out=oxygen nodupkey; by bene_id index_year; run;
proc sort data=ed out=ed nodupkey; by bene_id index_year; run;

proc sql;
create table proj_int.utilization_pre as select * 
from proj_int.index a 
left join
ip b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join 
snf c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year
left join 
esrd d
on trim(left(a.bene_id))=trim(left(d.bene_id)) and a.index_year=d.index_year
left join
oxygen e
on trim(left(a.bene_id))=trim(left(e.bene_id)) and a.index_year=e.index_year
left join 
ed f
on trim(left(a.bene_id))=trim(left(f.bene_id)) and a.index_year=f.index_year
left join
snf_6mb g
on trim(left(a.bene_id))=trim(left(g.bene_id)) and a.index_year=g.index_year
left join
hh h
on trim(left(a.bene_id))=trim(left(h.bene_id)) and a.index_year=h.index_year;
quit;

proc contents data=proj_int.utilization_pre; 
run;

H="xxx-not used, see below: classify SI based on primary dx"
/*recoded as a macro and use either the primary diagnosis or admitting diagnoses AD_DGNS */

/*start with IP claim list, 1 year before interview*/

%macro singledx(dxvar=,name=);
data dx_1_&name.;
set proj_int.ip_meet_365;

&name._dx=trim(left(&dxvar.));

if &name._dx~="" then do;

chf_&name._dx=0;
copd_&name._dx=0;
hip_&name._dx=0;

/*CHF*/
if (substr(&name._dx,1,5)='39891' or
		substr(&name._dx,1,5)='40211' or
		substr(&name._dx,1,5)='40291' or
		substr(&name._dx,1,5)='40411' or
		substr(&name._dx,1,5)='40413' or
		substr(&name._dx,1,5)='40491' or
		substr(&name._dx,1,5)='40493' or
		substr(&name._dx,1,3)='428') 
		and chf_&name._dx=0 
		then chf_&name._dx=1;*add one binary variables here.;
/*COPD*/
	if (substr(&name._dx,1,3)='490' or
		substr(&name._dx,1,3)='491' or
		substr(&name._dx,1,3)='492' or
		substr(&name._dx,1,4)='4930' or
		substr(&name._dx,1,4)='4931' or
		substr(&name._dx,1,4)='4932' or
		substr(&name._dx,1,4)='4938' or
		substr(&name._dx,1,5)='49390' or
		substr(&name._dx,1,5)='49391' or
		substr(&name._dx,1,3)='494' or
		substr(&name._dx,1,3)='495' or
		substr(&name._dx,1,3)='496' or
		substr(&name._dx,1,3)='497' or
		substr(&name._dx,1,3)='498' or
		substr(&name._dx,1,3)='499' or
		substr(&name._dx,1,3)='500' or
		substr(&name._dx,1,3)='501' or
		substr(&name._dx,1,3)='502' or
		substr(&name._dx,1,3)='503' or
		substr(&name._dx,1,3)='504' or
		substr(&name._dx,1,3)='505' or
		substr(&name._dx,1,4)='5064') 
			and copd_&name._dx=0 
		then copd_&name._dx=1;	
*hip fracture;
if (substr(&name._dx,1,3)='820' ) 
		and hip_&name._dx=0 
		then hip_&name._dx=1;*add one binary variables here.;
end;
run;

proc sql;
create table &name._dx_2 as
select distinct bene_id,index_year,
sum(chf_&name._dx) as chf_&name.,
sum(copd_&name._dx) as copd_&name.,
sum(hip_&name._dx) as hip_&name.
from dx_1_&name.
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data &name._dx_3(keep=bene_id index_year chf_&name._dx copd_&name._dx hip_&name._dx);
set &name._dx_2 ;
array list_com chf_&name. copd_&name. hip_&name.;
array list_com_bin chf_&name._dx copd_&name._dx hip_&name._dx;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;

run;

proc freq;
table chf_&name._dx copd_&name._dx hip_&name._dx;
run;
%mend;

/*use primary diagnosis code*/
%singledx(dxvar=icd_dgns_cd1,name=pri);
/*use admitting diagnosis code*/
%singledx(dxvar=ADmtg_DGNS_cd,name=adm);

/*merge together*/

proc sql;
create table dx_both as select *
from proj_int.index a 
left join 
pri_dx_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join
adm_dx_3 c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year;
quit;

data dx_both2;
set dx_both;

array list chf_pri_dx copd_pri_dx hip_pri_dx chf_adm_dx copd_adm_dx hip_adm_dx;
do over list;
	if list = .  then list=0;
end;
label chf_pri_dx="CHF as primary dx from IP claim, 1yr pre ivw";
label copd_pri_dx="COPD as primary dx from IP claim, 1yr pre ivw";
label hip_pri_dx="Hip fracture as primary dx from IP claim, 1yr pre ivw";

label chf_adm_dx="CHF as admitting dx from IP claim, 1yr pre ivw";
label copd_adm_dx="COPD as admitting dx from IP claim, 1yr pre ivw";
label hip_adm_dx="Hip fracture as admitting dx from IP claim, 1yr pre ivw";

run;


/*Hip fracture criteria, method  by Covinsky
One of the (2) criteria met:
(1) Subject was admitted to a hospital with admitting diagnosis of “820.xx”.
(2) There is a physician record of “HF procedure” (defined by CPT code of 27230-27248) that is supported by either: 
a. Another physician record within 2 days OR 2
b. Relevant surgery during hospitalization. (Relevant surgery is defined by ICD9 codes 785.5, 790.5, 791.5, 792.5). 
(1) variable hip_adm_dx defined in macro above
(2) HF procedure: carrier claims 	(HCPCS_YR specifies the year of CPT coding used)
					hcpcscd01-hcpcscd13 The level 1 HCPCS code is the CPT code
Then a)from carrier claims or 
     b) from IP claims
	

For item (2) checked inpatient claims variables hcpcscd01-45 but none had any of the CPT codes in the list
Next step, try running with carrier files...
*/

/********************************************************************/
/*Physican record of HF procedure, check IP claims
There are no observations with the HF procedure codes in the IP claims, this method isn't
used in creating the final variable*/
data ip_meet_365;
set proj_int.ip_meet_365;
run;

proc contents data=ip_meet_365;
run;

data testhf;
set ip_meet_365;
if HCPcSCD1~='';
run;

data hfproc_ip;
set ip_meet_365;
hf_proc_ind=0;
array list hcpcscd1-hcpcscd45;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;

/********************************************************************/
/*Physican record of HF procedure, check carrier claims*/
/********************************************************************/

data hfproc_carr;
set proj_int.pb_meet_365;
hf_proc_ind=0;
array list hcpcscd1-hcpcscd13;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;

run;

proc freq; table hf_proc_ind;
run;
/********************************************************************/
/*is there also a physican record within 2 days?*/
proc sort data=hfproc_carr; by bene_id admit_date disch_date hf_proc_ind;
run;

data hfproc_carr_2;
set hfproc_carr;
if eof1=0 then
	set hfproc_carr (firstobs=2 keep=admit_date disch_date rename=(admit_date=lead1admit disch_date=lead1disch)) end=eof1;
else do; lead1admit=.;  lead1disch=.; end;
run;

data hfproc_carr_3;
set hfproc_carr_2;
days_next_visit=lead1admit-disch_date;
days_next_disch=lead1disch-disch_date;
if hf_proc_ind=1 and days_next_visit<=2 and days_next_visit~=. & days_next_disch>0 then hf_w_visit_2d=1;
else hf_w_visit_2d=0;
run;

data hfproc_carr_4;
set hfproc_carr_3;
if hf_proc_ind=1;
run;

proc freq data=hfproc_carr_3;
table hf_proc_ind hf_w_visit_2d index_year; run;

/*if have hf CPT code from carrier, but no subsequent carrier claim,
do they have a surgery code from the inpatient claims?*/
data hfproc_carr_5;
set hfproc_carr_4;
if hf_proc_ind=1 and hf_w_visit_2d=0;
run;




/*for b) identify relevant surgeries from IP claims CPT codes and surgery dates*/

/*This section of code for just checking For Surgeries*/
data ip_meet_365;
set proj_int.ip_meet_365;
run;

proc contents data=ip_meet_365;
run;

data proc_long(keep=bene_id CLM_IP_ADMSN_TYPE_CD procedure procedure_date date_imp_yes ADMTG_DGNS_CD icd_dgns_cd1-ICD_DGNS_CD25
	 admit_date disch_date index_year);
set ip_meet_365;
array list ICD_PRCDR_CD1-ICD_PRCDR_CD25;
array date PRCDR_DT1-PRCDR_DT25;
do over list;
if list~="" then do;
	procedure=list;
	if date=0000000 then do;
		procedure_date=admit_date;
		date_imp_yes=1;
		end;
	if date~=0000000 then do;
	procedure_date=datejul(date);
	end;
	output;
end;
end;

format procedure_date date10.;
format admit_date date10.;
format disch_date date10.;

run;

proc freq; table date_imp_yes; run;
/* Identify surgeries that meet the criteria
Indicator variable surgery_meet = 1 if yes, include in sample 
79 surgeries meet the criteria*/
data surgery_meet;
set proc_long;
if length(compress(procedure))>3 then do;

if compress(procedure)+0 in (7855, 7905, 7915, 7925) then surgery_meet=1;

end;
/*only keep observations in work.surgery_meet that meet criteria*/
if surgery_meet then output;

run;
/*End surgery section 1*/

/*who has surgery that meets criteria AND hf CPT code from carrier?*/
proc sql;
create table cpt_and_surg as select a.*,b.admit_date as carr_hf_admit, b.disch_date as carr_hf_disch,
b.hf_proc_ind, b.hf_w_visit_2d from 
surgery_meet a inner join
hfproc_carr_5 b
on trim(left(a.bene_id))=trim(left(b.bene_id));
quit;

data cpt_and_surg_1;
set cpt_and_surg;
format carr_hf_admit carr_hf_disch date9.;
hf_w_surgery=1;
run;

/*now merge in lists to get a list of bid's that meet criteria 1 or 2*/
data cpt_and_surg_2;
set cpt_and_surg_1;
keep bene_id hf_proc_ind hf_w_surgery index_year;
run;

proc sort data=cpt_and_surg_2 nodupkey; by bene_id index_year ; run;

data hfproc_carr_6;
set hfproc_carr_4;
keep bene_id hf_proc_ind hf_w_visit_2d index_year;
if hf_proc_ind=1 and hf_w_visit_2d=1;
run;

proc sort data=hfproc_carr_6 nodupkey; by bene_id  index_year ; run;

*merge the datasets;
data hf_meet;
merge hfproc_carr_6 cpt_and_surg_2 ;
by bene_id index_year;
run;

proc sort data=hf_meet out=hf_meet2 nodupkey; by bene_id  index_year; run;

proc sql;
create table hf_meet3 as select* from
proj_int.index a 
left join 
hf_meet2 b 
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit;

data hf_meet4;
set hf_meet3;

array list hf_proc_ind hf_w_visit_2d hf_w_surgery ;
do over list;
	if list = .  then list=0;
end;
label hf_w_visit_2d ="HF CPT + Dr visit within 2 days, 1yr pre ivw";
label hf_w_surgery ="HF CPT + Surgery, 1yr pre ivw";

run;

proc freq; table hf_w_visit_2d hf_w_surgery; run;

/*Another idea is to check IP claims
if CPT code (in fields proj_int-HCPCSCD45 in list then if PRCDRCD1-PRCDRCD25 in list = hip frature = yes*/

/*merge new variables*/

proc sql;
create table proj_int.criteria as select * from
dx_both2 a
left join hf_meet4 b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;


H="classify SI from 6m"
/*recoded as a macro and use either the primary diagnosis or admitting diagnoses AD_DGNS */

/*start with IP claim list, 1 year before interview*/

%macro singledx(dxvar=,name=);
data dx_1_&name.;
set proj_int.ip_meet_183;

&name._dx=trim(left(&dxvar.));

if &name._dx~="" then do;

chf_&name._dx=0;
copd_&name._dx=0;
hip_&name._dx=0;

/*CHF*/
if (substr(&name._dx,1,5)='39891' or
		substr(&name._dx,1,5)='40211' or
		substr(&name._dx,1,5)='40291' or
		substr(&name._dx,1,5)='40411' or
		substr(&name._dx,1,5)='40413' or
		substr(&name._dx,1,5)='40491' or
		substr(&name._dx,1,5)='40493' or
		substr(&name._dx,1,3)='428') 
		and chf_&name._dx=0 
		then chf_&name._dx=1;*add one binary variables here.;
/*COPD*/
	if (substr(&name._dx,1,3)='490' or
		substr(&name._dx,1,3)='491' or
		substr(&name._dx,1,3)='492' or
		substr(&name._dx,1,4)='4930' or
		substr(&name._dx,1,4)='4931' or
		substr(&name._dx,1,4)='4932' or
		substr(&name._dx,1,4)='4938' or
		substr(&name._dx,1,5)='49390' or
		substr(&name._dx,1,5)='49391' or
		substr(&name._dx,1,3)='494' or
		substr(&name._dx,1,3)='495' or
		substr(&name._dx,1,3)='496' or
		substr(&name._dx,1,3)='497' or
		substr(&name._dx,1,3)='498' or
		substr(&name._dx,1,3)='499' or
		substr(&name._dx,1,3)='500' or
		substr(&name._dx,1,3)='501' or
		substr(&name._dx,1,3)='502' or
		substr(&name._dx,1,3)='503' or
		substr(&name._dx,1,3)='504' or
		substr(&name._dx,1,3)='505' or
		substr(&name._dx,1,4)='5064') 
			and copd_&name._dx=0 
		then copd_&name._dx=1;	
*hip fracture;
if (substr(&name._dx,1,3)='820' ) 
		and hip_&name._dx=0 
		then hip_&name._dx=1;*add one binary variables here.;
end;
run;

proc sql;
create table &name._dx_2 as
select distinct bene_id,index_year,
sum(chf_&name._dx) as chf_&name.,
sum(copd_&name._dx) as copd_&name.,
sum(hip_&name._dx) as hip_&name.
from dx_1_&name.
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data &name._dx_3(keep=bene_id index_year chf_&name._dx copd_&name._dx hip_&name._dx);
set &name._dx_2 ;
array list_com chf_&name. copd_&name. hip_&name.;
array list_com_bin chf_&name._dx copd_&name._dx hip_&name._dx;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;

run;

proc freq;
table chf_&name._dx copd_&name._dx hip_&name._dx;
run;
%mend;

/*use primary diagnosis code*/
%singledx(dxvar=icd_dgns_cd1,name=pri);
/*use admitting diagnosis code*/
%singledx(dxvar=ADmtg_DGNS_cd,name=adm);

/*merge together*/

proc sql;
create table dx_both as select *
from proj_int.index a 
left join 
pri_dx_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join
adm_dx_3 c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year;
quit;

data dx_both2;
set dx_both;

array list chf_pri_dx copd_pri_dx hip_pri_dx chf_adm_dx copd_adm_dx hip_adm_dx;
do over list;
	if list = .  then list=0;
end;
label chf_pri_dx="CHF as primary dx from IP claim, 6m pre ivw";
label copd_pri_dx="COPD as primary dx from IP claim, 6m pre ivw";
label hip_pri_dx="Hip fracture as primary dx from IP claim, 6m pre ivw";

label chf_adm_dx="CHF as admitting dx from IP claim, 6m pre ivw";
label copd_adm_dx="COPD as admitting dx from IP claim, 6m pre ivw";
label hip_adm_dx="Hip fracture as admitting dx from IP claim, 6m pre ivw";

run;


/*Hip fracture criteria, method  by Covinsky
One of the (2) criteria met:
(1) Subject was admitted to a hospital with admitting diagnosis of “820.xx”.
(2) There is a physician record of “HF procedure” (defined by CPT code of 27230-27248) that is supported by either: 
a. Another physician record within 2 days OR 2
b. Relevant surgery during hospitalization. (Relevant surgery is defined by ICD9 codes 785.5, 790.5, 791.5, 792.5). 
(1) variable hip_adm_dx defined in macro above
(2) HF procedure: carrier claims 	(HCPCS_YR specifies the year of CPT coding used)
					hcpcscd01-hcpcscd13 The level 1 HCPCS code is the CPT code
Then a)from carrier claims or 
     b) from IP claims
	

For item (2) checked inpatient claims variables hcpcscd01-45 but none had any of the CPT codes in the list
Next step, try running with carrier files...
*/

/********************************************************************/
/*Physican record of HF procedure, check IP claims
There are no observations with the HF procedure codes in the IP claims, this method isn't
used in creating the final variable*/
data ip_meet_183;
set proj_int.ip_meet_183;
run;

proc contents data=ip_meet_183;
run;

data testhf;
set ip_meet_183;
if HCPcSCD1~='';
run;

data hfproc_ip;
set ip_meet_183;
hf_proc_ind=0;
array list hcpcscd1-hcpcscd45;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;

/********************************************************************/
/*Physican record of HF procedure, check carrier claims*/
/********************************************************************/

data hfproc_carr;
set proj_int.pb_meet_183;
hf_proc_ind=0;
array list hcpcscd1-hcpcscd13;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;

run;

proc freq; table hf_proc_ind;
run;
/********************************************************************/
/*is there also a physican record within 2 days?*/
proc sort data=hfproc_carr; by bene_id admit_date disch_date hf_proc_ind;
run;

data hfproc_carr_2;
set hfproc_carr;
if eof1=0 then
	set hfproc_carr (firstobs=2 keep=admit_date disch_date rename=(admit_date=lead1admit disch_date=lead1disch)) end=eof1;
else do; lead1admit=.;  lead1disch=.; end;
run;

data hfproc_carr_3;
set hfproc_carr_2;
days_next_visit=lead1admit-disch_date;
days_next_disch=lead1disch-disch_date;
if hf_proc_ind=1 and days_next_visit<=2 and days_next_visit~=. & days_next_disch>0 then hf_w_visit_2d=1;
else hf_w_visit_2d=0;
run;

data hfproc_carr_4;
set hfproc_carr_3;
if hf_proc_ind=1;
run;

proc freq data=hfproc_carr_3;
table hf_proc_ind hf_w_visit_2d index_year; run;

/*if have hf CPT code from carrier, but no subsequent carrier claim,
do they have a surgery code from the inpatient claims?*/
data hfproc_carr_5;
set hfproc_carr_4;
if hf_proc_ind=1 and hf_w_visit_2d=0;
run;




/*for b) identify relevant surgeries from IP claims CPT codes and surgery dates*/

/*This section of code for just checking For Surgeries*/
data ip_meet_183;
set proj_int.ip_meet_183;
run;

proc contents data=ip_meet_183;
run;

data proc_long(keep=bene_id CLM_IP_ADMSN_TYPE_CD procedure procedure_date date_imp_yes ADMTG_DGNS_CD icd_dgns_cd1-ICD_DGNS_CD25
	 admit_date disch_date index_year);
set ip_meet_183;
array list ICD_PRCDR_CD1-ICD_PRCDR_CD25;
array date PRCDR_DT1-PRCDR_DT25;
do over list;
if list~="" then do;
	procedure=list;
	if date=0000000 then do;
		procedure_date=admit_date;
		date_imp_yes=1;
		end;
	if date~=0000000 then do;
	procedure_date=datejul(date);
	end;
	output;
end;
end;

format procedure_date date10.;
format admit_date date10.;
format disch_date date10.;

run;

proc freq; table date_imp_yes; run;
/* Identify surgeries that meet the criteria
Indicator variable surgery_meet = 1 if yes, include in sample 
79 surgeries meet the criteria*/
data surgery_meet;
set proc_long;
if length(compress(procedure))>3 then do;

if compress(procedure)+0 in (7855, 7905, 7915, 7925) then surgery_meet=1;

end;
/*only keep observations in work.surgery_meet that meet criteria*/
if surgery_meet then output;

run;
/*End surgery section 1*/

/*who has surgery that meets criteria AND hf CPT code from carrier?*/
proc sql;
create table cpt_and_surg as select a.*,b.admit_date as carr_hf_admit, b.disch_date as carr_hf_disch,
b.hf_proc_ind, b.hf_w_visit_2d from 
surgery_meet a inner join
hfproc_carr_5 b
on trim(left(a.bene_id))=trim(left(b.bene_id));
quit;

data cpt_and_surg_1;
set cpt_and_surg;
format carr_hf_admit carr_hf_disch date9.;
hf_w_surgery=1;
run;

/*now merge in lists to get a list of bid's that meet criteria 1 or 2*/
data cpt_and_surg_2;
set cpt_and_surg_1;
keep bene_id hf_proc_ind hf_w_surgery index_year;
run;

proc sort data=cpt_and_surg_2 nodupkey; by bene_id index_year ; run;

data hfproc_carr_6;
set hfproc_carr_4;
keep bene_id hf_proc_ind hf_w_visit_2d index_year;
if hf_proc_ind=1 and hf_w_visit_2d=1;
run;

proc sort data=hfproc_carr_6 nodupkey; by bene_id  index_year ; run;

*merge the datasets;
data hf_meet;
merge hfproc_carr_6 cpt_and_surg_2 ;
by bene_id index_year;
run;

proc sort data=hf_meet out=hf_meet2 nodupkey; by bene_id  index_year; run;

proc sql;
create table hf_meet3 as select* from
proj_int.index a 
left join 
hf_meet2 b 
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit;

data hf_meet4;
set hf_meet3;

array list hf_proc_ind hf_w_visit_2d hf_w_surgery ;
do over list;
	if list = .  then list=0;
end;
label hf_w_visit_2d ="HF CPT + Dr visit within 2 days, 6m pre ivw";
label hf_w_surgery ="HF CPT + Surgery, 6m pre ivw";

run;

proc freq; table hf_w_visit_2d hf_w_surgery; run;

/*Another idea is to check IP claims
if CPT code (in fields proj_int-HCPCSCD45 in list then if PRCDRCD1-PRCDRCD25 in list = hip frature = yes*/

/*merge new variables*/

proc sql;
create table proj_int.criteria as select * from
dx_both2 a
left join hf_meet4 b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;


H="get spending from claims"
/*Add total Medicare payments from claims 1 index_date after interview
and 6m after interview*/

/*Claims files from 2000-2012, claims pulled in previous section
to get just claims that are within 1 index_date of the interview dates
for those interviews were r>65 and ffs medicare 1 yr prior to ivw*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

%macro mp(month_n=,days_start=,days_after_core=,source=,equ=,name=);

/*Case 1 - no adjustment needed - claims where entire claim is within the x months after the interview*/
proc sql;
create table &source._meet_post_1 as select *
from proj_int.&source._meet_&days_after_core.p
where &days_start<=disch_date-index_date<=&days_after_core and
&days_start<=admit_date-index_date<=&days_after_core;
quit;

data zz_&source._meet_post_1;
set &source._meet_post_1;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;

/*Case 2 - adjustment needed because part of stay is in the window but part is after the window has ended
Claims with admission date within start of x months but discharge date is after the x month window*/
proc sql;
create table &source._meet2_post as select *
from proj_int.&source._meet_&days_after_core.p
where disch_date-index_date>&days_after_core and 0<=admit_date-index_date<=&days_after_core;
quit;

data zz_&source._meet2_post;
set &source._meet2_post;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3_post;
set &source._meet2_post;
pct_xm=((index_date+&days_after_core)-admit_date)/(disch_date-admit_date);
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*Case 3 - adjustment needed because part of stay is in the window but part is before the window started
Claims with discharge date within start of x months but admit date is before the interview date*/
proc sql;
create table &source._meet4_post as select *
from proj_int.&source._meet_&days_after_core.p
where disch_date-index_date<=&days_after_core and admit_date-index_date<&days_start;
quit;

data zz_&source._meet4_post;
set &source._meet4_post;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


data &source._meet5_post;
set &source._meet4_post;
pct_xm=(disch_date-index_date)/(disch_date-admit_date);
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 5/4/2015*/

/*create table merging both the claims fully in the 2 index_date period 
and those partially in that time
adjust for inflation here also*/
data &source._cost_post;
set &source._meet_post_1 &source._meet3_post &source._meet5_post;
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
end;


if year(admit_date)=2014 then rate=1;
if year(admit_date)=2013 then rate=1.02377;
if year(admit_date)=2012 then rate=1.05554;
if year(admit_date)=2011 then rate=1.09671;
if year(admit_date)=2010 then rate=1.13032;
if year(admit_date)=2009 then rate=1.16989;
if year(admit_date)=2008 then rate=1.20745;
if year(admit_date)=2007 then rate=1.25859;
if year(admit_date)=2006 then rate=1.32572;
if year(admit_date)=2005 then rate=1.38045;
if year(admit_date)=2004 then rate=1.44662;
if year(admit_date)=2003 then rate=1.51895;
if year(admit_date)=2002 then rate=1.58688;
if year(admit_date)=2001 then rate=1.66714;
if year(admit_date)=2000 then rate=1.74736;
if year(admit_date)<=1999 then rate=1.8833;


&source._paid_by_mc=rate*(clm_pmt_amt+clm_pass_thru_per_diem_amt);
run;
*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay_post as select distinct bene_id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost_post group by bene_id,index_date;
quit;

*merges the totals above with the full interview list;
proc sql;
create table &source._&name._post as select
a.*,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay_post b
 on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_date=b.index_date;
 quit;

 proc sort data=&source._&name._post ;
 by bene_id index_date;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_after_core=365,source=snf,equ=,name=12m );
%mp(days_start=0,days_after_core=183,source=snf,equ=,name=6m );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_after_core=365,source=ip,equ=~,name=12m );
%mp(days_start=0,days_after_core=183,source=ip,equ=~,name=6m );

/**********************************************************/
/**********************************************************/
/*totals from other claim types*/
/**********************************************************/
/**********************************************************/
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_after_core=);

/*Adjust for inflation*/
data &source._meet2_post;
set proj_int.&source._meet_&days_after_core.p;
/*adjust to 2014 dollars*/

if year(admit_date)=2014 then rate=1;
if year(admit_date)=2013 then rate=1.02377;
if year(admit_date)=2012 then rate=1.05554;
if year(admit_date)=2011 then rate=1.09671;
if year(admit_date)=2010 then rate=1.13032;
if year(admit_date)=2009 then rate=1.16989;
if year(admit_date)=2008 then rate=1.20745;
if year(admit_date)=2007 then rate=1.25859;
if year(admit_date)=2006 then rate=1.32572;
if year(admit_date)=2005 then rate=1.38045;
if year(admit_date)=2004 then rate=1.44662;
if year(admit_date)=2003 then rate=1.51895;
if year(admit_date)=2002 then rate=1.58688;
if year(admit_date)=2001 then rate=1.66714;
if year(admit_date)=2000 then rate=1.74736;
if year(admit_date)<=1999 then rate=1.8833;

&source._paid_by_mc=rate*(clm_pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay_post as select distinct bene_id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2_post group by bene_id,index_date;
quit;

/*merge in mc totals with interview list*/
proc sql;
create table &source.&month_n._post as select
a.*,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from proj_int.index a
left join
 &source._pay_post b
 on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_date=b.index_date;
 quit;

 proc sort data=&source&month_n._post ;
 by bene_id index_date;
 run;
 %mend all_other;

/******************************************************************/
/* Run the macro over the mc claims files for 2 index_dates prior to death*/
/******************************************************************/
 %all_other(source=op,month_n=_12m,days_start=0,days_after_core=365);
  %all_other(source=pb,month_n=_12m,days_start=0,days_after_core=365);
   %all_other(source=hh,month_n=_12m,days_start=0,days_after_core=365);
    %all_other(source=hs,month_n=_12m,days_start=0,days_after_core=365);
     %all_other(source=dm,month_n=_12m,days_start=0,days_after_core=365);

 %all_other(source=op,month_n=_6m,days_start=0,days_after_core=183);
  %all_other(source=pb,month_n=_6m,days_start=0,days_after_core=183);
   %all_other(source=hh,month_n=_6m,days_start=0,days_after_core=183);
    %all_other(source=hs,month_n=_6m,days_start=0,days_after_core=183);
     %all_other(source=dm,month_n=_6m,days_start=0,days_after_core=183);

/******************************************************************/
/* Merge into single file, by id and interview */
/******************************************************************/
*first merge 12m and 6m spending into single dataset;
data proj_int.mc_costs_all;
merge ip_12m_post snf_12m_post hh_12m_post hs_12m_post pb_12m_post op_12m_post dm_12m_post
 ip_6m_post snf_6m_post hh_6m_post hs_6m_post pb_6m_post op_6m_post dm_6m_post;
by bene_id index_date;
run;

proc means data=proj_int.mc_costs_all; run;

H="other outcomes from claims"
/*These additional variables are just added to the dataset with the
elixhauser and cc's 1 year preceeding the interview, can add them
later when required to get the 2 year look-back dataset*/

/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set proj_int.ip_meet_&days.p;
run;
data ip_&days._2;
set ip_meet_&days.;
type_adm=clm_ip_admsn_type_cd;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if erdaycnt>0 & erdaycnt~=. then ind_ed_charge=1;
if erdaycnt=0 | erdaycnt=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if disch_date-index_date>&days. then do;
	disch_date=index_date+&days.;
	admit_trunc=1;
	end;
if admit_date<index_date then do;
	admit_date=index_date;
	admit_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by bene_id index_year;
run;

proc sql;
create table ip_&days._3 as select distinct bene_id,index_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. post ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. post ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. post ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. post ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. post ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. post ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. post ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. post ivw"

 from ip_&days._2 group by bene_id,index_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=p6m);
%admissions(days=365,suffix=p12m);

data elective_1;
set ip_365_2;
if elect_admit=1;
run;



proc sort data=ip_183_3 nodupkey;
by bene_id index_year;
run;


proc sql;
create table ip_p6m as select a.*,b.icu_days_p6m,
b.n_ip_admit_p6m,b.n_hospd_p6m,b.n_em_urgent_admit_p6m,b.n_em_admit_p6m,
b.n_urgent_admit_p6m,b.n_elect_admit_p6m,b.n_ED_ip_p6m
from proj_int.index a
left join
ip_183_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sort data=ip_365_3 nodupkey;
by bene_id index_year;
run;

proc sql;
create table ip1 as select a.*,b.icu_days_p12m,
b.n_ip_admit_p12m,b.n_hospd_p12m,b.n_em_urgent_admit_p12m,b.n_em_admit_p12m,
b.n_urgent_admit_p12m,b.n_elect_admit_p12m,b.n_ED_ip_p12m
from ip_p6m a
left join
ip_365_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

/*Dataset just contains obs with ffs mc 1yr and age 65+
So if missing, set var to 0*/
 data ip ;
 set ip1 ;
 array list icu_days_p6m n_ip_admit_p6m n_hospd_p6m n_em_urgent_admit_p6m 
	n_em_admit_p6m n_urgent_admit_p6m n_elect_admit_p6m n_ED_ip_p6m
	icu_days_p12m n_ip_admit_p12m n_hospd_p12m n_em_urgent_admit_p12m
	n_em_admit_p12m n_urgent_admit_p12m n_elect_admit_p12m n_ED_ip_p12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_p6m=0 then ind_hosp_adm_p6m=0;
 if n_ip_admit_p6m>0 & n_ip_admit_p6m~=. then ind_hosp_adm_p6m=1;
 label ind_hosp_adm_p6m="Indicator for any hospital admission 6m post ivw";

 if n_em_urgent_admit_p6m=0 then ind_em_ur_adm_p6m=0;
 if n_em_urgent_admit_p6m>0 & n_em_urgent_admit_p6m~=. then ind_em_ur_adm_p6m=1;
 label ind_em_ur_adm_p6m="Ind any urgent or emergent hospital admission 6m post ivw";

 if n_em_admit_p6m=0 then ind_em_adm_p6m=0;
 if n_em_admit_p6m>0 & n_em_admit_p6m~=. then ind_em_adm_p6m=1;
 label ind_em_adm_p6m="Ind any emergency hospital admission 6m post ivw";

 if n_urgent_admit_p6m=0 then ind_ur_adm_p6m=0;
 if n_urgent_admit_p6m>0 & n_urgent_admit_p6m~=. then ind_ur_adm_p6m=1;
 label ind_ur_adm_p6m="Ind any urgent hospital admission 6m post ivw";

 if n_elect_admit_p6m =0 then ind_elect_adm_p6m=0;
 if n_elect_admit_p6m >0 & n_elect_admit_p6m ~=. then ind_elect_adm_p6m=1;
 label ind_elect_adm_p6m="Ind any elective hospital admission 6m post ivw";

 if (n_ip_admit_p6m - n_elect_admit_p6m)=0 then ind_nonelect_adm_p6m=0;
 if (n_ip_admit_p6m - n_elect_admit_p6m)>0 & n_elect_admit_p6m~=. then ind_nonelect_adm_p6m=1;
 label ind_nonelect_adm_p6m="Ind any non-elective hospital admission 6m post ivw";

 n_nonelect_adm_p6m=(n_ip_admit_p6m - n_elect_admit_p6m);
 label n_nonelect_adm_p6m="total n non-elective ip admit 6m post ivw";

 if n_ED_ip_p6m=0 then ind_ED_adm_p6m=0;
 if n_ED_ip_p6m>0 & n_ED_ip_p6m~=. then ind_ED_adm_p6m=1;
 label ind_ED_adm_p6m="Ind ED use with hospital admission 6m post ivw, from charges";

 if n_ip_admit_p12m=0 then ind_hosp_adm_p12m=0;
 if n_ip_admit_p12m>0 & n_ip_admit_p12m~=. then ind_hosp_adm_p12m=1;
 label ind_hosp_adm_p12m="Indicator for any hospital admission 12m post ivw";

 if n_em_urgent_admit_p12m=0 then ind_em_ur_adm_p12m=0;
 if n_em_urgent_admit_p12m>0 & n_em_urgent_admit_p12m~=. then ind_em_ur_adm_p12m=1;
 label ind_em_ur_adm_p12m="Ind any urgent or emergent hospital admission 12m post ivw";

 if n_em_admit_p12m=0 then ind_em_adm_p12m=0;
 if n_em_admit_p12m>0 & n_em_admit_p12m~=. then ind_em_adm_p12m=1;
 label ind_em_adm_p12m="Ind any emergency hospital admission 12m post ivw";

 if n_urgent_admit_p12m=0 then ind_ur_adm_p12m=0;
 if n_urgent_admit_p12m>0 & n_urgent_admit_p12m~=. then ind_ur_adm_p12m=1;
 label ind_ur_adm_p12m="Ind any urgent hospital admission 12m post ivw";

 if n_elect_admit_p12m =0 then ind_elect_adm_p12m=0;
 if n_elect_admit_p12m >0 & n_elect_admit_p12m ~=. then ind_elect_adm_p12m=1;
 label ind_elect_adm_p12m="Ind any elective hospital admission 12m post ivw";

 if (n_ip_admit_p12m - n_elect_admit_p12m)=0 then ind_nonelect_adm_p12m=0;
 if (n_ip_admit_p12m - n_elect_admit_p12m)>0 & n_elect_admit_p12m~=. then ind_nonelect_adm_p12m=1;
 label ind_nonelect_adm_p12m="Ind any non-elective hospital admission 12m post ivw";

 n_nonelect_adm_p12m=(n_ip_admit_p12m - n_elect_admit_p12m);
 label n_nonelect_adm_p12m="total n non-elective ip admit 12m post ivw";

 if n_ED_ip_p12m=0 then ind_ED_adm_p12m=0;
 if n_ED_ip_p12m>0 & n_ED_ip_p12m~=. then ind_ED_adm_p12m=1;
 label ind_ED_adm_p12m="Ind ED use with hospital admission 12m post ivw, from charges";

run;

 proc freq;
 table icu_days_p6m n_ip_admit_p6m n_hospd_p6m ind_hosp_adm_p6m n_em_urgent_admit_p6m ind_em_ur_adm_p6m 
	ind_em_adm_p6m ind_ur_adm_p6m ind_nonelect_adm_p6m n_nonelect_adm_p6m n_ED_ip_p6m ind_ED_adm_p6m 
	ind_em_adm_p6m*ind_ED_adm_p6m /missprint;
 run;

proc freq;
table icu_days_p12m n_ip_admit_p12m n_hospd_p12m ind_hosp_adm_p12m n_em_urgent_admit_p12m ind_em_ur_adm_p12m
	ind_em_adm_p12m ind_ur_adm_p12m ind_nonelect_adm_p12m n_nonelect_adm_p12m n_ED_ip_p12m ind_ED_adm_p12m 
	ind_em_adm_p12m*ind_ED_adm_p12m /missprint;
run;

/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months after the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months post-interview*/
data snf_meet_365;
set proj_int.snf_meet_365p;
run;

proc sort data=snf_meet_365;
by bene_id admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *1797*/
proc sql;
create table snf_meet1_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date - disch_date)>=0; 
quit;


/*meet time window 2 *152*/
proc sql;
create table snf_meet2_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_aft_365_1;
set snf_meet2_aft_365;
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *135 */
proc sql;
create table snf_meet3_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_aft_365_1;
set snf_meet3_aft_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 , overlap both start and end dates n=7*/
proc sql;
create table snf_meet4_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_aft_365_1;
set snf_meet4_aft_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_aft_365;
set snf_meet1_aft_365 snf_meet2_aft_365_1 snf_meet3_aft_365_1 snf_meet4_aft_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data proj_int.snf_meet_aft_365 ;
set  snf_meet_aft_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data aft_snf_days_1;
set proj_int.snf_meet_aft_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=aft_snf_days_1;
by bene_id index_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bene_id,index_year,
sum(calc_snf_LOS)
	as n_snf_days_p12m
	from aft_snf_days_1 group by bene_id,index_year;
quit;


/*merge into full ffs 1yr, age 65+ dataset*/
proc sort data=snf_days_pre nodupkey;
by bene_id index_year;
run;



 data snf ;
 set snf_days_pre ;
 array list n_snf_days_p12m;
 do over list;
 if list=. then list=0;
 end; 

if n_snf_days_p12m=0 then ind_snf_use_p12m=0;
 if n_snf_days_p12m>0 & n_snf_days_p12m~=. then ind_snf_use_p12m=1;
 label ind_snf_use_p12m="Indicator for any SNF stay 12m post ivw";
 label n_snf_days_p12m="SNF Days 12m post ivw";

run;

/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.mbsf_06_12 out=dn_2000_20122  nodupkey;
by bene_id year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table esrd1 as select
a.*,b.Bene_ESRD_IND from 
proj_int.index a left join
dn_2000_20122 b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year=b.year;
quit;

proc freq;
table bene_esrd_ind /missprint;
run;

data esrd;
set esrd1 ;
if bene_esrd_ind='Y' then esrd_ind_n=1;
if bene_esrd_ind='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop bene_esrd_ind;
run;

proc freq;
table esrd_ind_n /missprint;
run;

/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen1(keep=bene_id index_year oxygen);
set proj_int.dm_meet_365p;
oxygen=0;
if h_o2>0 then oxygen=1;
run;

proc sort data=oxygen1 out=oxygen nodupkey;
by bene_id index_year;
run;
proc contents data=medi.op_06_12; run;
data ed_op_1;
set proj_int.op_meet_365p(keep=bene_id admit_date disch_date index_date index_year erdaycnt);
if erdaycnt>0 then ed_op=1;
if erdaycnt=0 then ed_op=0;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bene_id,index_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_p12m
	from ed_op_1 group by bene_id,index_year;
quit;

proc freq;
table n_ed_op_visits_p12m;
run;


proc sort data=ed_op_2 nodupkey;
by bene_id index_year;
run;


data ed ;
set ed_op_2;
if n_ed_op_visits_p12m=. and comorb_1_0_1yr~=. then n_ed_op_visits_p12m=0;
label n_ed_op_visits_p12m="Count ED OP visits, 1yr post ivw";

if n_ed_op_visits_p12m=0 then ind_ed_op_p12m=0;
if n_ed_op_visits_p12m>0 & n_ed_op_visits_p12m~=. then ind_ed_op_p12m=1;
label ind_ed_op_p12m="Indicator any ED OP visits, 1 yr post ivw";
run;

proc freq;
table n_ed_op_visits_p12m*ind_ed_op_p12m;
run;


proc sort data=ip out=ip nodupkey; by bene_id index_year; run;
proc sort data=snf out=snf nodupkey; by bene_id index_year; run;
proc sort data=esrd out=esrd nodupkey; by bene_id index_year; run;
proc sort data=oxygen out=oxygen nodupkey; by bene_id index_year; run;
proc sort data=ed out=ed nodupkey; by bene_id index_year; run;


proc sql;
create table proj_int.utilization_post as select * 
from proj_int.index a 
left join
ip b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join 
snf c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year
left join 
esrd d
on trim(left(a.bene_id))=trim(left(d.bene_id)) and a.index_year=d.index_year
left join
oxygen e
on trim(left(a.bene_id))=trim(left(e.bene_id)) and a.index_year=e.index_year
left join 
ed f
on trim(left(a.bene_id))=trim(left(f.bene_id)) and a.index_year=f.index_year;
quit;

proc contents data=proj_int.utilization_post; 
run;

H="combine with interviews into one dataset"
data proj_int.index;
set proj_int.index;
if index_date = . then delete;
run;


data proj_int.index;
set proj_int.index;
if bene_id =" " then delete;
run;


proc sql; 
create table tomerge as select * from
proj_int.index a left join
proj_int.ffs_before b 
on a.bene_id=b.bene_id and a.index_year=b.index_year
left join 
proj_int.ffs_after c
on a.bene_id=c.bene_id and a.index_year=c.index_year
left join 
proj_int.elix_0_6m_2 d
on a.bene_id=d.bene_id and a.index_year=d.index_year
left join 
proj_int.charls_0_6m e
on a.bene_id=e.bene_id and a.index_year=e.index_year
left join
proj_int.dmouth_0_6m f
on a.bene_id=f.bene_id and a.index_year=f.index_year
left join
proj_int.chronic_21_6m3_0 g
on a.bene_id=g.bene_id and a.index_year=g.index_year
left join 
proj_int.utilization_pre h
on a.bene_id=h.bene_id and a.index_year=h.index_year
left join
proj_int.mc_costs_all i
on a.bene_id=i.bene_id and a.index_year=i.index_year
left join 
proj_int.utilization_post j
on a.bene_id=j.bene_id and a.index_year=j.index_year
left join
proj_int.criteria k
on a.bene_id=k.bene_id and a.index_year=k.index_year
left join
proj_int.chronic_21_1yr3_0 l
on a.bene_id=l.bene_id and a.index_year=l.index_year
left join
proj_int.addl_comorb m
on a.bene_id=m.bene_id and a.index_year=m.index_year;
quit;

proc sql;
create table proj_int.serious_ill_int_dataset as select * from
proj_int.nhats a 
left join
tomerge b 
on a.spid=b.spid and a.ivw_year=b.index_year;
quit;

proc export data=proj_int.serious_ill_int_dataset outfile="E:\nhats\data\projects\pal_perf_scale\int_data\serious_ill_int_dataset.dta" 
replace;
run;

H="variable cleaning and check criteria"
/*This section defines the serious medical illness indicators
as well as the additional criteria for serious illness
1. Serious medical illness
2. ADL impairment
3. Self report nursing home residence
4. Urgent or emergent hospitalization 

2 sets of criteria are used:


Criteria A: Either serious medical illness or ADL impairment
Criteria B: Critera A + either nursing home resident or hospitalization*/

option nofmterr;

data proj_int.serious_ill_int_dataset1;
set proj_int.serious_ill_int_dataset;


/*any elixhauser cancer dx*/
if comorb_17_0_1yr=1 | comorb_18_0_1yr=1 | comorb_19_0_1yr=1 then el_cancer_1yr=1;
if comorb_17_0_1yr=0 & comorb_18_0_1yr=0 & comorb_19_0_1yr=0 then el_cancer_1yr=0;

/*3 or more Elixhauser comorbidities*/
if comorb_all_0_1yr>2 then el_ge3_comorb_1yr=1;
if 0=<comorb_all_0_1yr<=2 then el_ge3_comorb_1yr=0;

/*4 or more comorbidities - needs to be reevaluated once other defs are defined!*/
if comorb_all_0_1yr>3 then el_ge4_comorb_1yr=1;
if 0=<comorb_all_0_1yr<=3 then el_ge4_comorb_1yr=0;

cc_all_count_1yr = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + cc_5_cataract_1yr + cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + cc_10_glaucoma_1yr + 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;

if cc_all_count_1yr >3 then cc_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr <=3 then cc_ge4_comorb_1yr=0;

/*cc's excluding cataract and glaucoma*/
cc_all_count_1yr_2 = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + /*cc_5_cataract_1yr +*/ cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + /*cc_10_glaucoma_1yr +*/ 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;
label cc_all_count_1yr_2="Count of cc's, excludes cataract and glaucoma";

if cc_all_count_1yr_2>3 then cc2_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr_2<=3 then cc2_ge4_comorb_1yr=0;

label el_ge3_comorb_1yr="3+ Elixhauser comorbidities";
label el_ge4_comorb_1yr="4+ Elixhauser comorbidities";
label cc_ge4_comorb_1yr="4+ DW Chronic Conditions";
label cc2_ge4_comorb_1yr="4+ DW Chronic Conditions, excl cataract and glaucoma";

/***************************************************/
/*create indicators for any indication of the serious medical illnesses across
variables (cc's elix hrs survey) */
/*dementia requires more than 1 dementia diagnosis 1 year before ivw*/
if dem_dx_1yr>=2 and dem_dx_1yr~=. then smi_dem_ind=1;
if dem_dx_1yr=0 or dem_dx_1yr=1 then smi_dem_ind=0;
label smi_dem_ind="Indicator of Dementia 1yr, Elixhauser 2+dx req.";

/*old def commented out
if el_cancer_1yr=1 | CC_cncr_chronic_1yr=1 | cancer_hrs=1 then cancer_any_ind=1;
if el_cancer_1yr=0 & CC_cncr_chronic_1yr=0 & cancer_hrs=0 then cancer_any_ind=0; */
/*cancer flagged as serious medical illness if metastatic cancer 
or blood cancers new def to be provided from Amy*/
/*note 3/27/2017--here includes Dartmouth poor-prognosis cancer/leukemia*/
if comorb_18_0_1yr=1 then smi_cancer_ind=1;
if comorb_18_0_1yr=0 then smi_cancer_ind=0;
if dmouth_1_0_1yr=1 then smi_cancer_ind=1;
label smi_cancer_ind="Indicator of Metastatic Cancer 1yr";

/*ESRD from either dx code per elixhauser or denominator file flag*/
if comorb_13_0_1yr=1 | esrd_ind_n=1 then smi_esrd_ind=1;
if comorb_13_0_1yr=0 & esrd_ind_n=0  then smi_esrd_ind=0;
label smi_esrd_ind="Indicator of ESRD 1yr, Elix and claims DN file";

/*chf, use dx list for Elixhauser, but as primary DX from a hospitalization only*/
if chf_pri_dx=1  then smi_chf_ind=1;
if chf_pri_dx=0  then smi_chf_ind=0;
label smi_chf_ind="Indicator of CHF 1yr, Primary dx from IP claim";

/*COPD indicator meets following criteria:
1. COPD from Elix (any dx field) and Oxygen use from DME claims or
2. COPD as a primary diagnosis from a hospitalization*/
if (comorb_9_0_1yr=1 & oxygen=1) | copd_pri_dx=1 then smi_copd_ind=1;
if (comorb_9_0_1yr=0 | oxygen=0) & copd_pri_dx=0 then smi_copd_ind=0;
label smi_copd_ind="Indicator of COPD 1yr, copd any dx and home o2 use or copd as prim dx";

/*diabetes, Elix 11 (diabetes with complications) if criteria for 
renal disease (comorb 34), ischemic heart disease (cc 12) or 
peripheral vascular disease (comorb 5) are present*/
if comorb_11_0_1yr=1 & (comorb_5_0_1yr=1 | comorb_34_0_1yr=1 | CC_12_ISCHMCHT_1yr =1) then
	smi_diab_compl_ind=1;
if comorb_11_0_1yr=0 | (comorb_5_0_1yr=0 & comorb_34_0_1yr=0 & CC_12_ISCHMCHT_1yr =0) then
	smi_diab_compl_ind=0;
label smi_diab_compl_ind="Elix compl diabetes + peripheral vas, renal or ischem, 1yr";

if comorb_14_0_1yr=1 then smi_liver_ind=1;
if comorb_14_0_1yr=0 then smi_liver_ind=0;
label smi_liver_ind="Indicator of Advanced liver disease/cirrhosis 1yr, elix";

/*Update 6/9/14 - HIV not included in final list of serious medical illnesses for
the criteria definition
4/2/15 - Added HIV back into list*/
if comorb_16_0_1yr=1 then smi_hiv_ind=1;
if comorb_16_0_1yr=0 then smi_hiv_ind=0;
label smi_hiv_ind="Indicator of HIV with and AIDS defining illness 1yr, elix";

if comorb_33_0_1yr=1 then smi_als_ind=1;
if comorb_33_0_1yr=0 then smi_als_ind=0;
label smi_als_ind="Indicator of ALS 1yr, icd9 code";

/*hip fracture, either admitting diagnosis or CPT from carrier claim AND
surgery or follow up carrier claim within 2 days*/
if hip_adm_dx=1 | hf_w_visit_2d=1 | hf_w_surgery=1 then smi_hip_ind=1;
if hip_adm_dx=0 & hf_w_visit_2d=0 & hf_w_surgery=0 then smi_hip_ind=0;
label smi_hip_ind="Indicator of Hip fracture 1yr, adm dx or from physician claims";
/*******************************************************************/
/*******************************************************************/

/*doesn't use the cc definition excluding cataract,glaucoma cc2_ge4_comorb_1yr */
if el_ge4_comorb_1yr=1 | cc_ge4_comorb_1yr=1 /*| comor_c_hrs=1*/ then multi_any_ind=1;
if el_ge4_comorb_1yr=0 & cc_ge4_comorb_1yr=0 /*& comor_c_hrs=0*/ then multi_any_ind=0;
label multi_any_ind="Any indicator of Multimorbidity 4+ chronic conditions 1yr";

/*total number of serious medical illnesses per these definitions*/
smi_count=smi_dem_ind + smi_cancer_ind + smi_esrd_ind + smi_chf_ind + smi_copd_ind + 
 smi_diab_compl_ind + smi_liver_ind + smi_hiv_ind + smi_als_ind + smi_hip_ind;

/*indicator for 3+serious medical illnesses*/
if smi_count>=3 then smi_ge3_ind=1;
if smi_count<3 then smi_ge3_ind=0;
label smi_ge3_ind="3 or more serious medical illnesses";

/*indicator for any serious medical illness
Update 6/9/14 - HIV not included in list of serious medical illnesses*/
if smi_dem_ind =1 | smi_cancer_ind =1 | smi_esrd_ind =1 | smi_chf_ind =1 | 
 smi_copd_ind =1 | smi_diab_compl_ind =1 | smi_liver_ind =1 | smi_hiv_ind =1 | 
 smi_als_ind =1 | smi_hip_ind=1
 then ser_med_illness=1;
if smi_dem_ind =0 & smi_cancer_ind =0 & smi_esrd_ind =0 & smi_chf_ind =0 & 
 smi_copd_ind =0 & smi_diab_compl_ind =0 & smi_liver_ind =0 & smi_hiv_ind =0 & 
 smi_als_ind =0 & smi_hip_ind=0
 then ser_med_illness=0;
label ser_med_illness="Any indicator of serious medical illness 1yr";

/*Indicator for any SNF stays 12m prior to interview or current nh res
Update 6/2/14 - nursing home use will be included only if current nh residence reported,
not if any SNF claims found*/
if /*ind_snf_use_12m=1 |*/ nhres=1 then smi_nh_ind=1;
if /*ind_snf_use_12m=0 &*/ nhres=0 then smi_nh_ind=0;
label smi_nh_ind="Nursing home resident self report in ivw";

/*indicator for adl helper*/
*if adl_helper_count>0 & adl_helper_count~=. then smi_helper_ind=1;
*if adl_helper_count=0 then smi_helper_ind=0;
*label smi_helper_ind="Indicator of having any helpers with ADL, core";

/*backfill adl status if adl helper variable is complete*/
adl_ind = adl_independent;
*if adl_independent=. and smi_helper_ind=1 then adl_ind_core_n=0;
*if adl_independent=. and smi_helper_ind=0 then adl_ind_core_n=1;
label adl_ind = "ADL independent at interview";

if adl_ind=1 then adl_impair = 0;
if adl_ind=0 then adl_impair = 1;
label adl_impair = "ADL impairment at core interview";

/*indicator for any ED visit, either OP or IP*/
if ind_ed_op_12m=1 | ind_ED_adm_12m=1 then ind_ed_op_or_ip_12m=1;
if ind_ed_op_12m=0 & ind_ED_adm_12m=0 then ind_ed_op_or_ip_12m=0;
label ind_ed_op_or_ip_12m="Indicator any ED use 12m pre ivw";

/*criteria (A) serious medical illness and/or ADL impairment*/
if (ser_med_illness=1 | adl_impair=1) then criteria_a=1;
if (ser_med_illness=0 & adl_impair=0) then criteria_a=0;
label criteria_a="Crit A SMI and/or ADL impair";

/*indicator for serious medical illness and ADL impairment*/
if (ser_med_illness=1 & adl_impair=1) then smi_and_adl=1;
if (ser_med_illness=0 | adl_impair=0) then smi_and_adl=0;
label smi_and_adl="SMI and ADL impairment";

/*criteria (B) serious medical illness and/or ADL impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 | adl_impair=1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_b=1;
if (ser_med_illness=0 & adl_impair=0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_b=0;
label criteria_b="Crit B SMI or ADL impair and hospital admit or nh use";

/*criteria (C) serious medical illness and adl impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 & adl_impair=1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_c=1;
if (ser_med_illness=0 | adl_impair=0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_c=0;
label criteria_c="Crit C SMI and ADL impair and hospital admit or nh use";

/*serious medical illness criteria variable defined, so name matches format of other criteria indicators*/
criteria_smi=ser_med_illness;
label criteria_smi="Comparison criteria - SMI";

run;

/*export full dataset to Stata*/


proc export data=proj_int.serious_ill_int_dataset1
outfile="E:\nhats\data\projects\pal_perf_scale\int_data\serious_ill_int_dataset1.dta" replace;
run;

H="var clean & check criteria--using 6m"
/*This section defines the serious medical illness indicators
as well as the additional criteria for serious illness
1. Serious medical illness
2. ADL impairment
3. Self report nursing home residence
4. Urgent or emergent hospitalization 

2 sets of criteria are used:


Criteria A: Either serious medical illness or ADL impairment
Criteria B: Critera A + either nursing home resident or hospitalization

note-04052017-
all using just 6m back
*/

option nofmterr;

data proj_int.serious_ill_int_dataset1;
set proj_int.serious_ill_int_dataset;


/*any elixhauser cancer dx*/
if comorb_17_0_6m=1 | comorb_18_0_6m=1 | comorb_19_0_6m=1 then el_cancer_6m=1;
if comorb_17_0_6m=0 & comorb_18_0_6m=0 & comorb_19_0_6m=0 then el_cancer_6m=0;

/*3 or more Elixhauser comorbidities*/
if comorb_all_0_6m>2 then el_ge3_comorb_6m=1;
if 0=<comorb_all_0_6m<=2 then el_ge3_comorb_6m=0;

/*4 or more comorbidities - needs to be reevaluated once other defs are defined!*/
if comorb_all_0_6m>3 then el_ge4_comorb_6m=1;
if 0=<comorb_all_0_6m<=3 then el_ge4_comorb_6m=0;

cc_all_count_6m = cc_1_ami_6m + cc_2_alzh_6m + cc_3_alzhdmta_6m + 
cc_4_atrialfb_6m + cc_5_cataract_6m + cc_6_chrnkidn_6m + 
cc_7_copd_6m + cc_8_chf_6m + cc_9_diabetes_6m + cc_10_glaucoma_6m + 
cc_11_hipfrac_6m + cc_12_ischmcht_6m + cc_13_depressn_6m + 
cc_14_osteoprs_6m + cc_15_ra_oa_6m + cc_16_strketia_6m + 
cc_17_cncrbrst_6m + cc_18_cncrclrc_6m + cc_19_cncrprst_6m + 
cc_20_cncrlung_6m + cc_21_cncrendm_6m;

if cc_all_count_6m >3 then cc_ge4_comorb_6m=1;
if 0=<cc_all_count_6m <=3 then cc_ge4_comorb_6m=0;

/*cc's excluding cataract and glaucoma*/
cc_all_count_6m_2 = cc_1_ami_6m + cc_2_alzh_6m + cc_3_alzhdmta_6m + 
cc_4_atrialfb_6m + /*cc_5_cataract_6m +*/ cc_6_chrnkidn_6m + 
cc_7_copd_6m + cc_8_chf_6m + cc_9_diabetes_6m + /*cc_10_glaucoma_6m +*/ 
cc_11_hipfrac_6m + cc_12_ischmcht_6m + cc_13_depressn_6m + 
cc_14_osteoprs_6m + cc_15_ra_oa_6m + cc_16_strketia_6m + 
cc_17_cncrbrst_6m + cc_18_cncrclrc_6m + cc_19_cncrprst_6m + 
cc_20_cncrlung_6m + cc_21_cncrendm_6m;
label cc_all_count_6m_2="Count of cc's, excludes cataract and glaucoma";

if cc_all_count_6m_2>3 then cc2_ge4_comorb_6m=1;
if 0=<cc_all_count_6m_2<=3 then cc2_ge4_comorb_6m=0;

label el_ge3_comorb_6m="3+ Elixhauser comorbidities";
label el_ge4_comorb_6m="4+ Elixhauser comorbidities";
label cc_ge4_comorb_6m="4+ DW Chronic Conditions";
label cc2_ge4_comorb_6m="4+ DW Chronic Conditions, excl cataract and glaucoma";

/***************************************************/
/*create indicators for any indication of the serious medical illnesses across
variables (cc's elix hrs survey) */
/*dementia requires more than 1 dementia diagnosis 1 year before ivw*/
/*update for 7/7/17--for APM, also requiring 2+ADLs*/
if dem_dx_6m>=2 and dem_dx_6m~=. and adl_index>1 and adl_index~=. then smi_dem_ind=1;
if dem_dx_6m=0 or dem_dx_6m=1 or adl_index<2 then smi_dem_ind=0;
label smi_dem_ind="Indicator of Dementia 6m, Elixhauser 2+dx & 2+ ADLs req.";

/*old def commented out
if el_cancer_6m=1 | CC_cncr_chronic_6m=1 | cancer_hrs=1 then cancer_any_ind=1;
if el_cancer_6m=0 & CC_cncr_chronic_6m=0 & cancer_hrs=0 then cancer_any_ind=0; */
/*cancer flagged as serious medical illness if metastatic cancer 
or blood cancers new def to be provided from Amy*/
/*note 3/27/2017--here includes Dartmouth poor-prognosis cancer/leukemia*/
if comorb_18_0_6m=1 then smi_cancer_ind=1;
if comorb_18_0_6m=0 then smi_cancer_ind=0;
if dmouth_1_0_6m=1 then smi_cancer_ind=1;
label smi_cancer_ind="Indicator of Metastatic Cancer 6m";

/*ESRD from either dx code per elixhauser or denominator file flag*/
if comorb_13_0_6m=1 | esrd_ind_n=1 then smi_esrd_ind=1;
if comorb_13_0_6m=0 & esrd_ind_n=0  then smi_esrd_ind=0;
label smi_esrd_ind="Indicator of ESRD 6m, Elix and claims DN file";

/*chf, use dx list for Elixhauser, but as primary DX from a hospitalization only*/
if chf_pri_dx=1  then smi_chf_ind=1;
if chf_pri_dx=0  then smi_chf_ind=0;
label smi_chf_ind="Indicator of CHF 6m, Primary dx from IP claim";

/*COPD indicator meets following criteria:
1. COPD from Elix (any dx field) and Oxygen use from DME claims or
2. COPD as a primary diagnosis from a hospitalization*/
if (comorb_9_0_6m=1 & oxygen=1) | copd_pri_dx=1 then smi_copd_ind=1;
if (comorb_9_0_6m=0 | oxygen=0) & copd_pri_dx=0 then smi_copd_ind=0;
label smi_copd_ind="Indicator of COPD 6m, copd any dx and home o2 use or copd as prim dx";

/*diabetes, Elix 11 (diabetes with complications) if criteria for 
renal disease (comorb 34), ischemic heart disease (cc 12) or 
peripheral vascular disease (comorb 5) are present*/
if comorb_11_0_6m=1 & (comorb_5_0_6m=1 | comorb_34_0_6m=1 | CC_12_ISCHMCHT_6m =1) then
	smi_diab_compl_ind=1;
if comorb_11_0_6m=0 | (comorb_5_0_6m=0 & comorb_34_0_6m=0 & CC_12_ISCHMCHT_6m =0) then
	smi_diab_compl_ind=0;
label smi_diab_compl_ind="Elix compl diabetes + peripheral vas, renal or ischem, 6m";

if comorb_14_0_6m=1 then smi_liver_ind=1;
if comorb_14_0_6m=0 then smi_liver_ind=0;
label smi_liver_ind="Indicator of Advanced liver disease/cirrhosis 6m, elix";

/*Update 6/9/14 - HIV not included in final list of serious medical illnesses for
the criteria definition
4/2/15 - Added HIV back into list*/
if comorb_16_0_6m=1 then smi_hiv_ind=1;
if comorb_16_0_6m=0 then smi_hiv_ind=0;
label smi_hiv_ind="Indicator of HIV with and AIDS defining illness 6m, elix";

if comorb_33_0_6m=1 then smi_als_ind=1;
if comorb_33_0_6m=0 then smi_als_ind=0;
label smi_als_ind="Indicator of ALS 6m, icd9 code";

/*hip fracture, either admitting diagnosis or CPT from carrier claim AND
surgery or follow up carrier claim within 2 days*/
if hip_adm_dx=1 | hf_w_visit_2d=1 | hf_w_surgery=1 then smi_hip_ind=1;
if hip_adm_dx=0 & hf_w_visit_2d=0 & hf_w_surgery=0 then smi_hip_ind=0;
label smi_hip_ind="Indicator of Hip fracture 6m, adm dx or from physician claims";
/*******************************************************************/
/*******************************************************************/

/*doesn't use the cc definition excluding cataract,glaucoma cc2_ge4_comorb_6m */
if el_ge4_comorb_6m=1 | cc_ge4_comorb_6m=1 /*| comor_c_hrs=1*/ then multi_any_ind=1;
if el_ge4_comorb_6m=0 & cc_ge4_comorb_6m=0 /*& comor_c_hrs=0*/ then multi_any_ind=0;
label multi_any_ind="Any indicator of Multimorbidity 4+ chronic conditions 6m";

/*total number of serious medical illnesses per these definitions*/
smi_count=smi_dem_ind + smi_cancer_ind + smi_esrd_ind + smi_chf_ind + smi_copd_ind + 
 smi_diab_compl_ind + smi_liver_ind + smi_hiv_ind + smi_als_ind + smi_hip_ind;

/*indicator for 3+serious medical illnesses*/
if smi_count>=3 then smi_ge3_ind=1;
if smi_count<3 then smi_ge3_ind=0;
label smi_ge3_ind="3 or more serious medical illnesses";

/*indicator for any serious medical illness
Update 6/9/14 - HIV not included in list of serious medical illnesses*/
/*Update 7/24/17- added in Parkinsons and neurodegenerative disorders and stroke*/
if smi_dem_ind =1 | smi_cancer_ind =1 | smi_esrd_ind =1 | smi_chf_ind =1 | 
 smi_copd_ind =1 | smi_diab_compl_ind =1 | smi_liver_ind =1 | smi_hiv_ind =1 | 
 smi_als_ind =1 | smi_hip_ind=1 | neurodeg=1 | cva=1
 then ser_med_illness=1;
if smi_dem_ind =0 & smi_cancer_ind =0 & smi_esrd_ind =0 & smi_chf_ind =0 & 
 smi_copd_ind =0 & smi_diab_compl_ind =0 & smi_liver_ind =0 & smi_hiv_ind =0 & 
 smi_als_ind =0 & smi_hip_ind=0 & neurodeg=0 & cva=0
 then ser_med_illness=0;
label ser_med_illness="Any indicator of serious medical illness 6m";
label cva="CVA, 6m";
label neurodeg="Neurodegenerative Disorder,6m";

/*Indicator for any SNF stays 6m prior to interview or current nh res
Update 6/2/14 - nursing home use will be included only if current nh residence reported,
not if any SNF claims found*/
if /*ind_snf_use_6m=1 |*/ nhres=1 then smi_nh_ind=1;
if /*ind_snf_use_6m=0 &*/ nhres=0 then smi_nh_ind=0;
label smi_nh_ind="Nursing home resident self report in ivw";

/*indicator for adl helper*/
*if adl_helper_count>0 & adl_helper_count~=. then smi_helper_ind=1;
*if adl_helper_count=0 then smi_helper_ind=0;
*label smi_helper_ind="Indicator of having any helpers with ADL, core";

/*backfill adl status if adl helper variable is complete*/
adl_ind = adl_independent;
*if adl_independent=. and smi_helper_ind=1 then adl_ind_core_n=0;
*if adl_independent=. and smi_helper_ind=0 then adl_ind_core_n=1;
label adl_ind = "ADL independent at interview";

if adl_ind=1 then adl_impair = 0;
if adl_ind=0 then adl_impair = 1;
label adl_impair = "ADL impairment at core interview";

/*indicator for any ED visit, either OP or IP*/
if ind_ed_op_6m=1 | ind_ED_adm_6m=1 then ind_ed_op_or_ip_6m=1;
if ind_ed_op_6m=0 & ind_ED_adm_6m=0 then ind_ed_op_or_ip_6m=0;
label ind_ed_op_or_ip_6m="Indicator any ED use 6m pre ivw";

/*criteria (A) serious medical illness and/or ADL impairment*/
if (ser_med_illness=1 | adl_impair=1) then criteria_a=1;
if (ser_med_illness=0 & adl_impair=0) then criteria_a=0;
label criteria_a="Crit A SMI and/or ADL impair";

/*indicator for serious medical illness and ADL impairment*/
if (ser_med_illness=1 & adl_impair=1) then smi_and_adl=1;
if (ser_med_illness=0 | adl_impair=0) then smi_and_adl=0;
label smi_and_adl="SMI and ADL impairment";

/*criteria (B) serious medical illness and/or ADL impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 | adl_impair=1) & (ind_em_ur_adm_6m=1 | smi_nh_ind=1) then criteria_b=1;
if (ser_med_illness=0 & adl_impair=0) | (ind_em_ur_adm_6m=0 & smi_nh_ind=0) then criteria_b=0;
label criteria_b="Crit B SMI or ADL impair and hospital admit or nh use";

/*criteria (C) serious medical illness and adl impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 & adl_impair=1) & (ind_em_ur_adm_6m=1 | smi_nh_ind=1) then criteria_c=1;
if (ser_med_illness=0 | adl_impair=0) | (ind_em_ur_adm_6m=0 & smi_nh_ind=0) then criteria_c=0;
label criteria_c="Crit C SMI and ADL impair and hospital admit or nh use";

/*serious medical illness criteria variable defined, so name matches format of other criteria indicators*/
criteria_smi=ser_med_illness;
label criteria_smi="Comparison criteria - SMI";

run;

/*export full dataset to Stata*/


proc export data=proj_int.serious_ill_int_dataset1
outfile="E:\nhats\data\projects\pal_perf_scale\int_data\serious_ill_int_dataset1.dta" replace;
run;

H="HCC"
libname hcc 'E:\nhats\data\Projects\pal_perf_scale\int_data\hcc';


data persa(keep=bene_id dob orec);
set medi.mbsf_06_14;
if year=2011;
dob=birth_date;
orec=BENE_ENTLMT_RSN_ORIG;
run;

option nofmterr;

data pers1 (keep=bene_id mcaid nemcaid sex);
set proj_int.serious_ill_int_dataset;
if bene_id~='' and wave=1;
sex=female+1;
mcaid=0<indexc(buyin_2y_r,"C","B","A")<=12;
nemcaid=mcaid=1 and indexc(substr(buyin_2y_r,13,12),"C","B","A")=0;
run;


proc sql;
create table person as select * from
pers1 a 
left join 
persa b
on a.bene_id=b.bene_id;
quit;

proc sort nodup data=person out=hcc.person;
by bene_id;
run;

data diag(keep=bene_id diag);
set proj_int.dx_0_1yr;
if index_year=2011;
run;

proc sort nodup data=diag out=hcc.diag;
by bene_id;
run;





 /*
    The following is JCL if you are using an IBM-type mainframe:

   //JOBCARD
   //V1210F1P EXEC SAS9,REGION=8M,
   // OPTIONS='ERRORS=0,NOCENTER,NEWS'
   //WORK  DD SPACE=(CYL,(1000,2))
   //WORK1   DD SPACE=(CYL,(2000,2))
   //* user-defined the location of formats
   //LIBRARY DD DISP=SHR,DSN=XXXX.XXXXXXX
   //*user-defined the location of macros
   //IN0 DD DISP=SHR,DSN=XXXX.XXXXXX
   //*the location of person-level file
   //IN1 DD DISP=SHR,DSN=XXXX.PERSON
   //*the location of the diagnosis file
   //IN2 DD DISP=SHR,DSN=XXXX.DIAG
   //*the location of the file containing all coefficients
   //INCOEF DD DISP=SHR,DSN=XXXX.HCCCOEFN
   //*the output file containing person-level scores
   //OUT DD DISP=(NEW,CATLG,KEEP),
   //    DSN=XXX.V1210F1P.PERSON,
   //    SPACE=(TRK,(20,10),RLSE)
   //SYSIN  DD *

   ******************************************************************
  If you are using PC-SAS, you must specify the location of the files
  on your PC in a libname/filename statement.
 */
  LIBNAME LIBRARY "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  FILENAME IN0 "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  LIBNAME  IN1 "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  LIBNAME  IN2 "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  LIBNAME  INCOEF "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  LIBNAME  OUT "E:\nhats\data\Projects\pal_perf_scale\int_data\";
 ***********************************************************************
 *
 *   DESCRIPTION:
 *
 * V1210F1P program creates seventy HCC variables (&CMSHCC) and four
 * score variables for each person who is present in a person file
 * supplied by a user.
 * If a person has at least one diagnosis in DIAG file (supplied by a
 * user) then HCC variables are created, otherwise HCCs are set to 0 .
 * Score variables are created using coefficients from 4 final models:
 * community, institutional, new enrollees, and SNP new enrollees.
 *
 * Assumptions about input files:
 *   - both files are sorted by person ID
 *
 *   - person level file has the following variables:
 *     :&IDVAR   - person ID variable (it is a macro parameter, HICNO
 *                 for Medicare data)
 *     :DOB      - date of birth
 *     :SEX      - sex
 *     :OREC     - original reason for entitlement
 *     :MCAID    - Medicaid dummy variable (base year)
 *     :NEMCAID  - Medicaid dummy variable for new enrollees (predicted
 *                 year)
 *
 *   - diagnosis level file has the following vars:
 *     :&IDVAR   - person ID variable (it is a macro parameter, HICNO
 *                 for Medicare data)
 *     :DIAG     - diagnosis
 *
 * The program supplies parameters to a main macro %V1210F1M that calls
 * other external macros:
 *
 *      %AGESEXNV  - create age/sex, originally disabled, disabled vars
 *      %EDITICD9  - perform edits to diagnosis
 *      %V12H70M   - assign one ICD9 to multiple CCs
 *      %V12H70L   - assign labels to HCCs
 *      %V12H70H   - set HCC=0 according to hierarchies
 *      %SCOREVAR  - calculate a score variable
 *
 *
 * Program steps:
 *         step1: include external macros
 *         step2: define internal macro variables
 *         step3: merge person and diagnosis files outputting one
 *                record per person for each input person level record
 *         step3.1: declaration section
 *         step3.2: bring regression coefficients
 *         step3.3: merge person and diagnosis file
 *         step3.4: for the first record for a person set CC to 0
 *                  and calculate age
 *         step3.5: if there are any diagnoses for a person
 *                  then do the following:
 *                   - create CC using format $I12101Y09Y10YC
 *                   - perform ICD9 edits using macro EDITICD9
 *                   - create additional CC using V12H70M macro
 *         step3.6: for the last record for a person do the
 *                  following:
 *                   - create demographic variables needed
 *                     for regressions (macro AGESEXNV)
 *                   - create HCC using hierarchies (macro V12H70H)
 *                   - create HCC interaction variables
 *                   - create HCC and DISABL interaction variables
 *                   - set HCCs and interaction vars to zero if there
 *                     are no diagnoses for a person
 *                   - create score for community model
 *                   - create score for institutional model
 *                   - create score for new enrollee model
 *                   - create score for SNP new enrollee model
 *                   - normalize score if needed
 *         step4: data checks and proc contents
 *
 *   USER CUSTOMIZATION:
 * A user must supply 2 files with the variables described above and
 * set the following parameters:
 *      INP      - SAS input person dataset
 *      IND      - SAS input diagnosis dataset
 *      OUTDATA  - SAS output dataset
 *      IDVAR    - name of person id variable (HICNO for medicare data)
 *      KEEPVAR  - variables to keep in the output dataset
 *      SEDITS   - a switch that controls whether to perform edits on 
 *                 ICD9. 1-YES, 0-NO
 *      DATE_ASOF- reference date to calculate age. Set to February 1 of 
 *                 the payment year for consistency with CMS. 
 *                 The default value in the code below is 1FEB2010.
 *      FMNAME   - format name (set to I12101Y09Y10YC by default)
 *      DF       - normalization factor (set to 1 by default)
 ***********************************************************************;

 %LET INPUTVARS=%STR(DOB MCAID NEMCAID OREC);

 %*demographic variables;
 %LET DEMVARS  =%STR(AGEF ORIGDS DISABL
                     F0_34  F35_44 F45_54 F55_59 F60_64 F65_69
                     F70_74 F75_79 F80_84 F85_89 F90_94 F95_GT
                     M0_34  M35_44 M45_54 M55_59 M60_64 M65_69
                     M70_74 M75_79 M80_84 M85_89 M90_94 M95_GT
                     NEF0_34  NEF35_44 NEF45_54 NEF55_59 NEF60_64
                     NEF65    NEF66    NEF67    NEF68    NEF69
                     NEF70_74 NEF75_79 NEF80_84 NEF85_89 NEF90_94
                     NEF95_GT
                     NEM0_34  NEM35_44 NEM45_54 NEM55_59 NEM60_64
                     NEM65    NEM66    NEM67    NEM68    NEM69
                     NEM70_74 NEM75_79 NEM80_84 NEM85_89 NEM90_94
                     NEM95_GT);

 %*list of HCCs included in models;
 %LET CMSHCC = %STR(
      HCC1      HCC2      HCC5     HCC7       HCC8
      HCC9      HCC10     HCC15    HCC16      HCC17
      HCC18     HCC19     HCC21    HCC25      HCC26
      HCC27     HCC31     HCC32    HCC33      HCC37
      HCC38     HCC44     HCC45    HCC51      HCC52
      HCC54     HCC55     HCC67    HCC68      HCC69
      HCC70     HCC71     HCC72    HCC73      HCC74
      HCC75     HCC77     HCC78    HCC79      HCC80
      HCC81     HCC82     HCC83    HCC92      HCC95
      HCC96     HCC100    HCC101   HCC104     HCC105
      HCC107    HCC108    HCC111   HCC112     HCC119
      HCC130    HCC131    HCC132   HCC148     HCC149
      HCC150    HCC154    HCC155   HCC157     HCC158
      HCC161    HCC177    HCC164   HCC174     HCC176);

 %*list of CCs that correspond to model HCCs;
 %LET CMSCC = %STR(
      CC1       CC2       CC5      CC7        CC8
      CC9       CC10      CC15     CC16       CC17
      CC18      CC19      CC21     CC25       CC26
      CC27      CC31      CC32     CC33       CC37
      CC38      CC44      CC45     CC51       CC52
      CC54      CC55      CC67     CC68       CC69
      CC70      CC71      CC72     CC73       CC74
      CC75      CC77      CC78     CC79       CC80
      CC81      CC82      CC83     CC92       CC95
      CC96      CC100     CC101    CC104      CC105
      CC107     CC108     CC111    CC112      CC119
      CC130     CC131     CC132    CC148      CC149
      CC150     CC154     CC155    CC157      CC158
      CC161     CC177     CC164    CC174      CC176);

 %LET SCOREVARS=%STR(SCORE_COMMUNITY
                     SCORE_INSTITUTIONAL
                     SCORE_NEW_ENROLLEE
                     SCORE_SNP_NEW_ENROLLEE);

 %* include main macro;
 %INCLUDE IN0(V1210F1M)/SOURCE2;

  %V1210F1M(INP      =IN1.PERSON,
            IND      =IN2.DIAG,
            OUTDATA  =OUT.PERSONout,
            IDVAR    =bene_id,
            KEEPVAR  =bene_id &SCOREVARS,
            SEDITS   =1,
            DATE_ASOF="1FEB2010"D);

proc export data=out.personout outfile="E:\nhats\data\Projects\pal_perf_scale\int_data\personout.dta" replace; run;

H="********"


H="Get community dwelling then check ffs"
/* Stata */

use "E:\nhats\data\Projects\serious_ill\final_data\serious_ill_nhats_sample.dta", replace

keep if community_dwelling
keep if wave<6
cap drop bene_id 

merge m:1 spid using "E:\nhats\data\20180625 NHATS CMS Data\merged\xwalk_2016.dta" 

keep if _m==3

save "E:\nhats\data\Projects\IAH\int_data\iah_fullsample.dta", replace

keep bene_id spid wave ivw_month ivw_year

saveold "E:\nhats\data\Projects\IAH\int_data\iah_ivwdates.dta", version(12) replace


/* SAS */

libname cms 'E:\nhats\data\20180625 NHATS CMS Data\merged';

proc import datafile="E:\nhats\data\Projects\IAH\int_data\iah_ivwdates.dta" out=ivdates(rename=(ivw_year = index_year)) dbms=stata replace; run;

data ivdates;
set ivdates;
index_year_n1 = index_year - 1;
bene_id = trim(left(bene_id));
run;

proc freq data=ivdates; tables ivw_month; run;

data mbsf;
set cms.mbsf_06_16;
hmoind12_n1 = hmoind12;
buyin12_n1 = buyin12;
bene_id = trim(left(bene_id));
run;



proc sql;
create table iv_mbsf as select a.*, b.hmoind12, b.buyin12
from ivdates a
inner join mbsf b
on a.index_year = b.year and a.bene_id = b.bene_id;
quit;

proc sql;
create table iv_mb1 as select a.*, b.hmoind12_n1, b.buyin12_n1
from iv_mbsf a 
inner join mbsf b
on a.index_year_n1 = b.year and a.bene_id = b.bene_id;
quit;


data iv_mb1;
set iv_mb1;
if length(trim(left(buyin12)))>=6 and ivw_month>0 then do;
buyin_sy=substr(trim(left(buyin12)),1,ivw_month); * creating buyin/hmo variable for the months before index date in same year;
hmo_sy=substr(trim(left(HMOIND12)),1,ivw_month);
end;
else do;
buyin_sy=trim(left(buyin12));
hmo_sy=trim(left(HMOIND12));
end;
run;

data iv_mb1;
set iv_mb1;
buyin_sy_r = left(reverse(buyin_sy));
hmo_sy_r = left(reverse(hmo_sy));
hmo_n1_r = left(reverse(hmoind12_n1));
buyin_n1_r = left(reverse(buyin12_n1));
run;

data iv_mb2;
set iv_mb1;
buyin_1y = trimn(left(buyin_sy_r))||trimn(left(buyin_n1_r));
hmo_1y = trimn(left(hmo_sy_r))||trimn(left(hmo_n1_r));
run;

data iv_mb2;
set iv_mb2;
buyin_6m = substr(buyin_1y,2,6);
hmo_6m = substr(hmo_1y,2,6);
part_ab_6m = 0;
hmo_no_6m = 0; 
ffs_6m = 0;
if indexc(buyin_6m,"0","1","2","A","B")=0 then part_ab_6m = 1;
if indexc(hmo_6m,"1","2","4","A","B","C")=0 then hmo_no_6m = 1;
if part_ab_6m = 1 and hmo_no_6m = 1 then ffs_6m = 1;
run;

proc export data=iv_mb2 (keep = spid wave ffs_6m) outfile="E:\nhats\data\Projects\IAH\int_data\iah_ffs.dta" dbms=stata replace; run;


H="Start with Serious Illness Data, restritct to waves 1-3"

use "E:\nhats\data\Projects\IAH\int_data\iah_fullsample.dta", clear

cap drop _merge

merge 1:1 spid wave using "E:\nhats\data\Projects\IAH\int_data\iah_ffs.dta", keepus(ffs_6m)
keep if _m==3

save "E:\nhats\data\Projects\IAH\final_data\iah_fullsample.dta", replace



local cvars sr_stroke_ever sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever sr_diabetes_ever sr_lung_dis_ever sr_dementia_ever

 
egen c_con = anycount(`cvars'), values(1)
gen cc_flag = 0
replace cc_flag = 1 if c_con>=2
label var cc_flag "2+ Chronic Conditions"
 
local avars adl_eat_help adl_bath_help adl_toil_help adl_dres_help adl_bed_help adl_ins_help
egen adl_con = anycount(`avars'), values(1)
gen adl_flag = 0
replace adl_flag = 1 if adl_con>=2 
label var adl_flag "2+ ADL Impairment"

gen homebound = 0
replace homebound = 1 if homebound_cat==1

gen homebound_never = 0
replace homebound_never = 1 if homebound_cat==2

rename cc_flag iah_chronic
rename adl_flag iah_adl
rename ind_nonelect_adm_12m iah_nonelect


save "E:\nhats\data\Projects\IAH\final_data\iah_wave1-5.dta", replace


keep if cc_flag
keep if adl_flag
keep if ind_nonelect_adm_12m // elective hospitalization in past year


H="Search for IP rehab and home calls"
libname claims "E:\nhats\data\20180625 NHATS CMS Data\merged";
libname cyears "E:\nhats\data\20180625 NHATS CMS Data\Cumulative";

proc import datafile="E:\nhats\data\Projects\IAH\final_data\iah_wave1-5.dta" out=iv_mb2 dbms=stata replace; run; 


/* Identifying Inpatient Rehab */

data ip_check (keep = bene_id index_date index_month year wave ffs_6m);
set iv_mb2;
run;


data inpatient;
set claims.ip_06_16;
run;

data ip_rev;
set cyears.inpatient_revenue_center_j_06_16;
run;

proc sql;
create table ip_clm_rev as select a.*, b.*
from inpatient a
inner join ip_rev b
on a.bene_id = b.bene_id and a.clm_id = b.clm_id;
quit;

proc freq data=inpatient; tables PTNT_DSCHRG_STUS_CD; run;
proc freq data=ip_rev; tables REV_CNTR_UNIT_CNT; run;
 

data ip_clm_rev;
set ip_clm_rev;
disch_rehab = 0;
ip_rehab = 0;
if PTNT_DSCHRG_STUS_CD='62' or PTNT_DSCHRG_STUS_CD='90' then disch_rehab = 1;
if REV_CNTR_UNIT_CNT = 24 then ip_rehab = 1;
run;


proc freq data=ip_clm_rev; tables disch_rehab; run;
proc freq data=ip_clm_rev; tables ip_rehab; run;


data disch_2_iprehab;
set ip_clm_rev;
where disch_rehab = 1;
run;

data ip_rehab;
set ip_clm_rev;
where ip_rehab = 1;
run;


data test;
set disch_2_iprehab ip_rehab;
run;


proc sort data=test nodupkey; by bene_id admit_date; run;


proc sql;
create table ip_restays as select a.*, b.admit_date, b.disch_date
from ip_check a
inner join test b
on a.bene_id = b.bene_id and 0 < a.index_date-b.admit_date <365;
quit;

proc sort data=ip_restays out=ip_rehabstays nodupkey; by bene_id index_date; run;

data ip_rehabstays;
set ip_rehabstays;
ip_rehab = 1;
run;

/* Checking for HH/SNF within 7 days of disch_date */

data homehealth;
set claims.hh_09_16;
run;

data snf;
set claims.snf_09_16;
run;

proc sql;
create table hh_nhats as select a.*, b.*
from ip_check a
inner join homehealth b
on a.bene_id = b.bene_id
where 0 < a.index_date - b.disch_date < 365;
quit;

data hh_nhats_short (keep = bene_id index_date admit_date disch_date hh);
set hh_nhats;
hh = 1;
run;

proc sql;
create table snf_nhats as select a.*, b.*
from ip_check a
inner join snf b
on a.bene_id = b.bene_id
where 0 <a.index_date - b.disch_date < 365;
quit;

data snf_nhats_short (keep = bene_id index_date admit_date disch_date snf);
set snf_nhats;
snf = 1;
run;

data rehab (rename=(admit_date = rehab_admit disch_date = rehab_disch));
set snf_nhats_short hh_nhats_short;
*format rehab_admit rehab_disch date10.;
run;

proc sql;
create table ip1 as select a.admit_date, a.disch_date, b.*
from inpatient a
inner join rehab b
on a.bene_id = b.bene_id
where 0 <= b.rehab_admit-a.disch_date < 8;
quit;

data ip1;
set ip1 ip_rehabstays;
run;

proc sort data=ip1; by bene_id index_date; run;
proc sort data=ip1 nodupkey; by bene_id index_date; run;

proc freq data=ip1; tables ip_rehab; run;

proc export data=ip1 outfile="E:\nhats\data\Projects\IAH\final_data\iah_rehab_flag.dta" replace; run;


/* Checking Nursing home enrollment on a monthly basis */

data snf_sheet;
set snf;
month = month(admit_date);
year = year(admit_date);
snf_stay = 1;
run;


data snf_sheet;
set snf_sheet;
m_1 = 0;
m_2 = 0;
m_3 = 0;
m_4 = 0;
m_5 = 0;
m_6 = 0;
m_7 = 0;
m_8 = 0;
m_9 = 0;
m_10 = 0;
m_11 = 0;
m_12 = 0;
if month = 1 then m_1 = 1;
if month = 2 then m_2 = 1;
if month = 3 then m_3 = 1;
if month = 4 then m_4 = 1;
if month = 5 then m_5 = 1;
if month = 6 then m_6 = 1;
if month = 7 then m_7 = 1;
if month = 8 then m_8 = 1;
if month = 9 then m_9 = 1;
if month = 10 then m_10 = 1;
if month = 11 then m_11 = 1;
if month = 12 then m_12 = 1;
run;

proc sql;
create table snf_st as
select distinct bene_id, year,
sum(m_1) as Jan,
sum(m_2) as Feb,
sum(m_3) as Mar,
sum(m_4) as Apr,
sum(m_5) as May,
sum(m_6) as Jun,
sum(m_7) as Jul,
sum(m_8) as Aug,
sum(m_9) as Sep,
sum(m_10) as Oct,
sum(m_11) as Nov,
sum(m_12) as Dec
from snf_sheet
group by bene_id, year;
quit;

data snf_st;
set snf_st;
array list Jan--Dec;
do over list;
if list > 0 then list = 1;
end;
run;

data snf_st;
set snf_st;
snf_months = trim(left(Jan))||trim(left(Feb))||trim(left(Mar))||trim(left(Apr))||trim(left(May))||trim(left(Jun))||trim(left(Jul))||trim(left(Aug))
||trim(left(Sep))||trim(left(Oct))||trim(left(Nov))||trim(left(Dec));
snf_months_n1 = snf_months;
run;


proc sql;
create table snf_ind as select a.*, b.index_month
from snf_st a
inner join ip_check b
on a.bene_id=b.bene_id and a.year=b.year;
quit;

data snf_ind (drop = snf_months_n1);
set snf_ind;
run;

proc sql;
create table snf_index as select a.*, b.snf_months_n1 
from snf_ind a
left join snf_st b
on a.bene_id=b.bene_id and a.year = b.year-1;
quit;

data snf_index;
set snf_index;
months_post = substr(snf_months,index_month,12);
snf_n1 = trim(left(reverse(snf_months_n1)));
run;

data snf_index;
set snf_index;
snf_1m = substr(snf_n1,1,1);
snf_s = trim(left(months_post))||trim(left(snf_n1));
run;

data snf_index;
set snf_index;
snf_m = substr(snf_s,1,3);
snf_3m = 0;
if indexc(snf_m,"0")=0 then snf_3m = 1;
run;


proc export data=snf_index (keep = bene_id year snf_3m) outfile="E:\nhats\data\Projects\IAH\final_data\snf_flag.dta" dbms=stata replace; run; 

proc contents data=claims.pb_09_16; run;


/* Identifying house calls */

data carrier;
set claims.pb_09_16;
array dx hcpcscd1--hcpcscd13;
do over dx;
hcpcs_cd=dx;
output;
end;
run;

data carrier1;
set carrier;
cptcodes1 = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrier1;
set carrier1;
cpt1flag = 0;
if 99341<=cptcodes1<=99350 or 99324<=cptcodes1<=99328 or 99334<=cptcodes1<=99337 then cpt1flag = 1;
run;

proc sort data=carrier1 nodupkey; by bene_id clm_id; run;

data carrierline (keep = bene_id clm_id LINE_PLACE_OF_SRVC_CD cptcodes);
set cyears.bcarrier_line_j_09_16;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrierline;
set carrierline;
cptflag = 0;
posflag = 0;
if 99341<=cptcodes<=99350 or 99324<=cptcodes<=99328 or 99334<=cptcodes<=99337 then cptflag=1;
if LINE_PLACE_OF_SRVC_CD in:(12,13,14) then posflag=1;
run;

data linecalls;
set carrierline;
where cptflag = 1 or posflag = 1;
run;

proc sql;
create table carrier2 as select a.*, b.*
from carrier1 a
full outer join linecalls b
on a.bene_id=b.bene_id and a.clm_id = b.clm_id;
quit;

data carrier2;
set carrier2;
where cptflag = 1 and posflag = 1;
year = year(admit_date);
run;

proc sort data=carrier2 nodupkey; by bene_id clm_id; run;

proc sql;
create table annual as select distinct bene_id, year,
sum(posflag) as housecalls_count
from carrier2
group by bene_id, year;
quit;


proc export data=annual outfile="E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta" replace; run;

proc sql;
create table homecallsb4_90 as select a.*, b.cptcodes
from ip_check a
inner join carrier2 b
on a.bene_id=b.bene_id and -90<a.index_date-b.admit_date<=90;
quit;


proc sort data=homecallsb4_90 nodupkey; by descending wave bene_id; run;
proc sort data=homecallsb4_90 nodupkey; by bene_id; run;

proc freq data=homecallsb4_90; tables ffs_6m; run;

proc sql;
create table homecallsb4_180 as select a.*, b.cptcodes
from ip_check a
inner join carrier2 b
on a.bene_id=b.bene_id and -180<a.index_date-b.admit_date<=180;
quit;

/*
proc sql;
create table homecallsafter as select a.*, b.cptcodes
from ip_check a
inner join carrier2 b
on a.bene_id=b.bene_id and 0<b.admit_date-a.index_date<=365;
quit;
*/
proc sort data=homecallsb4_90 out=test; by descending wave bene_id; run;






proc sort data=homecallsb4_180; by bene_id wave; run;


/*
%macro homecallsb4(wave=,days=);

data homecallsb4_&days._&wave.;
set homecallsb4_&days.;
by bene_id;
where wave = &wave.;
*cnt + 1;
if first.bene_id then cnt = 1;
run;

data homecallsb4_&days._&wave.;
set homecallsb4_&wave.;
*where cnt = 1; 
run;

%mend;


%homecallsb4(wave=1, days=90);
%homecallsb4(wave=2, days=90);
%homecallsb4(wave=3, days=90);
%homecallsb4(wave=4, days=90);
%homecallsb4(wave=5, days=90);

%homecallsb4(wave=1, days=180);
%homecallsb4(wave=2, days=180);
%homecallsb4(wave=3, days=180);
%homecallsb4(wave=4, days=180);
%homecallsb4(wave=5, days=180);

*/

data homecalls_90;
set homecallsb4_90_1 homecallsb4_90_2 homecallsb4_90_3 homecallsb4_90_4 homecallsb4_90_5;
run;


data homecalls_180;
set homecallsb4_180_1 homecallsb4_180_2 homecallsb4_180_3 homecallsb4_180_4 homecallsb4_180_5;
run;

proc export data=homecalls_90 outfile="E:\nhats\data\Projects\IAH\int_data\homecalls_90.dta" replace; run;

proc export data=homecalls_180 outfile="E:\nhats\data\Projects\IAH\int_data\homecalls_180.dta" replace; run;


%macro homecallsafter(wave=);

data homecallsafter_&wave.;
set homecallsafter;
by bene_id;
where wave = &wave.;
cnt + 1;
if first.bene_id then cnt = 1;
run;

data homecallsafter_&wave.;
set homecallsafter_&wave.;
where cnt = 2; 
run;
%mend;

%homecallsafter(wave=1);
%homecallsafter(wave=2);
%homecallsafter(wave=3);
%homecallsafter(wave=4);
%homecallsafter(wave=5);


data homecallsafter_all;
set homecallsafter_1 homecallsafter_2 homecallsafter_3 homecallsafter_4 homecallsafter_5;
run;

proc export data=homecallsafter_all outfile="E:\nhats\data\Projects\IAH\int_data\homecallsafter.dta" replace; run;


H="Home calls - version 2"
libname claims "E:\nhats\data\CMS_DUA_28016\Merged";
libname line "E:\nhats\data\CMS_DUA_28016\Cumulative Years";
libname cyears "E:\nhats\data\CMS_DUA_28016\Cumulative Years";

proc import datafile="E:\nhats\data\Projects\IAH\final_data\IAH_final_sample_old.dta" out=nhats replace; run; 

data nhats (keep = spid bene_id wave ffs_6m index_date);
set nhats;
run;

/*
data carrier_pflag;
set claims.pb_09_14;
pos1flag = 0;
array dx pos1--pos13;
do over dx;
if dx in:(12,13,14) then pos1flag = 1;
output;
end;
run;

*/

data carrier;
set claims.pb_09_14;
array dx hcpcscd1--hcpcscd13;
do over dx;
cptcodes=dx;
output;
end;
/*
pos1flag = 0;
if pos1 in:(12,13,14) then pos1flag = 1;
if pos2 in:(12,13,14) then pos1flag = 1;
if pos3 in:(12,13,14) then pos1flag = 1;
if pos4 in:(12,13,14) then pos1flag = 1;
if pos5 in:(12,13,14) then pos1flag = 1;
if pos6 in:(12,13,14) then pos1flag = 1;
if pos7 in:(12,13,14) then pos1flag = 1;
if pos8 in:(12,13,14) then pos1flag = 1;
if pos9 in:(12,13,14) then pos1flag = 1;
if pos10 in:(12,13,14) then pos1flag = 1;
if pos11 in:(12,13,14) then pos1flag = 1;
if pos12 in:(12,13,14) then pos1flag = 1;
if pos13 in:(12,13,14) then pos1flag = 1;
*/
run;


data carrierline (keep = bene_id clm_id LINE_PLACE_OF_SRVC_CD cptcodes hcpcs_cd);
set line.bcarrier_line_j_09_14;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrierline;
set carrierline;
cptflag = 0;
posflag = 0;
if 99341<=cptcodes<=99350 or 99324<=cptcodes<=99328 or 99334<=cptcodes<=99337 then cptflag=1;
if LINE_PLACE_OF_SRVC_CD in:(12,13,14) then posflag=1;
run;

data carrierline;
set carrierline;
both = 0;
if cptflag = 1 and posflag = 1 then both = 1;
run;


proc sql;
create table carrier2 as select a.*, b.admit_date, b.disch_date
from carrierline a
inner join carrier b
on a.bene_id=b.bene_id and a.clm_id=b.clm_id;
quit;

proc sql;
create table carrier3 as select a.*, b.*
from carrier2 a
inner join nhats b
on a.bene_id=b.bene_id and -90<=b.index_date-a.admit_date<=90;
quit;


data carrier3;
set carrier3;
where ffs_6m = 1;
run;

proc freq data=carrierline; tables cptflag posflag both; run;

/* both */

data bothclaims;
set carrier3;
where both = 1;
same = 0;
if hcpcs_cd = cptcodes then same = 1; /*checking if the cptcodes from from carrier claims is the same as the hcpcs_cd code in carrier line */
run;

proc sort data=bothclaims nodupkey; by bene_id clm_id hcpcs_cd; run;

/* gen single line per claim for annual count */

proc sort data=bothclaims out=annual nodupkey; by bene_id clm_id; run;

data annual;
set annual;
year = year(admit_date);
run;

proc sql;
create table annual_1 as select distinct bene_id, year,
sum(both) as housecalls_count
from annual
group by bene_id, year;
quit;

data annual_1;
set annual_1;
if year = 2011 then wave = 1;
if year = 2012 then wave = 2;
if year = 2013 then wave = 3;
run;

proc export data=annual_1 outfile="E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta" dbms=stata replace; run;

proc freq data=bothclaims order=freq; tables hcpcs_cd; run;

proc sort data=bothclaims nodupkey; by bene_id wave; run;


data both_beneid (keep= bene_id wave bflag);
set bothclaims;
bflag = 1;
run;

proc freq data=both_beneid; tables wave; run;

proc export data=both_beneid outfile="E:\nhats\data\Projects\IAH\int_data\cpt+pos.dta" replace; run;

proc sort data=both_beneid out=test nodupkey; by bene_id; run;


/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.bflag
from cptclaims a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if bflag = 1 then delete;
cflag = 1;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;
proc sort data=cptclaims out=test nodupkey; by bene_id; run;

proc export data=cptclaims outfile="E:\nhats\data\Projects\IAH\int_data\cpt+only.dta" replace; run;


/*pos only */

data posclaims;
set carrier3;
where posflag = 1 and both=0;
run;

proc sql;
create table posclaims1 as select a.*, b.cflag
from posclaims a
left join cptclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

proc sql;
create table posclaims2 as select a.*, b.bflag
from posclaims1 a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data posclaims;
set posclaims2;
if cflag = 1 or bflag = 1 then delete;
run;



proc sort data=posclaims nodupkey; by bene_id clm_id hcpcs_cd; run;
proc freq data=posclaims order=freq; tables hcpcs_cd; run;

 
proc sort data=posclaims nodupkey; by bene_id wave; run;

proc freq data=posclaims; tables wave; run;


proc sort data=posclaims nodupkey; by bene_id; run;


proc export data=posclaims outfile="E:\nhats\data\Projects\IAH\int_data\pos+only.dta" replace; run;





















/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.pflag
from cptclaims a
left join posclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if pflag = 1 then delete;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;

/* none */

data noclaims;
set carrier3;
where cpt


data carrier2 (keep = cptcodes hcpcs_cd) ;
set carrier2;
where posflag = 1 or pos1flag = 1;
run;

data carrier2 (keep = hcpcs_cd);
set carrier2;
run;
*/

proc sort data=carrier2 nodup; by hcpcs_cd; run;


proc export data=carrier2 outfile="E:\nhats\projects\IAH\20171115\cptcodes.xlsx" dbms=xlsx replace; run;


H="Get life sustaining procedures"
libname proj_int 'E:\nhats\data\projects\pal_perf_scale\int_data';

data ip_365 (drop=hcpcscd1--hcpcscd45);
set proj_int.ip_meet_365;
array list ICD_PRCDR_CD1-ICD_PRCDR_CD25;
array date PRCDR_DT1-PRCDR_DT25;
do over list;
if list ~="" then do;
pro=list+0;
procedure_date = date;
output;
end;
end;
format procedure_date date10.;
run;

data proc_long_ba;
set ip_365;
array list 
pre_intubation
pre_trach
pre_gastro_tude
pre_hemodia
pre_enteral_nut
pre_cpr;
do over list;
list=0;
end;

if length(trim(left(pro)))>=3 then do;

	if  substr(trim(left(pro)),1,3) in ("967")  then pre_intubation =1;
	if  substr(trim(left(pro)),1,3) in ("311") then  pre_trach=1;
	if  substr(trim(left(pro)),1,3) in ("432") then  pre_gastro_tude=1;

	if substr(trim(left(pro)),1,3) in ("966") then  pre_enteral_nut=1;

	if length(trim(left(pro)))>3 then do;
		if substr(trim(left(pro)),1,4) in ("9604","9605") or 
		  substr(trim(left(pro)),1,3) in ("967") then pre_intubation =1;
		if substr(trim(left(pro)),1,4) in ("3121","3129") or 
		  substr(trim(left(pro)),1,3) in ("311") then pre_trach=1;
		if substr(trim(left(pro)),1,4) in ("4311","4319","4432")  or 
		  substr(trim(left(pro)),1,3) in ("432") then pre_gastro_tude=1;
		if substr(trim(left(pro)),1,4) in ("3995") then pre_hemodia=1;
		if substr(trim(left(pro)),1,4) in ("9915") or 
		  substr(trim(left(pro)),1,3) in ("966") then pre_enteral_nut=1;
		if substr(trim(left(pro)),1,4) in ("9960","9963") then pre_cpr=1;
	end;

end;

if pre_intubation|
pre_trach|
pre_gastro_tude|
pre_hemodia|
pre_enteral_nut|
pre_cpr then date_proc=procedure_date;
run;

data proc_list;
set proc_long_ba;
where pre_intubation = 1 or pre_trach = 1 or pre_gastro_tude = 1 or pre_enteral_nut = 1 or pre_cpr = 1;
if procedure_date = . then procedure_date = admit_date;
run;

data proc_12 (keep = bene_id index_year pre_intubation pre_trach pre_gastro_tude pre_enteral_nut pre_cpr proc_12m proc_6m);
set proc_list;
proc_12m = 1;
proc_6m = 0;
if index_date - procedure_date<=183 then proc_6m = 1;
where index_date - procedure_date<=365;
run;

data proc_12;
set proc_12;
label pre_intubation = "intubation/mechanic ventilation pre ivw";
label pre_trach = "trachostomy pre ivw";
label pre_gastro_tude = "gastrostomy tube pre ivw";
label pre_enteral_nut = "enteral/parenteral nutrition pre ivw";
label pre_cpr = "CPR pre ivw";
label proc_12m = "Had 1 or more life saving procedure 12m pre ivw";
label proc_6m = "Had 1 or more life saving procedure 6m pre ivw";
run;

proc export data=proc_12 outfile="E:\nhats\data\Projects\IAH\int_data\life_proc_12.dta" replace; run;


data ip_365_post (drop=hcpcscd1--hcpcscd45);
set proj_int.ip_meet_365p;
array list ICD_PRCDR_CD1-ICD_PRCDR_CD25;
array date PRCDR_DT1-PRCDR_DT25;
do over list;
if list ~="" then do;
pro=list+0;
procedure_date = date;
output;
end;
end;
format procedure_date date10.;
run;

data proc_post;
set ip_365_post;
array list 
post_intubation
post_trach
post_gastro_tude
post_hemodia
post_enteral_nut
post_cpr;
do over list;
list=0;
end;

if length(trim(left(pro)))>=3 then do;

	if  substr(trim(left(pro)),1,3) in ("967")  then post_intubation =1;
	if  substr(trim(left(pro)),1,3) in ("311") then  post_trach=1;
	if  substr(trim(left(pro)),1,3) in ("432") then  post_gastro_tude=1;

	if substr(trim(left(pro)),1,3) in ("966") then  post_enteral_nut=1;

	if length(trim(left(pro)))>3 then do;
		if substr(trim(left(pro)),1,4) in ("9604","9605") or 
		  substr(trim(left(pro)),1,3) in ("967") then post_intubation =1;
		if substr(trim(left(pro)),1,4) in ("3121","3129") or 
		  substr(trim(left(pro)),1,3) in ("311") then post_trach=1;
		if substr(trim(left(pro)),1,4) in ("4311","4319","4432")  or 
		  substr(trim(left(pro)),1,3) in ("432") then post_gastro_tude=1;
		if substr(trim(left(pro)),1,4) in ("3995") then post_hemodia=1;
		if substr(trim(left(pro)),1,4) in ("9915") or 
		  substr(trim(left(pro)),1,3) in ("966") then post_enteral_nut=1;
		if substr(trim(left(pro)),1,4) in ("9960","9963") then post_cpr=1;
	end;

end;

if post_intubation|
post_trach|
post_gastro_tude|
post_hemodia|
post_enteral_nut|
post_cpr then date_proc=procedure_date;
run;

data proc_list_post;
set proc_post;
where post_intubation = 1 or post_trach = 1 or post_gastro_tude = 1 or post_enteral_nut = 1 or post_cpr = 1;
if procedure_date = . then procedure_date = admit_date;
run;

data proc_p12 (keep = bene_id index_year post_intubation post_trach post_gastro_tude post_enteral_nut post_cpr proc_p12m proc_p6m);
set proc_list_post;
proc_p12m = 1;
proc_p6m = 0;
if procedure_date - index_date<=183 then proc_p6m = 1;
run;

data proc_p12;
set proc_p12;
label post_intubation = "intubation/mechanic ventilation post ivw";
label post_trach = "trachostomy post ivw";
label post_gastro_tude = "gastrostomy tube post ivw";
label post_enteral_nut = "enteral/parenteral nutrition post ivw";
label post_cpr = "CPR post ivw";
label proc_p12m = "Had 1 or more life saving procedure 12m post ivw";
label proc_p6m = "Had 1 or more life saving procedure 6m post ivw";
run;


proc export data=proc_p12 outfile="E:\nhats\data\Projects\IAH\int_data\life_proc_p12.dta" replace; run;


H="Get hospice indicator + LOS"
/*Get claims 1 year and 2 year before each interview*/
/*Step 2: pull claims lists using xwalk and ivw date*/

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;


libname medi 'E:\nhats\data\cms_DUA_28016\merged';

proc import datafile="E:\nhats\data\Projects\IAH\int_data\death_datesw1_3.dta" out=index replace; run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/
%macro claims_pre(days_start=,days_bef_index=,yrs=,source=);

proc sql;
create table &source._meet_&days_bef_index. as select a.index_date,b.*
from index a inner join
medi.&source._&yrs. b 
on trim(left(a.bene_id))=trim(left(b.bene_id))
and &days_start<=a.index_date-b.admit_date<=&days_bef_index;
quit;

%mend;


%claims_pre(days_start=0,days_bef_index=730,yrs=09_14,source=hs);




/*hs*/
%macro hs_drop(days_bef_index=);
data hs_meet_&days_bef_index.;
set hs_meet_&days_bef_index.(keep=bene_id index_date admit_date disch_date);
run;
%mend hs_drop;


%hs_drop(days_bef_index=730);

proc sort data=hs_meet_730; by bene_id admit_date; run;

proc sort data=hs_meet_730 out=hospice nodupkey; by bene_id admit_date disch_date; run;

data hospice;
set hospice;
diff = disch_date - admit_date;
run;

proc sql;
create table hospice1 as select distinct bene_id,
sum(diff) as n_hs_days
from hospice
group by bene_id;
quit;

proc freq data=hospice1; tables n_hs_days; run;

data test; /*examine outliers with >365 hospice days prior to death */
set hospice;
where bene_id="eeeeeee6OMeqOMY";
run;

data hospice1;
set hospice1;
label n_hs_days = "Number of hospice days before death";
run;

proc export data=hospice1 outfile="E:\nhats\data\Projects\IAH\int_data\hospice_death.dta" replace; run;


H="Merging it together"
use "E:\nhats\data\Projects\IAH\final_data\iah_wave1-3.dta", clear

cap drop _m
merge 1:1 bene_id index_date using "E:\nhats\data\Projects\IAH\int_data\iah_rehab_flag.dta", keepus(snf hh ip_rehab)

rename snf snf_rehab
rename hh hh_rehab

foreach x of varlist snf_rehab hh_rehab ip_rehab {

replace `x' = 0 if `x'==.
}

gen iah_pacute = 0
replace iah_pacute = 1 if snf_rehab==1 | hh_rehab==1 | ip_rehab==1

gen iah_all = 0
replace iah_all = 1 if iah_chronic==1 & iah_adl==1 & iah_nonelect==1 & iah_pacute==1

/*
cap drop _m
merge 1:1 bene_id index_year using "E:\nhats\data\Projects\IAH\int_data\hospice_pre.dta" 
drop if _m==2
cap drop _m

foreach x of varlist n_hs_days_12m ind_hs_use_12m n_hs_days_6m ind_hs_use_6m {

replace `x'=0 if `x'==.
}

merge 1:1 bene_id index_year using "E:\nhats\data\Projects\IAH\int_data\hospice_post.dta" 
drop if _m==2
cap drop _m

foreach x of varlist n_hs_days_p12m ind_hs_use_p12m n_hs_days_p6m ind_hs_use_p6m {
replace `x'=0 if `x'==.
}
*/
save "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta" , replace


use "E:\nhats\data\Projects\IAH\int_data\life_proc_12.dta", clear
collapse (max) pre_intubation pre_trach pre_gastro_tude pre_enteral_nut pre_cpr proc_12m proc_6m, by(bene_id index_year)
label var pre_intubation "intubation/mechanic ventilation pre ivw"
label var pre_trach "trachostomy pre ivw"
label var pre_gastro_tude "gastrostomy tube pre ivw"
label var pre_enteral_nut "enteral/parenteral nutrition pre ivw"
label var pre_cpr "CPR pre ivw"
label var proc_12m "Had 1 or more life saving procedure 12m pre ivw"
label var proc_6m "Had 1 or more life saving procedure 6m pre ivw"

save "E:\nhats\data\Projects\IAH\int_data\life_proc_12.dta", replace


use "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta", clear

cap drop _m
merge 1:1 bene_id index_year using "E:\nhats\data\Projects\IAH\int_data\life_proc_12.dta" 
drop if _m==2

foreach x of varlist pre_intubation pre_trach pre_gastro_tude pre_enteral_nut pre_cpr proc_12m proc_6m {
replace `x' = 0 if `x'==.
}

cap drop _m

save "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta", replace
use "E:\nhats\data\Projects\IAH\int_data\life_proc_p12.dta", clear
 
collapse (max) post_intubation post_trach post_gastro_tude post_enteral_nut post_cpr proc_p12m proc_p6m, by(bene_id index_year)
label var post_intubation "intubation/mechanic ventilation post ivw"
label var post_trach "trachostomy post ivw"
label var post_gastro_tude "gastrostomy tube post ivw"
label var post_enteral_nut "enteral/parenteral nutrition post ivw"
label var post_cpr "CPR post ivw"
label var proc_p12m "Had 1 or more life saving procedure 12m post ivw"
label var proc_p6m "Had 1 or more life saving procedure 6m post ivw"
save "E:\nhats\data\Projects\IAH\int_data\life_proc_p12.dta", replace
use "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta", clear
merge 1:1 bene_id index_year using "E:\nhats\data\Projects\IAH\int_data\life_proc_p12.dta" 
drop if _m==2

foreach x of varlist post_intubation post_trach post_gastro_tude post_enteral_nut post_cpr proc_p12m proc_p6m {
replace `x' = 0 if `x'==.
}

save "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta", replace

label var iah_pacute "Post Acute Care 12m prior"

cap drop _m

merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\homecallsb4.dta", keepus(cnt)

gen homecallsb4 = 0
replace homecallsb4 = 1 if _m==3

cap drop _m

merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\homecallsafter.dta", keepus(cnt)

gen homecallsafter = 0
replace homecallsafter = 1 if _m==3

save "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta", replace

cap drop _m
merge m:1 bene_id using "E:\nhats\data\Projects\IAH\int_data\hospice_death.dta", keepus(n_hs_days)

save "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta", replace

use "E:\nhats\data\Projects\serious_ill\final_data\serious_ill_nhats_sample.dta", replace

keep if nhres 
keep spid wave nhres

rename nhres nhres_nw
label var nhres_nw "Nursing Home Resident Next Wave"

replace wave = wave - 1

save "E:\nhats\data\Projects\IAH\int_data\nhres_nw.dta", replace

use "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta", clear

cap drop _m

merge 1:1 spid wave using "E:\nhats\data\Projects\IAH\int_data\nhres_nw.dta", keepus(nhres_nw)
drop if _m==2

cap drop _m
merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\hcc_scores.dta"
keep if _m==3

replace n_hs_days = 1 if n_hs_days==0


save "E:\nhats\data\Projects\IAH\final_data\IAH_final_sample.dta", replace

local p12m icu_days_p12m ind_ed_adm_p12m ind_ed_op_p12m ind_ed_vis_p12m ind_elect_adm_p12m ///
ind_em_adm_p12m ind_em_ur_adm_p12m ind_hosp_adm_p12m ind_hs_p12m ind_icu_p12m ///
ind_nonelect_adm_p12m ind_snf_use_p12m ind_ur_adm_p12m mult_ed_vis_p12m mult_ip_adm_p12m ///
n_ed_ip_p12m n_ed_op_visits_p12m n_ed_vis_p12m n_elect_admit_p12m n_em_admit_p12m ///
n_em_urgent_admit_p12m n_hospd_p12m n_ip_admit_p12m n_nonelect_adm_p12m n_snf_days_p12m ///
n_urgent_admit_p12m proc_p12m

foreach x of local p12m { 

gen `x'_death = 0
replace `x'_death = `x' if died_12==1

}


H="IAH Table 1"
use "E:\nhats\nhats_code\IAH\Archive\unique_nocptpos.dta", clear 

cap drop _m
merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\cpt+pos.dta", keepus(bflag)
cap drop _m
merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\cpt+only.dta", keepus(cflag)
cap drop _m
merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\pos+only.dta", keepus(posflag)
drop homebound*
/*
preserve
capture gen none = 1
replace none =0 if bflag==1 | cflag==1 |posflag==1

keep if community_dwelling==1 & ffs_6m==1

replace ind_snf_use_p12m = 0 if ind_snf_use_p12m==.

capture gen ind_icu_p12m = 0
replace ind_icu_p12m = 1 if icu_days_p12m>0
label var ind_icu_p12m "ICU use 12m post ivw"

label var iah_adl "IAH - 2+ ADL Impairment"
label var iah_chronic "IAH - 2+ Chronic Conditions"
label var iah_nonelect "IAH - Nonelective admission 12m pre ivw"
label var iah_pacute "IAH - Post Acute Care 12m prior"

label var tot_paid_by_mc_12m "Total Paid by Medicare 12m post ivw"
label var died_12 "Died within 12m post ivw"

local sr_con adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help adl_bed_diff
foreach x of local sr_con {
tab `x'
replace `x' = 0 if `x'==.
}

label var adl_ins_diff "Difficulty getting around inside"
label var adl_bed_diff "Difficulty getting out of bed"
label var iah_all "IAH - All Criteria Met"
label var adl_eat_diff "Difficulting Eating"
label var adl_bath_diff "Difficulty bathing"
label var adl_dres_diff "Has Difficulty Dressing"

capture egen recent_yr = max(index_year), by(bene_id)

keep if recent_yr==index_year

save unique_nocptpos.dta, replace 

append using cpt+pos.dta
capture gen ind_cpt = 1

keep bene_id wave ind_cpt 

save cpt+pos.dta, replace

restore, preserve
*/
capture gen northeast = 0
replace northeast = 1 if re1dcensdiv==1 | re1dcensdiv==2 | re2dcensdiv==1 | re2dcensdiv==2 | re3dcensdiv==1 | re3dcensdiv==2

capture gen midwest = 0
replace midwest = 1 if re1dcensdiv==3 | re1dcensdiv==4 | re2dcensdiv==3 | re2dcensdiv==4 | re3dcensdiv==3 | re3dcensdiv==4

capture gen west = 0
replace west = 1 if re1dcensdiv==8 | re1dcensdiv==9 | re2dcensdiv==8 | re2dcensdiv==9 | re3dcensdiv==8 | re3dcensdiv==9

capture gen south = 0
replace south = 1 if northeast==0 & west==0 & midwest==0

cap drop _m
*merge m:1 bene_id using cpt+pos.dta, keepus(ind_cpt)

cap drop _m

merge 1:1 bene_id wave using "E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta"
drop if _m==2
label var housecalls_count "Ave. number of house calls in calendar year of interview"

replace housecalls_count = 0 if housecalls_count==.

cap drop _m
drop adl_bed_diff adl_ins_diff
cap drop _m
merge m:1 spid wave using "E:\nhats\data\NHATS cleaned\sp_round_1_6_public_sens_only.dta", keepus(homebound* adl_bed_diff adl_ins_diff) 
keep if _m==3

cap drop _m
drop anfinwgt

merge 1:1 spid using "E:\nhats\data\NHATS cleaned\wave1.dta", keepus(anfinwgt)
keep if _m==3

levelsof homebound_cat, local(levels)
local hb
foreach l of local levels {
	gen homebound`l'=homebound_cat==`l'
	local lab : label hb `l'
	label var homebound`l' "`lab'"
	local hb `hb' homebound`l'
}

svyset varunit [pweight=anfinwgt], strata(varstrat)

label var adl_bed_diff "Difficulty getting out of bed"
label var adl_ins_diff "Difficulty getting around inside"
gen ind_one_hc=housecalls_count==1
gen ind_no_hc=housecalls_count==0
label var ind_no_hc "No housecalls"
gen ind_lt3_hc=inlist(housecalls_count,1,2)
gen ind_gt2_hc=inrange(housecalls_count,3,365)
label var ind_one_hc "Exactly one housecall"
label var ind_lt3_hc "1 or 2 housecalls"
label var ind_gt2_hc "3+ Housecalls"
local cvars1 age aveincome
local ivars1 female white black hisp married livealone rcfres educ_hs_ind reg_doc_have reg_doc_seen ///
`hb' medicaid metro_ind northeast midwest south west
local ivars2 iah_adl iah_chronic iah_nonelect iah_pacute iah_all sr_ami_ever sr_stroke_ever ///
sr_cancer_ever sr_hip_ever sr_heart_dis_ever sr_htn_ever sr_ra_ever sr_osteoprs_ever ///
sr_diabetes_ever sr_dementia_ever prob_dem
local ivars3 ind_no_hc ind_one_hc ind_lt3_hc ind_gt2_hc adl_eat_diff adl_eat_help adl_bath_diff adl_bath_help adl_toil_diff ///
adl_toil_help adl_dres_diff adl_dres_help adl_ins_help adl_ins_diff adl_bed_help ///
adl_bed_diff ind_hosp_adm_p12m ind_ed_adm_p12m ind_icu_p12m died_12
local cvars2 tot_paid_by_mc_12m housecalls_count

local rd: word count `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' 1 1 1 1 1

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1
foreach x of local cvars1 {
svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r
}

foreach x of local ivars1 {

svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy: tab `x' ind_cpt, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}


foreach x of local ivars2 {

svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy: tab `x' ind_cpt, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}



foreach x of local ivars3 {

svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy: tab `x' ind_cpt, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}

foreach x of local cvars2 {
svy: mean `x', over(ind_cpt)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)
*/
}

sum housecalls_count if ind_cpt==1
mat tab1[`r',1]=r(min)
local ++r
mat tab1[`r',1]=r(max)
local ++r
mat tab1[`r',1]=2
local ++r


sum age if ind_cpt==1
mat tab1[`r',1] = r(N)

sum age if ind_cpt==0
mat tab1[`r',2] = r(N)
local ++r 
svy, subpop(if ind_cpt==1): mean age
mat tab1[`r',1] = e(N_subpop)

svy, subpop(if ind_cpt==0): mean age
mat tab1[`r',2] = e(N_subpop)

mat rownames tab1 = `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' ///
"Minimum number of house calls" "Maximum number of housecalls" "Median House Calls" ///
"N" "Weighted Sample Size"

mat list tab1

frmttable using "E:\nhats\data\projects\IAH\logs\table1_weighted_evan.doc", replace statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-3 Community Dwelling + 6m FFS (Weighted)") ///
ctitles("" "CPT+POS" "No House Calls") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")
gen hb=homebound1

foreach cpt in 1 0 {

local rd: word count `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' 1 1 1 1 1 

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1
foreach x of local cvars1 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r
}

foreach x of local ivars1 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}


foreach x of local ivars2 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}



foreach x of local ivars3 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}

foreach x of local cvars2 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)
*/
}

sum housecalls_count if hb==1
mat tab1[`r',1]=r(min)
local ++r
mat tab1[`r',1]=r(max)
local ++r
mat tab1[`r',1]=2
local ++r

sum age if ind_cpt==`cpt' & hb==0
mat tab1[`r',2] = r(N)
sum age if ind_cpt==`cpt' & hb==1
mat tab1[`r',1] = r(N)

local r=`r'+1
svy, subpop(if ind_cpt==`cpt' & hb==0): mean age
mat tab1[`r',2] = e(N_subpop)
svy, subpop(if ind_cpt==`cpt' & hb==1): mean age
mat tab1[`r',1] = e(N_subpop)



mat rownames tab1 = `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' ///
"Minimum number of house calls" "Maximum number of housecalls" "Median House Calls" ///
"N" "Weighted Sample Size"

mat list tab1
local housecall "1+ Housecall"
if `cpt'==0 local housecall "No Housecalls"
frmttable using "E:\nhats\data\projects\IAH\logs\table1_weighted_evan.doc", addtable statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-3 Community Dwelling + 6m FFS (Weighted) & `housecall'") ///
ctitles("" "Homebound" "Non-Homebound") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")

}

preserve
foreach cpt in 1  {
replace hb=ind_one_hc==1
local rd: word count `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' 1 1 1 1 1 

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1
foreach x of local cvars1 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r
}

foreach x of local ivars1 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}


foreach x of local ivars2 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}



foreach x of local ivars3 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}

foreach x of local cvars2 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)
*/
}

sum housecalls_count if hb==1
mat tab1[`r',1]=r(min)
local ++r
mat tab1[`r',1]=r(max)
local ++r
mat tab1[`r',1]=2
local ++r

sum age if ind_cpt==`cpt' & hb==0
mat tab1[`r',2] = r(N)
sum age if ind_cpt==`cpt' & hb==1
mat tab1[`r',1] = r(N)

local r=`r'+1
svy, subpop(if ind_cpt==`cpt' & hb==0): mean age
mat tab1[`r',2] = e(N_subpop)
svy, subpop(if ind_cpt==`cpt' & hb==1): mean age
mat tab1[`r',1] = e(N_subpop)



mat rownames tab1 = `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' ///
"Minimum number of house calls" "Maximum number of housecalls" "Median House Calls" ///
"N" "Weighted Sample Size"

mat list tab1
local housecall "1+ Housecall"
if `cpt'==0 local housecall "No Housecalls"
frmttable using "E:\nhats\data\projects\IAH\logs\table1_weighted_evan.doc", addtable statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-3 Community Dwelling + 6m FFS (Weighted) & `housecall'") ///
ctitles("" "One Housecall" "2+ Housecalls") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")

}
restore

preserve


foreach cpt in 1  {
gen cpt2=ind_cpt
replace ind_cpt=hb
replace hb=cpt2
//replace hb=ind_one_hc==1
local rd: word count `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' 1 1 1 1 1 

mat tab1 = J(`rd',2,.)
mat stars = J(`rd',2,0)

local r = 1
local c = 1
foreach x of local cvars1 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r
}

foreach x of local ivars1 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}


foreach x of local ivars2 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}



foreach x of local ivars3 {

svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)*100
mat tab1[`r',2] = el(e(b),1,1)*100

svy, subpop(if ind_cpt==`cpt'): tab `x' hb, pea
mat stars[`r',1]=(e(p_Pear)<.01) + (e(p_Pear)<.05)

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)*100

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)*100
*/
local ++r
}

foreach x of local cvars2 {
svy, subpop(if ind_cpt==`cpt'): mean `x', over(hb)
mat tab1[`r',1] = el(e(b),1,2)
mat tab1[`r',2] = el(e(b),1,1)

test [`x']0 = [`x']1

mat stars[`r',1]=(r(p)<.01) + (r(p)<.05)

local ++r

/*
qui sum `x' if posflag==1
mat tab1[`r',3] = r(mean)

qui sum `x' if none==1
mat tab1[`r',4] = r(mean)
*/
}

sum housecalls_count if hb==1
mat tab1[`r',1]=r(min)
local ++r
mat tab1[`r',1]=r(max)
local ++r
mat tab1[`r',1]=2
local ++r

sum age if ind_cpt==`cpt' & hb==0
mat tab1[`r',2] = r(N)
sum age if ind_cpt==`cpt' & hb==1
mat tab1[`r',1] = r(N)

local r=`r'+1
svy, subpop(if ind_cpt==`cpt' & hb==0): mean age
mat tab1[`r',2] = e(N_subpop)
svy, subpop(if ind_cpt==`cpt' & hb==1): mean age
mat tab1[`r',1] = e(N_subpop)



mat rownames tab1 = `cvars1' `ivars1' `ivars2' `ivars3' `cvars2' ///
"Minimum number of house calls" "Maximum number of housecalls" "Median House Calls" ///
"N" "Weighted Sample Size"

mat list tab1
local housecall "Homebound only"
if `cpt'==0 local housecall "No Housecalls"
frmttable using "E:\nhats\data\projects\IAH\logs\table1_weighted_evan.doc", addtable statmat(tab1) ///
varlabels title("Table 1: IAH Unique persons per NHATS Waves 1-3 Community Dwelling + 6m FFS (Weighted) & `housecall'") ///
ctitles("" "One Housecall" "2+ Housecalls") sdec(2) annotate(stars) asymbol(*,**) ///
note("These are unique people, and only survey data from their most recent NHATS interview was used. *p<0.05, **p<0.01")

}
restore




H="Probable Dementia house calls"
/* Stata */

use "E:\nhats\data\Projects\IAH\final_data\iah_wave1-3.dta", clear

keep if prob_dem==1
keep spid bene_id index_date wave

save "E:\nhats\data\Projects\IAH\final_data\dementia_wave1-3.dta"

/* SAS      */

libname claims "E:\nhats\data\CMS_DUA_28016\Merged";
libname line "E:\nhats\data\CMS_DUA_28016\Cumulative Years";
libname cyears "E:\nhats\data\CMS_DUA_28016\Cumulative Years";

proc import datafile="E:\nhats\data\Projects\IAH\final_data\dementia_wave1-3.dta" out=nhats replace; run; 

data nhats;
set nhats;
run;

/*
data carrier_pflag;
set claims.pb_09_14;
pos1flag = 0;
array dx pos1--pos13;
do over dx;
if dx in:(12,13,14) then pos1flag = 1;
output;
end;
run;

*/

data carrier;
set claims.pb_09_14;
array dx hcpcscd1--hcpcscd13;
do over dx;
cptcodes=dx;
output;
end;
/*
pos1flag = 0;
if pos1 in:(12,13,14) then pos1flag = 1;
if pos2 in:(12,13,14) then pos1flag = 1;
if pos3 in:(12,13,14) then pos1flag = 1;
if pos4 in:(12,13,14) then pos1flag = 1;
if pos5 in:(12,13,14) then pos1flag = 1;
if pos6 in:(12,13,14) then pos1flag = 1;
if pos7 in:(12,13,14) then pos1flag = 1;
if pos8 in:(12,13,14) then pos1flag = 1;
if pos9 in:(12,13,14) then pos1flag = 1;
if pos10 in:(12,13,14) then pos1flag = 1;
if pos11 in:(12,13,14) then pos1flag = 1;
if pos12 in:(12,13,14) then pos1flag = 1;
if pos13 in:(12,13,14) then pos1flag = 1;
*/
run;


data carrierline (keep = bene_id clm_id LINE_PLACE_OF_SRVC_CD cptcodes hcpcs_cd);
set line.bcarrier_line_j_09_14;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrierline;
set carrierline;
cptflag = 0;
posflag = 0;
if 99341<=cptcodes<=99350 or 99324<=cptcodes<=99328 or 99334<=cptcodes<=99337 then cptflag=1;
if LINE_PLACE_OF_SRVC_CD in:(12,13,14) then posflag=1;
run;

data carrierline;
set carrierline;
both = 0;
if cptflag = 1 and posflag = 1 then both = 1;
run;


proc sql;
create table carrier2 as select a.*, b.admit_date, b.disch_date
from carrierline a
inner join carrier b
on a.bene_id=b.bene_id and a.clm_id=b.clm_id;
quit;

proc sql;
create table carrier3 as select a.*, b.*
from carrier2 a
inner join nhats b
on a.bene_id=b.bene_id and -183<=b.index_date-a.admit_date<=183;
quit;


data carrier3;
set carrier3;
*where ffs_6m = 1;
where both = 1;
run;

proc sort data=carrier3; by spid wave; run;
proc sort data=carrier3 nodupkey; by spid; run;

proc freq data=carrier3; tables ffs_6m ffs_12m; run;

/* both */

data bothclaims;
set carrier3;
where both = 1;
same = 0;
if hcpcs_cd = cptcodes then same = 1; /*checking if the cptcodes from from carrier claims is the same as the hcpcs_cd code in carrier line */
run;

proc sort data=bothclaims nodupkey; by bene_id clm_id hcpcs_cd; run;

/* gen single line per claim for annual count */

proc sort data=bothclaims out=annual nodupkey; by bene_id clm_id; run;

data annual;
set annual;
year = year(admit_date);
run;

proc sql;
create table annual_1 as select distinct bene_id, year,
sum(both) as housecalls_count
from annual
group by bene_id, year;
quit;

data annual_1;
set annual_1;
if year = 2011 then wave = 1;
if year = 2012 then wave = 2;
if year = 2013 then wave = 3;
run;

proc export data=annual_1 outfile="E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta" dbms=stata replace; run;

proc freq data=bothclaims order=freq; tables hcpcs_cd; run;

proc sort data=bothclaims nodupkey; by bene_id wave; run;


data both_beneid (keep= bene_id wave bflag);
set bothclaims;
bflag = 1;
run;

proc freq data=both_beneid; tables wave; run;

proc export data=both_beneid outfile="E:\nhats\data\Projects\IAH\int_data\cpt+pos.dta" replace; run;

proc sort data=both_beneid out=test nodupkey; by bene_id; run;


/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.bflag
from cptclaims a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if bflag = 1 then delete;
cflag = 1;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;
proc sort data=cptclaims out=test nodupkey; by bene_id; run;

proc export data=cptclaims outfile="E:\nhats\data\Projects\IAH\int_data\cpt+only.dta" replace; run;


/*pos only */

data posclaims;
set carrier3;
where posflag = 1 and both=0;
run;

proc sql;
create table posclaims1 as select a.*, b.cflag
from posclaims a
left join cptclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

proc sql;
create table posclaims2 as select a.*, b.bflag
from posclaims1 a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data posclaims;
set posclaims2;
if cflag = 1 or bflag = 1 then delete;
run;



proc sort data=posclaims nodupkey; by bene_id clm_id hcpcs_cd; run;
proc freq data=posclaims order=freq; tables hcpcs_cd; run;

 
proc sort data=posclaims nodupkey; by bene_id wave; run;

proc freq data=posclaims; tables wave; run;


proc sort data=posclaims nodupkey; by bene_id; run;


proc export data=posclaims outfile="E:\nhats\data\Projects\IAH\int_data\pos+only.dta" replace; run;





















/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.pflag
from cptclaims a
left join posclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if pflag = 1 then delete;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;

/* none */

data noclaims;
set carrier3;
where cpt


data carrier2 (keep = cptcodes hcpcs_cd) ;
set carrier2;
where posflag = 1 or pos1flag = 1;
run;

data carrier2 (keep = hcpcs_cd);
set carrier2;
run;
*/

proc sort data=carrier2 nodup; by hcpcs_cd; run;


proc export data=carrier2 outfile="E:\nhats\projects\IAH\20171115\cptcodes.xlsx" dbms=xlsx replace; run;


H="Prob Dem - HRS"
/*2000-2012 medicare claims*/
libname claims 'E:\data\cms_DUA_24548_2012';
libname raw 'E:\data\cms_DUA_24548_2012\received_20150327';

data carrier;
set raw.pb_1998 raw.pb_1999 raw.pb_2000 raw.pb_2001 raw.pb_2002 raw.pb_2003 raw.pb_2004 raw.pb_2005 raw.pb_2006 raw.pb_2007 raw.pb_2008 raw.pb_2009 raw.pb_2010 raw.pb_2011 raw.pb_2012;
run;

proc contents data=carrier short; run;


data carrier (keep = bid_hrs_21 from_dt thru_dt PLCRVC01--PLCRVC13) ;
set carrier;
run;

proc import datafile="E:\data\IAH - Dementia\core_pdem.dta" out=nhats replace; run; /*technically HRS but too lazy to change */ 

data nhats;
set nhats;
run;


data carrier_pflag;
set carrier;
pos1flag = 0;
array dx PLCRVC01--PLCRVC13;
do over dx;
if dx in:(12,13,14) then pos1flag = 1;
end;
run;


proc freq data=carrier_pflag; tables pos1flag; run;

data carrier_pflag;
set carrier_pflag;
if pos1flag = 0 then delete;
run;

proc contents data=tmp1.pb_2008; run;

data carrier;
set claims.pb_2000_2012;
run;

proc sql;
create table carrier_new as select a.*, b.pos1flag
from carrier a
inner join carrier_pflag b
on a.bid_hrs_21=b.bid_hrs_21 and a.from_dt=b.from_dt and a.thru_dt=b.thru_dt;
quit;


data carrier_new;
set carrier_new;
array dx HCPSCD01--HCPSCD13;
do over dx;
hcpcs_cd = dx;
output;
end;
run;

data carrier_new;
set carrier_new;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrier_new;
set carrier_new;
cptflag = 0;
if 99341<=cptcodes<=99350 or 99324<=cptcodes<=99328 or 99334<=cptcodes<=99337 then cptflag=1;
run;

data carrier_new;
set carrier_new;
where cptflag = 1 and pos1flag = 1;
run;

proc sort data=carrier_new nodup; by bid_hrs_21; run;



/****************************************************************/
/*Add HRS xwalk ID to the claims datasets
Creates 2 datasets, one with the 6 month cc and elix 
and one with 12 month cc and elix */
/****************************************************************/

/*HRS - CMS crosswalk initial processing*/
data crosswalk_1;
set claims.cmsxref2012;
keep bid_hrs_21 hhid pn hhidpn hhidnew pnnew;
/*create id variable as concat of hhid and pn*/
length hhidpn $9 hhidnew $6 pnnew $3;
hhidnew=trim(hhid);
pnnew=trim(pn);
hhidpn=hhidnew||pnnew;
run;

data crosswalk_1a;
set crosswalk_1(keep=bid_hrs_21 hhidpn);
run;

proc sort data=crosswalk_1a nodupkey; by bid_hrs_21; run; 

proc sql;
create table hrs as select a.*, b.bid_hrs_21
from nhats a
inner join crosswalk_1a b
on a.id=b.hhidpn;
quit;


proc sql;
create table carrier_calls as select a.*, b.cptflag, b.pos1flag, b.admit_year
from hrs a
inner join carrier_new b
on a.bid_hrs_21=b.bid_hrs_21 and -183<=a.c_ivw_date-b.admit_date<=183;
quit;



proc sort data=carrier_calls; by bid_hrs_21 admit_year; run;


data dn_file (keep = bid_hrs_21 admit_year buyin12 hmoind12 hmo_mo buyin_mo orec esrd_ind bene_dob);
set claims.dn_2000_2012 (rename=(year = admit_year));
run;


proc sort data=dn_file; by bid_hrs_21 admit_year; run;

proc sql;
create table carrier_calls2 as select a.*, b.*
from carrier_calls a 
inner join dn_file b
on a.bid_hrs_21=b.bid_hrs_21 and a.admit_year=b.admit_year;
quit;


/* Trim buyin and hmo variables to only reflect time before dialysis */
data hrs_dial_y2;
set carrier_calls;
surg_month=month(c_ivw_month);
if length(trim(left(buyin12)))>=6 and surg_month>0 then do;
buyin_sy=substr(trim(left(buyin12)),1,surg_month); * creating buyin/hmo variable for the months before index date in same year;
hmo_sy=substr(trim(left(HMOIND12)),1,surg_month);
end;
else do;
buyin_sy=trim(left(buyin12));
hmo_sy=trim(left(HMOIND12));
end;
run;
proc means n;
var surg_month;
run;


proc sql;
create table dn_surg_y_bef as select
a.bid_hrs_21,a.admit_year as surg_year,b.year as surg_year_bef,b.year,b.buyin12,b.HMOIND12
from hrs_dial_final a inner join
merged.dn_2000_2012 b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21))
and a.admit_year-b.year=1 order by bid_hrs_21,admit_year;
quit;


proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
hrs_dial_y2 a
left join
dn_surg_y_bef b
on trim(left(a.bid_hrs_21))=trim(left(b.bid_hrs_21));
quit;


data all_insurance2;
set all_insurance;
buyin_2y=trim(left(buyin_bef))||trim(left(buyin_sy));
hmo_2y=trim(left(hmo_bef))||trim(left(hmo_sy));

/*create 12 month variables*/
buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));

if length(buyin_2y_r)>5 then buyin_1y_r=substr(trim(left(buyin_2y)),1,6);
if length(hmo_2y_r)>5 then hmo_1y_r=substr(trim(left(hmo_2y)),1,6);

if length(buyin_2y_r)<6 then buyin_1y_r="";
if length(hmo_2y_r)<6 then hmo_1y_r="";

buyin_1y=reverse(trim(buyin_1y_r));
hmo_1y=reverse(trim(hmo_1y_r));

/*create indicator variable for mc coverage 0=no, 1=yes*/
if length(buyin_1y)=6 then do;
if indexc(buyin_1y,"0","1","2","A","B") then part_ab_1y=0;
if indexc(buyin_1y,"0","1","2","A","B")=0 then part_ab_1y=1;
end;
/*create indicator variable for hmo coverage 0=no, 1=yes*/
if length(hmo_1y)=6 then do;
hmo_d_1y= 0;
if index(hmo_1y,"000000") then hmo_d_1y=1;
end;

/*create 6 month variable*/
if length(buyin_2y_r)>0 then buyin_6m_r=substr(trim(left(buyin_2y)),1,6);
if length(hmo_2y_r)>0 then hmo_6m_r=substr(trim(left(hmo_2y)),1,6);

if length(buyin_2y_r)<1 then buyin_6m_r="";
if length(hmo_2y_r)<1 then hmo_6m_r="";

buyin_6m=reverse(trim(buyin_6m_r));
hmo_6m=reverse(trim(hmo_6m_r));

/*create indicator variable for mc coverage 6 mo. 0=no, 1=yes*/
if length(buyin_6m)=1 then do;
if indexc(buyin_6m,"0","1","2","A","B") then part_ab_6m=0;
if indexc(buyin_6m,"0","1","2","A","B")=0 then part_ab_6m=1;
end;
if length(hmo_6m)=1 then do;
if index(hmo_6m,"0") then hmo_d_6m=0;
if index(hmo_6m,"0")=0 then hmo_d_6m=1;
end;

run;







data carrier3;
set carrier3;
*where ffs_6m = 1;
where both = 1;
run;

proc sort data=carrier3; by spid wave; run;
proc sort data=carrier3 nodupkey; by spid; run;

proc freq data=carrier3; tables ffs_6m ffs_12m; run;

/* both */

data bothclaims;
set carrier3;
where both = 1;
same = 0;
if hcpcs_cd = cptcodes then same = 1; /*checking if the cptcodes from from carrier claims is the same as the hcpcs_cd code in carrier line */
run;

proc sort data=bothclaims nodupkey; by bene_id clm_id hcpcs_cd; run;

/* gen single line per claim for annual count */

proc sort data=bothclaims out=annual nodupkey; by bene_id clm_id; run;

data annual;
set annual;
year = year(admit_date);
run;

proc sql;
create table annual_1 as select distinct bene_id, year,
sum(both) as housecalls_count
from annual
group by bene_id, year;
quit;

data annual_1;
set annual_1;
if year = 2011 then wave = 1;
if year = 2012 then wave = 2;
if year = 2013 then wave = 3;
run;

proc export data=annual_1 outfile="E:\nhats\data\Projects\IAH\int_data\annualcpt_count.dta" dbms=stata replace; run;

proc freq data=bothclaims order=freq; tables hcpcs_cd; run;

proc sort data=bothclaims nodupkey; by bene_id wave; run;


data both_beneid (keep= bene_id wave bflag);
set bothclaims;
bflag = 1;
run;

proc freq data=both_beneid; tables wave; run;

proc export data=both_beneid outfile="E:\nhats\data\Projects\IAH\int_data\cpt+pos.dta" replace; run;

proc sort data=both_beneid out=test nodupkey; by bene_id; run;


/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.bflag
from cptclaims a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if bflag = 1 then delete;
cflag = 1;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;
proc sort data=cptclaims out=test nodupkey; by bene_id; run;

proc export data=cptclaims outfile="E:\nhats\data\Projects\IAH\int_data\cpt+only.dta" replace; run;


/*pos only */

data posclaims;
set carrier3;
where posflag = 1 and both=0;
run;

proc sql;
create table posclaims1 as select a.*, b.cflag
from posclaims a
left join cptclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

proc sql;
create table posclaims2 as select a.*, b.bflag
from posclaims1 a
left join both_beneid b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data posclaims;
set posclaims2;
if cflag = 1 or bflag = 1 then delete;
run;



proc sort data=posclaims nodupkey; by bene_id clm_id hcpcs_cd; run;
proc freq data=posclaims order=freq; tables hcpcs_cd; run;

 
proc sort data=posclaims nodupkey; by bene_id wave; run;

proc freq data=posclaims; tables wave; run;


proc sort data=posclaims nodupkey; by bene_id; run;


proc export data=posclaims outfile="E:\nhats\data\Projects\IAH\int_data\pos+only.dta" replace; run;





















/*cptcodes only */

data cptclaims;
set carrier3;
where cptflag= 1 and both=0;
run;

proc sql;
create table cptclaims1 as select a.*, b.pflag
from cptclaims a
left join posclaims b
on a.bene_id=b.bene_id and a.wave=b.wave;
quit;

data cptclaims;
set cptclaims1;
if pflag = 1 then delete;
run;

proc sort data=cptclaims nodupkey; by bene_id clm_id hcpcs_cd; run;


proc freq data=cptclaims order=freq; tables hcpcs_cd; run;
proc freq data=cptclaims order=freq; tables LINE_PLACE_OF_SRVC_CD; run;

proc sort data=cptclaims nodupkey; by bene_id wave; run;
proc freq data=cptclaims ; tables wave; run;

/* none */

data noclaims;
set carrier3;
where cpt


data carrier2 (keep = cptcodes hcpcs_cd) ;
set carrier2;
where posflag = 1 or pos1flag = 1;
run;

data carrier2 (keep = hcpcs_cd);
set carrier2;
run;
*/

proc sort data=carrier2 nodup; by hcpcs_cd; run;


proc export data=carrier2 outfile="E:\nhats\projects\IAH\20171115\cptcodes.xlsx" dbms=xlsx replace; run;


H="***************************"


H="PPS"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "E:\nhats\data\NHATS cleaned\nsoc_round_1.dta", clear
gen diffany=0
foreach x in emotional physical financial {
	replace diffany=1 if diff_`x'_lv==1
}
label var diffany "Any CG-reported financial/emotional/physical difficulty (NSOC)"
keep if cg_primary_nsoc==1
keep spid diffany
tempfile nsoc
save `nsoc'
use "`datapath'\serious_ill_nhats_sample.dta" if sp_ivw==1 | nhres==1
cd `logpath'
merge 1:1 spid using `nsoc', nogen keep(match master)
replace diffany=0 if missing(diffany) 
//note, this is temporary, we should pull all into main xwave set
merge 1:1 spid using "E:\nhats\data\NHATS Public\round_1\NHATS_Round_1_SP_File.dta", ///
nogen keep(match master)
gen pain=ss1painbothr==1
gen pain_limit=ss1painlim==1
gen weightloss=hw1lst10pnds==1 & hw1trytolose==2 
gen dem_probable=dem_3_cat==1


//define PPS
/*what are we pulling?
	-symptoms--Tacara's list
	-sudden weightloss
	-any smi
	-difficulty walking inside
	-ADL difficulty no help
	-health/function prevent activity
	-nhres

	
	PPS
		-80+, no difficulty in ADLs or difficulty with effort
		-70-difficulty
}

*/

gen health_keep=0
foreach x of varlist pa1hlk* {
	replace health_keep=1 if `x'==1
}

gen hkindex=0
foreach x of varlist pa1h* {
	replace health_keep=1 if `x'==1
	replace hkindex=hkindex+1 if `x'==1
}

gen activity_cat=1 if adl_diff_index==0 & nhres==0
replace activity_cat=2 if (inrange(adl_diff_index,1,6) | inrange(iadl_diff_index,1,6)) 
replace activity_cat=3 if health_keep==1 & activity_cat==2
replace activity_cat=4 if ls1diskefrm3==1

label define activity_cat 1 "No difficulty reported" 2 "Difficulty in ADLs/IADLs" ///
3 "Difficulty & unable to do activities b/c health" 4 "Unable to do light housework b/c health or disab"
label values activity_cat activity_cat

*rename mo1dinsds ambulation

gen ambulation=1 if inlist(mo1dinsds,2,3,6)
replace ambulation=2 if mo1dinsds==1 | adl_ins_help==1 | adl_bed_help | mo1insdwout==1
replace ambulation=3 if mo1dbedsfdf==1
replace ambulation=4 if mo1dinsds==8
*replace ambulation=2 if mo1oflv>=1
label define ambulation 1 "Full ambulation" ///
2 "Reports help getting around inside or getting out of bed, or not going parts home by self" ///
3 "Reports not getting out of bed by self" 4 "Reports not moving around inside at all in past month"

label values ambulation ambulation
gen disease=criteria_smi==1
label var disease "Any SMI"

gen freq_help=0
foreach x in sc1eatslfoft sc1dresslf sc1toiloft sc1bathoft mo1bedslf mo1insdslf {
replace freq_help=`x' if `x'>freq_help
}

gen self_care=(freq_help==1)+1
replace self_care=3 if freq_help==2
replace self_care=4 if freq_help==3
replace self_care=5 if freq_help==4
label define self_care 1 "No assistance" 2 "Care dependent, mostly do by self" 3 "Sometimes do by self" ///
4 "Rarely do by self" 5 "Never do by self"
label values self_care self_care

gen intake=weightloss==1
label var intake "Intake (unintentional weightloss)"

tab1 ambulation activity self_care intake
/*
gen pps=100 if ambulation==1 
replace pps=90 if pps==100 & disease==1
replace pps=80 if pps==90 & activity_cat==2 & self_care==1
replace pps=70 if ambulation==2
replace pps=60 if (pps==70 & activity_cat==3) | nhres==1
replace pps=50 if ambulation==3
replace pps=40 if pps==50 &  self_care>=2
replace pps=30 if ambulation==4
*/


log using pps_log.txt, text replace
//first, ambulation
gen pps=100 if ambulation==1
replace pps=70 if ambulation==2
replace pps=50 if ambulation==3
replace pps=30 if ambulation==4

tab pps ambulation

//next, activity & disease
replace pps=90 if pps>90 & disease==1 
replace pps=80 if pps>80 & activity_cat==2 
replace pps=70 if pps>70 & activity_cat==3
replace pps=60 if pps>60 & activity_cat==4

tab pps disease
tab pps activity

//self-care (ADLs)
replace pps=60 if pps>60 & self_care==2
replace pps=50 if pps>50 & self_care==3
replace pps=40 if pps>40 & self_care==4
replace pps=30 if pps>30 & self_care==5

tab pps self_care

//nhres (no survey)
replace pps=60 if pps>60 & nhres==1


/*Variables:
	Health_keep: has health/function prevented you from doing x
		-pa1hlk...
	Activity_cat: No difficulty reported, yes difficulty, yes + health_keep
		-adl_diff_index, iadl_diff_index, health_keep
	Ambulation: Moved around inside by self w/ or w/o difficulty; 
				help getting around inside or report of not going parts of home/building by self
				reports not getting out of bed by self
				reports not moving around inside at all (bedbound?)
		-mo1dinsdslf, adl_ins_help, mo1insdwout, mo1bedwout
	Disease: Any SMI
		-any_smi
	Freq_help: Frequency of doing activity by self if help in 1+ ADL (set to least frequent)
		-sc1eatslfoft...
	Self Care: No ADL assistance, then how often require help
		-freq_help
	NHRes: Nursing Home Resident
		-nhres
	discussed, not used--weightloss
*/


foreach x in ambulation disease self_care nhres {
	tab `x'
}

foreach x in ambulation disease self_care nhres {
	tab pps `x'
}

foreach boris in yeltsin {
//health keep
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i'
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i'
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented) sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

preserve
drop if activity==1
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i'
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i'
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented, among those with reported difficulty) ///
sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

restore
}
log close


H="7/7 update"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "E:\nhats\data\CMS_DUA_28016\Merged Stata\dm_09_12.dta", clear
keep bene_id admit_date disch_date hcpcs_cd betos
gen wave=1
merge m:1 bene_id wave using ///
 "E:\nhats\data\Projects\pal_perf_scale\final_data\serious_ill_nhats_sample.dta", ///
 keep(match) keepusing(spid index_date)
keep if inrange(admit_date,index_date-186,index_date)

gen wc_betosa=betos=="D1D"
gen bed_betosa=betos=="D1B"

gen ind_wheelchaira=inlist(hcpcs_cd, "E1088","E1090","E1093","E1140","E1150","E1161") ///
 | inlist(hcpcs_cd,"E1220","E1226","E1230","E1232") ///
 | inlist(hcpcs_cd, "E1240","E1260","E1270","E2201","E2203") | inlist(hcpcs_cd,"E2206","E2208","E2209","E2210","E2226") ///
 | inlist(hcpcs_cd, "E2310","E2321","E2323","E2340","E2361") | inlist(hcpcs_cd,"E2363","E2364","E2365","E2366","E2367") ///
 | inlist(hcpcs_cd, "E2368","E2370","E2374","E2375","E2381") | inlist(hcpcs_cd,"E2382","E2383","E2386","E2387","E2389") ///
 | inlist(hcpcs_cd, "E2392","E2394","E2395","E2601","E2602") | inlist(hcpcs_cd,"E2603","E2604","E2605","E2607","E2608") ///
 | inlist(hcpcs_cd, "E2611","E2615","E2619","E2620","E2622") | inlist(hcpcs_cd,"E2623","E2624","K0001","K0002","K0003") ///
 | inlist(hcpcs_cd, "K0004","K0005","K0006","K0007","K0009") | inlist(hcpcs_cd,"K0010","K0011","K0012","K0014","K0015") ///
 | inlist(hcpcs_cd,"K0017","K0019","K0040","K0045","K0046") | inlist(hcpcs_cd,"K0047","K0053","K0056","K0069","K0070") ///
 | inlist(hcpcs_cd, "K0071","K0077","K0108","K0195","K0733") | inlist(hcpcs_cd,"K0734","K0735","K0736","K0800","K0806") ///
 | inlist(hcpcs_cd, "K0808","K0813","K0814","K0815","K0816") | inlist(hcpcs_cd,"K0821","K0822","K0823","K0824","K0825") ///
 | inlist(hcpcs_cd, "K0835","K0842","K0843","K0848","K0849") | inlist(hcpcs_cd,"K0856","K0861","K0877")																											

gen ind_hosp_beda=inlist(hcpcs_cd,"E0250","E0255","E0256") | inlist(hcpcs_cd,"E0260","E0261","E0265","E0271","E0272","E0274","E0277") ///
 | inlist(hcpcs_cd,"E0293","E0294","E0295","E0303","E0305") | inlist(hcpcs_cd,"E0310","E0316","E0860","E0870","E0910") ///
 | inlist(hcpcs_cd,"E0912","E0940","E0946","E0948","E0943") | inlist(hcpcs_cd,"K0456","K0549")																																																																																																												

keep spid bene_id index_date ind_* *_betosa
duplicates drop

foreach x of varlist *a {
	by spid, sort: egen `x'1=max(`x')
	drop `x'
}

rename *a1 *
duplicates drop

tempfile dme
save `dme'


use "E:\nhats\data\NHATS cleaned\nsoc_round_1.dta", clear
gen diffany=0
foreach x in emotional physical financial {
	replace diffany=1 if diff_`x'_lv==1
}
label var diffany "Any CG-reported financial/emotional/physical difficulty (NSOC)"
keep if cg_primary_nsoc==1
keep spid diffany
tempfile nsoc
save `nsoc'
use "`datapath'\serious_ill_nhats_sample.dta" if sp_ivw==1 | nhres==1
cd `logpath'
merge 1:1 spid using `nsoc', nogen keep(match master)
replace diffany=0 if missing(diffany) 
//note, this is temporary, we should pull all into main xwave set
merge 1:1 spid using "E:\nhats\data\NHATS Public\round_1\NHATS_Round_1_SP_File.dta", ///
nogen keep(match master)
//merge to get 1m discharge
merge 1:1 spid index_date using ///
"E:\nhats\data\Projects\pal_perf_scale\disch_1m.dta", ///
gen(ipm) keep(match master)
merge 1:1 spid index_date using `dme', gen(dmem) keep(match master)
replace ind_wheelchair=0 if missing(ind_whe)
replace ind_hosp_bed=0 if missing(ind_hosp_bed)
replace oxygen=0 if missing(oxygen)
gen bed_or_chair=ind_wheelchair | ind_hosp_bed

gen adl_diff_insd=mo1insddif>1 if mo1insddif>0
gen pain=ss1painbothr==1
gen sob=ss1probbreat==1
gen upper=ss1strnglmup==1
gen energy=ss1lowenergy==1
gen lower=ss1lwrbodstr==1
gen balance=ss1prbbalcrd==1
gen insomnia=inlist(hc1sleepmed,1,2) | inlist(hc1aslep30mn,1,2) | ///
inlist(hc1trbfalbck,1,2)
gen weightloss=hw1lst10pnds==1 & hw1trytolose==2 

gen dem_probable=dem_3_cat==1
/*7/7/17 update-3+ Dartmouth comorbidities counts as SMI*/
replace smi_count=smi_count+1 if dmouth_index>=3 & !missing(dmouth_index)
replace criteria_smi=1 if  dmouth_index>=3 & !missing(dmouth_index)

//define PPS
/*what are we pulling?
	-symptoms--Tacara's list
	-sudden weightloss
	-any smi
	-difficulty walking inside
	-ADL difficulty no help
	-health/function prevent activity
	-nhres

	
	PPS
		-80+, no difficulty in ADLs or difficulty with effort
		-70-difficulty
}

*/

/*5/24/17--switch from health keeps anything to health keeps work, rel svces, 
going out for enjoyment*/

gen health_keep=0
foreach x of varlist pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk {
	replace health_keep=1 if `x'==1
}

gen hkindex=0
foreach x of varlist pa1h* {
	*replace health_keep=1 if `x'==1
	replace hkindex=hkindex+1 if `x'==1
}

gen activity_cat=1 if adl_diff_index==0 & nhres==0
replace iadl_diff_index=iadl_diff_index+1 if ind_meds_diff==1
replace adl_diff_index=adl_diff_index+1 if adl_diff_insd==1
replace adl_diff_index=adl_diff_index+1 if inrange(mo1beddif,2,4)
replace activity_cat=2 if (inrange(adl_diff_index,1,6) | inrange(iadl_diff_index,1,6)) ///
| adl_impair==1 | iadl_impair==1
replace activity_cat=3 if health_keep==1 & activity_cat==2
gen nohousework=(inlist(ha1dmealreas,1,3) & inlist(ha1dmealsfdf,1,8)) & ///
(inlist(ha1dlaunreas,1,3) & inlist(ha1dlaunsfdf,1,8))
gen ind_diff=(inrange(adl_diff_index,1,6) | inrange(iadl_diff_index,1,6)) ///
& (!missing(adl_diff_index) | !missing(iadl_diff_index))
label var nohousework "Did not prepare meals or do laundry by self due to health"
label var ind_diff "Any difficulty in ADLs or IADLs"
replace activity_cat=4 if nohou
label define activity_cat 1 "No difficulty reported" 2 "Difficulty in ADLs/IADLs" ///
3 "Difficulty & unable to do activities b/c health" 4 "Unable to prepare meals or do laundry"
label values activity_cat activity_cat

*rename mo1dinsds ambulation

gen ambulation=1 if inlist(mo1dinsds,2,3,6)
replace ambulation=2 if mo1dinsds==1 | adl_ins_help==1 | adl_bed_help | mo1insdwout==1
replace ambulation=3 if mo1dbedsfdf==1
replace ambulation=4 if mo1dinsds==8
*replace ambulation=2 if mo1oflv>=1
label define ambulation 1 "Full ambulation" ///
2 "Reports help getting around inside or getting out of bed, or not going parts home by self" ///
3 "Reports not getting out of bed by self" 4 "Reports not moving around inside at all in past month"

label values ambulation ambulation
gen disease=criteria_smi==1
label var disease "Any SMI"

gen freq_help=0
foreach x in sc1eatslfoft sc1dresslf sc1toiloft sc1bathoft mo1bedslf mo1insdslf {
replace freq_help=`x' if `x'>freq_help
}

gen self_care=(freq_help==1)+1
replace self_care=3 if freq_help==2
replace self_care=4 if freq_help==3
replace self_care=5 if freq_help==4
label define self_care 1 "No assistance" 2 "Care dependent, mostly do by self" 3 "Sometimes do by self" ///
4 "Rarely do by self" 5 "Never do by self"
label values self_care self_care

gen intake=weightloss==1
label var intake "Intake (unintentional weightloss)"

tab1 ambulation activity self_care intake
/*
gen pps=100 if ambulation==1 
replace pps=90 if pps==100 & disease==1
replace pps=80 if pps==90 & activity_cat==2 & self_care==1
replace pps=70 if ambulation==2
replace pps=60 if (pps==70 & activity_cat==3) | nhres==1
replace pps=50 if ambulation==3
replace pps=40 if pps==50 &  self_care>=2
replace pps=30 if ambulation==4
*/


log using pps_log.txt, text replace
//first, ambulation
gen pps=100 if ambulation==1
replace pps=70 if ambulation==2
replace pps=50 if ambulation==3
replace pps=30 if ambulation==4

tab pps ambulation

//next, activity & disease
replace pps=90 if pps>90 & disease==1 
replace pps=80 if pps>80 & activity_cat==2 
replace pps=70 if pps>70 & activity_cat==3
replace pps=60 if pps>60 & activity_cat==4

tab pps disease
tab pps activity

//self-care (ADLs)
replace pps=60 if pps>60 & self_care==2
replace pps=50 if pps>50 & self_care==3
replace pps=40 if pps>40 & self_care==4
replace pps=30 if pps>30 & self_care==5

tab pps self_care

//nhres (no survey)
replace pps=60 if pps>60 & nhres==1



local symp pain sob upper energy lower balance insomnia weightloss ///
sr_phq2_depressed sr_gad2_anxiety
egen index_symp=rowtotal(`symp')
gen ind_ge3_symp=index_symp>=3 if !missing(index_symp)

//5/24/17--go just for pain/breathing problems limit activity
gen sig_symp=ss1prbbrlim==1 | ss1painl==1
label var sig_symp "Significant symptom burden--activity limited by pain or breathing problem"

gen ind_indication=/*weightloss==1 |*/ (smi_count>=2 & !missing(smi_count)) | ///
sig_symp==1 | any_disch_1m==1
label var ind_indication "1+ high-need indication"
/* Update 7/7/17--
the payment categories have been altered so that we've got just two groups--
	moderate complexity 
		PPS 60 or ADL or DME claim and cancer
		PPS 70 or ADL or DME claim and noncancer
		SMI 
		2 IP stays or 1 and separate ED visit
	severe complexity
		like moderate, except excludes dementia if only smi and 50/60 PPS instead
		of 60/70
*/
/*payment category from apm

uses: 
pps

other high need indications:
weightloss (sudden nutritional/functional decline)
smi_count (multiple serious illnesses)
ind_ge3_symp (significant symptom distress--3+ on symptom index)
any_disch_1m (inp discharge w/in 30 days)
not currrently used--frail cg or remote location
*/



gen payment_cat=0 if pps>=80
replace payment_cat=1 if (smi_cancer_ind==0 | smi_count>1) & (pps<=70 | ///
bed_or_chair==1 | oxygen==1 | adl_impair==1) & smi_count>=1 & (n_ip_admit_6m>=2 | ///
(ind_hosp_adm_6m & ed_op_wout_adm_ind==1))
replace payment_cat=1 if (smi_cancer_ind==1) & (pps<=60 | ///
bed_or_chair==1 | oxygen==1 | adl_impair==1) & smi_count>=1 & (n_ip_admit_6m>=2 | ///
(ind_hosp_adm_6m & ed_op_wout_adm_ind==1))
replace payment_cat=2 if (smi_cancer_ind==0 | smi_count>1) & (pps<=60 | ///
bed_or_chair==1 | oxygen==1 | adl_impair==1) & smi_count>=1 & (n_ip_admit_6m>=2 | ///
(ind_hosp_adm_6m & ed_op_wout_adm_ind==1))
replace payment_cat=2 if (smi_cancer_ind==1) & (pps<=50 | ///
bed_or_chair==1 | oxygen==1 | adl_impair==1) & smi_count>=1 & (n_ip_admit_6m>=2 | ///
(ind_hosp_adm_6m & ed_op_wout_adm_ind==1))
replace payment_cat=1 if payment_cat==2 & smi_dem_ind==1 & smi_count==1 
replace payment_cat=0 if n_ip_admit_6m==0 | (n_ip_admit_6m==1 & ed_op_wout==0)
replace payment_cat=0 if smi_count==0

gen old_payment_cat=0 if pps>=80
replace old_payment_cat=1 if pps==80 & ind_indication==1
replace old_payment_cat=2 if pps<70 
replace old_payment_cat=2 if pps==70 & ind_indication==1
replace old_payment_cat=3 if pps<50
replace old_payment_cat=3 if pps<70 & ind_indication==1
replace old_payment_cat=0 if criteria_smi!=1
label define old_payment_cat 0 "Low risk patients (not on scale)" 1 "Low-moderate need/risk patients" ///
2 "Moderate need/risk patients" 3 "High need/risk patients"
label values old_payment_cat old_payment_cat

label define payment_cat 0 "Low complexity patients" 1 "Moderate complexity patients" ///
2 "Severe complexity patients"
label values payment_cat payment_cat

/*Variables:
	Health_keep: has health/function prevented you from doing x
		-pa1hlk...
	Activity_cat: No difficulty reported, yes difficulty, yes + health_keep
		-adl_diff_index, iadl_diff_index, health_keep
	Ambulation: Moved around inside by self w/ or w/o difficulty; 
				help getting around inside or report of not going parts of home/building by self
				reports not getting out of bed by self
				reports not moving around inside at all (bedbound?)
		-mo1dinsdslf, adl_ins_help, mo1insdwout, mo1bedwout
	Disease: Any SMI
		-any_smi
	Freq_help: Frequency of doing activity by self if help in 1+ ADL (set to least frequent)
		-sc1eatslfoft...
	Self Care: No ADL assistance, then how often require help
		-freq_help
	NHRes: Nursing Home Resident
		-nhres
	discussed, not used--weightloss
*/



foreach x in ambulation disease self_care nhres {
	tab `x'
}

foreach x in ambulation disease self_care nhres {
	tab pps `x'
}

foreach one in two {
//health keep
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i' & health_keep==1
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i' & health_keep==1
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented) sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

preserve
drop if activity==1
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i' & health_keep==1
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i' & health_keep==1
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented, among those with reported difficulty) ///
sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

restore
}
log close



foreach now in never {
log using pps_payment_comparison.txt, text replace

label var payment_cat "Payment Category"
label var pps "PPS"
foreach x in pps payment_cat {


local lab : var label `x'
levelsof `x', local(levels)


local rn: word count `levels'
tokenize `levels'
mat tab`x'=J(`rn',3,.)
local r=1
local c=1
sum `x'
local denom=r(N)
	qui svy: tab `x'
	mat pct=e(b)
forvalues l=1/`rn' {
	qui sum died_12 if `x'==``l'' [aw=anfin]
	mat tab`x'[`r',1]=r(N)
	mat tab`x'[`r',2]=(pct[1,`l'])*100
	mat tab`x'[`r',3]=r(mean)*100
	local r=`r'+1
}

mat rownames tab`x'=`levels'

frmttable, statmat(tab`x') ctitles("`lab'" "N" "Estimate" "1 year mortality") ///
sdec(0,2,2)
}
/*
//look at who flips between 70 & 80 
gen diffcat=pps==pps_old
replace diffcat=2 if pps<pps_old
replace diffcat=3 if pps>pps_old
label define diffcat 1 "Same PPs" 2 "New PPS more severe" 3 "New PPS less severe"
label values diffcat diffcat

gen diffpay=payment_cat==payment_cat_old
replace diffpay=2 if payment_cat>payment_cat_old
replace diffpay=3 if payment_cat<payment_cat_old
label define diffpay 1 "Same payment category" 2 " New cat more severe" 3 "New cat less severe"
label values diffpay diffpay


logit died_12 i.diffcat, or
logit died_12 i.diffpay, or
*/
foreach x of varlist pa1h* {
di "`x'"
sum died_12 if `x'==1
}
foreach one in two {
//health keep
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i' & health_keep==1
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i' & health_keep==1
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented) sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

preserve
drop if activity==1
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i' & health_keep==1
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i' & health_keep==1
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented, among those with reported difficulty) ///
sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

restore
}
log close

}
save "E:\nhats\data\Projects\pal_perf_scale\final_data\pps_sample.dta", replace



H="payment groups"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "E:\nhats\data\NHATS cleaned\nsoc_round_1.dta", clear
gen diffany=0
foreach x in emotional physical financial {
	replace diffany=1 if diff_`x'_lv==1
}
label var diffany "Any CG-reported financial/emotional/physical difficulty (NSOC)"
keep if cg_primary_nsoc==1
keep spid diffany
tempfile nsoc
save `nsoc'
use "`datapath'\serious_ill_nhats_sample.dta" if sp_ivw==1 | nhres==1
cd `logpath'
merge 1:1 spid using `nsoc', nogen keep(match master)
replace diffany=0 if missing(diffany) 
//note, this is temporary, we should pull all into main xwave set
merge 1:1 spid using "E:\nhats\data\NHATS Public\round_1\NHATS_Round_1_SP_File.dta", ///
nogen keep(match master)
//merge to get 1m discharge
merge 1:1 spid index_date using ///
"E:\nhats\data\Projects\pal_perf_scale\disch_1m.dta", ///
gen(ipm) keep(match master)

gen adl_diff_insd=mo1insddif>1 if mo1insddif>0
gen pain=ss1painbothr==1
gen sob=ss1probbreat==1
gen upper=ss1strnglmup==1
gen energy=ss1lowenergy==1
gen lower=ss1lwrbodstr==1
gen balance=ss1prbbalcrd==1
gen insomnia=inlist(hc1sleepmed,1,2) | inlist(hc1aslep30mn,1,2) | ///
inlist(hc1trbfalbck,1,2)
gen weightloss=hw1lst10pnds==1 & hw1trytolose==2 

gen dem_probable=dem_3_cat==1


//define PPS
/*what are we pulling?
	-symptoms--Tacara's list
	-sudden weightloss
	-any smi
	-difficulty walking inside
	-ADL difficulty no help
	-health/function prevent activity
	-nhres

	
	PPS
		-80+, no difficulty in ADLs or difficulty with effort
		-70-difficulty
}

*/

gen health_keep=0
foreach x of varlist pa1hlk* {
	replace health_keep=1 if `x'==1
}

gen hkindex=0
foreach x of varlist pa1h* {
	replace health_keep=1 if `x'==1
	replace hkindex=hkindex+1 if `x'==1
}

gen activity_cat=1 if adl_diff_index==0 & nhres==0
replace activity_cat=2 if (inrange(adl_diff_index,1,6) | inrange(iadl_diff_index,1,6)) 
replace activity_cat=3 if health_keep==1 & activity_cat==2
replace activity_cat=4 if ls1diskefrm3==1

label define activity_cat 1 "No difficulty reported" 2 "Difficulty in ADLs/IADLs" ///
3 "Difficulty & unable to do activities b/c health" 4 "Unable to do light housework b/c health or disab"
label values activity_cat activity_cat

*rename mo1dinsds ambulation

gen ambulation=1 if inlist(mo1dinsds,2,3,6)
replace ambulation=2 if mo1dinsds==1 | adl_ins_help==1 | adl_bed_help | mo1insdwout==1
replace ambulation=3 if mo1dbedsfdf==1
replace ambulation=4 if mo1dinsds==8
*replace ambulation=2 if mo1oflv>=1
label define ambulation 1 "Full ambulation" ///
2 "Reports help getting around inside or getting out of bed, or not going parts home by self" ///
3 "Reports not getting out of bed by self" 4 "Reports not moving around inside at all in past month"

label values ambulation ambulation
gen disease=criteria_smi==1
label var disease "Any SMI"

gen freq_help=0
foreach x in sc1eatslfoft sc1dresslf sc1toiloft sc1bathoft mo1bedslf mo1insdslf {
replace freq_help=`x' if `x'>freq_help
}

gen self_care=(freq_help==1)+1
replace self_care=3 if freq_help==2
replace self_care=4 if freq_help==3
replace self_care=5 if freq_help==4
label define self_care 1 "No assistance" 2 "Care dependent, mostly do by self" 3 "Sometimes do by self" ///
4 "Rarely do by self" 5 "Never do by self"
label values self_care self_care

gen intake=weightloss==1
label var intake "Intake (unintentional weightloss)"

tab1 ambulation activity self_care intake
/*
gen pps=100 if ambulation==1 
replace pps=90 if pps==100 & disease==1
replace pps=80 if pps==90 & activity_cat==2 & self_care==1
replace pps=70 if ambulation==2
replace pps=60 if (pps==70 & activity_cat==3) | nhres==1
replace pps=50 if ambulation==3
replace pps=40 if pps==50 &  self_care>=2
replace pps=30 if ambulation==4
*/


log using pps_log.txt, text replace
//first, ambulation
gen pps=100 if ambulation==1
replace pps=70 if ambulation==2
replace pps=50 if ambulation==3
replace pps=30 if ambulation==4

tab pps ambulation

//next, activity & disease
replace pps=90 if pps>90 & disease==1 
replace pps=80 if pps>80 & activity_cat==2 
replace pps=70 if pps>70 & activity_cat==3
replace pps=60 if pps>60 & activity_cat==4

tab pps disease
tab pps activity

//self-care (ADLs)
replace pps=60 if pps>60 & self_care==2
replace pps=50 if pps>50 & self_care==3
replace pps=40 if pps>40 & self_care==4
replace pps=30 if pps>30 & self_care==5

tab pps self_care

//nhres (no survey)
replace pps=60 if pps>60 & nhres==1



local symp pain sob upper energy lower balance insomnia weightloss ///
sr_phq2_depressed sr_gad2_anxiety
egen index_symp=rowtotal(`symp')
gen ind_ge3_symp=index_symp>=3 if !missing(index_symp)

gen ind_indication=weightloss==1 | (smi_count>=2 & !missing(smi_count)) | ind_ge3_symp==1 | ///
any_disch_1m==1
label var ind_indication "1+ high-need indication"

/*payment category from aahpm

uses: 
pps

other high need indications:
weightloss (sudden nutritional/functional decline)
smi_count (multiple serious illnesses)
ind_ge3_symp (significant symptom distress--3+ on symptom index)
any_disch_1m (inp discharge w/in 30 days)
not currrently used--frail cg or remote location
*/



gen payment_cat=0 if pps>=80
replace payment_cat=1 if pps<=70
replace payment_cat=1 if pps==80 & ind_indication==1
replace payment_cat=2 if pps<70 
replace payment_cat=2 if pps==70 & ind_indication==1
replace payment_cat=3 if pps<50
replace payment_cat=3 if pps<70 & ind_indication==1
label define payment_cat 0 "Low risk patients (not on scale)" 1 "Low-moderate need/risk patients" ///
2 "Moderate need/risk patients" 3 "High need/risk patients"
label values payment_cat payment_cat

/*Variables:
	Health_keep: has health/function prevented you from doing x
		-pa1hlk...
	Activity_cat: No difficulty reported, yes difficulty, yes + health_keep
		-adl_diff_index, iadl_diff_index, health_keep
	Ambulation: Moved around inside by self w/ or w/o difficulty; 
				help getting around inside or report of not going parts of home/building by self
				reports not getting out of bed by self
				reports not moving around inside at all (bedbound?)
		-mo1dinsdslf, adl_ins_help, mo1insdwout, mo1bedwout
	Disease: Any SMI
		-any_smi
	Freq_help: Frequency of doing activity by self if help in 1+ ADL (set to least frequent)
		-sc1eatslfoft...
	Self Care: No ADL assistance, then how often require help
		-freq_help
	NHRes: Nursing Home Resident
		-nhres
	discussed, not used--weightloss
*/



foreach x in ambulation disease self_care nhres {
	tab `x'
}

foreach x in ambulation disease self_care nhres {
	tab pps `x'
}

foreach boris in yeltsin {
//health keep
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i'
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i'
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented) sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

preserve
drop if activity==1
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i'
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i'
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented, among those with reported difficulty) ///
sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

restore
}
log close


H="sample tables"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "`datapath'\pps_sample.dta", clear


/*what to look at?

-individual elements of pps and their individual elements
PPS is based on:

Ambulation
Disease
Activity
Self-Care
Others that we can't identify

*/
/*payment category from aahpm

uses: 
pps

other high need indications:
weightloss (sudden nutritional/functional decline)
smi_count (multiple serious illnesses)
sig_symp (significant symptom distress--activity-limiting pain or breathing)
any_disch_1m (inp discharge w/in 30 days)
not currrently used--frail cg or remote location
*/

preserve
drop if nhres==1
local pps ambulation disease  pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk health_keep ///
nohousework ind_diff activity_cat self_care pps weightloss smi_count ///
sig_symp any_disch_1m ss1prbbrlim ss1painl ind_indication payment_cat
label var health_keep "Prevented from religious services, going out, or working"
label var weightloss "Unintentional weight loss"
label var smi_count "Count of serious illnesses"
label var any_disch_1m "Any discharge <=30d prior to ivw"
label define disease 0 "No" 1 "Yes"
label values disease disease
label var ambulation "Ambulation"
label var activity_cat "Activity category"
label var self_care "Self-care"
local replace replace
replace smi_count=3 if smi_count>=4 & !missing(smi_count)
replace smi_count=0 if disease==0
label define smi_count 3 "3+"
label values smi_count smi_count
foreach p in `pps' {
	levelsof `p' if `p'>=0, local(levels)
	local rn : word count `levels'
	mat tab=J(`rn',2,.)
	local r=1
	local c=1
	sum `p' if nhres==0 & !missing(pps) [aw=anfin]
	local denom=r(sum_w)
	tokenize `levels'
	local rnames
	foreach l of local levels {
		sum `p' if `p'==`l' & nhres==0  & `p'>=0 [aw=anfin]
		mat tab[`r',1]=r(N)
		mat tab[`r',2]=(r(sum_w)/`denom')*100
		local lab : label `p' `l'
		if `l'==`1' local rnames "`lab'" 
		else local rnames `rnames'\"`lab'"
		local r=`r'+1
}
	local title : var label `p'
	frmttable using "`logpath'\PPS_AAHPM_cats_tables.rtf", statmat(tab) title(`title') ctitles("" "N" "%") ///
	rtitles(`rnames') sdec(0,2) `replace'
	local replace addtable
}

local pps ambulation disease activity_cat self_care

local ind_indication weightloss smi_count ss1prbbrlim ss1painl  sig_symp any_disch_1m

foreach y in ind_indication {
	foreach p in ``y'' {
	levelsof `p' if `p'>=0, local(levels)
	local rn : word count `levels'
	mat tab=J(`rn',2,.)
	local r=1
	local c=1
	sum `p' if nhres==0 & !missing(pps) & `y'==1 & `p'>=0
	local denom=r(N)
	tokenize `levels'
	local rnames
	foreach l of local levels {
		sum `p' if `p'==`l' & nhres==0  & `y'==1
		mat tab[`r',1]=r(N)
		mat tab[`r',2]=(r(N)/`denom')*100
		local lab : label `p' `l'
		if `l'==`1' local rnames "`lab'" 
		else local rnames `rnames'\"`lab'"
		local r=`r'+1
}
	local title : var label `p'
	local title "`title', among those with high need"
	frmttable using "`logpath'\PPS_AAHPM_cats_tables.rtf", statmat(tab) title("`title'") ctitles("" "N" "%") ///
	rtitles(`rnames') sdec(0,2) `replace'
	local replace addtable
}
}


H="characteristics and outcomes"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "`datapath'\pps_sample.dta" if nhres==0, clear


/*do table-1-style characteristics and basic outcomes by payment group
*/

log using `logpath'/pps_sample_chars.txt, text replace
gen n=1

local pps ambulation disease health_keep   pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk ///
nohousework ind_diff activity_cat self_care pps weightloss smi_count ///
sig_symp any_disch_1m ss1prbbrlim ss1painl ind_indication payment_cat

local ind_indication weightloss smi_count ss1prbbrlim ss1painl  sig_symp any_disch_1m

forvalues i=30(10)100 {
	gen pps`i'=pps==`i' if !missing(pps)
	label var pps`i' "PPS--`i'"
}

gen breath_lim=ss1prbbrlimt==1 
gen pain_lim=ss1prbbrlimt==1 if ss1painlimts>-8
gen ind_mult_smi=smi_count>=2 & !missing(smi_count)
tab ambulation, gen(ambulation)
tab self_care, gen(self_care)
tab activity_cat, gen(activity_cat)
label var breath_lim "Breathing problem limits activity"
label 
foreach y in ambulation self_care activity_cat {
local `y'
levelsof `y', local(levels)
foreach l of local levels {
local lab : label `y' `l'
label var `y'`l' "`lab'"
local `y' `y'`l'
}
}
foreach x in pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk {
	replace `x'=. if `x'<0
	replace `x'=0 if `x'==2
}


local ind_indication weightloss ind_mult_smi sig_symp breath_lim pain_lim any_disch_1m
local pps `ambulation' disease health_keep   pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk ///
nohousework ind_diff `activity_cat' `self_care' ind_indication


local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married educ_hs_ind
local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind ser_med_illness nhres 

local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m

 
sum `cvars1' `cvars2' `ivars1' `ivars2' `ioutcomes' `coutcomes' `pps' `ind_indication'

local cvars age aveincome
local ivars female white black hisp other_race married educ_hs_ind proxy ///
medicaid medigap srh_fp adl_independent /*iadl_independent*/ `pps' `ind_indication'
local ipps pps100 pps90 pps80 ///
pps70 pps60 pps50 pps40 pps30 
local cout tot_paid_by_mc_12m n_hospd_p12m
local iout ind_hosp_adm_p12m died_12

local rn : word count `cvars' `ivars' `ipps' `cout' `iout' 1 1 1 1 1

label var age "Age at interview, mean"
label var aveincome "Income, mean"
label var tot_paid_by_mc_12m "Total paid by MC 12m post interview, mean"
label var n_hospd_p12m "Total hospital days 12m post interview, mean"
label var died_12 "Died 12m post interview"
label var ind_hosp_adm_p12m "Any hospital admission 12m post interview"
label var educ_hs_ind "Education: HS+"
mat tab=J(`rn',4,.)
local r=1
local c=1

forvalues i=0/3 {
	local r=1 
	foreach x in vars pps out {
		foreach y in `c`x'' {
			sum `y' if payment_cat==`i' [aw=anfinw]
			mat tab[`r',`c']=r(mean)
			local r=`r'+1
}
		foreach y in `i`x'' {
			sum `y' if payment_cat==`i' [aw=anfinw]
			mat tab[`r',`c']=r(mean)*100
			local r=`r'+1
}
		local r=`r'+1
}
	sum n if payment_cat==`i'  [aw=anfinw]
	mat tab[`r',`c']=r(N)
	mat tab[`r'+1,`c']=r(sum)
	local c=`c'+1
	local lab`i' : label payment_cat `i'
}

mat rownames tab=`cvars' `ivars' "Estimated PPS score" `ipps' ///
"Outcomes" `cout' `iout' "_" "N" "National Estimate"

frmttable using "`logpath'/pps_table_1_with_outcomes.rtf", statmat(tab) sdec(2) varlabels ctitles("" "`lab0'" "`lab1'" "`lab2'" ///
"`lab3'") title("NHATS Sample Characteristics and Outcomes""by payment category") ///
replace note("NHATS 2011 Sample w/ 6+ months FFS pre interview, community dwelling (not nursing home) with SP interview")


H="looking at those with no utilization"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "`datapath'\pps_sample.dta" if nhres==0, clear


/*do table-1-style characteristics and basic outcomes by payment group
*/

log using `logpath'/pps_sample_chars.txt, text replace
gen n=1
replace payment_cat=3 if !payment_cat & disease==1 & (adl_impair==1 | ///
bed_or_chair==1 | oxygen==1 | pps<=60 | (pps==70 & smi_cancer==1))
label define payment_cat 3 "Does not meet utilization criteria but does others", modify
local pps ambulation disease health_keep   pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk ///
nohousework ind_diff activity_cat self_care pps weightloss smi_count ///
sig_symp any_disch_1m ss1prbbrlim ss1painl ind_indication payment_cat

local ind_indication weightloss smi_count ss1prbbrlim ss1painl  sig_symp any_disch_1m

forvalues i=30(10)100 {
	gen pps`i'=pps==`i' if !missing(pps)
	label var pps`i' "PPS--`i'"
}

gen breath_lim=ss1prbbrlimt==1 
gen pain_lim=ss1painlimt==1 if ss1painlimts>-8
gen ind_mult_smi=smi_count>=2 & !missing(smi_count)
tab ambulation, gen(ambulation)
tab self_care, gen(self_care)
tab activity_cat, gen(activity_cat)
label var breath_lim "Breathing problem limits activity"
label var pain_lim "Pain limits activity"
foreach y in ambulation self_care activity_cat {
local `y'
levelsof `y', local(levels)
foreach l of local levels {
local lab : label `y' `l'
label var `y'`l' "`lab'"
local `y' ``y'' `y'`l'
}
di "``y''"
}
foreach x in pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk {
	replace `x'=. if `x'<0
	replace `x'=0 if `x'==2
}
drop if payment_cat<3
replace payment_cat=1 if !n_ip_admit_6m & !ed_op
replace payment_cat=2 if ed_op
foreach x of varlist smi* dmouth* {
replace `x'=0 if missing(`x')
}

gen smi_any=smi_count>=1 | criteria_smi==1
label var smi_any "Any serious medical illness"
drop smi_count smi_nh_ind smi_and_adl 
gen dmouth_any=dmouth_index>=1 & !missing(dmouth_index)
label var dmouth_any "Any chronic disease, Dartmouth"
gen dmouth_ge3_ind=dmouth_index>=3
label var dmouth_ge3_ind "3+ Chronic diseases, Dartmouth"
drop dmouth_index
local dmouth
foreach x of varlist dmouth* {
	local dmouth `dmouth' `x'
}

local smi 
foreach x of varlist smi* {
	local smi `smi' `x'
}


local ind_indication weightloss ind_mult_smi sig_symp breath_lim pain_lim any_disch_1m
local pps `ambulation' disease health_keep pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk ///
nohousework ind_diff `activity_cat' `self_care' ind_indication


local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married educ_hs_ind
local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind /*smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind */ser_med_illness nhres 

local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m

 
sum `cvars1' `cvars2' `ivars1' `ivars2' `ioutcomes' `coutcomes' `pps' `ind_indication'

local cvars age aveincome
local ivars female white black hisp other_race married educ_hs_ind proxy ///
medicaid medigap srh_fp adl_independent /*iadl_independent*/ `pps' `ind_indication' ///
`dmouth' `smi'
local ipps pps100 pps90 pps80 ///
pps70 pps60 pps50 pps40 pps30 
local cout tot_paid_by_mc_12m n_hospd_p12m
local iout ind_hosp_adm_p12m died_12


local rn : word count `cvars' `ivars' `ipps' `cout' `iout' 1 1 1 1 1

label var age "Age at interview, mean"
label var aveincome "Income, mean"
label var tot_paid_by_mc_12m "Total paid by MC 12m post interview, mean"
label var n_hospd_p12m "Total hospital days 12m post interview, mean"
label var died_12 "Died 12m post interview"
label var ind_hosp_adm_p12m "Any hospital admission 12m post interview"
label var educ_hs_ind "Education: HS+"
mat tab=J(`rn',4,.)
local r=1
local c=1

forvalues i=0/3 {
	local r=1 
	foreach x in vars pps out {
		foreach y in `c`x'' {
			sum `y' if payment_cat==`i' //[aw=anfinw]
			mat tab[`r',`c']=r(N)
			local r=`r'+1
}
		foreach y in `i`x'' {
			sum `y' if payment_cat==`i' //[aw=anfinw]
			mat tab[`r',`c']=r(mean)*r(N)
			local r=`r'+1
}
		local r=`r'+1
}
	sum n if payment_cat==`i'  [aw=anfinw]
	mat tab[`r',`c']=r(N)
	mat tab[`r'+1,`c']=r(sum)
	local c=`c'+1
	local lab`i' : label payment_cat `i'
}

mat rownames tab=`cvars' `ivars' "Estimated PPS score" `ipps' ///
"Outcomes" `cout' `iout' "_" "N" "National Estimate"

frmttable using "`logpath'/pps_table_1_with_outcomes.rtf", statmat(tab) sdec(0) varlabels ctitles("" "`lab0'" "`lab1'" "`lab2'" ///
"`lab3'") title("NHATS Sample Characteristics and Outcomes""by payment category") ///
replace ///
note("NHATS 2011 Sample w/ 6+ months FFS pre interview, community dwelling (not nursing home) with SP interview; HIV, ALS, hip fracture, and liver disease not shown due to cell size restriction" ///
"* -not shown for cell size restriction") ///
landscape basefont(fs10) 

local rn : word count `cvars' `ivars' `ipps' `cout' `iout' 1 1 1 1 1

label var age "Age at interview, mean"
label var aveincome "Income, mean"
label var tot_paid_by_mc_12m "Total paid by MC 12m post interview, mean"
label var n_hospd_p12m "Total hospital days 12m post interview, mean"
label var died_12 "Died 12m post interview"
label var ind_hosp_adm_p12m "Any hospital admission 12m post interview"
label var educ_hs_ind "Education: HS+"
mat tab=J(`rn',4,.)
local r=1
local c=1

forvalues i=0/3 {
	local r=1 
	foreach x in vars pps out {
		foreach y in `c`x'' {
			sum `y' if payment_cat==`i' [aw=anfinw]
			mat tab[`r',`c']=r(mean)
			local r=`r'+1
}
		foreach y in `i`x'' {
			sum `y' if payment_cat==`i' [aw=anfinw]
			mat tab[`r',`c']=r(mean)*100
			local r=`r'+1
}
		local r=`r'+1
}
	sum n if payment_cat==`i'  [aw=anfinw]
	mat tab[`r',`c']=r(N)
	mat tab[`r'+1,`c']=r(sum)
	local c=`c'+1
	local lab`i' : label payment_cat `i'
}

mat rownames tab=`cvars' `ivars' "Estimated PPS score" `ipps' ///
"Outcomes" `cout' `iout' "_" "N" "National Estimate"

frmttable using "`logpath'/pps_table_1_with_outcomes.rtf", statmat(tab) sdec(2) varlabels ctitles("" "`lab0'" "`lab1'" "`lab2'" ///
) title("NHATS Sample Characteristics and Outcomes""by payment category") ///
addtable ///
note("NHATS 2011 Sample w/ 6+ months FFS pre interview, community dwelling (not nursing home) with SP interview; HIV, ALS, hip fracture, and liver disease not shown due to cell size restriction" ///
"* -not shown for cell size restriction") ///
landscape basefont(fs10)



H="sensitivity and specificity"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "E:\nhats\data\CMS_DUA_28016\Merged Stata\dm_09_12.dta", clear
keep bene_id admit_date disch_date hcpcs_cd betos
gen wave=1
merge m:1 bene_id wave using ///
 "E:\nhats\data\Projects\pal_perf_scale\final_data\serious_ill_nhats_sample.dta", ///
 keep(match) keepusing(spid index_date)
keep if inrange(admit_date,index_date-186,index_date)

gen wc_betosa=betos=="D1D"
gen bed_betosa=betos=="D1B"

gen ind_wheelchaira=inlist(hcpcs_cd, "E1088","E1090","E1093","E1140","E1150","E1161") ///
 | inlist(hcpcs_cd,"E1220","E1226","E1230","E1232") ///
 | inlist(hcpcs_cd, "E1240","E1260","E1270","E2201","E2203") | inlist(hcpcs_cd,"E2206","E2208","E2209","E2210","E2226") ///
 | inlist(hcpcs_cd, "E2310","E2321","E2323","E2340","E2361") | inlist(hcpcs_cd,"E2363","E2364","E2365","E2366","E2367") ///
 | inlist(hcpcs_cd, "E2368","E2370","E2374","E2375","E2381") | inlist(hcpcs_cd,"E2382","E2383","E2386","E2387","E2389") ///
 | inlist(hcpcs_cd, "E2392","E2394","E2395","E2601","E2602") | inlist(hcpcs_cd,"E2603","E2604","E2605","E2607","E2608") ///
 | inlist(hcpcs_cd, "E2611","E2615","E2619","E2620","E2622") | inlist(hcpcs_cd,"E2623","E2624","K0001","K0002","K0003") ///
 | inlist(hcpcs_cd, "K0004","K0005","K0006","K0007","K0009") | inlist(hcpcs_cd,"K0010","K0011","K0012","K0014","K0015") ///
 | inlist(hcpcs_cd,"K0017","K0019","K0040","K0045","K0046") | inlist(hcpcs_cd,"K0047","K0053","K0056","K0069","K0070") ///
 | inlist(hcpcs_cd, "K0071","K0077","K0108","K0195","K0733") | inlist(hcpcs_cd,"K0734","K0735","K0736","K0800","K0806") ///
 | inlist(hcpcs_cd, "K0808","K0813","K0814","K0815","K0816") | inlist(hcpcs_cd,"K0821","K0822","K0823","K0824","K0825") ///
 | inlist(hcpcs_cd, "K0835","K0842","K0843","K0848","K0849") | inlist(hcpcs_cd,"K0856","K0861","K0877")																											

gen ind_hosp_beda=inlist(hcpcs_cd,"E0250","E0255","E0256") | inlist(hcpcs_cd,"E0260","E0261","E0265","E0271","E0272","E0274","E0277") ///
 | inlist(hcpcs_cd,"E0293","E0294","E0295","E0303","E0305") | inlist(hcpcs_cd,"E0310","E0316","E0860","E0870","E0910") ///
 | inlist(hcpcs_cd,"E0912","E0940","E0946","E0948","E0943") | inlist(hcpcs_cd,"K0456","K0549")																																																																																																												

keep spid bene_id index_date ind_* *_betosa
duplicates drop

foreach x of varlist *a {
	by spid, sort: egen `x'1=max(`x')
	drop `x'
}

rename *a1 *
duplicates drop

tempfile dme
save `dme'


use "`datapath'\serious_ill_nhats_sample.dta"
merge 1:1 spid index_date using `dme', gen(dmem) keep(match master)
replace ind_wheelchair=0 if missing(ind_whe)
replace ind_hosp_bed=0 if missing(ind_hosp_bed)
replace oxygen=0 if missing(oxygen)
gen bed_or_chair=ind_wheelchair | ind_hosp_bed

cd `logpath'
//note, this is temporary, we should pull all into main xwave set
merge 1:1 spid using "E:\nhats\data\NHATS Public\round_1\NHATS_Round_1_SP_File.dta", ///
nogen keep(match master)
gen pain=ss1painbothr==1
gen pain_limit=ss1painlim==1
gen weightloss=hw1lst10pnds==1 & hw1trytolose==2 
gen dem_probable=dem_3_cat==1
/*pulling, for all Dartmouth conditions, as well as criteria A, B, C:
 -for all and those with 6m HH/SNF use or NH res
 -N
 -1yr outcomes: spending, mortality, hospitalization
 -screens: SRH, ADLs, weight loss, pain, probable dementia
 -same 1yr outcomes
*/

sum tot_paid_by_mc_12m,d
gen ind_top10=tot_paid_by_mc_12m>=r(p90) if !missing(tot_paid_by_mc_12m)
label var ind_top10 "Top 10% of MC costs"

local d1 "Cancer"
local d2 "COPD"
local d3 "CAD"
local d4 "CHF"
local d5 "PVD"
local d6 "Liver"
local d7 "Diabetes"
local d8 "Renal"
local d9 "Dementia"
local d10 "3cond"
*local d11 "2cond"
*local d12 "3cond"
foreach x of varlist dmouth_* {
replace `x'=0 if missing(`x')
}
gen dmouth_10_0_6m=dmouth_index_0_6m>=3
gen dmouth_11_0_6m=dmouth_index_0_6m>=2
gen dmouth_12_0_6m=dmouth_index_0_6m>=3
gen prob_func_diff=ind_hh_6m ==1 | ind_snf_6m==1 | nhres==1


label var weightloss "Unintentional weight loss"
label var pain "Pain reported"
label var pain_limit "Pain limits activities"
label var dem_probable "Probable dementia"
label var ind_hh_6m "Any Home health expenditures previous 6m"
label var ind_snf_6m "Any SNF stay previous 6m"
label var prob_func "HH/SNF use 6m prior or NH resident"
label var tot_paid_by_mc_12m "Total MC expenditures 12m post, mean(SD)"
label var died_12 "Died 12m post ivw"
label var dmouth_10_0 "3+ Chronic Conditions, Dartmouth"
*label var dmouth_11_0 "2+ Chronic Conditions, Dartmouth"
*label var dmouth_12_0 "3+ Chronic Conditions, Dartmouth"
label var adl_impair "ADL impairment at interview"
gen ind_hh_snf=ind_hh_6m==1 | ind_snf_6m==1
label var ind_hh_snf "HH/SNF use 6m prior to ivw"

local coutcomes tot_paid_by_mc_12m 
local ioutcomes ind_top10 died_12 ind_hosp_adm_p12m
local firstlev ind_hh_6m ind_snf_6m ind_hh_snf  nhres
local nextlev  adl_impair srh_fp weightloss pain pain_limit ///
dem_probable
local criteria criteria_a criteria_b criteria_c

gen screener=0
foreach x in `nextlev' {
	replace screener=1 if `x'==1
}
local nextlev  adl_impair srh_fp weightloss pain pain_limit ///
dem_probable screener hh_snf_screen

gen hh_snf_screen=ind_hh_snf==1 & screener==1
label var hh_snf_screen "HH or SNF and screen"


foreach x in `firstlev' `nextlev' {
	replace `x'=0 if missing(`x') & nhres==1
}

label var screener "Any of ADL/PF SRH/weightloss/prob dem/pain"
local rn : word count `firstlev' `nextlev' `criteria' 1 `coutcomes' `ioutcomes' 1

forvalues d=1/10 {
preserve
local hosp
local note
local title : var label dmouth_`d'_0_6m

foreach timethrough in 1 2 {
mat tab1=J(`rn',6,.)
local r=1
local c=1
foreach crit in criteria_all sp_ivw nhres {
	sum dmouth_`d'_0_6m if `crit'==1
	mat tab1[`r',`c']=r(mean)*r(N)
	mat tab1[`r',`c'+1]=r(mean)*100
	local r=`r'+1
	foreach x in `firstlev' `nextlev' `criteria' {
		sum `x' if dmouth_`d'_0_6m==1 & `crit'==1
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
	local r=`r'+1
	foreach x in `coutcomes' {
		sum `x' if dmouth_`d'_0_6m==1 & `crit'==1
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		local r=`r'+1
}
	foreach x in `ioutcomes' {
		sum `x' if dmouth_`d'_0_6m==1 & `crit'==1
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}

	local r=1
	local c=`c'+2
}


mat rownames tab1="`d`d''_yes" `firstlev' `nextlev' `criteria' "Outcomes" ///
`coutcomes' `ioutcomes'


local sdec "0\2"
forvalues i=1/`=`rn'-1' {
	local sdec "`sdec'\0\2"
}
di "`sdec'"
frmttable using condition_tables_`d`d''`hosp'.rtf, statmat(tab1) ///
ctitles("" "Full sample" "Criteria A" "Criteria B" ///
 "Criteria C") varlabels substat(1) landscape ///
 sdec(`sdec') replace note(`note') title(`title')
keep if ind_hosp_adm_6m==1
local hosp "_hosp"
local note "Restricted to those with hospitalization 6m pre-ivw"
}
restore

local hosp
local note
local title : var label dmouth_`d'_0_6m
foreach group in sp_ivw nhres {
local groupname "Community dwelling"
if "`group'"=="nhres" local groupname "NH Residents"
preserve
keep if `group'==1

foreach timethrough in 1 2 {
mat tab1=J(`rn',8,.)

local r=1
local c=1

foreach crit in criteria_all ind_hh_snf screener hh_snf_screen {
	sum dmouth_`d'_0_6m if `crit'==1
	mat tab1[`r',`c']=r(mean)*r(N)
	mat tab1[`r',`c'+1]=r(mean)*100
	local r=`r'+1
	foreach x in `firstlev' `nextlev' `criteria' {
		sum `x' if dmouth_`d'_0_6m==1 & `crit'==1
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
	local r=`r'+1
	foreach x in `coutcomes' {
		sum `x' if dmouth_`d'_0_6m==1 & `crit'==1
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		local r=`r'+1
}
	foreach x in `ioutcomes' {
		sum `x' if dmouth_`d'_0_6m==1 & `crit'==1
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}

	local r=1
	local c=`c'+2
}


mat rownames tab1="`d`d''_yes" `firstlev' `nextlev' `criteria' "Outcomes" ///
`coutcomes' `ioutcomes'


local sdec "0\2"
forvalues i=1/`=`rn'-1' {
	local sdec "`sdec'\0\2"
}
di "`sdec'"
frmttable using condition_tables_`d`d''`hosp'.rtf, statmat(tab1) ///
ctitles("" "" "Full sample" "HH/SNF" "Screener" "Both") varlabels substat(1) landscape ///
 sdec(`sdec') addtable note(`note') title("`title' `groupname'")
keep if ind_hosp_adm_6m==1
/*local hosp "_hosp"
local note "Restricted to those with hospitalization 6m pre-ivw"
*/

mat tab=J(9,4,.)
local r=2
local c=1

foreach x in `ioutcomes' {
foreach crit in criteria_all ind_hh_snf screener hh_snf_screen {
	tab `x' dmouth_`d'_0_6m if `crit'==1, matcell(cell)
	mat tab[`r',`c']=(cell[2,2]/(cell[2,2]+cell[1,2]))*100
	mat tab[`r'+1,`c']=(cell[2,1]/(cell[2,1]+cell[1,1]))*100
	local c=`c'+1
}
	local r=`r'+3
	local c=1
}


frmttable using condition_tables_`d`d''`hosp'.rtf, statmat(tab) ///
ctitles("" "" "Full sample" "HH/SNF" "Screener" "Both") varlabels landscape ///
 sdec(2) addtable note(`note') title("`title' `groupname'") ///
 rtitles("Top 10% spending"\"	Sensitivity"\"	Specificity"\ ///
"Death within 1 year"\"	Sensitivity"\"	Specificity"\ ///
"Hospitalization within 1 year"\"	Sensitivity"\"	Specificity" )

local hosp "_hosp"
local note "Restricted to those with hospitalization 6m pre-ivw"

}	
	
restore
}
}


gen group1=dmouth_index>=1 & ind_hosp_adm_6m if !missing(dmouth_index)
gen group2=group1==1 & (ind_hh_snf==1 | bed_or_chair==1 | oxygen==1)
gen group3=smi_count>=1 & ind_hosp_adm_6m if !missing(smi_count)
gen group4=group3==1 & (ind_hh_snf==1 | bed_or_chair==1 | oxygen==1)
gen group5=smi_count>=1 & adl_impair==1 if !missing(smi_count)
gen group6=group5==1 & group3==1
egen screener_2=rowtotal(`nextlev')
replace screener_2=screener_2>2 & !missing(screener_2)
local out ind_top10 ind_hosp_adm_p12m died_12 screener_2

/*
local rn : word count `coutcomes' `ioutcomes'

mat tab=J(`rn',12,.)
local r=1
local c=1
forvalues i=1/6 {
	foreach x in `coutcomes' {
		sum `x' if group`i'==1
		mat tab[`r',`c']=r(mean)
		mat tab[`r',`c'+1]=r(sd)
		local r=`r'+1
}
	foreach x in `ioutcomes' {
		sum `x' if group`i'==1
		mat tab[`r',`c']=r(mean)*r(N)
		mat tab[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
local r=1
local c=`c'+2
}


local sdec "0\2"
forvalues i=1/`=`rn'-1' {
	local sdec "`sdec'\0\2"
}

frmttable using condition_tables_sens_spec.rtf, statmat(tab) substat(1) ///
sdec(`sdec') title("Outcomes") ctitles("" "Cond & hosp" "Cond, hosp, HH/SNF/DME" ///
"SMI & hosp" "SMI, hosp, HH/SNF/DME" "SMI & ADL" "SMI, hosp, & ADL") replace ///
rtitles("Mean Spending"\"	SD"\"Top 10% Spending"\"	%" ///
"Died within 1 year"\"	 %"\"Hospitalization within 1 year"\"	%")
*/
local xvars ind_top10 died_12 ind_hosp_adm_p12m screener_2 adl_impair
local rn : word count `xvars' `coutcomes'

mat tab=J(`rn'*3,6,.)
local r=2
local c=1

forvalues i=1/6 {
	foreach x in `coutcomes' {
		sum `x' if group`i'==1
		mat tab[`r',`c']=r(mean)
		mat tab[`r'+1,`c']=r(sd)
		local r=`r'+3
}

	foreach x in `xvars' {
		sum `x' if group`i'==1
		mat tab[`r',`c']=r(mean)*100
		sum group`i' if `x'==1
		mat tab[`r'+1,`c']=r(mean)*100
		local r=`r'+3
}	
	local r=2
	local c=`c'+1
}
frmttable using condition_tables_sens_spec.rtf, statmat(tab) ///
varlabels replace sdec(2) title("Inclusion and Identification") ///
 rtitles("Medicare Expenditures"\ "Mean"\"SD"\"Top 10% spending" \"    %"\ "    % identified by criteria"\ ///
 "Death within 1 year" \"    %"\ "    % identified by criteria"\ ///
 "Hospitalization within 1 year" \"    %"\ "    % identified by criteria"\ ///
 "2+ on screener"\"    %"\ "    % identified by criteria"\ ///
 "ADL impairment"\"    %"\ "    % identified by criteria") ///
ctitles("" "Cond & hosp" "Cond, hosp, HH/SNF/DME" "SMI & hosp" "SMI, hosp, HH/SNF/DME" ///
"SMI & ADL" "SMI, hosp, & ADL")

local rn : word count `out'
mat tab=J(`rn'*4+2,6,.)
local r=2
local c=1

foreach x in `out' {
	forvalues i=1/6 {
		tab group`i' `x', matcell(cell)
		mat tab[`r',`c']=(cell[2,2]/(cell[2,2]+cell[1,2]))*100
		mat tab[`r'+1,`c']=(cell[1,1]/(cell[2,1]+cell[1,1]))*100
		roctab `x' group`i'
		mat tab[`r'+2,`c']=r(area)
		sum group`i' if group`i'==1 [aw=anfin]
		mat tab[`r'+3,`c']=r(N)
		mat tab[`r'+4,`c']=r(sum)		
		local c=`c'+1
}
	local r=`r'+4

	local c=1
}



frmttable using condition_tables_sens_spec.rtf, statmat(tab) ///
varlabels addtable sdec(2) title("Sensitivity and Specificity") ///
 rtitles("Top 10% spending" \"	Sensitivity"\"	Specificity"\"	ROC AUC"\ ///
 "Death within 1 year" \"	Sensitivity"\"	Specificity"\"	ROC AUC"\ ///
 "Hospitalization within 1 year" \"	Sensitivity"\"	Specificity"\"	ROC AUC"\ ///
 "2+ on screener"\"	Sensitivity"\"	Specificity"\"	ROC AUC" \"N" \"Nat'l Estimate") ///
ctitles("" "Cond & hosp" "Cond, hosp, HH/SNF/DME" "SMI & hosp" "SMI, hosp, HH/SNF/DME" ///
"SMI & ADL" "SMI, hosp, & ADL")






H="7/24 update"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "E:\nhats\data\CMS_DUA_28016\Merged Stata\dm_09_12.dta", clear
keep bene_id admit_date disch_date hcpcs_cd betos
gen wave=1
merge m:1 bene_id wave using ///
 "E:\nhats\data\Projects\pal_perf_scale\final_data\serious_ill_nhats_sample.dta", ///
 keep(match) keepusing(spid index_date)
keep if inrange(admit_date,index_date-186,index_date)

gen wc_betosa=betos=="D1D"
gen bed_betosa=betos=="D1B"

gen ind_wheelchaira=inlist(hcpcs_cd, "E1088","E1090","E1093","E1140","E1150","E1161") ///
 | inlist(hcpcs_cd,"E1220","E1226","E1230","E1232") ///
 | inlist(hcpcs_cd, "E1240","E1260","E1270","E2201","E2203") | inlist(hcpcs_cd,"E2206","E2208","E2209","E2210","E2226") ///
 | inlist(hcpcs_cd, "E2310","E2321","E2323","E2340","E2361") | inlist(hcpcs_cd,"E2363","E2364","E2365","E2366","E2367") ///
 | inlist(hcpcs_cd, "E2368","E2370","E2374","E2375","E2381") | inlist(hcpcs_cd,"E2382","E2383","E2386","E2387","E2389") ///
 | inlist(hcpcs_cd, "E2392","E2394","E2395","E2601","E2602") | inlist(hcpcs_cd,"E2603","E2604","E2605","E2607","E2608") ///
 | inlist(hcpcs_cd, "E2611","E2615","E2619","E2620","E2622") | inlist(hcpcs_cd,"E2623","E2624","K0001","K0002","K0003") ///
 | inlist(hcpcs_cd, "K0004","K0005","K0006","K0007","K0009") | inlist(hcpcs_cd,"K0010","K0011","K0012","K0014","K0015") ///
 | inlist(hcpcs_cd,"K0017","K0019","K0040","K0045","K0046") | inlist(hcpcs_cd,"K0047","K0053","K0056","K0069","K0070") ///
 | inlist(hcpcs_cd, "K0071","K0077","K0108","K0195","K0733") | inlist(hcpcs_cd,"K0734","K0735","K0736","K0800","K0806") ///
 | inlist(hcpcs_cd, "K0808","K0813","K0814","K0815","K0816") | inlist(hcpcs_cd,"K0821","K0822","K0823","K0824","K0825") ///
 | inlist(hcpcs_cd, "K0835","K0842","K0843","K0848","K0849") | inlist(hcpcs_cd,"K0856","K0861","K0877")																											

gen ind_hosp_beda=inlist(hcpcs_cd,"E0250","E0255","E0256") | inlist(hcpcs_cd,"E0260","E0261","E0265","E0271","E0272","E0274","E0277") ///
 | inlist(hcpcs_cd,"E0293","E0294","E0295","E0303","E0305") | inlist(hcpcs_cd,"E0310","E0316","E0860","E0870","E0910") ///
 | inlist(hcpcs_cd,"E0912","E0940","E0946","E0948","E0943") | inlist(hcpcs_cd,"K0456","K0549")																																																																																																												

keep spid bene_id index_date ind_* *_betosa
duplicates drop

foreach x of varlist *a {
	by spid, sort: egen `x'1=max(`x')
	drop `x'
}

rename *a1 *
duplicates drop

tempfile dme
save `dme'


use "E:\nhats\data\NHATS cleaned\nsoc_round_1.dta", clear
gen diffany=0
foreach x in emotional physical financial {
	replace diffany=1 if diff_`x'_lv==1
}
label var diffany "Any CG-reported financial/emotional/physical difficulty (NSOC)"
keep if cg_primary_nsoc==1
keep spid diffany
tempfile nsoc
save `nsoc'
use "`datapath'\serious_ill_nhats_sample.dta" if sp_ivw==1 | nhres==1
cd `logpath'
merge 1:1 spid using `nsoc', nogen keep(match master)
replace diffany=0 if missing(diffany) 
//note, this is temporary, we should pull all into main xwave set
merge 1:1 spid using "E:\nhats\data\NHATS Public\round_1\NHATS_Round_1_SP_File.dta", ///
nogen keep(match master)
//merge to get 1m discharge
merge 1:1 spid index_date using ///
"E:\nhats\data\Projects\pal_perf_scale\disch_1m.dta", ///
gen(ipm) keep(match master)
merge 1:1 spid index_date using `dme', gen(dmem) keep(match master)
replace ind_wheelchair=0 if missing(ind_whe)
replace ind_hosp_bed=0 if missing(ind_hosp_bed)
replace oxygen=0 if missing(oxygen)
gen bed_or_chair=ind_wheelchair | ind_hosp_bed

gen adl_diff_insd=mo1insddif>1 if mo1insddif>0
gen pain=ss1painbothr==1
gen sob=ss1probbreat==1
gen upper=ss1strnglmup==1
gen energy=ss1lowenergy==1
gen lower=ss1lwrbodstr==1
gen balance=ss1prbbalcrd==1
gen insomnia=inlist(hc1sleepmed,1,2) | inlist(hc1aslep30mn,1,2) | ///
inlist(hc1trbfalbck,1,2)
gen weightloss=hw1lst10pnds==1 & hw1trytolose==2 

gen dem_probable=dem_3_cat==1
/*7/7/17 update-3+ Dartmouth comorbidities counts as SMI*/
replace smi_count=smi_count+1 if dmouth_index>=3 & !missing(dmouth_index)
replace criteria_smi=1 if  dmouth_index>=3 & !missing(dmouth_index)

//define PPS
/*what are we pulling?
	-symptoms--Tacara's list
	-sudden weightloss
	-any smi
	-difficulty walking inside
	-ADL difficulty no help
	-health/function prevent activity
	-nhres

	
	PPS
		-80+, no difficulty in ADLs or difficulty with effort
		-70-difficulty
}

*/

/*5/24/17--switch from health keeps anything to health keeps work, rel svces, 
going out for enjoyment*/

gen health_keep=0
foreach x of varlist pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk {
	replace health_keep=1 if `x'==1
}

gen hkindex=0
foreach x of varlist pa1h* {
	*replace health_keep=1 if `x'==1
	replace hkindex=hkindex+1 if `x'==1
}

gen activity_cat=1 if adl_diff_index==0 & nhres==0
replace iadl_diff_index=iadl_diff_index+1 if ind_meds_diff==1
replace adl_diff_index=adl_diff_index+1 if adl_diff_insd==1
replace adl_diff_index=adl_diff_index+1 if inrange(mo1beddif,2,4)
replace activity_cat=2 if (inrange(adl_diff_index,1,6) | inrange(iadl_diff_index,1,6)) ///
| adl_impair==1 | iadl_impair==1
replace activity_cat=3 if health_keep==1 & activity_cat==2
gen nohousework=(inlist(ha1dmealreas,1,3) & inlist(ha1dmealsfdf,1,8)) & ///
(inlist(ha1dlaunreas,1,3) & inlist(ha1dlaunsfdf,1,8))
gen ind_diff=(inrange(adl_diff_index,1,6) | inrange(iadl_diff_index,1,6)) ///
& (!missing(adl_diff_index) | !missing(iadl_diff_index))
label var nohousework "Did not prepare meals or do laundry by self due to health"
label var ind_diff "Any difficulty in ADLs or IADLs"
replace activity_cat=4 if nohou
label define activity_cat 1 "No difficulty reported" 2 "Difficulty in ADLs/IADLs" ///
3 "Difficulty & unable to do activities b/c health" 4 "Unable to prepare meals or do laundry"
label values activity_cat activity_cat

*rename mo1dinsds ambulation

gen ambulation=1 if inlist(mo1dinsds,2,3,6)
replace ambulation=2 if mo1dinsds==1 | adl_ins_help==1 | adl_bed_help | mo1insdwout==1
replace ambulation=3 if mo1dbedsfdf==1
replace ambulation=4 if mo1dinsds==8
*replace ambulation=2 if mo1oflv>=1
label define ambulation 1 "Full ambulation" ///
2 "Reports help getting around inside or getting out of bed, or not going parts home by self" ///
3 "Reports not getting out of bed by self" 4 "Reports not moving around inside at all in past month"

label values ambulation ambulation
gen disease=criteria_smi==1
label var disease "Any SMI"

gen freq_help=0
foreach x in sc1eatslfoft sc1dresslf sc1toiloft sc1bathoft mo1bedslf mo1insdslf {
replace freq_help=`x' if `x'>freq_help
}

gen self_care=(freq_help==1)+1
replace self_care=3 if freq_help==2
replace self_care=4 if freq_help==3
replace self_care=5 if freq_help==4
label define self_care 1 "No assistance" 2 "Care dependent, mostly do by self" 3 "Sometimes do by self" ///
4 "Rarely do by self" 5 "Never do by self"
label values self_care self_care

gen intake=weightloss==1
label var intake "Intake (unintentional weightloss)"

tab1 ambulation activity self_care intake
/*
gen pps=100 if ambulation==1 
replace pps=90 if pps==100 & disease==1
replace pps=80 if pps==90 & activity_cat==2 & self_care==1
replace pps=70 if ambulation==2
replace pps=60 if (pps==70 & activity_cat==3) | nhres==1
replace pps=50 if ambulation==3
replace pps=40 if pps==50 &  self_care>=2
replace pps=30 if ambulation==4
*/


log using pps_log.txt, text replace
//first, ambulation
gen pps=100 if ambulation==1
replace pps=70 if ambulation==2
replace pps=50 if ambulation==3
replace pps=30 if ambulation==4

tab pps ambulation

//next, activity & disease
replace pps=90 if pps>90 & disease==1 
replace pps=80 if pps>80 & activity_cat==2 
replace pps=70 if pps>70 & activity_cat==3
replace pps=60 if pps>60 & activity_cat==4

tab pps disease
tab pps activity

//self-care (ADLs)
replace pps=60 if pps>60 & self_care==2
replace pps=50 if pps>50 & self_care==3
replace pps=40 if pps>40 & self_care==4
replace pps=30 if pps>30 & self_care==5

tab pps self_care

//nhres (no survey)
replace pps=60 if pps>60 & nhres==1



local symp pain sob upper energy lower balance insomnia weightloss ///
sr_phq2_depressed sr_gad2_anxiety
egen index_symp=rowtotal(`symp')
gen ind_ge3_symp=index_symp>=3 if !missing(index_symp)

//5/24/17--go just for pain/breathing problems limit activity
gen sig_symp=ss1prbbrlim==1 | ss1painl==1
label var sig_symp "Significant symptom burden--activity limited by pain or breathing problem"

gen ind_indication=/*weightloss==1 |*/ (smi_count>=2 & !missing(smi_count)) | ///
sig_symp==1 | any_disch_1m==1
label var ind_indication "1+ high-need indication"
/* Update 7/7/17--
the payment categories have been altered so that we've got just two groups--
	moderate complexity 
		PPS 60 or ADL or DME claim and cancer
		PPS 70 or ADL or DME claim and noncancer
		SMI 
		2 IP stays or 1 and separate ED visit
	severe complexity
		like moderate, except excludes dementia if only smi and 50/60 PPS instead
		of 60/70
*/

/*Update 7/27/17--
update to include obs stays and latest utilization changes from AAHPM

now utilization is ed or obs or ip stay for moderate and 1 ip stay and 1 other for
severe*/

/*payment category from apm

uses: 
pps

other high need indications:
weightloss (sudden nutritional/functional decline)
smi_count (multiple serious illnesses)
ind_ge3_symp (significant symptom distress--3+ on symptom index)
any_disch_1m (inp discharge w/in 30 days)
not currrently used--frail cg or remote location
*/

replace smi_count=0 if missing(smi_count)
gen utilization=ind_hosp_adm_6m==1 | ed_op==1 | obs_stay==1
gen function=pps<=60 | (pps<=70 & smi_cancer_ind==1) | adl_impair==1 | ///
oxygen==1 | bed_or_chair==1
gen payment_cat=0 if pps>=80
replace payment_cat=1 if (pps<=60 | ///
bed_or_chair==1 | oxygen==1 | adl_impair==1) & criteria_smi==1 & (n_ip_admit_6m>=1 | ///
obs_stay==1 | ed_op_wout_adm_ind==1)
replace payment_cat=1 if (smi_cancer_ind==1) & (pps<=70 | ///
bed_or_chair==1 | oxygen==1 | adl_impair==1) & criteria_smi==1 & (n_ip_admit_6m>=1 | ///
obs_stay==1 | ed_op_wout_adm_ind==1)
replace payment_cat=2 if smi_cancer_ind==1 & (pps<=60 | ///
bed_or_chair==1 | oxygen==1 | adl_impair==1) & criteria_smi==1 & (n_ip_admit_6m>=2 | ///
(ind_hosp_adm_6m & (obs_stay==1 | ed_op_wout_adm_ind==1)))
replace payment_cat=2 if (smi_cancer_ind==0) & (pps<=50 | ///
bed_or_chair==1 | oxygen==1 | adl_impair==1) & criteria_smi==1 & (n_ip_admit_6m>=2 | ///
(ind_hosp_adm_6m & (obs_stay==1 | ed_op_wout_adm_ind==1)))
replace payment_cat=1 if payment_cat==2 & smi_dem_ind==1 & smi_count==1 
*replace payment_cat=0 if n_ip_admit_6m==0 | (n_ip_admit_6m==1 & ed_op_wout==0)
replace payment_cat=0 if criteria_smi==0 | missing(payment_cat)

gen old_payment_cat=0 if pps>=80
replace old_payment_cat=1 if pps==80 & ind_indication==1
replace old_payment_cat=2 if pps<70 
replace old_payment_cat=2 if pps==70 & ind_indication==1
replace old_payment_cat=3 if pps<50
replace old_payment_cat=3 if pps<70 & ind_indication==1
replace old_payment_cat=0 if criteria_smi!=1
label define old_payment_cat 0 "Low risk patients (not on scale)" 1 "Low-moderate need/risk patients" ///
2 "Moderate need/risk patients" 3 "High need/risk patients"
label values old_payment_cat old_payment_cat

label define payment_cat 0 "Low complexity patients" 1 "Moderate complexity patients" ///
2 "Severe complexity patients"
label values payment_cat payment_cat

/*Variables:
	Health_keep: has health/function prevented you from doing x
		-pa1hlk...
	Activity_cat: No difficulty reported, yes difficulty, yes + health_keep
		-adl_diff_index, iadl_diff_index, health_keep
	Ambulation: Moved around inside by self w/ or w/o difficulty; 
				help getting around inside or report of not going parts of home/building by self
				reports not getting out of bed by self
				reports not moving around inside at all (bedbound?)
		-mo1dinsdslf, adl_ins_help, mo1insdwout, mo1bedwout
	Disease: Any SMI
		-any_smi
	Freq_help: Frequency of doing activity by self if help in 1+ ADL (set to least frequent)
		-sc1eatslfoft...
	Self Care: No ADL assistance, then how often require help
		-freq_help
	NHRes: Nursing Home Resident
		-nhres
	discussed, not used--weightloss
*/



foreach x in ambulation disease self_care nhres {
	tab `x'
}

foreach x in ambulation disease self_care nhres {
	tab pps `x'
}

foreach one in two {
//health keep
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i' & health_keep==1
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i' & health_keep==1
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented) sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

preserve
drop if activity==1
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i' & health_keep==1
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i' & health_keep==1
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented, among those with reported difficulty) ///
sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

restore
}
log close



foreach now in never {
log using pps_payment_comparison.txt, text replace

label var payment_cat "Payment Category"
label var pps "PPS"
foreach x in pps payment_cat {


local lab : var label `x'
levelsof `x', local(levels)


local rn: word count `levels'
tokenize `levels'
mat tab`x'=J(`rn',3,.)
local r=1
local c=1
sum `x'
local denom=r(N)
	qui svy: tab `x'
	mat pct=e(b)
forvalues l=1/`rn' {
	qui sum died_12 if `x'==``l'' [aw=anfin]
	mat tab`x'[`r',1]=r(N)
	mat tab`x'[`r',2]=(pct[1,`l'])*100
	mat tab`x'[`r',3]=r(mean)*100
	local r=`r'+1
}

mat rownames tab`x'=`levels'

frmttable, statmat(tab`x') ctitles("`lab'" "N" "Estimate" "1 year mortality") ///
sdec(0,2,2)
}
/*
//look at who flips between 70 & 80 
gen diffcat=pps==pps_old
replace diffcat=2 if pps<pps_old
replace diffcat=3 if pps>pps_old
label define diffcat 1 "Same PPs" 2 "New PPS more severe" 3 "New PPS less severe"
label values diffcat diffcat

gen diffpay=payment_cat==payment_cat_old
replace diffpay=2 if payment_cat>payment_cat_old
replace diffpay=3 if payment_cat<payment_cat_old
label define diffpay 1 "Same payment category" 2 " New cat more severe" 3 "New cat less severe"
label values diffpay diffpay


logit died_12 i.diffcat, or
logit died_12 i.diffpay, or
*/
foreach x of varlist pa1h* {
di "`x'"
sum died_12 if `x'==1
}
foreach one in two {
//health keep
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i' & health_keep==1
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i' & health_keep==1
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented) sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

preserve
drop if activity==1
mat tab=J(7,8,.)
local r=1
local c=1
forvalues i=1/7 {
qui sum hkindex if hkindex==`i' & health_keep==1
local denom=r(N)
mat tab[`r',`c']=r(N)
local c=`c'+1
foreach x of varlist pa1h* {
qui sum `x' if `x'==1 & hkindex==`i' & health_keep==1
mat tab[`r',`c']=(r(N)/`denom')*100
local c=`c'+1
}
local c=1
local r=`r'+1
}

mat rownames tab= 1 2 3 4 5 6 7
frmttable, statmat(tab) title(Activity prevented by # activities prevented, among those with reported difficulty) ///
sdec(0,2,2,2,2,2,2,2) ctitle("# activities" "N" "Visit fam/friends" "Rel. svcs" "clb mtgs" "going out" "work" "volunteering" "Favorite activity")

restore
}
log close

}
save "E:\nhats\data\Projects\pal_perf_scale\final_data\pps_sample.dta", replace



H="characteristics and outcomes"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "`datapath'\pps_sample.dta" if nhres==0, clear


/*do table-1-style characteristics and basic outcomes by payment group
*/

log using `logpath'/pps_sample_chars.txt, text replace
gen n=1

local pps ambulation disease health_keep   pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk ///
nohousework ind_diff activity_cat self_care pps weightloss smi_count ///
sig_symp any_disch_1m ss1prbbrlim ss1painl ind_indication payment_cat

local ind_indication weightloss smi_count ss1prbbrlim ss1painl  sig_symp any_disch_1m

forvalues i=30(10)100 {
	gen pps`i'=pps==`i' if !missing(pps)
	label var pps`i' "PPS--`i'"
}

gen breath_lim=ss1prbbrlimt==1 
gen pain_lim=ss1painlimt==1 if ss1painlimts>-8
gen ind_mult_smi=smi_count>=2 & !missing(smi_count)
tab ambulation, gen(ambulation)
tab self_care, gen(self_care)
tab activity_cat, gen(activity_cat)
label var breath_lim "Breathing problem limits activity"
label var pain_lim "Pain limits activity"
foreach y in ambulation self_care activity_cat {
local `y'
levelsof `y', local(levels)
foreach l of local levels {
local lab : label `y' `l'
label var `y'`l' "`lab'"
local `y' ``y'' `y'`l'
}
di "``y''"
}
foreach x in pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk {
	replace `x'=. if `x'<0
	replace `x'=0 if `x'==2
}

foreach x of varlist smi* dmouth* {
replace `x'=0 if missing(`x')
}

gen smi_any=smi_count>=1 | criteria_smi==1
label var smi_any "Any serious medical illness"
drop smi_count smi_nh_ind smi_and_adl 
gen dmouth_any=dmouth_index>=1 & !missing(dmouth_index)
label var dmouth_any "Any chronic disease, Dartmouth"
gen dmouth_ge3_ind=dmouth_index>=3
label var dmouth_ge3_ind "3+ Chronic diseases, Dartmouth"
drop dmouth_index
local dmouth
foreach x of varlist dmouth* {
	local dmouth `dmouth' `x'
}

local smi 
foreach x of varlist smi* {
	local smi `smi' `x'
}


local ind_indication weightloss ind_mult_smi sig_symp breath_lim pain_lim any_disch_1m
local pps `ambulation' disease health_keep pa1htkfrrlsr pa1hlkpgoenj pa1hlkpfrwrk ///
nohousework ind_diff `activity_cat' `self_care' ind_indication

replace payment_cat=payment_cat+1 if payment_cat>0
replace payment_cat=1 if !payment_cat & disease==1 & (adl_impair==1 | ///
bed_or_chair==1 | oxygen==1 | pps<=60 | (pps==70 & smi_cancer==1))
label define payment_cat 0 "Does not meet both dx and function requirements" ///
1 "Meets dx and function, but not utilization" 2 "Moderate complexity patients" ///
3 "Severe complexity patients", modify
label var park "Parkinson's, 6m"
local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married educ_hs_ind
local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind smi_cva smi_neurodeg park ser_med_illness nhres 

local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m

 
sum `cvars1' `cvars2' `ivars1' `ivars2' `ioutcomes' `coutcomes' `pps' `ind_indication'

local cvars age aveincome
local ivars female white black hisp other_race married educ_hs_ind proxy ///
medicaid medigap srh_fp adl_independent /*iadl_independent*/ `pps' `ind_indication' ///
`dmouth' `smi' ind_hosp_adm_6m obs_stay ed_op_wout_adm_ind
local ipps pps100 pps90 pps80 ///
pps70 pps60 pps50 pps40 pps30 
local cout tot_paid_by_mc_12m n_hospd_p12m
local iout ind_hosp_adm_p12m died_12


local rn : word count `cvars' `ivars' `ipps' `cout' `iout' 1 1 1 1 1
label var obs_stay "Indicator of  any observation stay 6m pre interview"
label var age "Age at interview, mean"
label var aveincome "Income, mean"
label var tot_paid_by_mc_12m "Total paid by MC 12m post interview, mean"
label var n_hospd_p12m "Total hospital days 12m post interview, mean"
label var died_12 "Died 12m post interview"
label var ind_hosp_adm_p12m "Any hospital admission 12m post interview"
label var educ_hs_ind "Education: HS+"
mat tab=J(`rn',4,.)
local r=1
local c=1

forvalues i=0/3 {
	local r=1 
	foreach x in vars pps out {
		foreach y in `c`x'' {
			sum `y' if payment_cat==`i' //[aw=anfinw]
			mat tab[`r',`c']=r(N)
			local r=`r'+1
}
		foreach y in `i`x'' {
			sum `y' if payment_cat==`i' //[aw=anfinw]
			mat tab[`r',`c']=r(mean)*r(N)
			if tab[`r',`c']<11 mat tab[`r',`c']=.
			local r=`r'+1
}
		local r=`r'+1
}
	sum n if payment_cat==`i'  [aw=anfinw]
	mat tab[`r',`c']=r(N)
	mat tab[`r'+1,`c']=r(sum)
	local c=`c'+1
	local lab`i' : label payment_cat `i'
}

mat rownames tab=`cvars' `ivars' "Estimated PPS score" `ipps' ///
"Outcomes" `cout' `iout' "_" "N" "National Estimate"

frmttable using "`logpath'/pps_table_1_with_outcomes.rtf", statmat(tab) sdec(0) varlabels ctitles("" "`lab0'" "`lab1'" "`lab2'" ///
"`lab3'") title("NHATS Sample Characteristics and Outcomes""by payment category") ///
replace ///
note("NHATS 2011 Sample w/ 6+ months FFS pre interview, community dwelling (not nursing home) with SP interview; HIV, ALS, hip fracture, and liver disease not shown due to cell size restriction" ///
"* -not shown for cell size restriction") ///
landscape basefont(fs10) 

local rn : word count `cvars' `ivars' `ipps' `cout' `iout' 1 1 1 1 1

label var age "Age at interview, mean"
label var aveincome "Income, mean"
label var tot_paid_by_mc_12m "Total paid by MC 12m post interview, mean"
label var n_hospd_p12m "Total hospital days 12m post interview, mean"
label var died_12 "Died 12m post interview"
label var ind_hosp_adm_p12m "Any hospital admission 12m post interview"
label var educ_hs_ind "Education: HS+"
mat tab=J(`rn',4,.)
local r=1
local c=1

forvalues i=0/3 {
	local r=1 
	foreach x in vars pps out {
		foreach y in `c`x'' {
			sum `y' if payment_cat==`i' [aw=anfinw]
			mat tab[`r',`c']=r(mean)
			local r=`r'+1
}
		foreach y in `i`x'' {
			sum `y' if payment_cat==`i' [aw=anfinw]
			mat tab[`r',`c']=r(mean)*100
			sum `y' if payment_cat==`i'
			/*if (r(mean)*r(N)<11 & r(mean)*r(N)!=0) | ///
			((r(N)-r(mean)*r(N))<11 & r(N)-r(mean)*r(N)!=0) mat tab[`r',`c']=.
			*/local r=`r'+1
}
		local r=`r'+1
}
	sum n if payment_cat==`i'  [aw=anfinw]
	mat tab[`r',`c']=r(N)
	mat tab[`r'+1,`c']=r(sum)
	local c=`c'+1
	local lab`i' : label payment_cat `i'
}

mat rownames tab=`cvars' `ivars' "Estimated PPS score" `ipps' ///
"Outcomes" `cout' `iout' "_" "N" "National Estimate"

frmttable using "`logpath'/pps_table_1_with_outcomes.rtf", statmat(tab) sdec(2) varlabels ctitles("" "`lab0'" "`lab1'" "`lab2'" ///
"`lab3'") title("NHATS Sample Characteristics and Outcomes""by payment category") ///
addtable ///
note("NHATS 2011 Sample w/ 6+ months FFS pre interview, community dwelling (not nursing home) with SP interview; HIV, ALS, hip fracture, and liver disease not shown due to cell size restriction" ///
"* -not shown for cell size restriction") ///
landscape basefont(fs10)

preserve
replace payment_cat=. if payment_cat!=1
replace payment_cat=payment_cat-1
replace payment_cat=1 if !payment_cat & !ind_hosp_adm_6m & !ed_op_wout_adm_ind
replace payment_cat=2 if payment_cat==0 & !ind_hosp_adm_6m & ed_op_wout_adm_ind==1
replace payment_cat=3 if !payment_cat & ind_hosp_adm_6m & !ed_op_wout_adm_ind
label define payment_cat 1 "Neither hospitalization nor ED" 2 "ED use only" ///
3 "Hospitalization without separate ED", modify
mat tab=J(`rn',3,.)

local r=1
local c=1
forvalues i=1/3 {
	local r=1 
	foreach x in vars pps out {
		foreach y in `c`x'' {
			sum `y' if payment_cat==`i' [aw=anfinw]
			mat tab[`r',`c']=r(mean)
			local r=`r'+1
}
		foreach y in `i`x'' {
			sum `y' if payment_cat==`i' [aw=anfinw]
			mat tab[`r',`c']=r(mean)*100
			sum `y' if payment_cat==`i'
			/*if (r(mean)*r(N)<11 & r(mean)*r(N)!=0) | ///
			((r(N)-r(mean)*r(N))<11 & r(N)-r(mean)*r(N)!=0) mat tab[`r',`c']=.*/
			local r=`r'+1
}
		local r=`r'+1
}
	sum n if payment_cat==`i'  [aw=anfinw]
	mat tab[`r',`c']=r(N)
	mat tab[`r'+1,`c']=r(sum)
	local c=`c'+1
	local lab`i' : label payment_cat `i'
}

mat rownames tab=`cvars' `ivars' "Estimated PPS score" `ipps' ///
"Outcomes" `cout' `iout' "_" "N" "National Estimate"

frmttable using "`logpath'/pps_table_1_with_outcomes.rtf", statmat(tab) sdec(2) ///
varlabels ctitles(""  "`lab1'" "`lab2'" ///
"`lab3'") title("NHATS Sample Characteristics and Outcomes""by payment category") ///
addtable ///
note("NHATS 2011 Sample w/ 6+ months FFS pre interview, community dwelling (not nursing home) with SP interview; HIV, ALS, hip fracture, and liver disease not shown due to cell size restriction" ///
"* -not shown for cell size restriction") ///
landscape basefont(fs10)
log close




H="sensspec with hcc"
clear all 
set more off
capture log close

local datapath "E:\nhats\data\Projects\pal_perf_scale\final_data"
local logpath "E:\nhats\data\Projects\pal_perf_scale\logs"

use "E:\nhats\data\CMS_DUA_28016\Merged Stata\dm_09_12.dta", clear
keep bene_id admit_date disch_date hcpcs_cd betos
gen wave=1
merge m:1 bene_id wave using ///
 "E:\nhats\data\Projects\pal_perf_scale\final_data\serious_ill_nhats_sample.dta", ///
 keep(match) keepusing(spid index_date)
keep if inrange(admit_date,index_date-186,index_date)

gen wc_betosa=betos=="D1D"
gen bed_betosa=betos=="D1B"

gen ind_wheelchaira=inlist(hcpcs_cd, "E1088","E1090","E1093","E1140","E1150","E1161") ///
 | inlist(hcpcs_cd,"E1220","E1226","E1230","E1232") ///
 | inlist(hcpcs_cd, "E1240","E1260","E1270","E2201","E2203") | inlist(hcpcs_cd,"E2206","E2208","E2209","E2210","E2226") ///
 | inlist(hcpcs_cd, "E2310","E2321","E2323","E2340","E2361") | inlist(hcpcs_cd,"E2363","E2364","E2365","E2366","E2367") ///
 | inlist(hcpcs_cd, "E2368","E2370","E2374","E2375","E2381") | inlist(hcpcs_cd,"E2382","E2383","E2386","E2387","E2389") ///
 | inlist(hcpcs_cd, "E2392","E2394","E2395","E2601","E2602") | inlist(hcpcs_cd,"E2603","E2604","E2605","E2607","E2608") ///
 | inlist(hcpcs_cd, "E2611","E2615","E2619","E2620","E2622") | inlist(hcpcs_cd,"E2623","E2624","K0001","K0002","K0003") ///
 | inlist(hcpcs_cd, "K0004","K0005","K0006","K0007","K0009") | inlist(hcpcs_cd,"K0010","K0011","K0012","K0014","K0015") ///
 | inlist(hcpcs_cd,"K0017","K0019","K0040","K0045","K0046") | inlist(hcpcs_cd,"K0047","K0053","K0056","K0069","K0070") ///
 | inlist(hcpcs_cd, "K0071","K0077","K0108","K0195","K0733") | inlist(hcpcs_cd,"K0734","K0735","K0736","K0800","K0806") ///
 | inlist(hcpcs_cd, "K0808","K0813","K0814","K0815","K0816") | inlist(hcpcs_cd,"K0821","K0822","K0823","K0824","K0825") ///
 | inlist(hcpcs_cd, "K0835","K0842","K0843","K0848","K0849") | inlist(hcpcs_cd,"K0856","K0861","K0877")																											

gen ind_hosp_beda=inlist(hcpcs_cd,"E0250","E0255","E0256") | inlist(hcpcs_cd,"E0260","E0261","E0265","E0271","E0272","E0274","E0277") ///
 | inlist(hcpcs_cd,"E0293","E0294","E0295","E0303","E0305") | inlist(hcpcs_cd,"E0310","E0316","E0860","E0870","E0910") ///
 | inlist(hcpcs_cd,"E0912","E0940","E0946","E0948","E0943") | inlist(hcpcs_cd,"K0456","K0549")																																																																																																												

keep spid bene_id index_date ind_* *_betosa
duplicates drop

foreach x of varlist *a {
	by spid, sort: egen `x'1=max(`x')
	drop `x'
}

rename *a1 *
duplicates drop

tempfile dme
save `dme'


use "`datapath'\serious_ill_nhats_sample.dta"
merge 1:1 spid index_date using `dme', gen(dmem) keep(match master)
merge 1:1 bene_id using "E:\nhats\data\Projects\pal_perf_scale\int_data\personout", ///
keep(match master)

replace ind_wheelchair=0 if missing(ind_whe)
replace ind_hosp_bed=0 if missing(ind_hosp_bed)
replace oxygen=0 if missing(oxygen)
gen bed_or_chair=ind_wheelchair | ind_hosp_bed

cd `logpath'
//note, this is temporary, we should pull all into main xwave set
merge 1:1 spid using "E:\nhats\data\NHATS Public\round_1\NHATS_Round_1_SP_File.dta", ///
nogen keep(match master)
gen pain=ss1painbothr==1
gen pain_limit=ss1painlim==1
gen weightloss=hw1lst10pnds==1 & hw1trytolose==2 
gen dem_probable=dem_3_cat==1
/*pulling, for all Dartmouth conditions, as well as criteria A, B, C:
 -for all and those with 6m HH/SNF use or NH res
 -N
 -1yr outcomes: spending, mortality, hospitalization
 -screens: SRH, ADLs, weight loss, pain, probable dementia
 -same 1yr outcomes
*/

sum tot_paid_by_mc_12m,d
gen ind_top10=tot_paid_by_mc_12m>=r(p90) if !missing(tot_paid_by_mc_12m)
label var ind_top10 "Top 10% of MC costs"

local d1 "Cancer"
local d2 "COPD"
local d3 "CAD"
local d4 "CHF"
local d5 "PVD"
local d6 "Liver"
local d7 "Diabetes"
local d8 "Renal"
local d9 "Dementia"
local d10 "3cond"
*local d11 "2cond"
*local d12 "3cond"
foreach x of varlist dmouth_* {
replace `x'=0 if missing(`x')
}
gen dmouth_10_0_6m=dmouth_index_0_6m>=3
gen dmouth_11_0_6m=dmouth_index_0_6m>=2
gen dmouth_12_0_6m=dmouth_index_0_6m>=3
gen prob_func_diff=ind_hh_6m ==1 | ind_snf_6m==1 | nhres==1


label var weightloss "Unintentional weight loss"
label var pain "Pain reported"
label var pain_limit "Pain limits activities"
label var dem_probable "Probable dementia"
label var ind_hh_6m "Any Home health expenditures previous 6m"
label var ind_snf_6m "Any SNF stay previous 6m"
label var prob_func "HH/SNF use 6m prior or NH resident"
label var tot_paid_by_mc_12m "Total MC expenditures 12m post, mean(SD)"
label var died_12 "Died 12m post ivw"
label var dmouth_10_0 "3+ Chronic Conditions, Dartmouth"
*label var dmouth_11_0 "2+ Chronic Conditions, Dartmouth"
*label var dmouth_12_0 "3+ Chronic Conditions, Dartmouth"
label var adl_impair "ADL impairment at interview"
gen ind_hh_snf=ind_hh_6m==1 | ind_snf_6m==1
label var ind_hh_snf "HH/SNF use 6m prior to ivw"

local coutcomes tot_paid_by_mc_12m 
local ioutcomes ind_top10 died_12 ind_hosp_adm_p12m
local firstlev ind_hh_6m ind_snf_6m ind_hh_snf  nhres
local nextlev  adl_impair srh_fp weightloss pain pain_limit ///
dem_probable
local criteria criteria_a criteria_b criteria_c

gen screener=0
foreach x in `nextlev' {
	replace screener=1 if `x'==1
}
local nextlev  adl_impair srh_fp weightloss pain pain_limit ///
dem_probable screener hh_snf_screen

gen hh_snf_screen=ind_hh_snf==1 & screener==1
label var hh_snf_screen "HH or SNF and screen"


foreach x in `firstlev' `nextlev' {
	replace `x'=0 if missing(`x') & nhres==1
}

label var screener "Any of ADL/PF SRH/weightloss/prob dem/pain"
local rn : word count `firstlev' `nextlev' `criteria' 1 `coutcomes' `ioutcomes' 1




gen group1=dmouth_index>=1 & ind_hosp_adm_6m if !missing(dmouth_index)
gen group2=group1==1 & (ind_hh_snf==1 | bed_or_chair==1 | oxygen==1)
gen group3=smi_count>=1 & ind_hosp_adm_6m if !missing(smi_count)
gen group4=group3==1 & (ind_hh_snf==1 | bed_or_chair==1 | oxygen==1)
gen group5=smi_count>=1 & adl_impair==1 if !missing(smi_count)
gen group6=group5==1 & group3==1
egen screener_2=rowtotal(`nextlev')
replace screener_2=screener_2>2 & !missing(screener_2)
local out ind_top10 ind_hosp_adm_p12m died_12 screener_2

/*
local rn : word count `coutcomes' `ioutcomes'

mat tab=J(`rn',12,.)
local r=1
local c=1
forvalues i=1/6 {
	foreach x in `coutcomes' {
		sum `x' if group`i'==1
		mat tab[`r',`c']=r(mean)
		mat tab[`r',`c'+1]=r(sd)
		local r=`r'+1
}
	foreach x in `ioutcomes' {
		sum `x' if group`i'==1
		mat tab[`r',`c']=r(mean)*r(N)
		mat tab[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
local r=1
local c=`c'+2
}


local sdec "0\2"
forvalues i=1/`=`rn'-1' {
	local sdec "`sdec'\0\2"
}

frmttable using condition_tables_sens_spec.rtf, statmat(tab) substat(1) ///
sdec(`sdec') title("Outcomes") ctitles("" "Cond & hosp" "Cond, hosp, HH/SNF/DME" ///
"SMI & hosp" "SMI, hosp, HH/SNF/DME" "SMI & ADL" "SMI, hosp, & ADL") replace ///
rtitles("Mean Spending"\"	SD"\"Top 10% Spending"\"	%" ///
"Died within 1 year"\"	 %"\"Hospitalization within 1 year"\"	%")
*/
sum score_com,d
gen hcc_top10=score_com>=r(p90) if !missing(score_com)
local xvars ind_top10 hcc_top10 died_12 ind_hosp_adm_p12m screener_2 adl_impair
local rn : word count `xvars' `coutcomes'

gen group7=hcc_top10

mat tab=J(`rn'*3,7,.)
local r=2
local c=1

forvalues i=1/7 {
	foreach x in `coutcomes' {
		sum `x' if group`i'==1
		mat tab[`r',`c']=r(mean)
		mat tab[`r'+1,`c']=r(sd)
		local r=`r'+3
}

	foreach x in `xvars' {
		sum `x' if group`i'==1
		mat tab[`r',`c']=r(mean)*100
		sum group`i' if `x'==1
		mat tab[`r'+1,`c']=r(mean)*100
		local r=`r'+3
}	
	local r=2
	local c=`c'+1
}
frmttable using condition_tables_sens_spec.rtf, statmat(tab) ///
varlabels replace sdec(2) title("Inclusion and Identification") ///
 rtitles("Medicare Expenditures"\ "Mean"\"SD"\"Top 10% spending" \"    %"\ ///
 "    % identified by criteria"\ ///
 "HCC Top 10%"\"    %"\ "    % identified by criteria"\ ///
 "Death within 1 year" \"    %"\ "    % identified by criteria"\ ///
 "Hospitalization within 1 year" \"    %"\ "    % identified by criteria"\ ///
 "2+ on screener"\"    %"\ "    % identified by criteria"\ ///
 "ADL impairment"\"    %"\ "    % identified by criteria") ///
ctitles("" "Cond & hosp" "Cond, hosp, HH/SNF/DME" "SMI & hosp" "SMI, hosp, HH/SNF/DME" ///
"SMI & ADL" "SMI, hosp, & ADL" "HCC Top 10%") landscape

label var group1 "Cond & hosp" 
label var group2 "Cond, hosp, HH/SNF/DME"
label var group3 "SMI & hosp" 
label var group4 "SMI, hosp, HH/SNF/DME"
label var group5 "SMI & ADL" 
label var group6 "SMI, hosp, & ADL" 
label var group7 "HCC Top 10%"
local rn : word count `out'
mat tab=J(`rn'*6+3,7,.)
local r=2
local c=1

foreach x in `out' {
	forvalues i=1/7 {
		tab group`i' `x', matcell(cell)
		mat tab[`r',`c']=(cell[2,2]/(cell[2,2]+cell[1,2]))*100
		mat tab[`r'+1,`c']=(cell[1,1]/(cell[2,1]+cell[1,1]))*100
		mat tab[`r'+2,`c']=(cell[2,2]/(cell[2,2]+cell[2,1]))*100
		mat tab[`r'+3,`c']=(cell[1,1]/(cell[1,1]+cell[1,2]))*100
		roctab `x' group`i'
		mat tab[`r'+4,`c']=r(area)
		sum group`i' if group`i'==1 [aw=anfin]
		mat tab[`r'+5,`c']=r(N)
		mat tab[`r'+6,`c']=r(sum)	
		sum group`i'   [aw=anfin]
		mat tab[`r'+7,`c']=r(mean)*100
		local c=`c'+1
}
	local r=`r'+6

	local c=1
}



frmttable using condition_tables_sens_spec.rtf, statmat(tab) ///
varlabels addtable sdec(2) title("Sensitivity and Specificity"\"     PPV"\"     NPV") ///
 rtitles("Top 10% spending" \"	Sensitivity"\"	Specificity"\"     PPV"\"     NPV"\"	ROC AUC"\ ///
 "Death within 1 year" \"	Sensitivity"\"	Specificity"\"     PPV"\"     NPV"\"	ROC AUC"\ ///
 "Hospitalization within 1 year" \"	Sensitivity"\"	Specificity"\"     PPV"\"     NPV"\"	ROC AUC"\ ///
 "2+ on screener"\"	Sensitivity"\"	Specificity"\"     PPV"\"     NPV"\"	ROC AUC" \ ///
 "N" \"Nat'l Estimate"\"% of FFS Medicare") ///
ctitles("" "Cond & hosp" "Cond, hosp, HH/SNF/DME" "SMI & hosp" "SMI, hosp, HH/SNF/DME" ///
"SMI & ADL" "SMI, hosp, & ADL" "HCC Top 10%") landscape




