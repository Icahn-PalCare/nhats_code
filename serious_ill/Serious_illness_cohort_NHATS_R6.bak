= V4 Outline MultiLine NoSorting TabWidth=30

H="NHATS Serious Illness"
/*HRS variables are processed in file HRS_Processing.txt
1998-2012 Core interviews
2002-2012 Exit interviews
Restricted data received in March 2015

Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!

******************************************************************

/*nhats cleaned path*/
libname nhats 'E:\nhats\data\NHATS cleaned';

/*medicare xwalk and claims path*/
libname medi 'E:\nhats\data\20180625 NHATS CMS Data\merged';

/*project data paths*/
libname proj_int 'E:\nhats\data\projects\serious_ill\int_data';
libname proj_fin 'E:\nhats\data\projects\serious_ill\final_data';
libname proj_ref 'E:\nhats\data\projects\serious_ill\ref_data';




H="get index date"
/*Import NHATS Cleaned Dataset for Rounds 1-6*/
proc import datafile="E:\nhats\data\NHATS cleaned\sp_round_1_6.dta" out=proj_int.nhats replace; run;


data index1;
set proj_int.nhats (keep=spid ivw_date ivw_month ivw_year);
index_date=ivw_date;
index_month=ivw_month;
index_year=ivw_year;
run;

proc import out=xwalk
	    datafile = "E:\nhats\data\20180625 NHATS CMS Data\merged\xwalk_2016.dta" replace;
run;

 
proc sql;
create table index as select a.spid, a.ivw_date as index_date, a.ivw_month as index_month, a.ivw_year as index_year, b.bene_id
from index1 a left join
xwalk b 
on a.spid=b.spid;
quit;

proc sort data=index out=proj_int.index nodupkey;
by spid bene_id index_year;
run;

H="get continuous ffs before index date"


/*sort claims denominator file*/

proc sort data=medi.mbsf_06_16 out=mbsf  nodupkey;
by bene_id year;
run;

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/*get mbsf just for interview year*/

proc sql; 
create table mbsf_index_year as select
a.*,b.buyin12,b.year,b.hmoind12
from index1 a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id)) 
and a.index_year=b.year;
quit;


proc sql;
select count(distinct bene_id) from mbsf_index_year;
quit;



data mbsf_index_year2;
set mbsf_index_year;
if length(trim(left(buyin12)))=12 and index_month>0 then do;
buyin_iy=substr(trim(left(buyin12)),1,index_month);
hmo_iy=substr(trim(left(HMOIND12)),1,index_month);
end;
else do;
buyin_iy=trim(left(buyin12));
hmo_iy=trim(left(HMOIND12));
end;
format index_date date9.;
run;
proc means n;
var index_month;
run;

proc sql;
create table mbsf_index_year_bef as select
a.bene_id,a.year as index_year,
b.year as index_year_bef,
b.year, b.buyin12,b.HMOIND12
from mbsf_index_year a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and 0<a.year-b.year<=1 order by bene_id,year;
quit;


/* and the year before... 1922 have the -2 year dn file*/
proc sql;
create table mbsf_index_year_2bef as select
a.bene_id,a.bene_id,a.index_year,a.index_year_bef,
b.year as index_year_2bef,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year_bef a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and 0<a.index_year_bef-b.year<=1 order by bene_id,year;
quit;

/*merge the insurance data for death year, -1 and -2 years into single dataset*/
proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_bef,b.HMOIND12 as hmo_bef from
mbsf_index_year2 a
left join
mbsf_index_year_bef b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sql;
create table all_insurance2 as select a.*,b.buyin12 as buyin_2bef,b.HMOIND12 as hmo_2bef from
all_insurance a
left join
mbsf_index_year_2bef b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year; 
quit;


/*merge death year and year before death buy-in and hmo variables
Trim so the final variable _6m is 6 months pre-death
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 6 months pre-death*/
data all_insurance3;
set all_insurance2;
buyin_2y=trimn(left(buyin_2bef))||trimn(left(buyin_bef))||trimn(left(buyin_iy));
hmo_2y=trimn(left(hmo_2bef))||trimn(left(hmo_bef))||trimn(left(hmo_iy));

buyin_2y_r=reverse(trim(buyin_2y));
hmo_2y_r=reverse(trim(hmo_2y));


/*create length of continous a&b and non-hmo coverage vars*/
if indexc(buyin_2y_r,"0","1","2","A","B")=0 then part_ab_n_mos=length(buyin_2y_r)-1;
if indexc(buyin_2y_r,"0","1","2","A","B") then part_ab_n_mos=indexc(buyin_2y_r,"0","1","2","A","B")-1;
if indexc(hmo_2y_r,"1","2","4","A","B","C")=0 then non_hmo_d_n_mos=length(hmo_2y_r)-1;
if indexc(hmo_2y_r,"1","2","4","A","B","C") then non_hmo_d_n_mos=indexc(hmo_2y_r,"1","2","4","A","B","C")-1;
if part_ab_n_mos<=non_hmo_d_n_mos then cont_ffs_n_mos=part_ab_n_mos;
if non_hmo_d_n_mos<part_ab_n_mos then cont_ffs_n_mos=non_hmo_d_n_mos;
run;


data proj_int.ffs_before;
set all_insurance3;
run;


H="get continuous ffs after index date"


/*sort claims denominator file*/

proc sort data=medi.mbsf_06_16 out=mbsf  nodupkey;
by bene_id year;
run;

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/*get mbsf just for interview year*/

proc sql; 
create table mbsf_index_year as select
a.*,b.buyin12,b.year,b.hmoind12
from index1 a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id)) 
and a.index_year=b.year;
quit;


proc sql;
select count(distinct bene_id) from mbsf_index_year;
quit;



data mbsf_index_year2;
set mbsf_index_year;
if length(trim(left(buyin12)))=12 and index_month>0 then do;
buyin_iy=substr(trim(left(buyin12)),index_month,13-index_month);
hmo_dy=substr(trim(left(HMOIND12)),index_month,13-index_month);
buyin_at_death=substr(trim(left(buyin12)),index_month,1);
hmo_at_death=substr(trim(left(HMOIND12)),index_month,1);
end;
else do;
buyin_iy=trim(left(buyin12));
hmo_iy=trim(left(HMOIND12));
end;
format index_date date9.;
run;
proc means n;
var index_month;
run;


proc sql;
create table mbsf_index_year_aft as select
a.bene_id,a.bene_id,a.year as index_year,
b.year as index_year_aft,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.year-b.year=-1 order by bene_id,year;
quit;


/* and the year aftore... 1790 have the +2 year dn file*/
proc sql;
create table mbsf_index_year_2aft as select
a.bene_id,a.bene_id,a.index_year,a.index_year_aft,
b.year as index_year_2aft,
b.year,b.buyin12,b.HMOIND12
from mbsf_index_year_aft a inner join
mbsf b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year_aft-b.year=-1 order by bene_id,year;
quit;

/*merge the insurance data for death year, +1 and +2 years into single dataset*/
proc sql;
create table all_insurance as select a.*,b.buyin12 as buyin_aft,b.HMOIND12 as hmo_aft from
mbsf_index_year2 a
left join
mbsf_index_year_aft b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sql;
create table all_insurance2 as select a.*,b.buyin12 as buyin_2aft,b.HMOIND12 as hmo_2aft from
all_insurance a
left join
mbsf_index_year_2aft b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;


/*merge death year and year aftore death buy-in and hmo variables
Trim so the final variable _p6m is 6 months post-death
Note: indicator variables for parts a and b and hmo are null if don't
have information for full 6 months post-death*/
data all_insurance3;
set all_insurance2;
buyin_2y=trimn(left(buyin_iy))||trimn(left(buyin_aft))||trimn(left(buyin_2aft));
hmo_2y=trimn(left(hmo_dy))||trimn(left(hmo_aft))||trimn(left(hmo_2aft));

/*create length of continous a&b and non-hmo coverage vars*/
if indexc(buyin_2y,"0","1","2","A","B")=0 then part_ab_p_mos=length(buyin_2y);
if indexc(buyin_2y,"0","1","2","A","B") then part_ab_p_mos=indexc(buyin_2y,"0","1","2","A","B");
if indexc(hmo_2y,"1","2","4","A","B","C")=0 then non_hmo_d_p_mos=length(hmo_2y);
if indexc(hmo_2y,"1","2","4","A","B","C") then non_hmo_d_p_mos=indexc(hmo_2y,"1","2","4","A","B","C");
if indexc(buyin_at_death,"0","1","2","A","B")=1 then part_ab_at_death=0;
if indexc(buyin_at_death,"0","1","2","A","B")=0 then part_ab_at_death=1;
if indexc(hmo_at_death,"1","2","4","A","B","C")=1 then hmo_d_at_death=1;
if indexc(hmo_at_death,"1","2","4","A","B","C")=0 then hmo_d_at_death=0;

if part_ab_p_mos<=non_hmo_d_p_mos then cont_ffs_p_mos=part_ab_p_mos;
if non_hmo_d_p_mos<part_ab_p_mos then cont_ffs_p_mos=non_hmo_d_p_mos;
run;

data proj_int.ffs_after;
set all_insurance3;
run;

H="get claims before index date"
/*Get claims 1 year and 2 year before each interview*/
/*Step 2: pull claims lists using xwalk and ivw date*/

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/
%macro claims_pre(days_start=,days_bef_index=,yrs=,source=);

proc sql;
create table &source._meet_&days_bef_index. as select a.index_date,a.index_year,b.*
from proj_int.index a inner join
medi.&source._&yrs. b 
on trim(left(a.bene_id))=trim(left(b.bene_id))
and &days_start<=a.index_date-b.disch_date<=&days_bef_index;
quit;

%mend;

/*run to get claims list 6 mo pre-ivw for ip*/
%claims_pre(days_start=0,days_bef_index=183,yrs=06_16,source=ip);

/*1yr*/
%claims_pre(days_start=0,days_bef_index=365,yrs=06_16,source=ip);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_16,source=snf);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_16,source=op);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_16,source=pb);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_16,source=hh);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_16,source=hs);
%claims_pre(days_start=0,days_bef_index=365,yrs=09_16,source=dm);

/*2yrs*/
%claims_pre(days_start=0,days_bef_index=730,yrs=06_16,source=ip);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_16,source=snf);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_16,source=op);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_16,source=pb);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_16,source=hh);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_16,source=hs);
%claims_pre(days_start=0,days_bef_index=730,yrs=09_16,source=dm);

%macro ip_drop(days_bef_index=);
data proj_int.ip_meet_&days_bef_index.;
set ip_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 icarecnt crnrydaycnt erdaycnt clm_ip_admsn_type_cd
  PRCDR_DT1-PRCDR_DT25 hcpcscd1-hcpcscd49);
run;
%mend ip_drop;

%macro snf_drop(days_bef_index=);
data proj_int.snf_meet_&days_bef_index.;
set snf_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 
 PRCDR_DT1-PRCDR_DT25 );
run;
%mend snf_drop;


/*hh*/
%macro hh_drop(days_bef_index=);
data proj_int.hh_meet_&days_bef_index.;
set hh_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
run;
%mend hh_drop;

/*hs*/
%macro hs_drop(days_bef_index=);
data proj_int.hs_meet_&days_bef_index.;
set hs_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25);
run;
%mend hs_drop;

/*dme*/
%macro dm_drop(days_bef_index=);
data proj_int.dm_meet_&days_bef_index.;
set dm_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date 
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 h_o2);
run;
%mend dm_drop;

/*op*/
%macro op_drop(days_bef_index=);
data proj_int.op_meet_&days_bef_index.;
set op_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 erdaycnt obs_stay);
run;
%mend op_drop;

/*carrier*/
%macro pb_drop(days_bef_index=);
data proj_int.pb_meet_&days_bef_index.;
set pb_meet_&days_bef_index.(keep=bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 hcpcscd1-hcpcscd13);
run;
%mend pb_drop;

%ip_drop(days_bef_index=183);
%ip_drop(days_bef_index=365);
%ip_drop(days_bef_index=730);
%snf_drop(days_bef_index=365);
%snf_drop(days_bef_index=730);
%hh_drop(days_bef_index=365);
%hh_drop(days_bef_index=730);
%hs_drop(days_bef_index=365);
%hs_drop(days_bef_index=730);
%dm_drop(days_bef_index=365);
%dm_drop(days_bef_index=730);
%op_drop(days_bef_index=365);
%op_drop(days_bef_index=730);
%pb_drop(days_bef_index=365);
%pb_drop(days_bef_index=730);



/****************************************************************************/
/****************************************************************************/
/* Macro to pull dx from claims lists, saves dx lists to int_data folder    */
/****************************************************************************/

%macro dx_time_range(range1=, range2=, days_bef_core=);

/*Process carrier medicare claims to pull out dx codes
Multiple lines per each BID*/
data pb_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.pb_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 hcpcscd1-hcpcscd13);
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12;
do over dx;
diag=dx ;
output;
end;
run;
/*check for and remove duplicates, note this doesn't remove blanks*/
proc sort data=pb_last_&range2._dx out=pb_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;


/*Process outpatient medicare claims to pull out dx codes
Dataset being created: op_last_&range2._dx2*/
data op_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.op_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25  );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=op_last_&range2._dx out=op_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

proc contents data=proj_int.ip_meet_365; run;


/*Dataset being created: ip_last_&range2._dx2*/
data ip_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.ip_meet_&days_bef_core.(keep=bene_id index_year ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 hcpcscd1-hcpcscd49);
array dx ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=ip_last_&range2._dx out=ip_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Dataset being created: snf_last_&range2._dx2*/
data snf_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.snf_meet_&days_bef_core.(keep=bene_id index_year ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=snf_last_&range2._dx out=snf_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process dme medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data dm_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.dm_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=dm_last_&range2._dx out=dm_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process hh medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hh_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.hh_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hh_last_&range2._dx out=hh_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;

/*Process hs medicare claims to pull out dx codes
Dataset being created: dm_last_&range2._dx2*/
data hs_last_&range2._dx(keep=bene_id index_year diag);
set proj_int.hs_meet_&days_bef_core.(keep=bene_id index_year PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
array dx PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ;
do over dx;
diag=dx ;
output;
end;
run;
proc sort data=hs_last_&range2._dx out=hs_last_&range2._dx2 nodupkey;
by bene_id index_year diag;
run;


/*set diag variable length = 7 chars since that's the max length from the mc claims
Need to do this because length varies across the different mc claim types*/
data hs_last_&range2._dx3;
length diag $7;
set hs_last_&range2._dx2;
run;
data hh_last_&range2._dx3;
length diag $7;
set hh_last_&range2._dx2;
run;
data ip_last_&range2._dx3;
length diag $7;
set ip_last_&range2._dx2;
run;
data snf_last_&range2._dx3;
length diag $7;
set snf_last_&range2._dx2;
run;
data dm_last_&range2._dx3;
length diag $7;
set dm_last_&range2._dx2;
run;
data op_last_&range2._dx3;
length diag $7;
set op_last_&range2._dx2;
run;
data pb_last_&range2._dx3;
length diag $7;
set pb_last_&range2._dx2;
run;


/*merge diagnoses from each claim type into single dataset*/
data dx_all_last_1&range2.;
set hs_last_&range2._dx3
hh_last_&range2._dx3
ip_last_&range2._dx3
snf_last_&range2._dx3
dm_last_&range2._dx3
op_last_&range2._dx3
pb_last_&range2._dx3;
run;

proc sql;
create table dx_all_last_&range2. as select * from
proj_int.index a 
left join 
dx_all_last_1&range2. b
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit; 

proc sort data=dx_all_last_&range2.(where=(diag~="")) out=proj_int.dx_&range1._&range2 nodupkey;
by bene_id index_year diag;
run;


%mend;

/*1 and 2 years pre-interview: proj_int.dx_0_1yr, proj_int.dx_0_2yr */
%dx_time_range(range1=0, range2=1yr, days_bef_core=365);
%dx_time_range(range1=0, range2=2yr, days_bef_core=730);



data dx_all_last_1yr_w_dups;
set hs_last_1yr_dx
hh_last_1yr_dx
ip_last_1yr_dx
snf_last_1yr_dx
dm_last_1yr_dx
op_last_1yr_dx
pb_last_1yr_dx;
if diag~='.';
run;

proc sort data=dx_all_last_1yr_w_dups;
by bene_id index_year diag;
run;

/*****************************************/
/*check dementia diagnosis frequencies, need to pull this into main dataset
dx list is from Elixhauser code*/
data proj_int.dem_dx_freq;
set dx_all_last_1yr_w_dups;
	dementia=0;
	if (substr(diag,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(diag,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;
run;



H="get claims after index date"
/*Get claims 1 year and 2 year before each interview*/
/*Step 2: pull claims lists using xwalk and ivw date*/

proc sort data=proj_int.index out=index1 nodupkey;
by bene_id index_year;
run;

/****************************************************************************/
/* Macro to pull claims lists, saves lists to int_data folder               */
/****************************************************************************/
%macro claims_post(days_start=,days_aft_index=,yrs=,source=);

proc sql;
create table &source._meet_&days_aft_index.p as select a.*,b.index_date,b.index_year
from medi.&source._&yrs. a inner join
proj_int.index b 
on trim(left(a.bene_id))=trim(left(b.bene_id))
and &days_start<=a.admit_date-b.index_date<=&days_aft_index;
quit;

%mend;

/*run to get claims list 6 mo pre-ivw for ip*/
%claims_post(days_start=0,days_aft_index=183,yrs=06_16,source=ip);

/*6m*/
%claims_post(days_start=0,days_aft_index=183,yrs=06_16,source=ip);
%claims_post(days_start=0,days_aft_index=183,yrs=09_16,source=snf);
%claims_post(days_start=0,days_aft_index=183,yrs=09_16,source=op);
%claims_post(days_start=0,days_aft_index=183,yrs=09_16,source=pb);
%claims_post(days_start=0,days_aft_index=183,yrs=09_16,source=hh);
%claims_post(days_start=0,days_aft_index=183,yrs=09_16,source=hs);
%claims_post(days_start=0,days_aft_index=183,yrs=09_16,source=dm);

/*1yr*/
%claims_post(days_start=0,days_aft_index=365,yrs=06_16,source=ip);
%claims_post(days_start=0,days_aft_index=365,yrs=09_16,source=snf);
%claims_post(days_start=0,days_aft_index=365,yrs=09_16,source=op);
%claims_post(days_start=0,days_aft_index=365,yrs=09_16,source=pb);
%claims_post(days_start=0,days_aft_index=365,yrs=09_16,source=hh);
%claims_post(days_start=0,days_aft_index=365,yrs=09_16,source=hs);
%claims_post(days_start=0,days_aft_index=365,yrs=09_16,source=dm);

/*2yrs*/
%claims_post(days_start=0,days_aft_index=730,yrs=06_16,source=ip);
%claims_post(days_start=0,days_aft_index=730,yrs=09_16,source=snf);
%claims_post(days_start=0,days_aft_index=730,yrs=09_16,source=op);
%claims_post(days_start=0,days_aft_index=730,yrs=09_16,source=pb);
%claims_post(days_start=0,days_aft_index=730,yrs=09_16,source=hh);
%claims_post(days_start=0,days_aft_index=730,yrs=09_16,source=hs);
%claims_post(days_start=0,days_aft_index=730,yrs=09_16,source=dm);

%macro ip_drop(days_aft_index=);
data proj_int.ip_meet_&days_aft_index.p;
set ip_meet_&days_aft_index.p(keep=clm_pmt_amt clm_pass_thru_per_diem_amt bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 crnrydaycnt icarecnt erdaycnt clm_ip_admsn_type_cd
  PRCDR_DT1-PRCDR_DT25 PRNCPAL_DGNS_CD);
run;
%mend ip_drop;

%macro snf_drop(days_aft_index=);
data proj_int.snf_meet_&days_aft_index.p;
set snf_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date 
  ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 ICD_PRCDR_CD1-ICD_PRCDR_CD25 
 PRCDR_DT1-PRCDR_DT25 PRNCPAL_DGNS_CD);
run;
%mend snf_drop;


/*hh*/
%macro hh_drop(days_aft_index=);
data proj_int.hh_meet_&days_aft_index.p;
set hh_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 );
run;
%mend hh_drop;

/*hs*/
%macro hs_drop(days_aft_index=);
data proj_int.hs_meet_&days_aft_index.p;
set hs_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25);
run;
%mend hs_drop;

/*dme*/
%macro dm_drop(days_aft_index=);
data proj_int.dm_meet_&days_aft_index.p;
set dm_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
run;
%mend dm_drop;

/*op*/
%macro op_drop(days_aft_index=);
data proj_int.op_meet_&days_aft_index.p;
set op_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25 erdaycnt);
run;
%mend op_drop;

/*carrier*/
%macro pb_drop(days_aft_index=);
data proj_int.pb_meet_&days_aft_index.p;
set pb_meet_&days_aft_index.p(keep=clm_pmt_amt bene_id index_year index_date admit_date disch_date
PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12 );
run;
%mend pb_drop;

%ip_drop(days_aft_index=183);
%ip_drop(days_aft_index=365);
%ip_drop(days_aft_index=730);
%snf_drop(days_aft_index=183);
%snf_drop(days_aft_index=365);
%snf_drop(days_aft_index=730);
%hh_drop(days_aft_index=183);
%hh_drop(days_aft_index=365);
%hh_drop(days_aft_index=730);
%hs_drop(days_aft_index=183);
%hs_drop(days_aft_index=365);
%hs_drop(days_aft_index=730);
%dm_drop(days_aft_index=183);
%dm_drop(days_aft_index=365);
%dm_drop(days_aft_index=730);
%op_drop(days_aft_index=183);
%op_drop(days_aft_index=365);
%op_drop(days_aft_index=730);
%pb_drop(days_aft_index=183);
%pb_drop(days_aft_index=365);
%pb_drop(days_aft_index=730);
 

H="***************************************"


H="Must run all below if change any above"


H="****************************************"


H="Dartmouth chronic diseases"
/*Add indicator variables for the Dartmouth chronic diseases */

/*Dartmouth code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 9 different chronic 
	diseases from the Dartmouth Index.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes from pdf "List of ICD-9_CM codes by Chronic Disease Category 
	(Nine chronic conditions used in the dartmouth atlas of health care 2008) from March 3, 2008*/


/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


%macro dartmouth(range1=,range2=);

data dx_dartmouth;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   dartmouth_1=0;
   dartmouth_1a=0;
   dartmouth_1b=0;
   dartmouth_2=0;
   dartmouth_3=0;
   dartmouth_4=0;
   dartmouth_5=0;
   dartmouth_6=0;
      dartmouth_7=0;
	     dartmouth_8=0;
		    dartmouth_9=0;
			   dartmouth_10=0;
			      dartmouth_11=0;
				     dartmouth_12=0;
					    dartmouth_13=0;
						   dartmouth_14=0;
						      dartmouth_15=0;
							     dartmouth_16=0;
								    dartmouth_17=0;

*do over dx;
	*Cancer with poor prognosis;
	if (substr(dx,1,4) in('1500','1501','1502','1503','1504','1505','1508','1509','1510','1511','1512',
			 	'1513','1514','1515','1516','1518','1519','1550','1551','1552','1570','1571',
			 	'1572','1573','1574','1578','1579','1580','1588','1589','1620','1622','1623',
			 	'1624','1625','1628','1629','1630','1631','1638','1639','1830','1832','1833',
			 	'1834','1835','1838','1839','1910','1911','1912','1913','1914','1915','1916',
			 	'1917','1918','1919','2890') 
		or substr(dx,1,5) in('20400','20410','20420','20480','20490','20500','20510',
				'20520','20530','20580','20590','20600','20610','20620','20680','20690','20700',
				'20710','20720','20780','20800','20810','20820','20880'))
               and dartmouth_1a=0
               then dartmouth_1a=1;
	*Metastatic Cancer;
	if (substr(dx,1,4) in('1960','1961','1962','1963','1965','1966','1968','1969','1970','1971','1972',
				'1973','1974','1975','1976','1977','1978','1980','1981','1982','1983','1984',
				'1985','1986','1987','1990','1991') or 
		substr(dx,1,5) in('19881','19882','19889'))
				and dartmouth_1b=0
				then dartmouth_1b=1;
	*Malignant Cancer, Leukemia;
	if dartmouth_1a=1 or dartmouth_1b=1 then dartmouth_1=1;
	*COPD;
	if (substr(dx,1,3) in('494','496','501','515') or
		substr(dx,1,4) in('4911,4918,4919,4920,4928,4940,4941,5064') or
		substr(dx,1,5) in('49120,49121,49122,49310,49311,49312,49320,49321,49322,49390,49391,49392'))
				and dartmouth_2=0
				then dartmouth_2=1;
	*CAD;
	if (substr(dx,1,3)='412' or
		substr(dx,1,4) in('4111','4118','4130','4139','4140','4148','4149') or
		substr(dx,1,5) in('41181','41189','41400','41401','41402','41403','41404','41405','41406','41407'))
				and dartmouth_3=0
				then dartmouth_3=1;
	*CHF;
	if (substr(dx,1,4) in('4280','4281','4282','4283','4284','4289') or
		substr(dx,1,5) in('42820','42821','42822','42823','42830','42831','42832','42833','42840','42841',
								'42842','42843','40201','40211','40291','39891','40401','40403','40411','40491',
								'40493'))
				and dartmouth_4=0
				then dartmouth_4=1;
	*PVD;
	if (substr(dx,1,4) in('4400','4401','4403','4408','4409','4410','4411','4412','4413','4414','4415','4416',
								'4417','4419','4439') or
		substr(dx,1,5) in('44020','44021','44022','44023','44024','44029','44030','44031','44032','44100','44101','44102','44103'))
				and dartmouth_5=0
				then dartmouth_5=1;
	*Severe Chronic Liver Disease;
	if substr(dx,1,4) in('5712','5715','5716','5723')
				and dartmouth_6=0
				then dartmouth_6=1;
	*Diabetes w/ End Organ Damage;
	if ((substr(dx,1,3)='250' and substr(dx,4,1) in('4','5','6','7','9') and substr(dx,5,1) in('0','1','2','3')) or
		substr(dx,1,4)='3572' or
		substr(dx,1,5) in('36641','36201','36202'))
				and dartmouth_7=0
				then dartmouth_7=1;
	*Renal Failure;
	if (substr(dx,1,3)='585' or
		substr(dx,1,4) in('5851','5852','5853','5854','5855','5856','5859','V451','V560','V568') or
		substr(dx,1,5) in('40301','40311','40391'))
				and dartmouth_8=0
				then dartmouth_8=1;
	*Dementia;
	if (substr(dx,1,3)='797' or
		substr(dx,1,4) in('2900','2903','2908','2909','2940','2941','2948','2949','3310','3312') or
		substr(dx,1,5) in('29101','29011','29012','29013','29020','29021','29040','29041','29042',
								'29043','29410','29411'))
				and dartmouth_9=0
				then dartmouth_9=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct bene_id,index_year,
sum(dartmouth_1a) as dmouth_a,
sum(dartmouth_1b) as dmouth_b,
sum(dartmouth_1) as cha_1,
sum(dartmouth_2) as cha_2,
sum(dartmouth_3) as cha_3,
sum(dartmouth_4) as cha_4,
sum(dartmouth_5) as cha_5,
sum(dartmouth_6) as cha_6,
sum(dartmouth_7) as cha_7,
sum(dartmouth_8) as cha_8,
sum(dartmouth_9) as cha_9
from dx_dartmouth
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data dartmouth_1(keep=bene_id index_year dmouth_1-dmouth_9 dmouth_index dmouth_index_wt);
set cha_test1;
array list_cha cha_1-cha_9;
array list_cha_bin dmouth_1-dmouth_9 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*replace cancer subtypes with indicators*/
if dmouth_a>1 then dmouth_a=1;
if dmouth_b>1 then dmouth_b=1;
/*note this dmouth_index count count is not weighted for morbidity*/
dmouth_index=dmouth_1+dmouth_2+dmouth_3+dmouth_4+dmouth_5+dmouth_6+dmouth_7+dmouth_8+dmouth_9;


label dmouth_a ="Poor prognosis cancer, Dartmouth";
label dmouth_b ="Metastatic cancer, Dartmouth";
label dmouth_1 ="Malignant Cancer or Leukemia, Dartmouth";
label dmouth_2 ="Chronic Pulmonary Disease, Dartmouth";
label dmouth_3 ="CAD, Dartmouth";
label dmouth_4 ="CHF, Dartmouth";
label dmouth_5 ="PVD, Dartmouth";
label dmouth_6 ="Severe Chronic Liver Disease, Dartmouth";
label dmouth_7 ="Diabetes w/ End Organ Damage, Dartmouth";
label dmouth_8 ="Renal Failure, Dartmouth";
label dmouth_9 ="Dementia, Dartmouth";
label dmouth_index ="Count Chronic Diseases, Dartmouth";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=dartmouth_1 out=test nodupkey;
by bene_id index_year;
run;



%rename(WORK,TEST,&range1._&range2);

data proj_int.dmouth_&range1._&range2.(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 dmouth: index_year:;
run;
proc sort data=proj_int.dmouth_&range1._&range2.;
by bene_id index_year;
run;

%mend;

*%dartmouth(range1=0, range2=6m);
%dartmouth(range1=0, range2=1yr);




H="Elixhauser comorbidities"
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!
*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;




/****************************************************************************/
/* Elixhauser comorbidities macro                                           */
/****************************************************************************/
/*Note elixhauser comorbidities diagnosis lists are modified for the 
purposes of this project, do not copy and paste this Elixhauser code 
for use in other projects!!*/

%macro elixhauser(range1=, range2=);

data dx_31_comor;
set proj_int.dx_&range1._&range2(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

comorbi_1=0;
comorbi_2=0;
comorbi_3=0;
comorbi_4=0;
comorbi_5=0;
comorbi_6=0;
comorbi_7=0;
comorbi_8=0;
comorbi_9=0;
comorbi_10=0;
comorbi_11=0;
comorbi_12=0;
comorbi_13=0;
comorbi_14=0;
comorbi_15=0;
comorbi_16=0;
comorbi_17=0;
comorbi_18=0;
comorbi_19=0;
comorbi_20=0;
comorbi_21=0;
comorbi_22=0;
comorbi_23=0;
comorbi_24=0;
comorbi_25=0;
comorbi_26=0;
comorbi_27=0;
comorbi_28=0;
comorbi_29=0;
comorbi_30=0;
*end of intialize of 30 binary variables;
*add dementia and CAD and ALS;
dementia=0;
cad=0;
als=0;
renal_dis=0;

*do over dx;
	*Congestive Heart Failure;
	if (substr(dx,1,5)='39891' or
		substr(dx,1,5)='40211' or
		substr(dx,1,5)='40291' or
		substr(dx,1,5)='40411' or
		substr(dx,1,5)='40413' or
		substr(dx,1,5)='40491' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='428') 
		and comorbi_1=0 
		then comorbi_1=1;*add one binary variables here.;
	*Cariac Arrhythmias;
	if (substr(dx,1,5)='42610' or
		substr(dx,1,5)='42611' or
		substr(dx,1,5)='42613' or
		substr(dx,1,4)='4262' or
		substr(dx,1,4)='4263' or
		substr(dx,1,4)='4264' or
		substr(dx,1,5)='42650' or
		substr(dx,1,5)='42651' or
		substr(dx,1,5)='42652' or
		substr(dx,1,5)='42653' or
		substr(dx,1,4)='4266' or
		substr(dx,1,4)='4267' or
		substr(dx,1,4)='4268' or
		substr(dx,1,4)='4270' or
		substr(dx,1,4)='4272' or
		substr(dx,1,5)='42731' or
		substr(dx,1,5)='42760' or
		substr(dx,1,4)='4279' or
		substr(dx,1,4)='7850' or
		substr(dx,1,4)='V450' or
		substr(dx,1,4)='V533')
			and comorbi_2=0 
		then comorbi_2=1;
	* Valvular Disease ;
	if (substr(dx,1,5)='09320' or
		substr(dx,1,5)='09321' or
		substr(dx,1,5)='09322' or
		substr(dx,1,5)='09323' or
		substr(dx,1,5)='09324' or
		substr(dx,1,3)='394' or
		substr(dx,1,3)='395' or
		substr(dx,1,3)='396' or
		substr(dx,1,4)='3970' or
		substr(dx,1,4)='3971' or
		substr(dx,1,4)='4240' or
		substr(dx,1,4)='4241' or
		substr(dx,1,4)='4242' or
		substr(dx,1,4)='4243' or
		substr(dx,1,4)='4244' or
		substr(dx,1,4)='4245' or
		substr(dx,1,4)='4246' or
		substr(dx,1,4)='4247' or
		substr(dx,1,4)='4248' or
		substr(dx,1,5)='42490' or
		substr(dx,1,5)='42491' or
		substr(dx,1,4)='7463' or
		substr(dx,1,4)='7464' or
		substr(dx,1,4)='7465' or
		substr(dx,1,4)='7466' or
		substr(dx,1,4)='V422' or
		substr(dx,1,4)='V433')
			and comorbi_3=0 
		then comorbi_3=1;
	*Pulmonary Circulation Disorders;
	if (substr(dx,1,3)='416' or
		substr(dx,1,4)='4179')
			and comorbi_4=0 
		then comorbi_4=1;
	*Peripheral Vascular Disorders;
	if (substr(dx,1,3)='440' or
		substr(dx,1,4)='4412' or
		substr(dx,1,4)='4414' or
		substr(dx,1,4)='4417' or
		substr(dx,1,4)='4419' or
		substr(dx,1,4)='4431' or
		substr(dx,1,4)='4432' or
		substr(dx,1,4)='4438' or
		substr(dx,1,4)='4439' or
		substr(dx,1,4)='4471' or
		substr(dx,1,4)='5571' or
		substr(dx,1,4)='5579' or
		substr(dx,1,4)='V434')
			and comorbi_5=0 
		then comorbi_5=1;
	*Hypertension;
	if ((substr(dx,1,4)='4011' or
		substr(dx,1,4)='4019')) or
	   ((substr(dx,1,5)='40210' or
		substr(dx,1,5)='40290' or
		substr(dx,1,5)='40410' or
		substr(dx,1,5)='40490' or
		substr(dx,1,5)='40511' or
		substr(dx,1,5)='40519' or
		substr(dx,1,5)='40591' or
		substr(dx,1,5)='40599')) 
			and comorbi_6=0 
		then comorbi_6=1;
	*Paralysis;	
	if (substr(dx,1,4)='3420' or
		substr(dx,1,5)='34210' or
		substr(dx,1,5)='34211' or
		substr(dx,1,5)='34212' or
		substr(dx,1,4)='3429' or
		substr(dx,1,3)='343' or
		substr(dx,1,3)='344')
			and comorbi_7=0 
		then comorbi_7=1;
	*Other Neurological Disorders;
	if (substr(dx,1,4)='3319' or
		substr(dx,1,4)='3320' or
		substr(dx,1,4)='3334' or
		substr(dx,1,4)='3335' or
		substr(dx,1,3)='334' or
		substr(dx,1,3)='335' or
		substr(dx,1,3)='340' or
		substr(dx,1,4)='3411' or
		substr(dx,1,4)='3418' or
		substr(dx,1,4)='3419' or
		substr(dx,1,5)='34500' or
		substr(dx,1,5)='34501' or
		substr(dx,1,5)='34510' or
		substr(dx,1,5)='34511' or
		substr(dx,1,4)='3454' or
		substr(dx,1,5)='34550' or
		substr(dx,1,5)='34551' or
		substr(dx,1,4)='3458' or
		substr(dx,1,5)='34590' or
		substr(dx,1,5)='34591' or
		substr(dx,1,4)='3481' or
		substr(dx,1,4)='3483' or
		substr(dx,1,4)='7803' or
		substr(dx,1,4)='7843') 
			and comorbi_8=0 
		then comorbi_8=1;	
	*Chronic Pulmonary Disease;
	if (substr(dx,1,3)='490' or
		substr(dx,1,3)='491' or
		substr(dx,1,3)='492' or
		substr(dx,1,4)='4930' or
		substr(dx,1,4)='4931' or
		substr(dx,1,4)='4932' or
		substr(dx,1,4)='4938' or
		substr(dx,1,5)='49390' or
		substr(dx,1,5)='49391' or
		substr(dx,1,3)='494' or
		substr(dx,1,3)='495' or
		substr(dx,1,3)='496' or
		substr(dx,1,3)='497' or
		substr(dx,1,3)='498' or
		substr(dx,1,3)='499' or
		substr(dx,1,3)='500' or
		substr(dx,1,3)='501' or
		substr(dx,1,3)='502' or
		substr(dx,1,3)='503' or
		substr(dx,1,3)='504' or
		substr(dx,1,3)='505' or
		substr(dx,1,4)='5064') 
			and comorbi_9=0 
		then comorbi_9=1;	
	*Diabetes, uncomplicated;
	if (substr(dx,1,4)='2500' or
		substr(dx,1,4)='2501' or
		substr(dx,1,4)='2502' or
		substr(dx,1,4)='2503') 
			and comorbi_10=0 
		then comorbi_10=1;
	*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507' or
		substr(dx,1,4)='2509') 
			and comorbi_11=0 
		then comorbi_11=1;
	*Hypothyroidism;
	if (substr(dx,1,3)='243' or
		substr(dx,1,4)='2440' or
		substr(dx,1,4)='2441' or
		substr(dx,1,4)='2442' or
		substr(dx,1,4)='2448' or
		substr(dx,1,4)='2449') 	
			and comorbi_12=0 
		then comorbi_12=1;
	*Renal Failure;
	*Original list modified to drop 2 codes  585 and V568;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560') 
			and comorbi_13=0 
		then comorbi_13=1;
	*Advanced Liver Disease or Cirrhosis;
	*Code list modified from orig Elix;
	*572.4 hepatorenal syndrome must be added; 
	*Remove '07032' or – chronic hep B, '07033' or – chronic hep B, '07054' or – chronic hep C, '5713' or – alcoholic liver damage, '5714' or – chronic hepatitis;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,5)='45620' or
		substr(dx,1,5)='45621' or
		substr(dx,1,4)='5710' or
		substr(dx,1,4)='5712' or
		substr(dx,1,4)='5715' or
		substr(dx,1,4)='5716' or
		substr(dx,1,4)='5718' or
		substr(dx,1,4)='5719' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
		substr(dx,1,4)='5728' or
		substr(dx,1,4)='V427') 
			and comorbi_14=0 
		then comorbi_14=1;
	*Peptic Ulcer Disease excluding bleeding;
	if (substr(dx,1,5)='53170' or
		substr(dx,1,5)='53190' or
		substr(dx,1,5)='53270' or
		substr(dx,1,5)='53290' or
		substr(dx,1,5)='53370' or
		substr(dx,1,5)='53390' or
		substr(dx,1,5)='53470' or
		substr(dx,1,5)='53490' or
		substr(dx,1,5)='V1271') 
			and comorbi_15=0 
		then comorbi_15=1;
	*AIDS;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044') 
			and comorbi_16=0 
		then comorbi_16=1;
	*Lymphoma;
	if (substr(dx,1,3)='200' or
		substr(dx,1,3)='201' or
		substr(dx,1,4)='2020' or
		substr(dx,1,4)='2021' or
		substr(dx,1,4)='2022' or
		substr(dx,1,4)='2023' or
		substr(dx,1,4)='2025' or
		substr(dx,1,4)='2026' or
		substr(dx,1,4)='2027' or
		substr(dx,1,4)='2028' or
		substr(dx,1,4)='2029' or
		substr(dx,1,4)='2030' or
		substr(dx,1,4)='2038' or
		substr(dx,1,4)='2386' or
		substr(dx,1,4)='2733' or
		substr(dx,1,5)='V1071' or
		substr(dx,1,5)='V1072' or
		substr(dx,1,5)='V1079')
			and comorbi_17=0 
		then comorbi_17=1;
	*Metastatic Cancer or Hematologic Cancer;
	*Modified to add lukemias;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' or
		substr(dx,1,3)='204' or
		substr(dx,1,3)='205' or
		substr(dx,1,3)='206' or
		substr(dx,1,3)='207' or
		substr(dx,1,3)='208') 
			and comorbi_18=0 
		then comorbi_18=1;	
	*Solid Tumor without Metastisis;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
		substr(dx,1,3)='V10')
			and comorbi_19=0 
		then comorbi_19=1;
	*Rheumatoid Arthritis/Collagen Vascular Diseases;
	if (substr(dx,1,4)='7010' or
		substr(dx,1,3)='710' or
		substr(dx,1,3)='714' or
		substr(dx,1,3)='720' or
		substr(dx,1,3)='725') 
			and comorbi_20=0 
		then comorbi_20=1;
	*Coagulopathy;
	if (substr(dx,1,3)='286' or
		substr(dx,1,4)='2871' or
		substr(dx,1,4)='2873' or
		substr(dx,1,4)='2874' or
		substr(dx,1,4)='2875') 
			and comorbi_21=0 
		then comorbi_21=1;
	*Obesity;
	if (substr(dx,1,4)='2780')  
			and comorbi_22=0 
		then comorbi_22=1;
	*Weight Loss;
	if (substr(dx,1,3)='260' or
		substr(dx,1,3)='261' or
		substr(dx,1,3)='262' or
		substr(dx,1,3)='263') 
			and comorbi_23=0 
		then comorbi_23=1;	
	*Fluid and Electrolyte Disorders;
	if (substr(dx,1,3)='276') 
			and comorbi_24=0 
		then comorbi_24=1;
	*Blood Loss Anemia;
	if (substr(dx,1,4)='2800') 
			and comorbi_25=0 
		then comorbi_25=1;
	*Deficiency Anemias;
	if (substr(dx,1,4)='2801' or
		substr(dx,1,4)='2808' or
		substr(dx,1,4)='2809' or
		substr(dx,1,4)='2859') 
			and comorbi_26=0 
		then comorbi_26=1;
	*Alcohol Abuse;
	if (substr(dx,1,4)='2911' or
		substr(dx,1,4)='2912' or
		substr(dx,1,4)='2915' or
		substr(dx,1,4)='2918' or
		substr(dx,1,4)='2919' or
		substr(dx,1,4)='3039' or
		substr(dx,1,4)='3050' or
		substr(dx,1,4)='V113') 
			and comorbi_27=0 
		then comorbi_27=1;
	*Drug Abuse;
	if (substr(dx,1,4)='2920' or
		substr(dx,1,5)='29282' or
		substr(dx,1,5)='29283' or
		substr(dx,1,5)='29284' or
		substr(dx,1,5)='29289' or
		substr(dx,1,4)='2929' or
		substr(dx,1,3)='304' or
		substr(dx,1,4)='3052' or
		substr(dx,1,4)='3053' or
		substr(dx,1,4)='3054' or
		substr(dx,1,4)='3055' or
		substr(dx,1,4)='3056' or
		substr(dx,1,4)='3057' or
		substr(dx,1,4)='3058' or
		substr(dx,1,4)='3059')
			and comorbi_28=0 
		then comorbi_28=1;	
	*Psychoses;
	if (substr(dx,1,3)='295' or
		substr(dx,1,3)='296' or
		substr(dx,1,3)='297' or
		substr(dx,1,3)='298' or
		substr(dx,1,4)='2991') 
			and comorbi_29=0 
		then comorbi_29=1;
	*Depression;
	if (substr(dx,1,4)='3004' or
		substr(dx,1,5)='30112' or
		substr(dx,1,4)='3090' or
		substr(dx,1,4)='3091' or
		substr(dx,1,3)='311')
			and comorbi_30=0 
		then comorbi_30=1;

	*Dementia;
	if (substr(dx,1,4) in ('3310','3311','3312','2900','2901',
             '2902','2903','2912','2948','2949') or
		substr(dx,1,5) in ('29410','29411','29040','29041','29042','29043')) 
		and dementia=0 
          then dementia=1;

	*CAD coronary artery disease;
	if (substr(dx,1,4) in ('4140','4142','4143','4148','4149') or 
		substr(dx,1,3) in ('410','411','412','413') or
		substr(dx,1,5) in ('V4581','V4582'))
		and cad=0 
          then cad=1;

	*ALS Amyotrophic lateral sclerosis;
	if (substr(dx,1,5)='33520') and als=0 
		then als=1;

*Renal Disease, new variable;
	*To identify diabetese with complications;
	if (substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40492' or
		substr(dx,1,3)='585' or
		substr(dx,1,3)='586' or
		substr(dx,1,4)='V420' or
		substr(dx,1,4)='V451' or
		substr(dx,1,4)='V560' or
		substr(dx,1,4)='V568') 
			and renal_dis=0 
		then renal_dis=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table com_test1 as
select distinct bene_id,index_year,
sum(comorbi_1) as com_1,
sum(comorbi_2) as com_2,
sum(comorbi_3) as com_3,
sum(comorbi_4) as com_4,
sum(comorbi_5) as com_5,
sum(comorbi_6) as com_6,
sum(comorbi_7) as com_7,
sum(comorbi_8) as com_8,
sum(comorbi_9) as com_9,
sum(comorbi_10) as com_10,
sum(comorbi_11) as com_11,
sum(comorbi_12) as com_12,
sum(comorbi_13) as com_13,
sum(comorbi_14) as com_14,
sum(comorbi_15) as com_15,
sum(comorbi_16) as com_16,
sum(comorbi_17) as com_17,
sum(comorbi_18) as com_18,
sum(comorbi_19) as com_19,
sum(comorbi_20) as com_20,
sum(comorbi_21) as com_21,
sum(comorbi_22) as com_22,
sum(comorbi_23) as com_23,
sum(comorbi_24) as com_24,
sum(comorbi_25) as com_25,
sum(comorbi_26) as com_26,
sum(comorbi_27) as com_27,
sum(comorbi_28) as com_28,
sum(comorbi_29) as com_29,
sum(comorbi_30) as com_30,
sum(dementia) as dementia,
sum(cad) as cad,
sum(als) as als,
sum(renal_dis) as renal_dis
from dx_31_comor
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data comorbidity_1(keep=bene_id index_year comorb_1-comorb_34 comorb_all);
set com_test1;
array list_com com_1-com_30 dementia cad als renal_dis;
array list_com_bin comorb_1-comorb_34 ;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;
/*note this comorb_all count does not include CAD or ALS or Renal disease*/
comorb_all=comorb_1+comorb_2+comorb_3+comorb_4+comorb_5+comorb_6+comorb_7+comorb_8+comorb_9+comorb_10
+comorb_11+comorb_12+comorb_13+comorb_14+comorb_15+comorb_16+comorb_17+comorb_18+comorb_19+comorb_20
+comorb_21+comorb_22+comorb_23+comorb_24+comorb_25+comorb_26+comorb_27+comorb_28+comorb_29+comorb_30
+comorb_31;

run;

/*merge in to list of core ivw dates for those with ffs mc, age=65+ */
proc sort data=comorbidity_1 nodupkey;
by bene_id index_year;
run;

data proj_int.elix_&range1._&range2;
set comorbidity_1 ;

label comorb_1 ="Congestive Heart Failure";
label comorb_2 ="Cardiac Arrhythmias";
label comorb_3 ="Valvular Disease";
label comorb_4 ="Pulmonary Circulation Disorders";
label comorb_5 ="Peripheral Vascular Disorders";
label comorb_6 ="Hypertension";
label comorb_7 ="Paralysis";
label comorb_8 ="Other Neurological Disorders";
label comorb_9 ="Chronic Pulmonary Disease";
label comorb_10 ="Diabetes, uncomplicated";
label comorb_11 ="Diabetes, complicated";
label comorb_12 ="Hypothyroidism";
label comorb_13 ="Renal Failure";
label comorb_14 ="Advanced Liver Disease or Cirrhosis";
label comorb_15 ="Peptic Ulcer Disease excluding bleeding";
label comorb_16 ="AIDS";
label comorb_17 ="Lymphoma";
label comorb_18 ="Metastatic or Hematologic Cancer";
label comorb_19 ="Solid Tumor without Metastisis";
label comorb_20 ="Rheumatoid Arthritis/Collagen Vascular Diseases";
label comorb_21 ="Coagulopathy";
label comorb_22 ="Obesity";
label comorb_23 ="Weight Loss";
label comorb_24 ="Fluid and Electrolyte Disorders";
label comorb_25 ="Blood Loss Anemia";
label comorb_26 ="Deficiency Anemias";
label comorb_27 ="Alcohol Abuse";
label comorb_28 ="Drug Abuse";
label comorb_29 ="Psychoses";
label comorb_30 ="Depression";
label comorb_31 ="Dementia";
label comorb_32 ="CAD";
label comorb_33 ="ALS";
label comorb_34 ="Renal Disease";
label comorb_all ="Count of Elix comorbidities";
run;

data test;
set proj_int.elix_&range1._&range2;
run;

%rename(WORK,TEST,&range1._&range2);

data proj_int.elix_&range1._&range2._2(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 comorb: index_year:;
run;
proc sort data=proj_int.elix_&range1._&range2._2;
by bene_id index_year;
run;

%mend;

/*Run for 1 year, 2 year datasets, resulting datasets are proj_int.elix_0_1yr_2, proj_int.elix_0_2yr_2*/
%elixhauser(range1=0, range2=1yr);
%elixhauser(range1=0, range2=2yr);

proc freq data=proj_int.elix_0_1yr_2;
table comorb:;
run;

proc freq data=proj_int.elix_0_2yr_2;
table comorb:;
run;




/*this is merged into the main dataset when the elixhauser indicator variables 
in the next section*/
proc sql;
create table dem_dx_freq_2 as select distinct bene_id,index_year,
sum(dementia) as dem_dx_1yr label="count dementia dx 1yr pre core ivw"
 from proj_int.dem_dx_freq group by bene_id,index_year;
quit;

/* merge in the 1 year count of dementia diagnoses from the previous section*/
proc sql;
create table elix_1yr_dm_dx_count as select a.*,b.dem_dx_1yr from
proj_int.elix_0_1yr_2 a left join
dem_dx_freq_2 b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

/*overwrite the previously saved dataset with one with the additional dementia variable added*/
data proj_int.elix_0_1yr_2;
set elix_1yr_dm_dx_count;
if comorb_31_0_1yr=0 then dem_dx_1yr=0;
run;

proc freq data=proj_int.elix_0_1yr_2;
table comorb:;
run;

 

H="Charlson comorbidities"
/*Add indicator variables for the Charlson comorbidities
and Charlson weighted and unweighted index */

/*Charlson code

This program reads through the diagnosis codes of patient abstract records in a hospital
    file and identifies whether the record belongs to one (or more) of 17 different Charlson
    Comorbidity Index (CCI) groups.  The groups are identified by using the Enhanced ICD-9-CM
    diagnosis codes listed in Quan et al., "Coding Algorithms for Defining Comorbidities
    in ICD-9-CM and ICD-10 Administrative Data", Medical Care:43(11), Nov. 2005 p1130-1139.*/

/*final datasets to be merged are proj_int.charls_0_1yr and proj_int.charls_0_2yr*/

/****************************************************************************/
/* Rename variables macro                                                   */
/****************************************************************************/

%macro rename(lib,dsn,pre);
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "Before Renaming All Variables";
run;
proc sql noprint;
select nvar into :num_vars
from dictionary.tables
where libname="&LIB" and
memname="&DSN";
select distinct(name) into :var1-
:var%TRIM(%LEFT(&num_vars))
from dictionary.columns
where libname="&LIB" and
memname="&DSN";
quit;
run;
proc datasets library=&LIB;
modify &DSN;
rename
%do i=1 %to &num_vars;
&&var&i=&&var&i.._&pre 
%end;
;
quit;
run;
options pageno=1 nodate;
proc contents data=&lib..&dsn;
title "After Renaming All Variables";
run;
%mend rename;


%macro charlson(range1=,range2=);

data dx_charlson;
set proj_int.dx_&range1._&range2.(rename=(diag=dx_0));
dx=trim(left(dx_0));

if dx~="" then do;

*initialize variables;
   charlson_1=0;
   charlson_2=0;
   charlson_3=0;
   charlson_4=0;
   charlson_5=0;
   charlson_6=0;
      charlson_7=0;
	     charlson_8=0;
		    charlson_9=0;
			   charlson_10=0;
			      charlson_11=0;
				     charlson_12=0;
					    charlson_13=0;
						   charlson_14=0;
						      charlson_15=0;
							     charlson_16=0;
								    charlson_17=0;

*do over dx;
   *Myocardial Infarction;
   if(substr(dx,1,3)='410' or
               substr(dx,1,3)='412')
               and charlson_1=0
               then charlson_1=1;
   *Congestive heart failure;
   if(substr(dx,1,5)='39891' or
               substr(dx,1,5)='40201' or
               substr(dx,1,5)='40211' or
               substr(dx,1,5)='40291' or
               substr(dx,1,5)='40401' or
               substr(dx,1,5)='40403' or
               substr(dx,1,5)='40411' or
               substr(dx,1,5)='40413' or
               substr(dx,1,5)='40491' or
               substr(dx,1,5)='40493' or
               substr(dx,1,4)='4254' or
               substr(dx,1,4)='4255' or
               substr(dx,1,4)='4256' or
               substr(dx,1,4)='4257' or
               substr(dx,1,4)='4258' or
               substr(dx,1,4)='4259' or
               substr(dx,1,3)='428')
               and charlson_2=0
               then charlson_2=1;
   *Periphral Vascular Disease;
    if(substr(dx,1,4)='0930' or
               substr(dx,1,4)='4373' or
               substr(dx,1,3)='440' or
               substr(dx,1,3)='441' or
               substr(dx,1,4)='4431' or
               substr(dx,1,4)='4432' or
               substr(dx,1,4)='4438' or
               substr(dx,1,4)='4439' or
               substr(dx,1,4)='4471' or
               substr(dx,1,4)='5571' or
               substr(dx,1,4)='5579' or
               substr(dx,1,4)='V434')
               and charlson_3=0
               then charlson_3=1;
    *Cerebrovascular Disease ;
        if(substr(dx,1,5)='36234' or
               substr(dx,1,3)='430' or
               substr(dx,1,3)='431' or
               substr(dx,1,3)='432' or
               substr(dx,1,3)='433' or
               substr(dx,1,3)='434' or
               substr(dx,1,3)='435' or
               substr(dx,1,3)='436' or
               substr(dx,1,3)='437' or
               substr(dx,1,3)='438')
               and charlson_4=0
               then charlson_4=1;
    *Dementia ;
       if(substr(dx,1,3)='290' or
               substr(dx,1,4)='2941' or
               substr(dx,1,4)='3312')
               and charlson_5=0
               then charlson_5=1;
   *Chronic Pulmonary Disease ;
        if(substr(dx,1,4)='4168' or
               substr(dx,1,4)='4169' or
               substr(dx,1,3)='490' or
               substr(dx,1,3)='491' or
               substr(dx,1,3)='492' or
               substr(dx,1,3)='493' or
               substr(dx,1,3)='494' or
               substr(dx,1,3)='495' or
               substr(dx,1,3)='496' or
               substr(dx,1,3)='500' or
               substr(dx,1,3)='501' or
               substr(dx,1,3)='502' or
               substr(dx,1,3)='503' or
               substr(dx,1,3)='504' or
               substr(dx,1,3)='505' or
               substr(dx,1,4)='5064' or
               substr(dx,1,4)='5081' or
               substr(dx,1,4)='5088')
               and charlson_6=0
               then charlson_6=1;
*Connective Tissue Disease-Rheumatic Disease;
         if(substr(dx,1,4)='4465' or
               substr(dx,1,4)='7100' or
               substr(dx,1,4)='7101' or
               substr(dx,1,4)='7102' or
               substr(dx,1,4)='7103' or
               substr(dx,1,4)='7104' or
               substr(dx,1,4)='7140' or
               substr(dx,1,4)='7141' or
               substr(dx,1,4)='7142' or
               substr(dx,1,4)='7148' or
               substr(dx,1,3)='725')
               and charlson_7=0
               then charlson_7=1;
 *Peptic Ulcer Disease;
         if(substr(dx,1,3)='531' or
               substr(dx,1,3)='532' or
               substr(dx,1,3)='533' or
               substr(dx,1,3)='534')
               and charlson_8=0
               then charlson_8=1;
*Mild Liver Disease ;
         if(substr(dx,1,5)='07022' or
               substr(dx,1,5)='07023' or
               substr(dx,1,5)='07032' or
               substr(dx,1,5)='07033' or
               substr(dx,1,5)='07044' or
               substr(dx,1,5)='07054' or
               substr(dx,1,4)='0706' or
               substr(dx,1,4)='0709' or
               substr(dx,1,3)='570' or
               substr(dx,1,3)='571' or
               substr(dx,1,4)='5733' or
               substr(dx,1,4)='5734' or
               substr(dx,1,4)='5738' or
               substr(dx,1,4)='5739' or
               substr(dx,1,4)='V427')
               and charlson_9=0
               then charlson_9=1;
*Diabetes without complications ;
         if(substr(dx,1,4)='2500' or
               substr(dx,1,4)='2501' or
               substr(dx,1,4)='2502' or
               substr(dx,1,4)='2503' or
               substr(dx,1,4)='2508' or
               substr(dx,1,4)='2509')
               and charlson_10=0
               then charlson_10=1;
*Diabetes, complicated;
	if (substr(dx,1,4)='2504' or
		substr(dx,1,4)='2505' or
		substr(dx,1,4)='2506' or
		substr(dx,1,4)='2507')
		and charlson_11=0
                then charlson_11=1;
*Paraplegia and Hemiplegia ;
	if (substr(dx,1,4)='3341' or
		substr(dx,1,3)='342' or
		substr(dx,1,3)='343' or
		substr(dx,1,4)='3440' or
		substr(dx,1,4)='3441' or
		substr(dx,1,4)='3442' or
		substr(dx,1,4)='3443' or
                substr(dx,1,4)='3444' or
		substr(dx,1,4)='3445' or
		substr(dx,1,4)='3446' or
		substr(dx,1,4)='3449')
		and charlson_12=0
                then charlson_12=1;
* Renal Disease ;
	if (substr(dx,1,5)='40301' or
		substr(dx,1,5)='40311' or
		substr(dx,1,5)='40391' or
		substr(dx,1,5)='40402' or
		substr(dx,1,5)='40403' or
		substr(dx,1,5)='40412' or
		substr(dx,1,5)='40413' or
                substr(dx,1,5)='40492' or
		substr(dx,1,5)='40493' or
		substr(dx,1,3)='582' or
		substr(dx,1,4)='5830' or
                substr(dx,1,4)='5831' or
                substr(dx,1,4)='5832' or
                substr(dx,1,4)='5834' or
                substr(dx,1,4)='5836' or
                substr(dx,1,4)='5837' or
                substr(dx,1,3)='585' or
                substr(dx,1,3)='586' or
                substr(dx,1,4)='5880' or
                substr(dx,1,4)='V420' or
                substr(dx,1,4)='V451' or
                substr(dx,1,3)='V56' )
		and charlson_13=0
                then charlson_13=1;
*Cancer ;
	if (substr(dx,1,2)='14' or
		substr(dx,1,2)='15' or
		substr(dx,1,2)='16' or
		substr(dx,1,3)='170' or
		substr(dx,1,3)='171' or
		substr(dx,1,3)='172' or
		substr(dx,1,3)='174' or
		substr(dx,1,3)='175' or
		substr(dx,1,3)='176' or
		substr(dx,1,3)='179' or
		substr(dx,1,2)='18' or
		substr(dx,1,3)='190' or
		substr(dx,1,3)='191' or
		substr(dx,1,3)='192' or
		substr(dx,1,3)='193' or
		substr(dx,1,3)='194' or
		substr(dx,1,3)='195' or
                substr(dx,1,3)='200' or
                substr(dx,1,3)='201' or
                substr(dx,1,3)='202' or
                substr(dx,1,3)='203' or
                substr(dx,1,3)='204' or
                substr(dx,1,3)='205' or
                substr(dx,1,3)='206' or
                substr(dx,1,3)='207' or
                substr(dx,1,3)='208' or
                substr(dx,1,4)='2386' )
		and charlson_14=0
                then charlson_14=1;
* Moderate or Severe Liver Disease ;
	if (substr(dx,1,4)='4560' or
		substr(dx,1,4)='4561' or
		substr(dx,1,4)='4562' or
		substr(dx,1,4)='5722' or
		substr(dx,1,4)='5723' or
		substr(dx,1,4)='5724' or
      		substr(dx,1,4)='5728' )
		and charlson_15=0
                then charlson_15=1;
  * Metastatic Carcinoma ;
	if (substr(dx,1,3)='196' or
		substr(dx,1,3)='197' or
		substr(dx,1,3)='198' or
		substr(dx,1,3)='199' )
		and charlson_16=0
                then charlson_16=1;
  * AIDS/HIV ;
	if (substr(dx,1,3)='042' or
		substr(dx,1,3)='043' or
		substr(dx,1,3)='044' )
		and charlson_17=0
                then charlson_17=1;

end;

run;

/*get count of each comorbidity for each id-core year combination*/
proc sql;
create table cha_test1 as
select distinct bene_id,index_year,
sum(charlson_1) as cha_1,
sum(charlson_2) as cha_2,
sum(charlson_3) as cha_3,
sum(charlson_4) as cha_4,
sum(charlson_5) as cha_5,
sum(charlson_6) as cha_6,
sum(charlson_7) as cha_7,
sum(charlson_8) as cha_8,
sum(charlson_9) as cha_9,
sum(charlson_10) as cha_10,
sum(charlson_11) as cha_11,
sum(charlson_12) as cha_12,
sum(charlson_13) as cha_13,
sum(charlson_14) as cha_14,
sum(charlson_15) as cha_15,
sum(charlson_16) as cha_16,
sum(charlson_17) as cha_17
from dx_charlson
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data charlson_1(keep=bene_id index_year charls_1-charls_17 charls_index charls_index_wt);
set cha_test1;
array list_cha cha_1-cha_17;
array list_cha_bin charls_1-charls_17 ;

do over list_cha;
  list_cha_bin=0;

  if list_cha>0 then do;
    list_cha_bin=1;
   end;

end;
/*note this charls_index count count is not weighted for morbidity*/
charls_index=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+charls_11+charls_12+charls_13+charls_14+charls_15+charls_16+charls_17;
/*now morbidity weighted*/
charls_index_wt=charls_1+charls_2+charls_3+charls_4+charls_5+charls_6+charls_7+charls_8+charls_9+charls_10
+2*charls_11+2*charls_12+2*charls_13+2*charls_14+3*charls_15+6*charls_16+6*charls_17;

label charls_1 ="Myocardial infarction, Charlson";
label charls_2 ="Congestive Heart Failure, Charlson";
label charls_3 ="Peripheral Vascular Disease, Charlson";
label charls_4 ="Cerebrovascular disease, Charlson";
label charls_5 ="Dementia, Charlson";
label charls_6 ="Chronic Pulmonary Disease, Charlson";
label charls_7 ="Rheumatic disease, Charlson";
label charls_8 ="Peptic ulcer disease, Charlson";
label charls_9 ="Mild liver disease, Charlson";
label charls_10 ="Diabetes, uncomplicated, Charlson";
label charls_11 ="Diabetes, complicated, Charlson";
label charls_12 ="Hemiplegia or paraplegia, Charlson";
label charls_13 ="Renal disease, Charlson";
label charls_14 ="Any malignancy except neoplasm of skin, Charlson";
label charls_15 ="Mod or severe liver disease, Charlson";
label charls_16 ="Metastatic solid tumor, Charlson";
label charls_17 ="AIDS/HIV, Charlson";
label charls_index ="Charlson score index, not weighted";
label charls_index_wt ="Charlson score index, weighted";

run;

/*merge into list of obs with ffs mc 6m prior to ivw*/
proc sort data=charlson_1 out=test nodupkey;
by bene_id index_year;
run;



%rename(WORK,TEST,&range1._&range2);

data proj_int.charls_&range1._&range2.(rename =(bene_id_&range1._&range2=bene_id
index_year_&range1._&range2=index_year));
set test;
keep bene_id_&range1._&range2 charls: index_year:;
run;
proc sort data=proj_int.charls_&range1._&range2.;
by bene_id index_year;
run;

%mend;

%charlson(range1=0, range2=1yr);
%charlson(range1=0, range2=2yr);

proc freq data=proj_int.charls_0_1yr;
table charls:;
run;

proc freq data=proj_int.charls_0_2yr;
table charls:;
run;



H="DW chronic conditions"
/*CMS Data Warehouse Chronic Conditions*/
/*final datasets to merge are proj_int.chronic_21_1yr3_0 & proj_int.chronic_21_2yr3_0*/
/****************************************************************************/
/*First get the dx list into dot format using Stata*/
/****************************************************************************/

/*export to Stata*/
proc export data=proj_int.dx_0_1yr
outfile="E:\nhats\data\projects\serious_ill\int_data\dx_0_1yr.dta" replace;
run;

proc export data=proj_int.dx_0_2yr
outfile="E:\nhats\data\projects\serious_ill\int_data\dx_0_2yr.dta" replace;
run;

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO STATA HERE*/
/****************************************************************************/
/****************************************************************************/

capture log close
clear
set more off
local datapath E:\nhats\data\projects\serious_ill\int_data

use `datapath'\dx_0_1yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_1yr_2.dta,replace
outsheet using `datapath'\dx_0_1yr_2.csv, comma replace


clear all

use `datapath'\dx_0_2yr.dta,clear

// convert diagnosis codes to string variables, tostring diag,gen(icd9_c)
gen new=ltrim(diag)
icd9 check new,gen(icd9_c)
replace new="" if icd9_c>0 
// convert into dot format (ex 12.1 instead of 121)
icd9 clean new,dots 

replace diag=new
drop icd9_c new

save `datapath'\dx_0_2yr_2.dta,replace
outsheet using `datapath'\dx_0_2yr_2.csv, comma replace

/****************************************************************************/
/****************************************************************************/
/*SWITCH TO SAS HERE*/
/****************************************************************************/
/****************************************************************************/

proc import 
datafile="E:\nhats\data\projects\serious_ill\int_data\dx_0_1yr_2.csv" 
out=dx_0_1yr_2 replace;
run;

proc import 
datafile="E:\nhats\data\projects\serious_ill\int_data\dx_0_2yr_2.csv" 
out=dx_0_2yr_2 replace;
run;

/*bring in excel list of dx codes associated with each chronic condition*/
proc import 
datafile='E:\nhats\data\projects\serious_ill\ref_data\chronic_21_condition_icd9.xls'
out=icd9_21_chronic dbms=xls replace;
run;

proc contents data=icd9_21_chronic;
run;

/*creates macro variables of each of the chronic conditions listing of dx codes*/
proc sql;
select icd_9 into :chronic_desc1-:chronic_desc21 from icd9_21_chronic;
quit;
%put &chronic_desc10;
%put &chronic_desc5;

/*******************************************************************/
/*Macro to generate chronic conditions indicators using dx codes   */
/*******************************************************************/

%macro cc(precore=);

data list_&precore._dx;
set dx_0_&precore._2;
array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
do over list ;
list=0;
end;

diag_string=diag;

/* for dx codes that begin with numbers, process chronic cond variables*/
if anydigit(substr(trim(left(diag_string)),1,1))=1 then do;
diag=diag_string+0;

if diag in (&chronic_desc1) then CC_1_AMI=1;
if diag in (&chronic_desc2)  then CC_2_ALZH=1;
if diag in (&chronic_desc3)  then CC_3_ALZHDMTA=1;
if diag in (&chronic_desc4) then CC_4_ATRIALFB=1;
if diag in (&chronic_desc5) then CC_5_CATARACT=1;
if diag in (&chronic_desc6) then CC_6_CHRNKIDN=1;
if diag in (&chronic_desc7) then CC_7_COPD=1;
if diag in (&chronic_desc8) then CC_8_CHF=1;
if diag in (&chronic_desc9) then CC_9_DIABETES=1;
if diag in (&chronic_desc10) then CC_10_GLAUCOMA=1;
if diag in (&chronic_desc11) then CC_11_HIPFRAC=1;
if diag in (&chronic_desc12) then CC_12_ISCHMCHT=1;
if diag in (&chronic_desc13) then CC_13_DEPRESSN=1;
if diag in (&chronic_desc14) then CC_14_OSTEOPRS=1;
if diag in (&chronic_desc15) then CC_15_RA_OA=1;
if diag in (&chronic_desc16) then CC_16_STRKETIA=1;
if diag in (&chronic_desc17) then CC_17_CNCRBRST=1;
if diag in (&chronic_desc18) then CC_18_CNCRCLRC=1;
if diag in (&chronic_desc19) then CC_19_CNCRPRST=1;
if diag in (&chronic_desc20) then CC_20_CNCRLUNG=1;
if diag in (&chronic_desc21) then CC_21_CNCREndM=1;
end;

/*Process with dx codes that start with letters
Only two of them in the list*/
if anydigit(substr(trim(left(diag_string)),1,1))=0 then do;
if trim(left(diag_string)) in ("V431") then CC_5_CATARACT=1;
if trim(left(diag_string)) in ("V801") then CC_10_GLAUCOMA=1;
end;

run;


proc sql;
create table bid_dx_0_&precore. as
select distinct bene_id,index_year,
sum(CC_1_AMI) as CC_1_AMI,
sum(CC_2_ALZH) as CC_2_ALZH,
sum(CC_3_ALZHDMTA) as CC_3_ALZHDMTA,
sum(CC_4_ATRIALFB) as CC_4_ATRIALFB,
sum(CC_5_CATARACT) as CC_5_CATARACT,
sum(CC_6_CHRNKIDN) as CC_6_CHRNKIDN,
sum(CC_7_COPD) as CC_7_COPD,
sum(CC_8_CHF) as CC_8_CHF,
sum(CC_9_DIABETES) as CC_9_DIABETES,
sum(CC_10_GLAUCOMA) as CC_10_GLAUCOMA,
sum(CC_11_HIPFRAC) as CC_11_HIPFRAC,
sum(CC_12_ISCHMCHT) as CC_12_ISCHMCHT,
sum(CC_13_DEPRESSN) as CC_13_DEPRESSN,
sum(CC_14_OSTEOPRS) as CC_14_OSTEOPRS,
sum(CC_15_RA_OA) as CC_15_RA_OA,
sum(CC_16_STRKETIA) as CC_16_STRKETIA,
sum(CC_17_CNCRBRST) as CC_17_CNCRBRST,
sum(CC_18_CNCRCLRC) as CC_18_CNCRCLRC,
sum(CC_19_CNCRPRST) as CC_19_CNCRPRST,
sum(CC_20_CNCRLUNG) as CC_20_CNCRLUNG,
sum(CC_21_CNCREndM) as CC_21_CNCREndM

from list_&precore._dx group by bene_id,index_year;
quit;

proc sort data=bid_dx_0_&precore. nodupkey;
by bene_id index_year;
run;

/*convert to chronic condition vars. to binary variables*/
 data bid_dx_0_&precore.3;
 set bid_dx_0_&precore.;
 array list CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM
;
do over list ;
if list>0 then list=1;
if list<=0 then list=0;
end;

/*create aggregated indicators*/
CC_AMI_isch=CC_1_AMI|CC_12_ISCHMCHT;
CC_alzheim=CC_2_ALZH|CC_3_ALZHDMTA;
CC_cncr_chronic=CC_17_CNCRBRST | CC_18_CNCRCLRC | CC_19_CNCRPRST | CC_20_CNCRLUNG | 
	CC_21_CNCREndM ;
run;

proc means;
var CC_1_AMI
CC_2_ALZH
CC_3_ALZHDMTA
CC_4_ATRIALFB
CC_5_CATARACT
CC_6_CHRNKIDN
CC_7_COPD
CC_8_CHF
CC_9_DIABETES
CC_10_GLAUCOMA
CC_11_HIPFRAC
CC_12_ISCHMCHT
CC_13_DEPRESSN
CC_14_OSTEOPRS
CC_15_RA_OA
CC_16_STRKETIA
CC_17_CNCRBRST
CC_18_CNCRCLRC
CC_19_CNCRPRST
CC_20_CNCRLUNG
CC_21_CNCREndM;
run;

/*run rename macro*/
data test;
set bid_dx_0_&precore.3;
run;

%rename(WORK,TEST,&precore.);

data proj_int.chronic_21_&precore.3_0;
set test;
bene_id=bene_id_&precore.;
index_year=index_year_&precore.;
drop bene_id_&precore. index_year_&precore.;
run;

%mend;

/*2 datasets are proj_int.chronic_21_1yr_0 and proj_int.chronic_21_2yr_0*/
%cc(precore=1yr);
%cc(precore=2yr);

proc freq data=proj_int.chronic_21_1yr3_0;
table cc_:;
run;

proc freq data=proj_int.chronic_21_2yr3_0;
table cc_:;
run;

proc contents data=proj_int.chronic_21_1yr3_0;
run;


H="get add'l utilization info from claims"
/*These additional variables are just added to the dataset with the
elixhauser and cc's 1 year preceeding the interview, can add them
later when required to get the 2 year look-back dataset*/

/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set proj_int.ip_meet_&days.;
run;
data ip_&days._2;
set ip_meet_&days.;
type_adm=clm_ip_admsn_type_cd;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if erdaycnt>0 & erdaycnt~=. then ind_ed_charge=1;
if erdaycnt=0 | erdaycnt=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if index_date-admit_date>&days. then do;
	admit_date=index_date-&days.;
	admit_trunc=1;
	end;
if index_date<disch_date then do;
	disch_date=index_date;
	disch_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by bene_id index_year;
run;

proc sql;
create table ip_&days._3 as select distinct bene_id,index_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. pre ivw ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. pre ivw ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. pre ivw ivw",
/*ICU stays*/
count(case when icu_days>0 then 1 else . end) as n_icu_stays_&suffix. 
	label="ICU stays &suffix pre ivw",
/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. pre ivw ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. pre ivw ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. pre ivw ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. pre ivw ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. pre ivw ivw"

 from ip_&days._2 group by bene_id,index_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=6m);
%admissions(days=365,suffix=12m);

data elective_1;
set ip_365_2;
if elect_admit=1;
run;



proc sort data=ip_183_3 nodupkey;
by bene_id index_year;
run;


proc sql;
create table ip_6m as select a.*,b.icu_days_6m,b.n_icu_stays_6m,
b.n_ip_admit_6m,b.n_hospd_6m,b.n_em_urgent_admit_6m,b.n_em_admit_6m,
b.n_urgent_admit_6m,b.n_elect_admit_6m,b.n_ED_ip_6m
from proj_int.index a
left join
ip_183_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sort data=ip_365_3 nodupkey;
by bene_id index_year;
run;

proc sql;
create table ip1 as select a.*,b.icu_days_12m,b.n_icu_stays_12m,
b.n_ip_admit_12m,b.n_hospd_12m,b.n_em_urgent_admit_12m,b.n_em_admit_12m,
b.n_urgent_admit_12m,b.n_elect_admit_12m,b.n_ED_ip_12m
from ip_6m a
left join
ip_365_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

/*Dataset just contains obs with ffs mc 1yr and age 65+
So if missing, set var to 0*/
 data ip ;
 set ip1 ;
 array list icu_days_6m n_ip_admit_6m n_hospd_6m n_em_urgent_admit_6m 
	n_em_admit_6m n_urgent_admit_6m n_elect_admit_6m n_ED_ip_6m
	icu_days_12m n_ip_admit_12m n_hospd_12m n_em_urgent_admit_12m
	n_em_admit_12m n_urgent_admit_12m n_elect_admit_12m n_ED_ip_12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_6m=0 then ind_hosp_adm_6m=0;
 if n_ip_admit_6m>0 & n_ip_admit_6m~=. then ind_hosp_adm_6m=1;
 label ind_hosp_adm_6m="Indicator for any hospital admission 6m pre ivw";

 if n_em_urgent_admit_6m=0 then ind_em_ur_adm_6m=0;
 if n_em_urgent_admit_6m>0 & n_em_urgent_admit_6m~=. then ind_em_ur_adm_6m=1;
 label ind_em_ur_adm_6m="Ind any urgent or emergent hospital admission 6m pre ivw";

 if n_em_admit_6m=0 then ind_em_adm_6m=0;
 if n_em_admit_6m>0 & n_em_admit_6m~=. then ind_em_adm_6m=1;
 label ind_em_adm_6m="Ind any emergency hospital admission 6m pre ivw";

 if n_urgent_admit_6m=0 then ind_ur_adm_6m=0;
 if n_urgent_admit_6m>0 & n_urgent_admit_6m~=. then ind_ur_adm_6m=1;
 label ind_ur_adm_6m="Ind any urgent hospital admission 6m pre ivw";

 if n_elect_admit_6m =0 then ind_elect_adm_6m=0;
 if n_elect_admit_6m >0 & n_elect_admit_6m ~=. then ind_elect_adm_6m=1;
 label ind_elect_adm_6m="Ind any elective hospital admission 6m pre ivw";

 if (n_ip_admit_6m - n_elect_admit_6m)=0 then ind_nonelect_adm_6m=0;
 if (n_ip_admit_6m - n_elect_admit_6m)>0 & n_elect_admit_6m~=. then ind_nonelect_adm_6m=1;
 label ind_nonelect_adm_6m="Ind any non-elective hospital admission 6m pre ivw";

 n_nonelect_adm_6m=(n_ip_admit_6m - n_elect_admit_6m);
 label n_nonelect_adm_6m="total n non-elective ip admit 6m pre ivw";

 if n_ED_ip_6m=0 then ind_ED_adm_6m=0;
 if n_ED_ip_6m>0 & n_ED_ip_6m~=. then ind_ED_adm_6m=1;
 label ind_ED_adm_6m="Ind ED use with hospital admission 6m pre ivw, from charges";

 if n_ip_admit_12m=0 then ind_hosp_adm_12m=0;
 if n_ip_admit_12m>0 & n_ip_admit_12m~=. then ind_hosp_adm_12m=1;
 label ind_hosp_adm_12m="Indicator for any hospital admission 12m pre ivw";

 if n_em_urgent_admit_12m=0 then ind_em_ur_adm_12m=0;
 if n_em_urgent_admit_12m>0 & n_em_urgent_admit_12m~=. then ind_em_ur_adm_12m=1;
 label ind_em_ur_adm_12m="Ind any urgent or emergent hospital admission 12m pre ivw";

 if n_em_admit_12m=0 then ind_em_adm_12m=0;
 if n_em_admit_12m>0 & n_em_admit_12m~=. then ind_em_adm_12m=1;
 label ind_em_adm_12m="Ind any emergency hospital admission 12m pre ivw";

 if n_urgent_admit_12m=0 then ind_ur_adm_12m=0;
 if n_urgent_admit_12m>0 & n_urgent_admit_12m~=. then ind_ur_adm_12m=1;
 label ind_ur_adm_12m="Ind any urgent hospital admission 12m pre ivw";

 if n_elect_admit_12m =0 then ind_elect_adm_12m=0;
 if n_elect_admit_12m >0 & n_elect_admit_12m ~=. then ind_elect_adm_12m=1;
 label ind_elect_adm_12m="Ind any elective hospital admission 12m pre ivw";

 if (n_ip_admit_12m - n_elect_admit_12m)=0 then ind_nonelect_adm_12m=0;
 if (n_ip_admit_12m - n_elect_admit_12m)>0 & n_elect_admit_12m~=. then ind_nonelect_adm_12m=1;
 label ind_nonelect_adm_12m="Ind any non-elective hospital admission 12m pre ivw";

 n_nonelect_adm_12m=(n_ip_admit_12m - n_elect_admit_12m);
 label n_nonelect_adm_12m="total n non-elective ip admit 12m pre ivw";

 if n_ED_ip_12m=0 then ind_ED_adm_12m=0;
 if n_ED_ip_12m>0 & n_ED_ip_12m~=. then ind_ED_adm_12m=1;
 label ind_ED_adm_12m="Ind ED use with hospital admission 12m pre ivw, from charges";

run;

 proc freq;
 table icu_days_6m n_ip_admit_6m n_hospd_6m ind_hosp_adm_6m n_em_urgent_admit_6m ind_em_ur_adm_6m 
	ind_em_adm_6m ind_ur_adm_6m ind_nonelect_adm_6m n_nonelect_adm_6m n_ED_ip_6m ind_ED_adm_6m 
	ind_em_adm_6m*ind_ED_adm_6m /missprint;
 run;

proc freq;
table icu_days_12m n_ip_admit_12m n_hospd_12m ind_hosp_adm_12m n_em_urgent_admit_12m ind_em_ur_adm_12m
	ind_em_adm_12m ind_ur_adm_12m ind_nonelect_adm_12m n_nonelect_adm_12m n_ED_ip_12m ind_ED_adm_12m 
	ind_em_adm_12m*ind_ED_adm_12m /missprint;
run;

/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months preceding the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months pre-interview*/
data snf_meet_365;
set proj_int.snf_meet_365;
run;

proc sort data=snf_meet_365;
by bene_id admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *1797*/
proc sql;
create table snf_meet1_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date - disch_date)>=0; 
quit;


/*meet time window 2 *152*/
proc sql;
create table snf_meet2_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_pre_365_1;
set snf_meet2_pre_365;
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *135 */
proc sql;
create table snf_meet3_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_pre_365_1;
set snf_meet3_pre_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 , overlap both start and end dates n=7*/
proc sql;
create table snf_meet4_pre_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_pre_365_1;
set snf_meet4_pre_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_pre_365;
set snf_meet1_pre_365 snf_meet2_pre_365_1 snf_meet3_pre_365_1 snf_meet4_pre_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data proj_int.snf_meet_pre_365 ;
set  snf_meet_pre_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data pre_snf_days_1;
set proj_int.snf_meet_pre_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=pre_snf_days_1;
by bene_id index_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bene_id,index_year,
sum(calc_snf_LOS)
	as n_snf_days_12m
	from pre_snf_days_1 group by bene_id,index_year;
quit;


/*merge into full ffs 1yr, age 65+ dataset*/
proc sort data=snf_days_pre nodupkey;
by bene_id index_year;
run;



 data snf ;
 set snf_days_pre ;
 array list n_snf_days_12m;
 do over list;
 if list=. then list=0;
 end; 

if n_snf_days_12m=0 then ind_snf_use_12m=0;
 if n_snf_days_12m>0 & n_snf_days_12m~=. then ind_snf_use_12m=1;
 label ind_snf_use_12m="Indicator for any SNF stay 12m pre ivw";
 label n_snf_days_12m="SNF Days 12m pre ivw";

run;


proc freq data=snf; tables n_snf_days_12m / missprint; run;
/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.mbsf_06_16 out=dn_2000_20122  nodupkey;
by bene_id year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table esrd1 as select
a.*,b.Bene_ESRD_IND from 
proj_int.index a left join
dn_2000_20122 b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year=b.year;
quit;

proc freq;
table bene_esrd_ind /missprint;
run;

data esrd;
set esrd1 ;
if bene_esrd_ind='Y' then esrd_ind_n=1;
if bene_esrd_ind='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop bene_esrd_ind;
run;

proc freq;
table esrd_ind_n /missprint;
run;

/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen1(keep=bene_id index_year oxygen);
set proj_int.dm_meet_365;
oxygen=0;
if h_o2>0 then oxygen=1;
if oxygen=1;
run;

proc sort data=oxygen1 out=oxygen nodupkey;
by bene_id index_year;
run;
proc contents data=medi.op_09_16; run;
data ed_op_1;
set proj_int.op_meet_365(keep=bene_id admit_date disch_date index_date index_year erdaycnt obs_stay);
if erdaycnt>0 then ed_op=1;
if erdaycnt=0 then ed_op=0;
if obs_stay=. then obs_stay=0;
if obs_stay>1 then obs_stay=1;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bene_id,index_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_12m,
sum(obs_stay) as n_obs_stay_12m,
max(obs_stay) as obs_stay_12m
	from ed_op_1 group by bene_id,index_year;
quit;




proc sort data=ed_op_2 nodupkey;
by bene_id index_year;
run;


data ed ;
set ed_op_2;
if n_ed_op_visits_12m=. then n_ed_op_visits_12m=0;
label n_ed_op_visits_12m="Count ED OP visits, 1yr pre ivw";

if n_ed_op_visits_12m=0 then ind_ed_op_12m=0;
if n_ed_op_visits_12m>0 & n_ed_op_visits_12m~=. then ind_ed_op_12m=1;
label ind_ed_op_12m="Indicator any ED OP visits, 1 yr pre ivw";

if n_obs_stay_12m=. then n_obs_stay_12m=0;
label n_obs_stay_12m="Number obs stays, 1 yr pre ivw";

if n_obs_stay_12m=. then obs_stay_12m=0;
label obs_stay_12m="Indicator any obs stay, 1 yr pre ivw";
run;

proc freq; tables n_ed_op_visits_12m n_obs_stay_12m /missprint; run;

data hh(keep=bene_id index_year ind_hh_12m);
set proj_int.hh_meet_365;
ind_hh_12m=1;
run;

proc sort data=ip out=ip nodupkey; by bene_id index_year; run;
proc sort data=snf out=snf nodupkey; by bene_id index_year; run;
proc sort data=esrd out=esrd nodupkey; by bene_id index_year; run;
proc sort data=oxygen out=oxygen nodupkey; by bene_id index_year; run;
proc sort data=ed out=ed nodupkey; by bene_id index_year; run;
proc sort data=hh out=hh nodupkey; by bene_id index_year; run;


/*housecalls

housecall codes (from Bruce Kinosian from CMS on 8/16/17) are 99341-99350
and dom care codes are 99324-99328 and 99334-99337

POS codes are 12 13 14

*/

%macro pb_pre (days=,suf=);

proc sql;
create table pb_meet_&days.d_bef as select * from
proj_int.index a
left join medi.pb_09_16 b
on a.bene_id=b.bene_id and admit_date<=index_date<=admit_date+&days;
quit;


data hc;
set pb_meet_&days.d_bef;
array this hcpcscd1-hcpcscd13;
code=0;
do over this;
if in(this,"99324","99325","99326","99327","99328","99334","99335","99336","99337", 
	"99341","99342","99343","99344","99345","99346","99347","99348","99349","99350") and code=0 
	then code=1;
end;
array that pos1-pos13;
place=0;
do over that;
if in(that,"12","13","14") and place=0 then place=1;
end;
housecall=place=1 and code=1;
run;

proc sql; 
create table hc_&suf as select distinct bene_id, index_date,
sum(housecall) as n_housecalls_&suf
from hc
group by bene_id, index_date;
quit;

%mend;

/*housecalls

housecall codes (from Bruce Kinosian from CMS on 8/16/17) are 99341-99350
and dom care codes are 99324-99328 and 99334-99337

POS codes are 12 13 14

*/

%macro pb_post (days=,suf=);

proc sql;
create table pb_meet_&days.d_bef as select * from
proj_int.index a
left join medi.pb_09_16 b
on a.bene_id=b.bene_id and admit_date>=index_date>=admit_date-&days;
quit;


data hc;
set pb_meet_&days.d_bef;
array this hcpcscd1-hcpcscd13;
code=0;
do over this;
if in(this,"99324","99325","99326","99327","99328","99334","99335","99336","99337", 
	"99341","99342","99343","99344","99345","99346","99347","99348","99349","99350") and code=0 
	then code=1;
end;
array that pos1-pos13;
place=0;
do over that;
if in(that,"12","13","14") and place=0 then place=1;
end;
housecall=place=1 and code=1;
run;

proc sql; 
create table hc_&suf as select distinct bene_id, index_date,
sum(housecall) as n_housecalls_&suf
from hc group by bene_id, index_date;
quit;

%mend;

%pb_pre(days=365,suf=n12m);
%pb_pre(days=90,suf=n3m);
%pb_post(days=365,suf=p12m);
%pb_post(days=90,suf=p3m);

proc sql;
create table pb as select * from
proj_int.index a
left join 
hc_n3m b
on a.bene_id=b.bene_id and a.index_date=b.index_date
left join
hc_n12m c
on a.bene_id=c.bene_id and a.index_date=c.index_date
left join 
hc_p3m d
on a.bene_id=d.bene_id and a.index_date=d.index_date
left join
hc_p12m e
on a.bene_id=e.bene_id and a.index_date=e.index_date;
quit;

proc sql;
create table proj_int.utilization_pre as select * 
from proj_int.index a 
left join
ip b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join 
snf c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year
left join 
esrd d
on trim(left(a.bene_id))=trim(left(d.bene_id)) and a.index_year=d.index_year
left join
oxygen e
on trim(left(a.bene_id))=trim(left(e.bene_id)) and a.index_year=e.index_year
left join 
ed f
on trim(left(a.bene_id))=trim(left(f.bene_id)) and a.index_year=f.index_year
left join
hh g
on trim(left(a.bene_id))=trim(left(g.bene_id)) and a.index_year=g.index_year
left join 
pb h
on trim(left(a.bene_id))=trim(left(h.bene_id)) and a.index_year=h.index_year;
quit;

proc contents data=proj_int.utilization_pre; 
run;



H="classify SI based on primary dx"
/*recoded as a macro and use either the primary diagnosis or admitting diagnoses AD_DGNS */

/*start with IP claim list, 1 year before interview*/

%macro singledx(dxvar=,name=);
data dx_1_&name.;
set proj_int.ip_meet_365;

&name._dx=trim(left(&dxvar.));

if &name._dx~="" then do;

chf_&name._dx=0;
copd_&name._dx=0;
hip_&name._dx=0;

/*CHF*/
if (substr(&name._dx,1,5)='39891' or
		substr(&name._dx,1,5)='40211' or
		substr(&name._dx,1,5)='40291' or
		substr(&name._dx,1,5)='40411' or
		substr(&name._dx,1,5)='40413' or
		substr(&name._dx,1,5)='40491' or
		substr(&name._dx,1,5)='40493' or
		substr(&name._dx,1,3)='428') 
		and chf_&name._dx=0 
		then chf_&name._dx=1;*add one binary variables here.;
/*COPD*/
	if (substr(&name._dx,1,3)='490' or
		substr(&name._dx,1,3)='491' or
		substr(&name._dx,1,3)='492' or
		substr(&name._dx,1,4)='4930' or
		substr(&name._dx,1,4)='4931' or
		substr(&name._dx,1,4)='4932' or
		substr(&name._dx,1,4)='4938' or
		substr(&name._dx,1,5)='49390' or
		substr(&name._dx,1,5)='49391' or
		substr(&name._dx,1,3)='494' or
		substr(&name._dx,1,3)='495' or
		substr(&name._dx,1,3)='496' or
		substr(&name._dx,1,3)='497' or
		substr(&name._dx,1,3)='498' or
		substr(&name._dx,1,3)='499' or
		substr(&name._dx,1,3)='500' or
		substr(&name._dx,1,3)='501' or
		substr(&name._dx,1,3)='502' or
		substr(&name._dx,1,3)='503' or
		substr(&name._dx,1,3)='504' or
		substr(&name._dx,1,3)='505' or
		substr(&name._dx,1,4)='5064') 
			and copd_&name._dx=0 
		then copd_&name._dx=1;	
*hip fracture;
if (substr(&name._dx,1,3)='820' ) 
		and hip_&name._dx=0 
		then hip_&name._dx=1;*add one binary variables here.;
end;
run;

proc sql;
create table &name._dx_2 as
select distinct bene_id,index_year,
sum(chf_&name._dx) as chf_&name.,
sum(copd_&name._dx) as copd_&name.,
sum(hip_&name._dx) as hip_&name.
from dx_1_&name.
group by bene_id,index_year;
quit;

/*convert counts of diagnoses for each comorbidity to indicator variables*/ 
data &name._dx_3(keep=bene_id index_year chf_&name._dx copd_&name._dx hip_&name._dx);
set &name._dx_2 ;
array list_com chf_&name. copd_&name. hip_&name.;
array list_com_bin chf_&name._dx copd_&name._dx hip_&name._dx;

do over list_com;
  list_com_bin=0;

  if list_com>0 then do;
    list_com_bin=1;
   end;

end;

run;

proc freq;
table chf_&name._dx copd_&name._dx hip_&name._dx;
run;
%mend;

/*use primary diagnosis code*/
%singledx(dxvar=icd_dgns_cd1,name=pri);
/*use admitting diagnosis code*/
%singledx(dxvar=ADmtg_DGNS_cd,name=adm);

/*merge together*/

proc sql;
create table dx_both as select *
from proj_int.index a 
left join 
pri_dx_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join
adm_dx_3 c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year;
quit;

data dx_both2;
set dx_both;

array list chf_pri_dx copd_pri_dx hip_pri_dx chf_adm_dx copd_adm_dx hip_adm_dx;
do over list;
	if list = .  then list=0;
end;
label chf_pri_dx="CHF as primary dx from IP claim, 1yr pre ivw";
label copd_pri_dx="COPD as primary dx from IP claim, 1yr pre ivw";
label hip_pri_dx="Hip fracture as primary dx from IP claim, 1yr pre ivw";

label chf_adm_dx="CHF as admitting dx from IP claim, 1yr pre ivw";
label copd_adm_dx="COPD as admitting dx from IP claim, 1yr pre ivw";
label hip_adm_dx="Hip fracture as admitting dx from IP claim, 1yr pre ivw";

run;


/*Hip fracture criteria, method  by Covinsky
One of the (2) criteria met:
(1) Subject was admitted to a hospital with admitting diagnosis of “820.xx”.
(2) There is a physician record of “HF procedure” (defined by CPT code of 27230-27248) that is supported by either: 
a. Another physician record within 2 days OR 2
b. Relevant surgery during hospitalization. (Relevant surgery is defined by ICD9 codes 785.5, 790.5, 791.5, 792.5). 
(1) variable hip_adm_dx defined in macro above
(2) HF procedure: carrier claims 	(HCPCS_YR specifies the year of CPT coding used)
					hcpcscd01-hcpcscd13 The level 1 HCPCS code is the CPT code
Then a)from carrier claims or 
     b) from IP claims
	

For item (2) checked inpatient claims variables hcpcscd01-45 but none had any of the CPT codes in the list
Next step, try running with carrier files...
*/

/********************************************************************/
/*Physican record of HF procedure, check IP claims
There are no observations with the HF procedure codes in the IP claims, this method isn't
used in creating the final variable*/
data ip_meet_365;
set proj_int.ip_meet_365;
run;

proc contents data=ip_meet_365;
run;

data testhf;
set ip_meet_365;
if HCPcSCD1~='';
run;

data hfproc_ip;
set ip_meet_365;
hf_proc_ind=0;
array list hcpcscd1-hcpcscd45;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;


run;

proc freq; table hf_proc_ind;
run;

/********************************************************************/
/*Physican record of HF procedure, check carrier claims*/
/********************************************************************/

data hfproc_carr;
set proj_int.pb_meet_365;
hf_proc_ind=0;
array list hcpcscd1-hcpcscd13;
do over list;
if list~='' then do;
	if (list='27230' or
		list='27231' or
		list='27232' or
		list='27233' or
		list='27234' or
		list='27235' or
		list='27236' or
		list='27237' or
		list='27238' or
		list='27239' or
		list='27240' or
		list='27241' or
		list='27242' or
		list='27243' or
		list='27244' or
		list='27245' or
		list='27246' or
		list='27247' or
		list='27248')
		/*and hf_proc_ind=0*/
		then hf_proc_ind=1;
	end;
end;

run;

proc freq; table hf_proc_ind;
run;
/********************************************************************/
/*is there also a physican record within 2 days?*/
proc sort data=hfproc_carr; by bene_id admit_date disch_date hf_proc_ind;
run;

data hfproc_carr_2;
set hfproc_carr;
if eof1=0 then
	set hfproc_carr (firstobs=2 keep=admit_date disch_date rename=(admit_date=lead1admit disch_date=lead1disch)) end=eof1;
else do; lead1admit=.;  lead1disch=.; end;
run;

data hfproc_carr_3;
set hfproc_carr_2;
days_next_visit=lead1admit-disch_date;
days_next_disch=lead1disch-disch_date;
if hf_proc_ind=1 and days_next_visit<=2 and days_next_visit~=. & days_next_disch>0 then hf_w_visit_2d=1;
else hf_w_visit_2d=0;
run;

data hfproc_carr_4;
set hfproc_carr_3;
if hf_proc_ind=1;
run;

proc freq data=hfproc_carr_3;
table hf_proc_ind hf_w_visit_2d index_year; run;

/*if have hf CPT code from carrier, but no subsequent carrier claim,
do they have a surgery code from the inpatient claims?*/
data hfproc_carr_5;
set hfproc_carr_4;
if hf_proc_ind=1 and hf_w_visit_2d=0;
run;




/*for b) identify relevant surgeries from IP claims CPT codes and surgery dates*/

/*This section of code for just checking For Surgeries*/
data ip_meet_365;
set proj_int.ip_meet_365;
run;

proc contents data=ip_meet_365;
run;

data proc_long(keep=bene_id CLM_IP_ADMSN_TYPE_CD procedure procedure_date date_imp_yes ADMTG_DGNS_CD icd_dgns_cd1-ICD_DGNS_CD25
	 admit_date disch_date index_year);
set ip_meet_365;
array list ICD_PRCDR_CD1-ICD_PRCDR_CD25;
array date PRCDR_DT1-PRCDR_DT25;
do over list;
if list~="" then do;
	procedure=list;
	if date=0000000 then do;
		procedure_date=admit_date;
		date_imp_yes=1;
		end;
	if date~=0000000 then do;
	procedure_date=datejul(date);
	end;
	output;
end;
end;

format procedure_date date10.;
format admit_date date10.;
format disch_date date10.;

run;

proc freq; table date_imp_yes; run;
/* Identify surgeries that meet the criteria
Indicator variable surgery_meet = 1 if yes, include in sample 
79 surgeries meet the criteria*/
data surgery_meet;
set proc_long;
if length(compress(procedure))>3 then do;

if compress(procedure)+0 in (7855, 7905, 7915, 7925) then surgery_meet=1;

end;
/*only keep observations in work.surgery_meet that meet criteria*/
if surgery_meet then output;

run;
/*End surgery section 1*/

/*who has surgery that meets criteria AND hf CPT code from carrier?*/
proc sql;
create table cpt_and_surg as select a.*,b.admit_date as carr_hf_admit, b.disch_date as carr_hf_disch,
b.hf_proc_ind, b.hf_w_visit_2d from 
surgery_meet a inner join
hfproc_carr_5 b
on trim(left(a.bene_id))=trim(left(b.bene_id));
quit;

data cpt_and_surg_1;
set cpt_and_surg;
format carr_hf_admit carr_hf_disch date9.;
hf_w_surgery=1;
run;

/*now merge in lists to get a list of bid's that meet criteria 1 or 2*/
data cpt_and_surg_2;
set cpt_and_surg_1;
keep bene_id hf_proc_ind hf_w_surgery index_year;
run;

proc sort data=cpt_and_surg_2 nodupkey; by bene_id index_year ; run;

data hfproc_carr_6;
set hfproc_carr_4;
keep bene_id hf_proc_ind hf_w_visit_2d index_year;
if hf_proc_ind=1 and hf_w_visit_2d=1;
run;

proc sort data=hfproc_carr_6 nodupkey; by bene_id  index_year ; run;

*merge the datasets;
data hf_meet;
merge hfproc_carr_6 cpt_and_surg_2 ;
by bene_id index_year;
run;

proc sort data=hf_meet out=hf_meet2 nodupkey; by bene_id  index_year; run;

proc sql;
create table hf_meet3 as select* from
proj_int.index a 
left join 
hf_meet2 b 
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit;

data hf_meet4;
set hf_meet3;

array list hf_proc_ind hf_w_visit_2d hf_w_surgery ;
do over list;
	if list = .  then list=0;
end;
label hf_w_visit_2d ="HF CPT + Dr visit within 2 days, 1yr pre ivw";
label hf_w_surgery ="HF CPT + Surgery, 1yr pre ivw";

run;

proc freq; table hf_w_visit_2d hf_w_surgery; run;

/*Another idea is to check IP claims
if CPT code (in fields proj_int-HCPCSCD45 in list then if PRCDRCD1-PRCDRCD25 in list = hip frature = yes*/

/*merge new variables*/

proc sql;
create table proj_int.criteria as select * from
dx_both2 a
left join hf_meet4 b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;


H="get spending from claims"
/*Add total Medicare payments from claims 1 index_date after interview
and 6m after interview*/

/*Claims files from 2000-2012, claims pulled in previous section
to get just claims that are within 1 index_date of the interview dates
for those interviews were r>65 and ffs medicare 1 yr prior to ivw*/

/**********************************************************/
/**********************************************************/
/*totals from mp file*/
/*Note: variable SSLSSNF from mp claims is N=Skilled nursing facility*/
/*Two totals are calculated - one for skilled nursing facility claims
and one for all other claims in the mp file (inpatient claims)*/
/**********************************************************/
/**********************************************************/

%macro mp(month_n=,days_start=,days_after_core=,source=,equ=,name=);

/*Case 1 - no adjustment needed - claims where entire claim is within the x months after the interview*/
proc sql;
create table &source._meet_post_1 as select *
from proj_int.&source._meet_&days_after_core.p
where &days_start<=disch_date-index_date<=&days_after_core and
&days_start<=admit_date-index_date<=&days_after_core;
quit;

data zz_&source._meet_post_1;
set &source._meet_post_1;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;

/*Case 2 - adjustment needed because part of stay is in the window but part is after the window has ended
Claims with admission date within start of x months but discharge date is after the x month window*/
proc sql;
create table &source._meet2_post as select *
from proj_int.&source._meet_&days_after_core.p
where disch_date-index_date>&days_after_core and 0<=admit_date-index_date<=&days_after_core;
quit;

data zz_&source._meet2_post;
set &source._meet2_post;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


/*identify fraction of claims that span x month period that should be 
attributed to the x month period
by just using the fraction of time that was included in the span*/
data &source._meet3_post;
set &source._meet2_post;
pct_xm=((index_date+&days_after_core)-admit_date)/(disch_date-admit_date);
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*Case 3 - adjustment needed because part of stay is in the window but part is before the window started
Claims with discharge date within start of x months but admit date is before the interview date*/
proc sql;
create table &source._meet4_post as select *
from proj_int.&source._meet_&days_after_core.p
where disch_date-index_date<=&days_after_core and admit_date-index_date<&days_start;
quit;

data zz_&source._meet4_post;
set &source._meet4_post;
ivw_to_admit=admit_date-index_date;
ivw_to_disch=disch_date-index_date;
run;
proc means; var ivw_to_admit ivw_to_disch; run;


data &source._meet5_post;
set &source._meet4_post;
pct_xm=(disch_date-index_date)/(disch_date-admit_date);
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
/*scale the partial claims by the time within the x month period*/
list=list*pct_xm;
end;

run;

/*adjust for inflation, Uses CPI for Medical Services from 
BLS website, accessed 5/4/2015*/

/*create table merging both the claims fully in the 2 index_date period 
and those partially in that time
adjust for inflation here also*/
data &source._cost_post;
set &source._meet_post_1 &source._meet3_post &source._meet5_post;
array list clm_pmt_amt clm_pass_thru_per_diem_amt;
do over list;
if list=. then list=0;
end;


if year(admit_date)=2014 then rate=1;
if year(admit_date)=2013 then rate=1.02377;
if year(admit_date)=2012 then rate=1.05554;
if year(admit_date)=2011 then rate=1.09671;
if year(admit_date)=2010 then rate=1.13032;
if year(admit_date)=2009 then rate=1.16989;
if year(admit_date)=2008 then rate=1.20745;
if year(admit_date)=2007 then rate=1.25859;
if year(admit_date)=2006 then rate=1.32572;
if year(admit_date)=2005 then rate=1.38045;
if year(admit_date)=2004 then rate=1.44662;
if year(admit_date)=2003 then rate=1.51895;
if year(admit_date)=2002 then rate=1.58688;
if year(admit_date)=2001 then rate=1.66714;
if year(admit_date)=2000 then rate=1.74736;
if year(admit_date)<=1999 then rate=1.8833;


&source._paid_by_mc=rate*(clm_pmt_amt+clm_pass_thru_per_diem_amt);
run;
*calculates total of mc charges for the claim type by hrs bid;
proc sql;
create table &source._pay_post as select distinct bene_id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc 
from &source._cost_post group by bene_id,index_date;
quit;

*merges the totals above with the full interview list;
proc sql;
create table &source._&name._post as select
a.*,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc_&name.
from proj_int.index a
left join
 &source._pay_post b
 on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_date=b.index_date;
 quit;

 proc sort data=&source._&name._post ;
 by bene_id index_date;
 run;
%mend;

/*Runs macro to get total for the SNF claims*/
%mp(days_start=0,days_after_core=730,source=snf,equ=,name=24m );
%mp(days_start=0,days_after_core=365,source=snf,equ=,name=12m );
%mp(days_start=0,days_after_core=183,source=snf,equ=,name=6m );
/*Runs macro to get total for the inpatient (not SNF) claims*/
%mp(days_start=0,days_after_core=730,source=ip,equ=~,name=24m );
%mp(days_start=0,days_after_core=365,source=ip,equ=~,name=12m );
%mp(days_start=0,days_after_core=183,source=ip,equ=~,name=6m );

/**********************************************************/
/**********************************************************/
/*totals from other claim types*/
/**********************************************************/
/**********************************************************/
/*macro to calculate totals for the claims that are not in medpar files*/
%macro all_other(source=,month_n=,days_start=,days_after_core=);

/*Adjust for inflation*/
data &source._meet2_post;
set proj_int.&source._meet_&days_after_core.p;
/*adjust to 2014 dollars*/

if year(admit_date)=2014 then rate=1;
if year(admit_date)=2013 then rate=1.02377;
if year(admit_date)=2012 then rate=1.05554;
if year(admit_date)=2011 then rate=1.09671;
if year(admit_date)=2010 then rate=1.13032;
if year(admit_date)=2009 then rate=1.16989;
if year(admit_date)=2008 then rate=1.20745;
if year(admit_date)=2007 then rate=1.25859;
if year(admit_date)=2006 then rate=1.32572;
if year(admit_date)=2005 then rate=1.38045;
if year(admit_date)=2004 then rate=1.44662;
if year(admit_date)=2003 then rate=1.51895;
if year(admit_date)=2002 then rate=1.58688;
if year(admit_date)=2001 then rate=1.66714;
if year(admit_date)=2000 then rate=1.74736;
if year(admit_date)<=1999 then rate=1.8833;

&source._paid_by_mc=rate*(clm_pmt_amt);
run;

/*Calculate total mc payments by ID*/
proc sql;
create table &source._pay_post as select distinct bene_id,index_date,
sum(&source._paid_by_mc) as &source._paid_by_mc
from &source._meet2_post group by bene_id,index_date;
quit;

/*merge in mc totals with interview list*/
proc sql;
create table &source.&month_n._post as select
a.*,coalesce(b.&source._paid_by_mc,0) as &source._paid_by_mc&month_n 
from proj_int.index a
left join
 &source._pay_post b
 on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_date=b.index_date;
 quit;

 proc sort data=&source&month_n._post ;
 by bene_id index_date;
 run;
 %mend all_other;

/******************************************************************/
/* Run the macro over the mc claims files for 2 index_dates prior to death*/
/******************************************************************/
 %all_other(source=op,month_n=_24m,days_start=0,days_after_core=730);
  %all_other(source=pb,month_n=_24m,days_start=0,days_after_core=730);
   %all_other(source=hh,month_n=_24m,days_start=0,days_after_core=730);
    %all_other(source=hs,month_n=_24m,days_start=0,days_after_core=730);
     %all_other(source=dm,month_n=_24m,days_start=0,days_after_core=730);

%all_other(source=op,month_n=_12m,days_start=0,days_after_core=365);
  %all_other(source=pb,month_n=_12m,days_start=0,days_after_core=365);
   %all_other(source=hh,month_n=_12m,days_start=0,days_after_core=365);
    %all_other(source=hs,month_n=_12m,days_start=0,days_after_core=365);
     %all_other(source=dm,month_n=_12m,days_start=0,days_after_core=365);

 %all_other(source=op,month_n=_6m,days_start=0,days_after_core=183);
  %all_other(source=pb,month_n=_6m,days_start=0,days_after_core=183);
   %all_other(source=hh,month_n=_6m,days_start=0,days_after_core=183);
    %all_other(source=hs,month_n=_6m,days_start=0,days_after_core=183);
     %all_other(source=dm,month_n=_6m,days_start=0,days_after_core=183);

/******************************************************************/
/* Merge into single file, by id and interview */
/******************************************************************/
*first merge 12m and 6m spending into single dataset;
data proj_int.mc_costs_all;
merge ip_24m_post snf_24m_post hh_24m_post hs_24m_post pb_24m_post op_24m_post dm_24m_post
ip_12m_post snf_12m_post hh_12m_post hs_12m_post pb_12m_post op_12m_post dm_12m_post
 ip_6m_post snf_6m_post hh_6m_post hs_6m_post pb_6m_post op_6m_post dm_6m_post;
by bene_id index_date;
run;

proc means data=proj_int.mc_costs_all; run;

H="other outcomes from claims"
/*These additional variables are just added to the dataset with the
elixhauser and cc's 1 year preceeding the interview, can add them
later when required to get the 2 year look-back dataset*/

/****************************************************************************/
/*Get indicator of any hospital admission 6 and 12 months pre-core interview*/
/****************************************************************************/

%macro admissions(days=,suffix=);

/*pull list of ip claims from all medpar claims x days pre-interview*/
data ip_meet_&days.;
set proj_int.ip_meet_&days.p;
run;
data ip_&days._2;
set ip_meet_&days.;
type_adm=clm_ip_admsn_type_cd;
if icarecnt=. then icarecnt=0; /*medpar intensive care day count*/
if CRNRYDAY=. then CRNRYDAY=0; /*medpar coronary day count*/
icu_days=icarecnt+CRNRYDAY;
em_urgent_admit=0; /*Urgent , emergent admissions from admission type*/
if type_adm in (1,2) then em_urgent_admit=1;
em_admit=0;
if type_adm=1 then em_admit=1;
urgent_admit=0;
if type_adm=2 then urgent_admit=1;
elect_admit=0;
if type_adm=3 then elect_admit=1;
ind_ed_charge=0; /*ED charges as another indicator of ED use*/
if erdaycnt>0 & erdaycnt~=. then ind_ed_charge=1;
if erdaycnt=0 | erdaycnt=. then ind_ed_charge=0;

/*truncate stays where the admit is more than x days before interview
or discharge is after the interview date so can get accurate LOS*/
if disch_date-index_date>&days. then do;
	disch_date=index_date+&days.;
	admit_trunc=1;
	end;
if admit_date<index_date then do;
	admit_date=index_date;
	admit_trunc=1;	
	end;
adj_los=disch_date-admit_date;
if disch_date-admit_date=0 then adj_los=1;
run;

proc sort data=ip_&days._2;
by bene_id index_year;
run;

proc sql;
create table ip_&days._3 as select distinct bene_id,index_year,
/*total ICU days*/
sum(icu_days) as icu_days_&suffix. label="total icu days &suffix. post ivw",
/*count of IP admissions, all types*/
count(*) as n_ip_admit_&suffix. label="total n of hospital admit &suffix. post ivw",
/*total Hospital LOS*/
sum(adj_los) as n_hospd_&suffix. label="total hospital days &suffix. post ivw",

/*count urgent or emergency admissions*/
count(case when em_urgent_admit=1 then em_urgent_admit else . end) as n_em_urgent_admit_&suffix. 
	label="total n of urgent/emergent hospital admit &suffix. post ivw",
/*count of emergency admissions, from admission type code*/
count(case when em_admit=1 then em_admit else . end) as n_em_admit_&suffix. 
	label="total n of emergent hospital admit &suffix. post ivw",
/*ICU stays*/
count(case when icu_days>0 then 1 else . end) as n_icu_stays_&suffix. 
	label="ICU stays &suffix post ivw",
/*count of urgent admissions, from admission type code*/
count(case when urgent_admit=1 then urgent_admit else . end) as n_urgent_admit_&suffix. 
	label="total n of urgent hospital admit &suffix. post ivw",
/*count of elective admissions, from admission type code*/
count(case when elect_admit=1 then elect_admit else . end) as n_elect_admit_&suffix. 
	label="total n of elective hospital admit &suffix. post ivw",
/*count of admissions with any ED charges*/
count(case when ind_ed_charge=1 then ind_ed_charge else . end) as n_ED_ip_&suffix. 
	label="total n of ED visits with subsequent admit &suffix. post ivw"

 from ip_&days._2 group by bene_id,index_year;
quit;

data ip_&days._4;
set ip_&days._3;
if icu_days_&suffix.>n_hospd_&suffix. then icu_days_&suffix.=n_hospd_&suffix.;
run;

%mend;

%admissions(days=183,suffix=p6m);
%admissions(days=365,suffix=p12m);

data elective_1;
set ip_365_2;
if elect_admit=1;
run;



proc sort data=ip_183_3 nodupkey;
by bene_id index_year;
run;


proc sql;
create table ip_p6m as select a.*,b.icu_days_p6m,b.n_icu_stays_p6m,
b.n_ip_admit_p6m,b.n_hospd_p6m,b.n_em_urgent_admit_p6m,b.n_em_admit_p6m,
b.n_urgent_admit_p6m,b.n_elect_admit_p6m,b.n_ED_ip_p6m
from proj_int.index a
left join
ip_183_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

proc sort data=ip_365_3 nodupkey;
by bene_id index_year;
run;

proc sql;
create table ip1 as select a.*,b.icu_days_p12m,b.n_icu_stays_p12m,
b.n_ip_admit_p12m,b.n_hospd_p12m,b.n_em_urgent_admit_p12m,b.n_em_admit_p12m,
b.n_urgent_admit_p12m,b.n_elect_admit_p12m,b.n_ED_ip_p12m
from ip_p6m a
left join
ip_365_3 b 
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year;
quit;

/*Dataset just contains obs with ffs mc 1yr and age 65+
So if missing, set var to 0*/
 data ip ;
 set ip1 ;
 array list icu_days_p6m n_icu_stays_p6m n_icu_stays_p12m n_ip_admit_p6m n_hospd_p6m n_em_urgent_admit_p6m 
	n_em_admit_p6m n_urgent_admit_p6m n_elect_admit_p6m n_ED_ip_p6m
	icu_days_p12m n_ip_admit_p12m n_hospd_p12m n_em_urgent_admit_p12m
	n_em_admit_p12m n_urgent_admit_p12m n_elect_admit_p12m n_ED_ip_p12m;
 do over list;
 if list=. then list=0;
 end;

 if n_ip_admit_p6m=0 then ind_hosp_adm_p6m=0;
 if n_ip_admit_p6m>0 & n_ip_admit_p6m~=. then ind_hosp_adm_p6m=1;
 label ind_hosp_adm_p6m="Indicator for any hospital admission 6m post ivw";

 if n_em_urgent_admit_p6m=0 then ind_em_ur_adm_p6m=0;
 if n_em_urgent_admit_p6m>0 & n_em_urgent_admit_p6m~=. then ind_em_ur_adm_p6m=1;
 label ind_em_ur_adm_p6m="Ind any urgent or emergent hospital admission 6m post ivw";

 if n_em_admit_p6m=0 then ind_em_adm_p6m=0;
 if n_em_admit_p6m>0 & n_em_admit_p6m~=. then ind_em_adm_p6m=1;
 label ind_em_adm_p6m="Ind any emergency hospital admission 6m post ivw";

 if n_urgent_admit_p6m=0 then ind_ur_adm_p6m=0;
 if n_urgent_admit_p6m>0 & n_urgent_admit_p6m~=. then ind_ur_adm_p6m=1;
 label ind_ur_adm_p6m="Ind any urgent hospital admission 6m post ivw";

 if n_elect_admit_p6m =0 then ind_elect_adm_p6m=0;
 if n_elect_admit_p6m >0 & n_elect_admit_p6m ~=. then ind_elect_adm_p6m=1;
 label ind_elect_adm_p6m="Ind any elective hospital admission 6m post ivw";

 if (n_ip_admit_p6m - n_elect_admit_p6m)=0 then ind_nonelect_adm_p6m=0;
 if (n_ip_admit_p6m - n_elect_admit_p6m)>0 & n_elect_admit_p6m~=. then ind_nonelect_adm_p6m=1;
 label ind_nonelect_adm_p6m="Ind any non-elective hospital admission 6m post ivw";

 n_nonelect_adm_p6m=(n_ip_admit_p6m - n_elect_admit_p6m);
 label n_nonelect_adm_p6m="total n non-elective ip admit 6m post ivw";

 if n_ED_ip_p6m=0 then ind_ED_adm_p6m=0;
 if n_ED_ip_p6m>0 & n_ED_ip_p6m~=. then ind_ED_adm_p6m=1;
 label ind_ED_adm_p6m="Ind ED use with hospital admission 6m post ivw, from charges";

 if n_ip_admit_p12m=0 then ind_hosp_adm_p12m=0;
 if n_ip_admit_p12m>0 & n_ip_admit_p12m~=. then ind_hosp_adm_p12m=1;
 label ind_hosp_adm_p12m="Indicator for any hospital admission 12m post ivw";

 if n_em_urgent_admit_p12m=0 then ind_em_ur_adm_p12m=0;
 if n_em_urgent_admit_p12m>0 & n_em_urgent_admit_p12m~=. then ind_em_ur_adm_p12m=1;
 label ind_em_ur_adm_p12m="Ind any urgent or emergent hospital admission 12m post ivw";

 if n_em_admit_p12m=0 then ind_em_adm_p12m=0;
 if n_em_admit_p12m>0 & n_em_admit_p12m~=. then ind_em_adm_p12m=1;
 label ind_em_adm_p12m="Ind any emergency hospital admission 12m post ivw";

 if n_urgent_admit_p12m=0 then ind_ur_adm_p12m=0;
 if n_urgent_admit_p12m>0 & n_urgent_admit_p12m~=. then ind_ur_adm_p12m=1;
 label ind_ur_adm_p12m="Ind any urgent hospital admission 12m post ivw";

 if n_elect_admit_p12m =0 then ind_elect_adm_p12m=0;
 if n_elect_admit_p12m >0 & n_elect_admit_p12m ~=. then ind_elect_adm_p12m=1;
 label ind_elect_adm_p12m="Ind any elective hospital admission 12m post ivw";

 if (n_ip_admit_p12m - n_elect_admit_p12m)=0 then ind_nonelect_adm_p12m=0;
 if (n_ip_admit_p12m - n_elect_admit_p12m)>0 & n_elect_admit_p12m~=. then ind_nonelect_adm_p12m=1;
 label ind_nonelect_adm_p12m="Ind any non-elective hospital admission 12m post ivw";

 n_nonelect_adm_p12m=(n_ip_admit_p12m - n_elect_admit_p12m);
 label n_nonelect_adm_p12m="total n non-elective ip admit 12m post ivw";

 if n_ED_ip_p12m=0 then ind_ED_adm_p12m=0;
 if n_ED_ip_p12m>0 & n_ED_ip_p12m~=. then ind_ED_adm_p12m=1;
 label ind_ED_adm_p12m="Ind ED use with hospital admission 12m post ivw, from charges";

run;



/****************************************************************************/
/****************************************************************************/
/*Get SNF days, indicator for 12 months after the interview*/
/****************************************************************************/
/****************************************************************************/

/*pull list of snf claims from all medpar claims 12 months post-interview*/
data snf_meet_365;
set proj_int.snf_meet_365p;
run;

proc sort data=snf_meet_365;
by bene_id admit_date;
run;

data snf_meet_365_1a;
set snf_meet_365;
format admit_date date9. disch_date date9.;
run;

/*3 claim windows are present:
1. SNF stays fully within the 1 year before interview
2. Stays that begin before 1 year pre-core but end within 1 year pre-core
3. Stays that begin within 1 year of core but end after core ivw
4. Stays that begin before 1 year and end after interview, LOS=365!
Get claims that meet 1 *1797*/
proc sql;
create table snf_meet1_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date - disch_date)>=0; 
quit;


/*meet time window 2 *152*/
proc sql;
create table snf_meet2_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)>=0; 
quit;

/*For these claims that start > 1 year before core, truncate start date so 
only count LOS days w/i 1 year
create indicator variable that claim start date is truncated*/
data snf_meet2_aft_365_1;
set snf_meet2_aft_365;
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_admit_date_mod ;
run;

/*meet time window 3 *135 */
proc sql;
create table snf_meet3_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)<365 & (index_date-disch_date)<0; 
quit;

/*For these claims that end after core, truncate end date so 
only count LOS days 1 year before the core
create indicator variable that claim end date is truncated*/
data snf_meet3_aft_365_1;
set snf_meet3_aft_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
run;

proc freq;
table snf_disch_date_mod ;
run;

/*meet 4 , overlap both start and end dates n=7*/
proc sql;
create table snf_meet4_aft_365 as select *
from snf_meet_365_1a
where (index_date - admit_date)>=365 & (index_date - disch_date)<0; 
quit;

/*truncate both start and end dates so just count 1 year pre interview*/
data snf_meet4_aft_365_1;
set snf_meet4_aft_365;
disch_date = index_date;
snf_disch_date_mod = 1;
label snf_disch_date_mod = "Disch date mod; at ivw date";
admit_date = index_date-365;
snf_admit_date_mod = 1;
label snf_admit_date_mod = "Admit date mod; at 12 mo from ivw date";
run;

proc freq;
table snf_disch_date_mod snf_admit_date_mod;
run;


data snf_meet_aft_365;
set snf_meet1_aft_365 snf_meet2_aft_365_1 snf_meet3_aft_365_1 snf_meet4_aft_365_1;
run;

proc freq;
table snf_admit_date_mod snf_disch_date_mod ;
run;

/*save final files to project int_data directory*/
data proj_int.snf_meet_aft_365 ;
set  snf_meet_aft_365;
run;

/*************************************************************/
/*calculate total number of days spent in SNF by BID*/
/*************************************************************/

data aft_snf_days_1;
set proj_int.snf_meet_aft_365;
calc_snf_LOS=disch_date-admit_date;
if calc_snf_LOS=0 then calc_snf_LOS=1;
run;

proc sort data=aft_snf_days_1;
by bene_id index_date admit_date;
run;

proc sql;
create table snf_days_pre as select distinct bene_id,index_year,
sum(calc_snf_LOS)
	as n_snf_days_p12m
	from aft_snf_days_1 group by bene_id,index_year;
quit;


/*merge into full ffs 1yr, age 65+ dataset*/
proc sort data=snf_days_pre nodupkey;
by bene_id index_year;
run;



 data snf ;
 set snf_days_pre ;
 array list n_snf_days_p12m;
 do over list;
 if list=. then list=0;
 end; 

if n_snf_days_p12m=0 then ind_snf_use_p12m=0;
 if n_snf_days_p12m>0 & n_snf_days_p12m~=. then ind_snf_use_p12m=1;
 label ind_snf_use_p12m="Indicator for any SNF stay 12m post ivw";
 label n_snf_days_p12m="SNF Days 12m post ivw";

run;

/****************************************************************************/
/****************************************************************************/
/*Get indicator of ESRD codes from the denominator file the year of the interview*/
/****************************************************************************/
/****************************************************************************/
proc sort data=medi.mbsf_06_16 out=dn_2000_20122  nodupkey;
by bene_id year;
run;

/*pull ESRD status variable from dn file
for the core interview years*/
proc sql;
create table esrd1 as select
a.*,b.Bene_ESRD_IND from 
proj_int.index a left join
dn_2000_20122 b
on trim(left(a.bene_id))=trim(left(b.bene_id))
and a.index_year=b.year;
quit;

proc freq;
table bene_esrd_ind /missprint;
run;

data esrd;
set esrd1 ;
if bene_esrd_ind='Y' then esrd_ind_n=1;
if bene_esrd_ind='0' then esrd_ind_n=0;
label esrd_ind_n="ESRD indicator from claims denominator file";
drop bene_esrd_ind;
run;

proc freq;
table esrd_ind_n /missprint;
run;

/****************************************************************************/
/*Get indicator of Home 02 use 12 months pre interview from DME claims*/
/****************************************************************************/
data oxygen1(keep=bene_id index_year oxygen);
set proj_int.dm_meet_365p;
oxygen=0;
if h_o2>0 then oxygen=1;
if oxygen=1;
run;

proc sort data=oxygen1 out=oxygen nodupkey;
by bene_id index_year;
run;
proc contents data=medi.op_09_16; run;

data ed_op_1;
set proj_int.op_meet_365p(keep=bene_id admit_date disch_date index_date index_year erdaycnt);
if erdaycnt>0 then ed_op=1;
if erdaycnt=0 then ed_op=0;
run;

proc freq;
table ed_op;
run;

proc sql;
create table ed_op_2 as select distinct bene_id,index_year,
count(case when ed_op=1 then ed_op else . end)
	as n_ed_op_visits_p12m
	from ed_op_1 group by bene_id,index_year;
quit;

proc freq;
table n_ed_op_visits_p12m;
run;


proc sort data=ed_op_2 nodupkey;
by bene_id index_year;
run;


data ed ;
set ed_op_2;
if n_ed_op_visits_p12m=. and comorb_1_0_1yr~=. then n_ed_op_visits_p12m=0;
label n_ed_op_visits_p12m="Count ED OP visits, 1yr post ivw";

if n_ed_op_visits_p12m=0 then ind_ed_op_p12m=0;
if n_ed_op_visits_p12m>0 & n_ed_op_visits_p12m~=. then ind_ed_op_p12m=1;
label ind_ed_op_p12m="Indicator any ED OP visits, 1 yr post ivw";
run;

proc freq;
table n_ed_op_visits_p12m*ind_ed_op_p12m;
run;


proc sort data=ip out=ip nodupkey; by bene_id index_year; run;
proc sort data=snf out=snf nodupkey; by bene_id index_year; run;
proc sort data=esrd out=esrd nodupkey; by bene_id index_year; run;
proc sort data=oxygen out=oxygen nodupkey; by bene_id index_year; run;
proc sort data=ed out=ed nodupkey; by bene_id index_year; run;


proc sql;
create table proj_int.utilization_post as select * 
from proj_int.index a 
left join
ip b
on trim(left(a.bene_id))=trim(left(b.bene_id)) and a.index_year=b.index_year
left join 
snf c
on trim(left(a.bene_id))=trim(left(c.bene_id)) and a.index_year=c.index_year
left join 
esrd d
on trim(left(a.bene_id))=trim(left(d.bene_id)) and a.index_year=d.index_year
left join
oxygen e
on trim(left(a.bene_id))=trim(left(e.bene_id)) and a.index_year=e.index_year
left join 
ed f
on trim(left(a.bene_id))=trim(left(f.bene_id)) and a.index_year=f.index_year;
quit;

proc contents data=proj_int.utilization_post; 
run;

H="get function-related indicators"
/*based on Chrischilles 2016, appendix*/


proc sql;
create table dm_meet as select * from
proj_int.index a 
left join 
medi.dm_09_14 b 
on a.bene_id=b.bene_id and b.admit_date<=a.index_date<=b.admit_date+365;
quit;

proc sql;
create table pb_meet as select * from
proj_int.index a 
left join 
medi.pb_09_14 b 
on a.bene_id=b.bene_id and b.admit_date<=a.index_date<=b.admit_date+365;
quit;

data dm_pb_meet;
set dm_meet pb_meet;
run;


/*get FRIs*/

data dm1;
set dm_pb_meet;
cane1=0;
walker1=0;
commode1=0;
beadpan1=0;
urinal1=0;
tub_toil_dev1=0;
lift1=0;
bed1=0;
chair1=0;
oxygen1=0;
array list hcpcscd1-hcpcscd13;
do over list;

if list in("E0100","E0105")
 then cane1=1;
if list in("E0130","E0135","E0140","E0141","E0143","E0144","E0147","E0148","E0149",
				"E0153","E0154","E0155","E0156","E0157","E0158","E0159")
 then walker1=1;
if list in("E0163","E0165","E0167","E0168","E0170","E0171","E0172","E0175")
 then commode1=1;
if list in("E0275","E0276")
 then bedpan1=1;
if list in("E02325","E0326")
 then urinal1=1;
if list in("E0240","E0241","E0242","E0243","E0244","E0245","E0246","E0247","E0248")
 then tub_toil_dev1=1;
if list in("E0621","E0625","E0627","E0628","E0629","E0630","E0635","E0636","E0637",
				"E0638","E0639","E0640","E0642","E0700","E0705","E0710")
 then lift1=1;
if list in("E0250","E0251","E0255","E0256","E0260","E0261","E0265","E0266","E0270",
				"E0271","E0272","E0273","E0274","E0277","E0280","E0290","E0291","E0292",
				"E0293","E0294","E0295","E0296","E0297","E0301","E0302","E0303","E0304"
				"E0305","E0310","E0315","E0316","E0370","E0371","E0372","E0373")
 then bed1=1;
if list in("E1031","E1035","E1038","E1039","E1050","E1060","E1070","E1083","E1084",
				"E1085","E1086","E1087","E1088","E1089","E1090","E1092","E1093","E1100",
				"E1110","E1130","E1140","E1150","E1160","E1161","E1170","E1171","E1172",
				"E1180","E1190","E1195","E1200","E1220","E1221","E1222","E1223","E1224",
				"E1230","E1240","E1250","E1260","E1270","E1280","E1285","E1290","E1295",
				"E1296","E1297","E1298","E0950","E0951","E0952","E0955","E0956","E0957",
				"E0958","E0959","E0960","E0961","E0966","E0967","E0970","E0971","E0973",
				"E0974","E0978","E0980","E0981","E0982","E0983","E0984","E0985","E0986",
				"E0990","E0992","E0994","E0995","E1002","E1003","E1004","E1005","E1006",
				"E1007","E1008","E1009","E1010","E1015","E1016","E1017","E1018","E1020",
				"E1028","E1029","E1030","E1225","E1226","E1227","E1228","E2201","E2202",
				"E2203","E2204","E2205","E2206","E2207","E2208","E2209","E2210","E2211",
				"E2212","E2213","E2214","E2215","E2216","E2217","E2218","E2219","E2220",
				"E2221","E2222","E2223","E2224","E2225","E2226","E2300","E2301","E2310",
				"E2311","E2321","E2322","E2323","E2324","E2325","E2326","E2327","E2328",
				"E2329","E2330","E2331","E2340","E2341","E2342","E2343","E2351","E2360",
				"E2361","E2362","E2363","E2364","E2365","E2366","E2367","E2368","E2369",
				"E2370","E2371","E2372","E2373","E2374","E2375","E2376","E2377","E2381",
				"E2382","E2383","E2384","E2385","E2386","E2387","E2388","E2389","E2390",
				"E2391","E2392","E2393","E2394","E2395","E2396","E2399","E2402","E2601",
				"E2602","E2603","E2604","E2605","E2606","E2607","E2608","E2609","E2610",
				"E2611","E2612","E2613","E2614","E2615","E2616","E2617","E2618","E2619",
				"E2620","E2621")
 then chair1=1;
if list in("E0424","E0425","E0430","E0431","E0434","E0435","E0439","E0440","E0441",
				"E0442","E0443","E0444","E1390","E1391","E1392","E1399","E1405","E1406")
 then oxygen1=1;
end;
run;

proc sql;
create table dm2 as select distinct bene_id, index_year,
sum(cane1) as n_cane,
sum(walker1) as n_w,
sum(commode1) as n_com,
sum(bedpan1) as n_bp,
sum(urinal1) as n_ur,
sum(tub_toil_dev1) as n_ttd,
sum(lift1) as n_lift,
sum(bed1) as n_bed,
sum(chair1) as n_wc,
sum(oxygen1) as n_oxy
from dm1 group by bene_id, index_year;
quit;

proc sql; 
create table dm3 as select * from
proj_int.index a
left join 
dm2 b
on a.bene_id=b.bene_id and a.index_year=b.index_year;
quit;


data proj_int.fri(keep=bene_id index_year cane walker commode bedpan urinal tub_toil_dev lift bed chair oxy);
set dm3;
cane=n_cane>=1;
walker=n_w>1;
commode=n_com>=1;
urinal=n_ur>=1;
bedpan=n_bp>=1;
tub_toil_dev=n_ttd>=1;
lift=n_lift>=1;
bed=n_bed>=1;
chair=n_wc>=1;
oxy=n_oxy>=1;
run;

data pbtest;
set pb_meet;
if substr(hcpcscd1,1,2)="E0" then hc=hcpcscd1;
run;
proc freq;
tables hc;
run;

H="get hospice details"
/*need to get--
	hospice los
	first hospice date
	died on hospice
	live discharges*/

data index;
set proj_int.index;
run;


data hs1 (keep=bene_id live_disch died_on_hs los admit_date);
set medi.hs_09_14;
live_disch=PTNT_DSCHRG_STUS_CD='01';
died_on_hs=PTNT_DSCHRG_STUS_CD='40' or PTNT_DSCHRG_STUS_CD='41';
los=disch_date-admit_date;
run;

proc sql;
create table hs2 as select unique bene_id,
sum(live_disch) as n_live_disch,
sum(died_on_hs) as n_died_on_hs,
sum(los) as hs_los
from hs1 group by bene_id;
quit;

proc sort data=hs1 out=hs3 nodupkey;
by bene_id admit_date;
run;
proc sort data=hs3 out=hs4 nodupkey;
by bene_id;
run;

data hs5(keep=bene_id first_hs);
set hs4;
first_hs=admit_date;
run;

proc sql;
create table hs6 as select * from
index a 
left join
hs2 b
on a.bene_id=b.bene_id
left join
hs5 c
on a.bene_id=c.bene_id;
quit;

data proj_int.hs;
set hs6;
hs_los=hs_los+1;
ind_live_disch=n_live_disch>=1;
ind_died_hs=n_died_on_hs>=1;
format hs_los date9.;
run;


H="combine with interviews into one dataset"
data proj_int.index;
set proj_int.index;
if index_year = . then delete;
run;


data proj_int.index;
set proj_int.index;
if bene_id =" " then delete;
run;


proc sql; 
create table tomerge as select * from
proj_int.index a left join
proj_int.ffs_before b 
on a.bene_id=b.bene_id and a.index_year=b.index_year
left join 
proj_int.ffs_after c
on a.bene_id=c.bene_id and a.index_year=c.index_year
left join 
proj_int.elix_0_1yr_2 d
on a.bene_id=d.bene_id and a.index_year=d.index_year
left join 
proj_int.charls_0_1yr e
on a.bene_id=e.bene_id and a.index_year=e.index_year
left join 
proj_int.chronic_21_1yr3_0 f
on a.bene_id=f.bene_id and a.index_year=f.index_year
left join 
proj_int.utilization_pre g
on a.bene_id=g.bene_id and a.index_year=g.index_year
left join 
proj_int.criteria h
on a.bene_id=h.bene_id and a.index_year=h.index_year
left join 
proj_int.utilization_post i
on a.bene_id=i.bene_id and a.index_year=i.index_year
left join 
proj_int.mc_costs_all j
on a.bene_id=j.bene_id and a.index_year=j.index_year
left join
proj_int.fri k
on a.bene_id=k.bene_id and a.index_year=k.index_year
left join 
proj_int.dmouth_0_1yr l
on a.bene_id=l.bene_id and a.index_year=l.index_year
left join
proj_int.hs m
on a.bene_id=m.bene_id and a.index_year=m.index_year;
quit;

proc sql;
create table proj_int.serious_ill_int_dataset as select * from
proj_int.nhats a 
left join
tomerge b 
on a.spid=b.spid and a.ivw_year=b.index_year;
quit;



H="variable cleaning and check criteria"
/*This section defines the serious medical illness indicators
as well as the additional criteria for serious illness
1. Serious medical illness
2. ADL impairment
3. Self report nursing home residence
4. Urgent or emergent hospitalization 

2 sets of criteria are used:
Criteria A: Either serious medical illness or ADL impairment
Criteria B: Critera A + either nursing home resident or hospitalization*/

option nofmterr;

data proj_int.serious_ill_int_dataset1;
set proj_int.serious_ill_int_dataset;


/*any elixhauser cancer dx*/
if comorb_17_0_1yr=1 | comorb_18_0_1yr=1 | comorb_19_0_1yr=1 then el_cancer_1yr=1;
if comorb_17_0_1yr=0 & comorb_18_0_1yr=0 & comorb_19_0_1yr=0 then el_cancer_1yr=0;

/*3 or more Elixhauser comorbidities*/
if comorb_all_0_1yr>2 then el_ge3_comorb_1yr=1;
if 0=<comorb_all_0_1yr<=2 then el_ge3_comorb_1yr=0;

/*4 or more comorbidities - needs to be reevaluated once other defs are defined!*/
if comorb_all_0_1yr>3 then el_ge4_comorb_1yr=1;
if 0=<comorb_all_0_1yr<=3 then el_ge4_comorb_1yr=0;

cc_all_count_1yr = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + cc_5_cataract_1yr + cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + cc_10_glaucoma_1yr + 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;

if cc_all_count_1yr >3 then cc_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr <=3 then cc_ge4_comorb_1yr=0;

/*cc's excluding cataract and glaucoma*/
cc_all_count_1yr_2 = cc_1_ami_1yr + cc_2_alzh_1yr + cc_3_alzhdmta_1yr + 
cc_4_atrialfb_1yr + /*cc_5_cataract_1yr +*/ cc_6_chrnkidn_1yr + 
cc_7_copd_1yr + cc_8_chf_1yr + cc_9_diabetes_1yr + /*cc_10_glaucoma_1yr +*/ 
cc_11_hipfrac_1yr + cc_12_ischmcht_1yr + cc_13_depressn_1yr + 
cc_14_osteoprs_1yr + cc_15_ra_oa_1yr + cc_16_strketia_1yr + 
cc_17_cncrbrst_1yr + cc_18_cncrclrc_1yr + cc_19_cncrprst_1yr + 
cc_20_cncrlung_1yr + cc_21_cncrendm_1yr;
label cc_all_count_1yr_2="Count of cc's, excludes cataract and glaucoma";

if cc_all_count_1yr_2>3 then cc2_ge4_comorb_1yr=1;
if 0=<cc_all_count_1yr_2<=3 then cc2_ge4_comorb_1yr=0;

label el_ge3_comorb_1yr="3+ Elixhauser comorbidities";
label el_ge4_comorb_1yr="4+ Elixhauser comorbidities";
label cc_ge4_comorb_1yr="4+ DW Chronic Conditions";
label cc2_ge4_comorb_1yr="4+ DW Chronic Conditions, excl cataract and glaucoma";

/***************************************************/
/*create indicators for any indication of the serious medical illnesses across
variables (cc's elix hrs survey) */
/*dementia requires more than 1 dementia diagnosis 1 year before ivw*/
if dem_dx_1yr>=2 and dem_dx_1yr~=. then smi_dem_ind=1;
if dem_dx_1yr=0 or dem_dx_1yr=1 then smi_dem_ind=0;
label smi_dem_ind="Indicator of Dementia 1yr, Elixhauser 2+dx req.";

/*old def commented out
if el_cancer_1yr=1 | CC_cncr_chronic_1yr=1 | cancer_hrs=1 then cancer_any_ind=1;
if el_cancer_1yr=0 & CC_cncr_chronic_1yr=0 & cancer_hrs=0 then cancer_any_ind=0; */
/*cancer flagged as serious medical illness if metastatic cancer 
or blood cancers new def to be provided from Amy*/
if comorb_18_0_1yr=1 then smi_cancer_ind=1;
if comorb_18_0_1yr=0 then smi_cancer_ind=0;
label smi_cancer_ind="Indicator of Metastatic Cancer 1yr";

/*ESRD from either dx code per elixhauser or denominator file flag*/
if comorb_13_0_1yr=1 | esrd_ind_n=1 then smi_esrd_ind=1;
if comorb_13_0_1yr=0 & esrd_ind_n=0  then smi_esrd_ind=0;
label smi_esrd_ind="Indicator of ESRD 1yr, Elix and claims DN file";

/*chf, use dx list for Elixhauser, but as primary DX from a hospitalization only*/
if chf_pri_dx=1  then smi_chf_ind=1;
if chf_pri_dx=0  then smi_chf_ind=0;
label smi_chf_ind="Indicator of CHF 1yr, Primary dx from IP claim";

/*COPD indicator meets following criteria:
1. COPD from Elix (any dx field) and Oxygen use from DME claims or
2. COPD as a primary diagnosis from a hospitalization*/
if (comorb_9_0_1yr=1 & oxygen=1) | copd_pri_dx=1 then smi_copd_ind=1;
if (comorb_9_0_1yr=0 | oxygen=0) & copd_pri_dx=0 then smi_copd_ind=0;
label smi_copd_ind="Indicator of COPD 1yr, copd any dx and home o2 use or copd as prim dx";

/*diabetes, Elix 11 (diabetes with complications) if criteria for 
renal disease (comorb 34), ischemic heart disease (cc 12) or 
peripheral vascular disease (comorb 5) are present*/
if comorb_11_0_1yr=1 & (comorb_5_0_1yr=1 | comorb_34_0_1yr=1 | CC_12_ISCHMCHT_1yr =1) then
	smi_diab_compl_ind=1;
if comorb_11_0_1yr=0 | (comorb_5_0_1yr=0 & comorb_34_0_1yr=0 & CC_12_ISCHMCHT_1yr =0) then
	smi_diab_compl_ind=0;
label smi_diab_compl_ind="Elix compl diabetes + peripheral vas, renal or ischem, 1yr";

if comorb_14_0_1yr=1 then smi_liver_ind=1;
if comorb_14_0_1yr=0 then smi_liver_ind=0;
label smi_liver_ind="Indicator of Advanced liver disease/cirrhosis 1yr, elix";

/*Update 6/9/14 - HIV not included in final list of serious medical illnesses for
the criteria definition
4/2/15 - Added HIV back into list*/
if comorb_16_0_1yr=1 then smi_hiv_ind=1;
if comorb_16_0_1yr=0 then smi_hiv_ind=0;
label smi_hiv_ind="Indicator of HIV with and AIDS defining illness 1yr, elix";

if comorb_33_0_1yr=1 then smi_als_ind=1;
if comorb_33_0_1yr=0 then smi_als_ind=0;
label smi_als_ind="Indicator of ALS 1yr, icd9 code";

/*hip fracture, either admitting diagnosis or CPT from carrier claim AND
surgery or follow up carrier claim within 2 days*/
if hip_adm_dx=1 | hf_w_visit_2d=1 | hf_w_surgery=1 then smi_hip_ind=1;
if hip_adm_dx=0 & hf_w_visit_2d=0 & hf_w_surgery=0 then smi_hip_ind=0;
label smi_hip_ind="Indicator of Hip fracture 1yr, adm dx or from physician claims";
/*******************************************************************/
/*******************************************************************/

/*doesn't use the cc definition excluding cataract,glaucoma cc2_ge4_comorb_1yr */
if el_ge4_comorb_1yr=1 | cc_ge4_comorb_1yr=1 /*| comor_c_hrs=1*/ then multi_any_ind=1;
if el_ge4_comorb_1yr=0 & cc_ge4_comorb_1yr=0 /*& comor_c_hrs=0*/ then multi_any_ind=0;
label multi_any_ind="Any indicator of Multimorbidity 4+ chronic conditions 1yr";

/*total number of serious medical illnesses per these definitions*/
smi_count=smi_dem_ind + smi_cancer_ind + smi_esrd_ind + smi_chf_ind + smi_copd_ind + 
 smi_diab_compl_ind + smi_liver_ind + smi_hiv_ind + smi_als_ind + smi_hip_ind;

/*indicator for 3+serious medical illnesses*/
if smi_count>=3 then smi_ge3_ind=1;
if smi_count<3 then smi_ge3_ind=0;
label smi_ge3_ind="3 or more serious medical illnesses";

/*indicator for any serious medical illness
Update 6/9/14 - HIV not included in list of serious medical illnesses*/
if smi_dem_ind =1 | smi_cancer_ind =1 | smi_esrd_ind =1 | smi_chf_ind =1 | 
 smi_copd_ind =1 | smi_diab_compl_ind =1 | smi_liver_ind =1 | smi_hiv_ind =1 | 
 smi_als_ind =1 | smi_hip_ind=1
 then ser_med_illness=1;
if smi_dem_ind =0 & smi_cancer_ind =0 & smi_esrd_ind =0 & smi_chf_ind =0 & 
 smi_copd_ind =0 & smi_diab_compl_ind =0 & smi_liver_ind =0 & smi_hiv_ind =0 & 
 smi_als_ind =0 & smi_hip_ind=0
 then ser_med_illness=0;
label ser_med_illness="Any indicator of serious medical illness 1yr";

/*Indicator for any SNF stays 12m prior to interview or current nh res
Update 6/2/14 - nursing home use will be included only if current nh residence reported,
not if any SNF claims found*/
if /*ind_snf_use_12m=1 |*/ nhres=1 then smi_nh_ind=1;
if /*ind_snf_use_12m=0 &*/ nhres=0 then smi_nh_ind=0;
label smi_nh_ind="Nursing home resident self report in ivw";

/*indicator for adl helper*/
*if adl_helper_count>0 & adl_helper_count~=. then smi_helper_ind=1;
*if adl_helper_count=0 then smi_helper_ind=0;
*label smi_helper_ind="Indicator of having any helpers with ADL, core";

/*backfill adl status if adl helper variable is complete*/
adl_ind = adl_independent;
*if adl_independent=. and smi_helper_ind=1 then adl_ind_core_n=0;
*if adl_independent=. and smi_helper_ind=0 then adl_ind_core_n=1;
label adl_ind = "ADL independent at interview";

if adl_ind=1 then adl_impair = 0;
if adl_ind=0 then adl_impair = 1;
label adl_impair = "ADL impairment at core interview";

/*indicator for any ED visit, either OP or IP*/
if ind_ed_op_12m=1 | ind_ED_adm_12m=1 then ind_ed_op_or_ip_12m=1;
if ind_ed_op_12m=0 & ind_ED_adm_12m=0 then ind_ed_op_or_ip_12m=0;
label ind_ed_op_or_ip_12m="Indicator any ED use 12m pre ivw";

/*criteria (A) serious medical illness and/or ADL impairment*/
if (ser_med_illness=1 | adl_impair=1) then criteria_a=1;
if (ser_med_illness=0 & adl_impair=0) then criteria_a=0;
label criteria_a="Crit A SMI and/or ADL impair";

/*indicator for serious medical illness and ADL impairment*/
if (ser_med_illness=1 & adl_impair=1) then smi_and_adl=1;
if (ser_med_illness=0 | adl_impair=0) then smi_and_adl=0;
label smi_and_adl="SMI and ADL impairment";

/*criteria (B) serious medical illness and/or ADL impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 | adl_impair=1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_b=1;
if (ser_med_illness=0 & adl_impair=0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_b=0;
label criteria_b="Crit B SMI or ADL impair and hospital admit or nh use";

/*criteria (C) serious medical illness and adl impairment AND nh res or urgent/emergent hosp*/
if (ser_med_illness=1 & adl_impair=1) & (ind_em_ur_adm_12m=1 | smi_nh_ind=1) then criteria_c=1;
if (ser_med_illness=0 | adl_impair=0) | (ind_em_ur_adm_12m=0 & smi_nh_ind=0) then criteria_c=0;
label criteria_c="Crit C SMI and ADL impair and hospital admit or nh use";

/*serious medical illness criteria variable defined, so name matches format of other criteria indicators*/
criteria_smi=ser_med_illness;
label criteria_smi="Comparison criteria - SMI";

run;
/*
 ods rtf body="E:\nhats\data\projects\serious_ill\logs\criteria_vars_before_coredate.rtf"

title "Number of unique people in full cohort 2000-2012"
proc sql
select count(distinct spid) from proj_int.serious_ill_int_dataset
where index_year in (2000,2002,2004,2006,2008,2010,2012)

title "Unique R's w/ Age 65+"
select count(distinct spid) from proj_int.serious_ill_int_dataset
where age_ge_65=1 and index_year in (2000,2002,2004,2006,2008,2010,2012)

title "Unique R's w/ Age 65+, With mc xwalk id"
select count(distinct spid) from proj_int.serious_ill_int_dataset
where  index_year in (2000,2002,2004,2006,2008,2010,2012)

title "Unique R's w/ Age 65+, With mc xwalk id, and FFS 1yr pre-ivw"
select count(distinct spid) from proj_int.serious_ill_int_dataset
where  part_ab_12m=1 and hmo_d_12m=0 
and index_year in (2000,2002,2004,2006,2008,2010,2012)

create table age_ge_65_mc as 
select * from proj_int.serious_ill_int_dataset
where  part_ab_12m=1 and hmo_d_12m=0 
and index_year in (2000,2002,2004,2006,2008,2010,2012)
quit

title "Dementia - elix, 2+ diagnoses required"
proc freq data=age_ge_65_mc 
table smi_dem_ind /missprint
run

title "Cancer - elix, metastatic or hematologic cancer"
proc freq data=age_ge_65_mc 
table smi_cancer_ind /missprint 
run

title "End Stage Renal Disease - elix, claims denominator file year of core ivw"
proc freq data=age_ge_65_mc 
table comorb_13_0_1yr esrd_ind_n comorb_13_0_1yr*esrd_ind_n ind_hosp_adm_12m*esrd_ind_n smi_esrd_ind /missprint
run

title "CHF+Indicator of more advanced disease - elix + some utilization measure TBD!"
proc freq data=age_ge_65_mc 
table smi_chf_ind chf_pri_dx chf_adm_dx /missprint
run

title "COPD, Either (1) ICD=9 code in any claim + DME claim for home O2 OR (2) COPD as primary dx in IP claim"
proc freq data=age_ge_65_mc 
table smi_copd_ind /missprint
run

*data o2_no_copd
*set age_ge_65_mc 
*if smi_lung_02_ind =0 and oxygen =1
*run

*title "Among interviews with home O2 use but no COPD, check to see if these are CHF patients?"
*proc freq data=o2_no_copd
*table  smi_chf_ind*oxygen /missprint
*run

title "Diabetes with severe complications (renal disease, ischemic hd or peripheral vascular disease)"
proc freq data=age_ge_65_mc 
table smi_diab_compl_ind /missprint
run

title "Advanced liver disease/cirrhosis - elix"
proc freq data=age_ge_65_mc 
table smi_liver_ind /missprint
run

title "HIV with and AIDS defining illness - elix"
proc freq data=age_ge_65_mc 
table smi_hiv_ind /missprint
run

title "ALS - just single dx code "
proc freq data=age_ge_65_mc 
table smi_als_ind /missprint
run

title "Hip fracture, CC"
proc freq data=age_ge_65_mc 
table smi_hip_ind /missprint
run

title "Multimorbidity, 3+serious medical illnesses as defined here"
proc freq data=age_ge_65_mc 
table smi_count smi_ge3_ind /missprint
run

title "Any ADL help, HRS"
proc freq data=age_ge_65_mc 
table adl_independent /missprint
run

title "Hospital admissions 6m, 12m before core interview"
proc freq data=age_ge_65_mc  
table ind_hosp_adm_6m*ind_em_ur_adm_6m ind_hosp_adm_12m*ind_em_ur_adm_12m 
ind_em_adm_12m*ind_ED_adm_12m ind_em_ur_adm_12m*ind_ED_adm_12m /missprint
run

title "Elective vs non elective hospital admissions, 12m before core"
proc freq data=age_ge_65_mc  
table ind_nonelect_adm_12m n_nonelect_adm_12m ind_elect_adm_12m n_elect_admit_12m /missprint
run

title "ED visit without subsequent admission from OP claims, 12m pre interview"
proc freq data=age_ge_65_mc  
table ind_ed_op_12m n_ed_op_visits_12m ind_ed_op_or_ip_12m/missprint
run

title "Nursing home use 12m before core interview or self report NH resident at interview"
proc freq data=age_ge_65_mc  
table ind_snf_use_12m*nhres smi_nh_ind /missprint
run

title "Any helper with ADLs, core interview"
proc freq data=age_ge_65_mc  
table smi_helper_ind smi_helper_ind*adl_independent  /missprint
run

title "Number of R's that meet A)Any serious illness"
proc sql
select count(distinct spid) from age_ge_65_mc  
where ser_med_illness=1

title "Number of R's that meet HIV"
proc sql
select count(distinct spid) from age_ge_65_mc  
where smi_hiv_ind=1

title "Number of R's that meet B)Any ADL help"
proc sql
select count(distinct spid) from age_ge_65_mc  
where =1

title "Number of R's that meet Criteria A: Serious medical illness and/or Any ADL help"
proc sql
select count(distinct spid) from age_ge_65_mc  
where (criteria_a=1)

title "Number of R's that meet Criteria B: Serious medical illness and/or Any ADL help and NH use and/or Hospitalization"
proc sql
select count(distinct spid) from age_ge_65_mc  
where criteria_b=1

title "Number of R's that meet Criteria C: Serious medical illness and Any ADL help and NH use and/or Hospitalization"
proc sql
select count(distinct spid) from age_ge_65_mc  
where criteria_c=1

title "Number of R's that meet Any urgent or emergent hospital admission 12m preceding core interview"
proc sql
select count(distinct spid) from age_ge_65_mc  
where ind_em_ur_adm_12m=1

title "Number of R's that meet NH resident at interview "
proc sql
select count(distinct spid) from age_ge_65_mc  
where smi_nh_ind=1

title "Number of R's that meet Any helper with ADLs core interview"
proc sql
select count(distinct spid) from age_ge_65_mc  
where smi_helper_ind=1

title "Number of R's that meet Any serious illness and ADL help"
proc sql
select count(distinct spid) from age_ge_65_mc  
where (ser_med_illness=1 and =1) 

title "Number of R's that meet Any serious illness and Urgent or Emergency hospital admission"
proc sql
select count(distinct spid) from age_ge_65_mc  
where (ser_med_illness=1 and ind_em_ur_adm_12m=1) 

ods rtf close 

/*******************************************************************************/
/*17 observations where esrd flag in denominator file = 1 but no esrd comorbidity
what are these peoples diagnoses?*/
/*
data esrd_check_1
set age_ge_65_mc
if esrd_ind_n=1 and comorb_13_0_1yr=0
run

proc freq data=esrd_check_1 table part_ab_12m hmo_d_12m run

proc sql
create table esrd_check_2 as select a.* from 
dx_all_last_1yr a join
esrd_check_1 b
on a.bene_id=b.bene_id and a.index_year=b.index_year
quit

ods rtf body="E:\nhats\data\projects\serious_ill\logs\check_esrd_2012.rtf"
title "n=17 with esrd flag in denominator file but not from elixhauser comorb definition"
proc freq data=esrd_check_2 order=freq table diag run
quit
ods rtf close
*/

/* Identifying incident wave where criteria was met */

data ivw_meet_a;
set proj_int.serious_ill_int_dataset1(keep=spid criteria_a criteria_b criteria_c index_year);
if criteria_a=1 and index_year ~=.;
run;

proc sort data=ivw_meet_a;
by spid index_year;
run;

data ivw_meet_a_1;
set ivw_meet_a;
by spid;
if first.spid then incident_ivw=1;
else incident_ivw=0;
run;

data ivw_meet_a_1;
set ivw_meet_a_1;
incident_a = 0;
incident_b = 0;
incident_c = 0;
IF criteria_a = 1 and criteria_b ne 1 and criteria_c ne 1 then incident_a = 1;
IF criteria_b = 1 and criteria_c ne 1 then incident_b = 1;
IF criteria_c = 1 then incident_c = 1;
IF incident_ivw ne 1 then delete;
run;

data incident_date;
set ivw_meet_a_1;
if criteria_c = . then criteria_c = 0;
run;

/*export full dataset to Stata*/

proc export data=incident_date outfile="E:\nhats\data\projects\serious_ill\int_data\incident_dataset.dta" replace; run;

proc export data=proj_int.serious_ill_int_dataset1
outfile="E:\nhats\data\projects\serious_ill\int_data\serious_ill_int_dataset1.dta" replace;
run;

H="compare outcomes"
use "E:\nhats\data\Projects\serious_ill\int_data\serious_ill_int_dataset1.dta", clear
local logpath E:\nhats\data\Projects\serious_ill\logs
use "E:\data\serious_ill\final_data\n0_n1_p1_p2_x_criteria_2010_v1.dta", clear
drop if nhres_n0==1
drop if hmo_d_12m_n0==1
drop if part_ab_12m_n0==0
gen criteria_all_n0=1
gen criteria_none_n0=criteria_a_n0==0

gen mult_ip_adm_p12m_n0=n_ip_admit_p12m_n0>1 if !missing(n_ip_admit_p12m_n0)
gen n_ed_vis_12m_n0=n_ed_op_visits_12m_n0+n_ed_ip_12m_n0
gen ind_ed_vis_p12m_n0=n_ed_vis_12m_n0>0 if !missing(n_ed_vis_12m_n0)
gen mult_ed_vis_p12m_n0=n_ed_vis_12m_n0>1 if !missing(n_ed_vis_12m_n0)
gen ind_icu_p12m_n0=icu_days_12m_n0>0 if !missing(icu_days_12m_n0)
gen ind_hs_p12m_n0=hs_paid_by_mc_12m_n0!=0 if !missing(hs_paid_by_mc_12m_n0)
*/
local outcomes3 ind_hosp_adm_p12m_n0 mult_ip_adm_p12m_n0 ind_ed_vis_p12m_n0 mult_ed_vis_p12m_n0 ///
ind_icu_p12m_n0 ind_hs_p12m_n0 core_to_dod_1yr_n0

local outcomes2 n_hospd_p12m_n0

local outcomes1 ip_paid_by_mc_12m_n0 snf_paid_by_mc_12m_n0 hh_paid_by_mc_12m_n0 ///
 hs_paid_by_mc_12m_n0 pb_paid_by_mc_12m_n0 op_paid_by_mc_12m_n0 ///
 dm_paid_by_mc_12m_n0 tot_paid_by_mc_12m_n0
local rn : word count `outcomes1' `outcomes1' `outcomes2' `outcomes2' `outcomes3' 1
foreach x in `outcomes1' `outcomes2' `outcomes3' {
drop if `x'==.
}

mat tab1=J(`rn',10,.)
local r=1
local c=1

foreach i in all none a b c {
	foreach x in `outcomes1' `outcomes2' {
		sum `x' if criteria_`i'_n0==1 [aw=wgtr_n0],d
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		mat tab1[`r'+1,`c']=r(p50)
		local r=`r'+2
}
	foreach x in `outcomes3' {
		qui sum `x' if criteria_`i'_n0==1 [aw=wgtr_n0]
		mat tab1[`r',`c']=r(mean)*r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1="IP MC payments 12m post ivw" ///
"	Median" "SNF MC payments 12m post ivw" ///
"	Median" "HH MC payments 12m post ivw" ///
"	Median" "HS MC payments 12m post ivw" ///
"	Median" "PB MC payments 12m post ivw" ///
"	Median" "OP MC payments 12m post ivw" ///
"	Median" "DME MC payments 12m post ivw" ///
"	Median" "Total MC payments 12m post ivw" ///
"	Median" "n hospital nights 12m post ivw" ///
"	Median"  `outcomes3' N

frmttable using "`logpath'\compare_hrs_nhats_outcomes.doc",  replace ///
statmat(tab1) varlabels  title("One Year Outcomes by Propensity 1 yr Mortality,HRS") ///
 ctitles("" "Full Sample Mean/N" "SD/%" "Criteria A " "SD/%" "B" "SD/%" "C" "SD/%") ///
 sdec(2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\ ///
 2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\ ///
 2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\0,2,0,2,0,2,0,2) ///
 /*rtitles("IP MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"SNF MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"HH MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"HS MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"PB MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"OP MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"DME MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"Total MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"n hospital nights 12m post ivw (mean,SD)" \ ///
"	Median" ind_hosp_adm_p12m_n0\ ///
 mult_ip_adm_p12m_n0\ mult_ed_vis_p12m_n0\ ///
 ind_icu_vis_p12m_n0\ hs_admit_p12m_n0\ ///
 core_to_dod_1yr_n0\ loc_hosp_x\ N) ///
*/ note("All costs WI adjusted 2012$"\"P-values compared to baseline of low probability group") 
use "E:\nhats\data\Projects\serious_ill\int_data\serious_ill_int_dataset1.dta", clear
local logpath E:\nhats\data\Projects\serious_ill\logs
keep if cont_ffs_n_mos>=12 & wave==1 //& sp_ivw==1
gen criteria_all=1
gen criteria_none=criteria_a==0
gen tot_paid_by_mc_12m=0
foreach x in ip snf hh hs pb op dm {
replace tot_paid_by=tot_paid_by+`x'_paid_by_mc_12m
}
gen mult_ip_adm_p12m=n_ip_admit_p12m>1 if !missing(n_ip_admit_p12m)
gen n_ed_vis_p12m=n_ed_op_visits_p12m+n_ed_ip_p12m
gen ind_ed_vis_p12m=n_ed_vis_p12m>0 if !missing(n_ed_vis_p12m)
gen mult_ed_vis_p12m=n_ed_vis_p12m>1 if !missing(n_ed_vis_p12m)
gen ind_icu_p12m=icu_days_p12m>0 if !missing(icu_days_p12m)
gen ind_hs_p12m=hs_paid_by_mc_12m!=0 if !missing(hs_paid_by_mc_12m)

local outcomes3 ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_vis_p12m mult_ed_vis_p12m ///
ind_icu_p12m ind_hs_p12m died_12

local outcomes2 n_hospd_p12m

local outcomes1 ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m
local rn : word count `outcomes1' `outcomes1' `outcomes2' `outcomes2' `outcomes3' 1
foreach x in `outcomes1' `outcomes2' `outcomes3' {
drop if `x'==.
}

mat tab1=J(`rn',10,.)
local r=1
local c=1

foreach i in all none a b c {
	foreach x in `outcomes1' `outcomes2' {
		sum `x' if criteria_`i'==1 [aw=anfinwgt],d
		mat tab1[`r',`c']=r(mean)
		mat tab1[`r',`c'+1]=r(sd)
		mat tab1[`r'+1,`c']=r(p50)
		local r=`r'+2
}
	foreach x in `outcomes3' {
		qui sum `x' if criteria_`i'==1 [aw=anfinwgt]
		mat tab1[`r',`c']=r(N)
		mat tab1[`r',`c'+1]=r(mean)*100
		local r=`r'+1
}
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+2
}
mat rownames tab1="IP MC payments 12m post ivw" ///
"	Median" "SNF MC payments 12m post ivw" ///
"	Median" "HH MC payments 12m post ivw" ///
"	Median" "HS MC payments 12m post ivw" ///
"	Median" "PB MC payments 12m post ivw" ///
"	Median" "OP MC payments 12m post ivw" ///
"	Median" "DME MC payments 12m post ivw" ///
"	Median" "Total MC payments 12m post ivw" ///
"	Median" "n hospital nights 12m post ivw" ///
"	Median"  `outcomes3' N

frmttable using "`logpath'\compare_hrs_nhats_outcomes.doc",  addtable ///
statmat(tab1) varlabels  title("One Year Outcomes by Propensity 1 yr Mortality, NHATS") ///
 ctitles("" "Full Sample" "SD/%" "Criteria A" "SD/%" "B" "SD/%" "C" "SD/%") ///
 sdec(2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\ ///
 2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\ ///
 2,2,2,2,2,2,2,2\2,2,2,2,2,2,2,2\0,2,0,2,0,2,0,2) ///
 /*rtitles("IP MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"SNF MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"HH MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"HS MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"PB MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"OP MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"DME MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"Total MC payments 12m post ivw (mean,SD)" \ ///
"	Median"\"n hospital nights 12m post ivw (mean,SD)" \ ///
"	Median" ind_hosp_adm_p12m_n0\ ///
 mult_ip_adm_p12m_n0\ mult_ed_vis_p12m_n0\ ///
 ind_icu_vis_p12m_n0\ hs_admit_p12m_n0\ ///
 core_to_dod_1yr_n0\ loc_hosp_x\ N) ///
*/ note("All costs WI adjusted 2012$"\"P-values compared to baseline of low probability group") 


H="dataset cleaning and sample derivation"
clear all 
set more off
capture log close

local intpath "E:\nhats\data\Projects\serious_ill\int_data"
local datapath "E:\nhats\data\Projects\serious_ill\final_data"
local logpath "E:\nhats\data\Projects\serious_ill\logs"

cd `datapath'
log using `logpath'\sample_derivation_xwave.txt, text replace

use `intpath'\serious_ill_int_dataset1.dta, clear

*****************************************
//variable cleaning and construction
*****************************************
foreach x of varlist adl*help {
replace `x'=. if sp_ivw_==0
replace adl_independent=0 if `x'==1
replace adl_impair=1 if `x'==1
}
//set comorb/serill to zero if missing (because no entry in the pb file)
foreach x of varlist comorb* cc* smi* {
	replace `x'=0 if `x'==. & cont_ffs_n_mos>=12
}


replace el_ge3=comorb_all>3 if !missing(comorb_all)
replace adl_impair=1 if nhres==1
replace smi_count=smi_dem_ind + smi_cancer_ind + smi_esrd_ind + smi_chf_ind + ///
smi_copd_ind + smi_diab_compl_ind + smi_liver_ind + smi_hiv_ind + smi_als_ind + smi_hip_ind
replace ser_med_illness=smi_count>0 if missing(ser_med_illness) & !missing(smi_count)
replace criteria_a=smi_count>0 if !missing(smi_count) & missing(criteria_a)
replace criteria_a=1 if adl_impair==1
replace criteria_b=criteria_a==1 & (ind_em_ur_adm_12m==1 | smi_nh_ind==1) if missing(criteria_b)
replace criteria_c=ser_med_illness==1 & adl_impair==1 & (ind_em_ur_adm_12m==1 | ///
smi_nh_ind==1) if missing(criteria_c)

gen criteria_all=1
gen criteria_none=criteria_a==0

foreach y in 12 24 {
gen tot_paid_by_mc_`y'm=0
foreach x in ip snf hh hs pb op dm {
replace tot_paid_by_mc_`y'=tot_paid_by_mc_`y'+`x'_paid_by_mc_`y'm
}
}

gen mult_ip_adm_p12m=n_ip_admit_p12m>1 if !missing(n_ip_admit_p12m)
foreach x of varlist *_op_* *icu_* {
replace `x'=0 if missing(`x')
}

gen n_ed_vis_p12m=n_ed_op_visits_p12m+n_ed_ip_p12m
gen ind_ed_vis_p12m=n_ed_vis_p12m>0 if !missing(n_ed_vis_p12m)
gen mult_ed_vis_p12m=n_ed_vis_p12m>1 if !missing(n_ed_vis_p12m)
gen ind_icu_p12m=icu_days_p12m>0 if !missing(icu_days_p12m)
gen ind_hs_p12m=hs_paid_by_mc_12m!=0 if !missing(hs_paid_by_mc_12m)

*****************************************
//sample derivation
*****************************************
gen wave1=wave==1
gen ffs_12m=cont_ffs_n_mos>=12 if !missing(cont_ffs_n_mos)
gen ab_12m=part_ab_n_mos>=12
gen hmo_12m=non_hmo_d_n_mos>=12
label var ab_12m "12m AB Medicare before ivw"
label var hmo_12m "12m w/o HMO before ivw"
label var wave1 "Wave 1 Interview"
label var ffs_12m "12m continuous FFS before ivw"
*local samplevars wave1 sp_ivw_yes ab_12m hmo_12m ffs_12m 
local samplevars ab_12m hmo_12m ffs_12m 

local rn : word count `samplevars'
local r=1
local c=1
mat samp=J(`rn',2,.)

foreach x in `samplevars' {
	*keep if `x'==1
	sum `x'
	mat samp[`r',`c']=r(N)
	local r=`r'+1
}

mat rownames samp=`samplevars'

frmttable, statmat(samp) ctitles("" "N") title("Sample Derivation") sdec(0) ///
varlabels

save serious_ill_nhats_sample, replace

foreach x of varlist comorb* cc* ser_med *smi* criteria* {
	replace `x'=0 if `x'==.
}


H="****************************************"


H="****************************************"


H="characteristics and outcomes"
clear all 
set more off
capture log close

local intpath "E:\nhats\data\Projects\serious_ill\int_data"
local datapath "E:\nhats\data\Projects\serious_ill\final_data"
local logpath "E:\nhats\data\Projects\serious_ill\logs"

cd `datapath'
*log using `logpath'\table1_xwave.txt, text replace

use serious_ill_nhats_sample, clear
cap drop _m
/*
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_a.dta", keepus(ivw_meet_crit_a)
drop if _m==2
drop _m
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_b.dta", keepus(ivw_meet_crit_b)
drop if _m==2
drop _m
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_c.dta", keepus(ivw_meet_crit_c)
drop if _m==2
drop _m
*/

sort spid ivw_date
by spid: egen ivw_meet_a = min(ivw_date) if criteria_a==1
by spid: egen ivw_meet_b = min(ivw_date) if criteria_b==1
by spid: egen ivw_meet_c = min(ivw_date) if criteria_c==1

sort spid wave
by spid (wave): carryforward aveincome, replace

gen incident_a = 0
replace incident_a = 1 if ivw_meet_a==ivw_date
gen incident_b = 0
replace incident_b = 1 if ivw_meet_b==ivw_date
gen incident_c = 0
replace incident_c = 1 if ivw_meet_c==ivw_date
drop if wave==4
egen max_wave = max(wave), by(spid)
drop if criteria_a==0 & wave!=max_wave
label var educ_hs_ind "High school"
gen incident_group=incident_a
replace incident_group=2 if incident_b==1
replace incident_group=3 if incident_c==1
rename criteria_all incident_all
*rename criteria_none incident_none
gen incident_none = 0
replace incident_none = 1 if criteria_a==0
gen cgroupa=incident_a
gen cgroupb=incident_b
gen cgroupc=incident_c
label var incident_a "Incident Criteria A"
label var incident_b "Incident Criteria B"
label var incident_c "Incident Criteria C" 
gen ind=1
drop if !incident_a & !incident_b & !incident_c & !incident_none
local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married educ_hs_ind
local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind ser_med_illness el_ge3_comorb_1yr nhres ///
incident_a incident_b incident_c
local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m
gen missingany=0
foreach i in 0 1 {
di "SP ivw=`i'"
foreach x in `cvars1' `cvars2' `ivars1' `ivars2' {
/* qui */ sum ind if missing(`x') & sp_ivw==`i'
if r(N)>0 {
di "`x'"
di r(N)
}
/* qui */ replace missingany=1 if `x'==.
}
}

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' n `coutcomes' `ioutcomes'
foreach i in 0 1 {
di "SP ivw=`i'"
local r=1
local c=1
mat miss=J(`rn',3,.)

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' {
/* qui */ sum `x' if sp_ivw==`i'
mat miss[`r',1]=r(mean)
mat miss[`r',2]=r(N)
/* qui */ sum ind if missing(`x') & sp_ivw==`i'
mat miss[`r',3]=r(N)
local r=`r'+1
}
/* qui */ sum ind if sp_ivw==`i'
mat miss[`r',1]=r(N)

mat rownames miss=`cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' N

frmttable, statmat(miss) varlabels title("Missing values") ///
ctitles( "Variable" "mean" "N" "N missing") sdec(2,0,0)
tab missingany
}
*drop if missingany
local r=1
local c=1

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',5,.)
mat stars=J(`rn',5,0)
local r=1
local c=1
foreach i in all none a b c {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			/* qui */ sum `x' if incident_`i'==1 
			mat tab1[`r',`c']=r(mean)
			if inlist("`i'","a","b","c") {
				/* qui */ ttest `x' if incident_`i'==1 | incident_none==1, by(cgroup`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
		foreach x of local ivars`round' {
			/* qui */ sum `x' if incident_`i'==1
			mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","a","b","c") {
			/* qui */	tab `x' cgroup`i' if incident_`i'==1 | incident_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		/* qui */ sum `x' if incident_`i'==1,d
		mat tab1[`r',`c']=r(mean)
		if inlist("`i'","a","b","c") {
		/* qui */	ttest `x' if incident_`i'==1 | incident_none==1, by(cgroup`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			/* qui */ sum `x' if incident_`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		/* qui */ sum `x' if incident_`i'==1
		mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","a","b","c") {
				/* qui */ tab `x' cgroup`i' if incident_`i'==1 | incident_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
	/* qui */ sum ind if incident_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "Outcome Measures Over 1 Year" ///
`rnames' `ioutcomes' N

frmttable using `logpath'\sample_characteristics_xwave.doc, replace statmat(tab1) ///
 title("NHATS Waves 1- 3 Serious Illness Criteria") ///
 ctitles("" "Full Sample" "None" "Crit A" "B" "C" ) ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("*p<.05 difference between x and no criteria met groups, t-test or chi2" ///
 "Sample was derived from the incident wave when people first meet a criteria. For those who met no criteria wave 3 data was used.")

capture log close


H="char/outcomes by percentiles"
clear all 
set more off
capture log close

local intpath "E:\nhats\data\Projects\serious_ill\int_data"
local datapath "E:\nhats\data\Projects\serious_ill\final_data"
local logpath "E:\nhats\data\Projects\serious_ill\logs"

cd `datapath'
log using `logpath'\top_percentiles.txt, text replace
use serious_ill_nhats_sample, clear

/*create variable to demarcate between care types */

gen top1 = 0
gen top5 = 0
gen top10 = 0
gen top20 = 0

replace top1 = 1 if tot_paid_by_mc_12m>=94825.22
replace top5 = 1 if tot_paid_by_mc_12m>=47681.3
replace top10 = 1 if tot_paid_by_mc_12m>=28871.06
replace top20 = 1 if tot_paid_by_mc_12m>=13784.35

gen caretype = 4
replace caretype=1 if nhres==1
replace caretype=2 if rcfres==1 & sp_ivw_yes==1
replace caretype=3 if rcfres==1 & sp_ivw_yes==0
la de caretypelbl 1"nursing home"2"res care w/sp"3"res care no sp"4"community"
la values caretype caretypelbl


gen cgroupgroup=caretype 
gen cgroupa=0
replace cgroupa=1 if top1==1

gen cgroupb=0 
replace cgroupb=1 if top5==1

gen cgroupc=0
replace cgroupc = 1 if top10==1

gen cgroupd=0 
replace cgroupd=1 if top20==1

gen cgroupall = 1


gen ind=1
local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married 

local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind ser_med_illness el_ge3_comorb_1yr nhres ///
criteria_a criteria_b criteria_c
local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m
gen missingany=0

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' {
qui sum ind if missing(`x')
if r(N)>0 {
di "`x'"
di r(N)
}
qui replace missingany=1 if `x'==.
}


local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' n `coutcomes' `ioutcomes'

local r=1
local c=1
mat miss=J(`rn',3,.)

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' {
sum `x' 
mat miss[`r',1]=r(mean)
mat miss[`r',2]=r(N)
sum ind if missing(`x')
mat miss[`r',3]=r(N)
local r=`r'+1
}
sum ind
mat miss[`r',1]=r(N)

mat rownames miss=`cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' N

frmttable, statmat(miss) varlabels title("Missing values") ///
ctitles("" "Variable" "mean" "N" "N missing") sdec(2,0,0)
tab missingany
*drop if missingany
local r=1
local c=1

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',5,.)
mat stars=J(`rn',5,0)
local r=1
local c=1
foreach i in all a b c d {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			qui sum `x' if cgroup`i'==1 
			mat tab1[`r',`c']=r(mean)
			*if inlist("`i'","a","b","c") {
				*ttest `x' if cgroup`i'==1 | cgroupnone==1, by(cgroup`i')
				*mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
*}
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if cgroup`i'==1
			mat tab1[`r',`c']=r(mean)*100
			*if inlist("`i'","a","b","c") {
			*	tab `x' cgroup`i' if cgroup`i'==1 | cgroupnone==1, chi2
			*	mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
*}
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		sum `x' if cgroup`i'==1,d
		mat tab1[`r',`c']=r(mean)
		*if inlist("`i'","a","b","c") {
		*	ttest `x' if cgroup`i'==1 | cgroupnone==1, by(cgroup`i')
		*	mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
*}
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			sum `x' if cgroup`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		qui sum `x' if cgroup`i'==1
		mat tab1[`r',`c']=r(mean)*100
			*if inlist("`i'","a","b","c") {
			*	tab `x' cgroup`i' if cgroup`i'==1 | cgroupnone==1, chi2
			*	mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
*}
			local r=`r'+1
}
	sum ind if cgroup`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}


mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "Outcome Measures Over 1 Year" ///
`rnames' `ioutcomes' N

frmttable using `logpath'\percentiles_tables.doc, replace statmat(tab1) ///
 title("Sample Characteristics by Percentiles") ///
 ctitles("" "All" "Top 1%" "Top 5%" "Top 10%" "Top 20%" ) ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note()


log close


H="Char/outcomes Prevalence, wave 1"
clear all 
set more off
capture log close

local intpath "E:\nhats\data\Projects\serious_ill\int_data"
local datapath "E:\nhats\data\Projects\serious_ill\final_data"
local logpath "E:\nhats\data\Projects\serious_ill\logs"

cd `datapath'
*log using `logpath'\table1_xwave.txt, text replace

use serious_ill_nhats_sample, clear
keep if ffs_12m==1
cap drop _m
/*
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_a.dta", keepus(ivw_meet_crit_a)
drop if _m==2
drop _m
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_b.dta", keepus(ivw_meet_crit_b)
drop if _m==2
drop _m
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_c.dta", keepus(ivw_meet_crit_c)
drop if _m==2
drop _m
*/

sort spid ivw_date
by spid: egen ivw_meet_a = min(ivw_date) if criteria_a==1
by spid: egen ivw_meet_b = min(ivw_date) if criteria_b==1
by spid: egen ivw_meet_c = min(ivw_date) if criteria_c==1

format ivw_meet_a %td
format ivw_meet_b %td
format ivw_meet_c %td



sort spid wave
by spid (wave): carryforward aveincome, replace

gen incident_a = criteria_a
*replace incident_a = 1 if ivw_meet_a==ivw_date
gen incident_b = criteria_b
*replace incident_b = 1 if ivw_meet_b==ivw_date
gen incident_c = criteria_c
*replace incident_c = 1 if ivw_meet_c==ivw_date
drop if wave==4
preserve
keep if wave==1
*egen max_wave = max(wave), by(spid)
*drop if criteria_a==0 & wave!=max_wave
label var educ_hs_ind "High school"
gen incident_group=incident_a
replace incident_group=2 if incident_b==1
replace incident_group=3 if incident_c==1
rename criteria_all incident_all
*rename criteria_none incident_none
gen incident_none = 0
replace incident_none = 1 if criteria_a==0
gen cgroupa=incident_a
gen cgroupb=incident_b
gen cgroupc=incident_c
label var incident_a "Incident Criteria A"
label var incident_b "Incident Criteria B"
label var incident_c "Incident Criteria C" 
gen ind=1
drop if !incident_a & !incident_b & !incident_c & !incident_none
local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married educ_hs_ind
local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind ser_med_illness el_ge3_comorb_1yr nhres ///
incident_a incident_b incident_c
local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m
gen missingany=0
foreach i in 0 1 {
di "SP ivw=`i'"
foreach x in `cvars1' `cvars2' `ivars1' `ivars2' {
/* qui */ sum ind if missing(`x') & sp_ivw==`i'
if r(N)>0 {
di "`x'"
di r(N)
}
/* qui */ replace missingany=1 if `x'==.
}
}

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' n `coutcomes' `ioutcomes'
foreach i in 0 1 {
di "SP ivw=`i'"
local r=1
local c=1
mat miss=J(`rn',3,.)

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' {
qui sum `x' if sp_ivw==`i'
mat miss[`r',1]=r(mean)
mat miss[`r',2]=r(N)
qui sum ind if missing(`x') & sp_ivw==`i'
mat miss[`r',3]=r(N)
local r=`r'+1
}
qui sum ind if sp_ivw==`i'
mat miss[`r',1]=r(N)

mat rownames miss=`cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' N

frmttable, statmat(miss) varlabels title("Missing values") ///
ctitles( "Variable" "mean" "N" "N missing") sdec(2,0,0)
tab missingany
}
*drop if missingany
local r=1
local c=1

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',5,.)
mat stars=J(`rn',5,0)
local r=1
local c=1
foreach i in all none a b c {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			/* qui */ sum `x' if incident_`i'==1 
			mat tab1[`r',`c']=r(mean)
			if inlist("`i'","a","b","c") {
				/* qui */ ttest `x' if incident_`i'==1 | incident_none==1, by(cgroup`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
		foreach x of local ivars`round' {
			/* qui */ sum `x' if incident_`i'==1
			mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","a","b","c") {
			/* qui */	tab `x' cgroup`i' if incident_`i'==1 | incident_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		/* qui */ sum `x' if incident_`i'==1,d
		mat tab1[`r',`c']=r(mean)
		if inlist("`i'","a","b","c") {
		/* qui */	ttest `x' if incident_`i'==1 | incident_none==1, by(cgroup`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			/* qui */ sum `x' if incident_`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		/* qui */ sum `x' if incident_`i'==1
		mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","a","b","c") {
				/* qui */ tab `x' cgroup`i' if incident_`i'==1 | incident_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
	/* qui */ sum ind if incident_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "Outcome Measures Over 1 Year" ///
`rnames' `ioutcomes' N

frmttable using `logpath'\sample_characteristics_xwave1.doc, replace statmat(tab1) ///
 title("NHATS Wave 1 Serious Illness Criteria (Prevalence)") ///
 ctitles("" "Full Sample" "None" "Crit A" "B" "C" ) ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("*p<.05 difference between x and no criteria met groups, t-test or chi2" ///
"Figures have been inflation adjusted to 2014 dollars")

capture log close


H="Char/outcomes Prevalence, wave 2"
clear all 
set more off
capture log close

local intpath "E:\nhats\data\Projects\serious_ill\int_data"
local datapath "E:\nhats\data\Projects\serious_ill\final_data"
local logpath "E:\nhats\data\Projects\serious_ill\logs"

cd `datapath'
*log using `logpath'\table1_xwave.txt, text replace

use serious_ill_nhats_sample, clear
keep if ffs_12m==1
cap drop _m
/*
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_a.dta", keepus(ivw_meet_crit_a)
drop if _m==2
drop _m
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_b.dta", keepus(ivw_meet_crit_b)
drop if _m==2
drop _m
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_c.dta", keepus(ivw_meet_crit_c)
drop if _m==2
drop _m
*/

sort spid ivw_date
by spid: egen ivw_meet_a = min(ivw_date) if criteria_a==1
by spid: egen ivw_meet_b = min(ivw_date) if criteria_b==1
by spid: egen ivw_meet_c = min(ivw_date) if criteria_c==1

format ivw_meet_a %td
format ivw_meet_b %td
format ivw_meet_c %td



sort spid wave
by spid (wave): carryforward aveincome, replace

gen incident_a = criteria_a
*replace incident_a = 1 if ivw_meet_a==ivw_date
gen incident_b = criteria_b
*replace incident_b = 1 if ivw_meet_b==ivw_date
gen incident_c = criteria_c
*replace incident_c = 1 if ivw_meet_c==ivw_date
drop if wave==4
preserve
keep if wave==2
*egen max_wave = max(wave), by(spid)
*drop if criteria_a==0 & wave!=max_wave
label var educ_hs_ind "High school"
gen incident_group=incident_a
replace incident_group=2 if incident_b==1
replace incident_group=3 if incident_c==1
rename criteria_all incident_all
*rename criteria_none incident_none
gen incident_none = 0
replace incident_none = 1 if criteria_a==0
gen cgroupa=incident_a
gen cgroupb=incident_b
gen cgroupc=incident_c
label var incident_a "Incident Criteria A"
label var incident_b "Incident Criteria B"
label var incident_c "Incident Criteria C" 
gen ind=1
drop if !incident_a & !incident_b & !incident_c & !incident_none
local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married educ_hs_ind
local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind ser_med_illness el_ge3_comorb_1yr nhres ///
incident_a incident_b incident_c
local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m
gen missingany=0
foreach i in 0 1 {
di "SP ivw=`i'"
foreach x in `cvars1' `cvars2' `ivars1' `ivars2' {
/* qui */ sum ind if missing(`x') & sp_ivw==`i'
if r(N)>0 {
di "`x'"
di r(N)
}
/* qui */ replace missingany=1 if `x'==.
}
}

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' n `coutcomes' `ioutcomes'
foreach i in 0 1 {
di "SP ivw=`i'"
local r=1
local c=1
mat miss=J(`rn',3,.)

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' {
qui sum `x' if sp_ivw==`i'
mat miss[`r',1]=r(mean)
mat miss[`r',2]=r(N)
qui sum ind if missing(`x') & sp_ivw==`i'
mat miss[`r',3]=r(N)
local r=`r'+1
}
qui sum ind if sp_ivw==`i'
mat miss[`r',1]=r(N)

mat rownames miss=`cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' N

frmttable, statmat(miss) varlabels title("Missing values") ///
ctitles( "Variable" "mean" "N" "N missing") sdec(2,0,0)
tab missingany
}
*drop if missingany
local r=1
local c=1

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',5,.)
mat stars=J(`rn',5,0)
local r=1
local c=1
foreach i in all none a b c {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			/* qui */ sum `x' if incident_`i'==1 
			mat tab1[`r',`c']=r(mean)
			if inlist("`i'","a","b","c") {
				/* qui */ ttest `x' if incident_`i'==1 | incident_none==1, by(cgroup`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
		foreach x of local ivars`round' {
			/* qui */ sum `x' if incident_`i'==1
			mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","a","b","c") {
			/* qui */	tab `x' cgroup`i' if incident_`i'==1 | incident_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		/* qui */ sum `x' if incident_`i'==1,d
		mat tab1[`r',`c']=r(mean)
		if inlist("`i'","a","b","c") {
		/* qui */	ttest `x' if incident_`i'==1 | incident_none==1, by(cgroup`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			/* qui */ sum `x' if incident_`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		/* qui */ sum `x' if incident_`i'==1
		mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","a","b","c") {
				/* qui */ tab `x' cgroup`i' if incident_`i'==1 | incident_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
	/* qui */ sum ind if incident_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "Outcome Measures Over 1 Year" ///
`rnames' `ioutcomes' N

frmttable using `logpath'\sample_characteristics_xwave2.doc, replace statmat(tab1) ///
 title("NHATS Wave 2 Serious Illness Criteria (Prevalence)") ///
 ctitles("" "Full Sample" "None" "Crit A" "B" "C" ) ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("*p<.05 difference between x and no criteria met groups, t-test or chi2" ///
"Figures have been inflation adjusted to 2014 dollars")

capture log close


H="Char/outcomes Prevalence, wave 3"
clear all 
set more off
capture log close

local intpath "E:\nhats\data\Projects\serious_ill\int_data"
local datapath "E:\nhats\data\Projects\serious_ill\final_data"
local logpath "E:\nhats\data\Projects\serious_ill\logs"

cd `datapath'
*log using `logpath'\table1_xwave.txt, text replace

use serious_ill_nhats_sample, clear
keep if ffs_12m==1
cap drop _m
/*
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_a.dta", keepus(ivw_meet_crit_a)
drop if _m==2
drop _m
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_b.dta", keepus(ivw_meet_crit_b)
drop if _m==2
drop _m
merge m:1 spid ivw_year using "E:\nhats\data\projects\serious_ill\int_data\incident_c.dta", keepus(ivw_meet_crit_c)
drop if _m==2
drop _m
*/

sort spid ivw_date
by spid: egen ivw_meet_a = min(ivw_date) if criteria_a==1
by spid: egen ivw_meet_b = min(ivw_date) if criteria_b==1
by spid: egen ivw_meet_c = min(ivw_date) if criteria_c==1

format ivw_meet_a %td
format ivw_meet_b %td
format ivw_meet_c %td



sort spid wave
by spid (wave): carryforward aveincome, replace

gen incident_a = criteria_a
*replace incident_a = 1 if ivw_meet_a==ivw_date
gen incident_b = criteria_b
*replace incident_b = 1 if ivw_meet_b==ivw_date
gen incident_c = criteria_c
*replace incident_c = 1 if ivw_meet_c==ivw_date
drop if wave==4
preserve
keep if wave==3
*egen max_wave = max(wave), by(spid)
*drop if criteria_a==0 & wave!=max_wave
label var educ_hs_ind "High school"
gen incident_group=incident_a
replace incident_group=2 if incident_b==1
replace incident_group=3 if incident_c==1
rename criteria_all incident_all
*rename criteria_none incident_none
gen incident_none = 0
replace incident_none = 1 if criteria_a==0
gen cgroupa=incident_a
gen cgroupb=incident_b
gen cgroupc=incident_c
label var incident_a "Incident Criteria A"
label var incident_b "Incident Criteria B"
label var incident_c "Incident Criteria C" 
gen ind=1
drop if !incident_a & !incident_b & !incident_c & !incident_none
local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married educ_hs_ind
local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind ser_med_illness el_ge3_comorb_1yr nhres ///
incident_a incident_b incident_c
local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m
gen missingany=0
foreach i in 0 1 {
di "SP ivw=`i'"
foreach x in `cvars1' `cvars2' `ivars1' `ivars2' {
/* qui */ sum ind if missing(`x') & sp_ivw==`i'
if r(N)>0 {
di "`x'"
di r(N)
}
/* qui */ replace missingany=1 if `x'==.
}
}

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' n `coutcomes' `ioutcomes'
foreach i in 0 1 {
di "SP ivw=`i'"
local r=1
local c=1
mat miss=J(`rn',3,.)

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' {
qui sum `x' if sp_ivw==`i'
mat miss[`r',1]=r(mean)
mat miss[`r',2]=r(N)
qui sum ind if missing(`x') & sp_ivw==`i'
mat miss[`r',3]=r(N)
local r=`r'+1
}
qui sum ind if sp_ivw==`i'
mat miss[`r',1]=r(N)

mat rownames miss=`cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' N

frmttable, statmat(miss) varlabels title("Missing values") ///
ctitles( "Variable" "mean" "N" "N missing") sdec(2,0,0)
tab missingany
}
*drop if missingany
local r=1
local c=1

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',5,.)
mat stars=J(`rn',5,0)
local r=1
local c=1
foreach i in all none a b c {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			/* qui */ sum `x' if incident_`i'==1 
			mat tab1[`r',`c']=r(mean)
			if inlist("`i'","a","b","c") {
				/* qui */ ttest `x' if incident_`i'==1 | incident_none==1, by(cgroup`i')
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
		foreach x of local ivars`round' {
			/* qui */ sum `x' if incident_`i'==1
			mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","a","b","c") {
			/* qui */	tab `x' cgroup`i' if incident_`i'==1 | incident_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		/* qui */ sum `x' if incident_`i'==1,d
		mat tab1[`r',`c']=r(mean)
		if inlist("`i'","a","b","c") {
		/* qui */	ttest `x' if incident_`i'==1 | incident_none==1, by(cgroup`i')
			mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			/* qui */ sum `x' if incident_`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		/* qui */ sum `x' if incident_`i'==1
		mat tab1[`r',`c']=r(mean)*100
			if inlist("`i'","a","b","c") {
				/* qui */ tab `x' cgroup`i' if incident_`i'==1 | incident_none==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
	/* qui */ sum ind if incident_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}

mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "Outcome Measures Over 1 Year" ///
`rnames' `ioutcomes' N

frmttable using `logpath'\sample_characteristics_xwave3.doc, replace statmat(tab1) ///
 title("NHATS Wave 3 Serious Illness Criteria (Prevalence)") ///
 ctitles("" "Full Sample" "None" "Crit A" "B" "C" ) ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note("*p<.05 difference between x and no criteria met groups, t-test or chi2" ///
"Figures have been inflation adjusted to 2014 dollars")

capture log close


H="char/outcomes by type of care + sensitivity/specificity"
clear all 
set more off
capture log close

local intpath "E:\nhats\data\Projects\serious_ill\int_data"
local datapath "E:\nhats\data\Projects\serious_ill\final_data"
local logpath "E:\nhats\data\Projects\serious_ill\logs"

cd `datapath'
log using `logpath'\caretype_char.txt, text replace
use serious_ill_nhats_sample, clear

merge 

/*create variable to demarcate between care types */

gen caretype = 4
replace caretype=1 if nhres==1
replace caretype=2 if rcfres==1 & sp_ivw_yes==1
replace caretype=3 if rcfres==1 & sp_ivw_yes==0
la de caretypelbl 1"nursing home"2"res care w/sp"3"res care no sp"4"community"
la values caretype caretypelbl


gen cgroupgroup=caretype 
gen cgroupa=0
replace cgroupa=1 if caretype==1

gen cgroupb=0 
replace cgroupb=1 if caretype==2

gen cgroupc=0
replace cgroupc = 1 if caretype==3

gen cgroupd=0 
replace cgroupd=1 if caretype==4

gen cgroupall = 1


gen ind=1
local cvars1 age
local cvars2 aveincome
local ivars1 female white black hisp other_race married 

local ivars2 proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind ser_med_illness el_ge3_comorb_1yr nhres ///
cgroupa cgroupb cgroupc cgroupd
local ioutcomes ind_hosp_adm_p12m mult_ip_adm_p12m ind_ed_op_p12m  ///
ind_icu_p12m ind_hs_p12m died_12

local coutcomes ip_paid_by_mc_12m snf_paid_by_mc_12m hh_paid_by_mc_12m ///
 hs_paid_by_mc_12m pb_paid_by_mc_12m op_paid_by_mc_12m ///
 dm_paid_by_mc_12m tot_paid_by_mc_12m n_hospd_p12m
gen missingany=0

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' {
qui sum ind if missing(`x')
if r(N)>0 {
di "`x'"
di r(N)
}
qui replace missingany=1 if `x'==.
}


local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' n `coutcomes' `ioutcomes'

local r=1
local c=1
mat miss=J(`rn',3,.)

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' {
sum `x' 
mat miss[`r',1]=r(mean)
mat miss[`r',2]=r(N)
sum ind if missing(`x')
mat miss[`r',3]=r(N)
local r=`r'+1
}
sum ind
mat miss[`r',1]=r(N)

mat rownames miss=`cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' N

frmttable, statmat(miss) varlabels title("Missing values") ///
ctitles("" "Variable" "mean" "N" "N missing") sdec(2,0,0)
tab missingany
*drop if missingany
local r=1
local c=1

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `coutcomes' `ioutcomes' 1 1
di `rn'
mat tab1=J(`rn',5,.)
mat stars=J(`rn',5,0)
local r=1
local c=1
foreach i in all a b c d {
	foreach round in 1 2 {
		foreach x of local cvars`round' {
			qui sum `x' if cgroup`i'==1 
			mat tab1[`r',`c']=r(mean)
			*if inlist("`i'","a","b","c") {
				*ttest `x' if cgroup`i'==1 | cgroupnone==1, by(cgroup`i')
				*mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
*}
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if cgroup`i'==1
			mat tab1[`r',`c']=r(mean)*100
			*if inlist("`i'","a","b","c") {
			*	tab `x' cgroup`i' if cgroup`i'==1 | cgroupnone==1, chi2
			*	mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
*}
			local r=`r'+1
}
}
	local r=`r'+1

	
	foreach x of local coutcomes {
		sum `x' if cgroup`i'==1,d
		mat tab1[`r',`c']=r(mean)
		*if inlist("`i'","a","b","c") {
		*	ttest `x' if cgroup`i'==1 | cgroupnone==1, by(cgroup`i')
		*	mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
*}
		local r=`r'+1
*		if "`x'"=="tot_paid_by_mc_12m_wi_n0" {
			sum `x' if cgroup`i'==1,d
			mat tab1[`r',`c']=r(p50)
			local r=`r'+1
*}
}
	foreach x of local ioutcomes {
		qui sum `x' if cgroup`i'==1
		mat tab1[`r',`c']=r(mean)*100
			*if inlist("`i'","a","b","c") {
			*	tab `x' cgroup`i' if cgroup`i'==1 | cgroupnone==1, chi2
			*	mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
*}
			local r=`r'+1
}
	sum ind if cgroup`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+1
}

foreach x in `coutcomes' {
local rnames `rnames' "`x'" "Median"
}


mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' "Outcome Measures Over 1 Year" ///
`rnames' `ioutcomes' N

frmttable using `logpath'\caretype_tables.doc, replace statmat(tab1) ///
 title("Sample Characteristics by Type of Care") ///
 ctitles("" "All" "Nursing H" "Ass. Care w/SP" "Ass. Care no SP" "Community" ) ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note()


************ Sensitivity/Specificity Analysis **************

/* Hospital Utilization */
tab ind_hosp_adm_p12m

tab ind_hosp_adm_p12m if criteria_a==1
tab ind_hosp_adm_p12m if criteria_a==0

di 695/(695+521) //sensitivity analysis
di 2881/(2881+1175) //specificity analysis

tab ind_hosp_adm_p12m if criteria_b==1
tab ind_hosp_adm_p12m if criteria_b==0

di 390/(390+412) //sensitivity analysis
di 3644/(3644+412) //specificity analysis

tab ind_hosp_adm_p12m if criteria_c==1
tab ind_hosp_adm_p12m if criteria_c==0

di 126/(126+1090) //sensitivity analysis
di 3981/(3981+75) //specificity analysis

/* Top 5% of spenders */

gen top1 = 0
gen top5 = 0
gen top10 = 0
gen top20 = 0

replace top1 = 1 if tot_paid_by_mc_12m>=94825.22
replace top5 = 1 if tot_paid_by_mc_12m>=47681.3
replace top10 = 1 if tot_paid_by_mc_12m>=28871.06
replace top20 = 1 if tot_paid_by_mc_12m>=13784.35

tab top5 if criteria_a==1
tab top5 if criteria_a==0

di 209/(209+88) //sensitivity analysis
di 3314/(3314+1661) //specificity analysis

tab top5 if criteria_b==1 
tab top5 if criteria_b==0

di 134/(134+163) //sensitivity analysis
di 4307/(4307+668) //specificity analysis

tab top5 if criteria_c==1
tab top5 if criteria_c==0

di 49/(49+248) //sensitivity analysis
di 4823/(4823+152) //specificity analysis

/* Died 12 months after interview */

tab died_12 if criteria_a==1
tab died_12 if criteria_a==0

di 292/(292+86) //sensitivity analysis
di 3316/(3316+1578) //specificity analysis

tab died_12 if criteria_b==1
tab died_12 if criteria_b==0

di 192/(192+186)
di 4284/(4284+610)

tab died_12 if criteria_c==1
tab died_12 if criteria_c==0

di 48/(48+330)
di 4741/(4741+153)

log close


H="HCC dataset"
/*******************************************************************************/
/* STEP 1: Create a PERSON and DIAG file for calculating CMS-HCC risk adjustment scores
           (Step 1 portion of this code)
/* STEP 2: Run the format file E:\hrs_code\general_data_setup\HCCsoftware07\format.sas
/* STEP 3: Run the HCC software E:\hrs_code\general_data_setup\HCCsoftware07\V1206D4P
/* STEP 4: Create file combining new, HCC risk, and calculate benefit
           (Step 4 portion of this code)
/*******************************************************************************/

/* Before the HCC files could be used all txt files were converted to SAS 
***** convert SAS transport files to SAS format;
filename in1 "E:\hrs_code\general_data_setup\HCCsoftware07\C1206D4Y";
libname out "E:\hrs_code\general_data_setup";
proc cimport library=out infile=in1;
run;

filename in1 "E:\hrs_code\general_data_setup\HCCsoftware07\F1206D4Y";
libname out "E:\hrs_code\general_data_setup\HCCsoftware07";
proc cimport library=out infile=in1;
run;
*/



/*******************************************/
* STEP 1
/*******************************************/;

libname medi 'E:\data\cms_DUA_24548_2012';
libname cms 'E:\nhats\data\Projects\serious_ill\int_data';
libname mbsf 'E:\nhats\data\CMS_DUA_28016\Merged';
libname hcc 'E:\nhats\data\CMS_DUA_28016\HCC in progress';



/*******************************************/
/* PERSON FILE
/*******************************************/
* Use 2007 DN file to determine if subject is a new enrollee
  HMO included to see determine if new enrollees should include subjects 
  moving from HMO to FFS;

data yr2010; keep BENE_ID ref10;
set mbsf.mbsf_06_12; 
if BENE_ENROLLMT_REF_YR = 2010;
ref10=1;
run;

proc sort data = yr2010; by BENE_ID; run;

data yr2011;
set mbsf.mbsf_06_12;
if BENE_ENROLLMT_REF_YR = 2011;
run;

proc sort data = yr2011; by BENE_ID; run;

data person11 ; 
merge yr2010 yr2011; 
by BENE_ID;
HICNO=BENE_ID;
*DOB= input(birth_date, yymmdd8.) ;
rename birth_date = DOB;
if BENE_AGE_AT_END_REF_YR<65 then age65=0;
   if BENE_AGE_AT_END_REF_YR ge 64 and BENE_AGE_AT_END_REF_YR le 66then age65=1;
     if BENE_AGE_AT_END_REF_YR ge 66 then age65=2;
if BENE_AGE_AT_END_REF_YR<60 then agecat=59;
   if BENE_AGE_AT_END_REF_YR ge 60 and BENE_AGE_AT_END_REF_YR <70 then agecat=60;
   if BENE_AGE_AT_END_REF_YR ge 70 and BENE_AGE_AT_END_REF_YR <780 then agecat=70;
   if BENE_AGE_AT_END_REF_YR ge 80 then agecat=80;
* determine if R is a new enrollee;
if ref10=1 and year = 2011 then new=0;
   if ref10 = . and year = 2011 then new=1;
* create HCC variables; 
buyin_mo = indexc(BUYIN12,"A","B","C");
if buyin_mo >0 then MCAID=1; else MCAID=0; * if num of part b buy in mos >0;
if new=1 and MCAID=1 then NEMCAID=1; else NEMCAID=0; * if new enrollee & num of part b buy in mos >0;
rename BENE_ENTLMT_RSN_ORIG = OREC;
rename BENE_SEX_IDENT_CD = SEX;
run;

/*proc freq data=person;
tables new ;
tables year * ref07 / missing nocol norow nopercent;
tables age65 * new / missing nocol norow nopercent;
tables agecat * new / missing nocol norow nopercent;
tables HMO_MO * HMO_MO_07 / missing nocol norow nopercent;
run;
* this tables indicates that only 36 subjects would be added if 
  not continous FFS- HMO in 2007 and NO HMO in 2008;
proc freq data=person;
tables HMO_MO * HMO_MO_07  / missing nocol norow nopercent;
where new=0 and BENE_AGE_AT_END_REF_YR ge 64 ; 
run;
*/
data hcc.person11 ; keep HICNO SEX DOB MCAID NEMCAID OREC new;
set person11;
where BENE_AGE_AT_END_REF_YR ge 64;
run;

proc sort data=person11 out=hcc.person11; by HICNO; run;

/* Run HCC program */

*Code for converting coefficients transport file to SAS file;
filename inc  "C:\Users\rahmao03\Documents\CMS_HCC_2011Software\C1210F1Y";
libname incoef  "C:\Users\rahmao03\Documents\CMS_HCC_2011Software";
proc cimport data=incoef.hcccoefn infile=inc;
run;


*Code for converting formats transport file to SAS file;
filename inf  "C:\Users\rahmao03\Documents\CMS_HCC_2011Software\F1210F1Y";
libname library  "C:\Users\rahmao03\Documents\CMS_HCC_2011Software";
proc cimport library=library infile=inf;
run;













/*******************************************/
/* DIAG FILE
/*******************************************/
* create wide file of diagnoses from all the claim files;
data diag011; keep HICNO ADMTG_DGNS_CD PRNCPAL_DGNS_CD ICD_DGNS_CD1--ICD_DGNS_CD25;
set
cms.ip_meet_365 (rename=(BENE_ID=HICNO) keep= BENE_ID ADMTG_DGNS_CD PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25)
cms.pb_meet_365 (rename=(BENE_ID=HICNO) keep= BENE_ID PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12)
cms.op_meet_365 (rename=(BENE_ID=HICNO) keep= BENE_ID PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25)
cms.dm_meet_365 (rename=(BENE_ID=HICNO) keep= BENE_ID PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD12)
cms.hh_meet_365 (rename=(BENE_ID=HICNO) keep= BENE_ID PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25)
cms.hs_meet_365 (rename=(BENE_ID=HICNO) keep= BENE_ID PRNCPAL_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25)
cms.snf_meet_365 (rename=(BENE_ID=HICNO) keep= BENE_ID ADMTG_DGNS_CD ICD_DGNS_CD1-ICD_DGNS_CD25);
*by HICNO;
run;

proc sort data=diag011 out=hcc.diag011; by HICNO; run;

libname proj_int 'E:\nhats\data\projects\serious_ill\int_data'; 
* transpose to long file;
data hcc.diag11 (keep = HICNO diag x);
set diag011;
*by  HICNO;
array dx(27) ICD_DGNS_CD1-ICD_DGNS_CD25 ADMTG_DGNS_CD PRNCPAL_DGNS_CD;
do x=1 to 27;
   if dx(x) ne '' then diag=dx(x);
   if x=1 and dx(x) ne '' then output;
   else if x>1 and (dx(x) ne dx(x-1)) then output;
end;
run;




proc means data=hcc.person_coeff; run;







/*merge score file with person file to get new enrollee status */

data personfile;
set hcc.person11;
keep HICNO new;
run;

data temp;
merge
personfile
hcc.person_coeff (keep=HICNO SCORE_COMMUNITY SCORE_INSTITUTIONAL SCORE_NEW_ENROLLEE);
by HICNO;
HCC_sp_2012=10711;
run;



proc export data=temp
outfile="E:\nhats\data\CMS_DUA_28016\HCC in progress\nhatsHCC.dta" replace;
run;


proc contents data=temp; run;



proc contents data=medi.person; run;
/*******************************************/
* STEP 4
/*******************************************/;
/*prepare xwalk id file to merge*/
data crosswalk_1;
set medi.cmsxref2012;
keep BENE_ID hhid pn;
run;

/*get 2 variables bid_hrs = claims id, id=HRS id*/
data crosswalk_2;
set crosswalk_1;
bid_hrs=BENE_ID;
id=trim(hhid)||trim(pn);
drop hhid pn;
HICNO=BENE_ID;
*drop BENE_ID;
run;
proc sort data=crosswalk_2; by HICNO; run;
proc sort data=person; by HICNO; run;
proc sort data=medi.person; by HICNO; run;

data temp; drop HICNO;
merge 
crosswalk_2
person (keep=HICNO new)
medi.person (keep=HICNO SCORE_COMMUNITY SCORE_INSTITUTIONAL SCORE_NEW_ENROLLEE);
by HICNO;
HCC_sp_2008=9418;
HCC_sp_2008_adj2012=10043.13;
run;

data medi.HCC2008; set temp;
where SCORE_COMMUNITY ne . or SCORE_INSTITUTIONAL ne . or SCORE_NEW_ENROLLEE ne .;
run;

proc sort data= medi.HCC2008;
by id;
run;

proc export data=medi.HCC2008
outfile ="E:\data\cms_DUA_24548_2012\HCC2008.dta" replace;
run;


H="Creating HCC Table"
clear all

use "E:\nhats\data\CMS_DUA_28016\HCC in progress\nhatsHCC.dta", clear
rename hicno bene_id 
keep bene_id score_community score_institutional score_new_enrollee score_snp_new_enrollee
merge 1:1 bene_id using "E:\nhats\data\Projects\serious_ill\final_data\serious_ill_nhats_sample.dta"
cap drop _merge
keep if _merge==3 & wave==1
save "E:\nhats\data\CMS_DUA_28016\HCC in progress\nhatsHCC1.dta", replace 
gen cost2012 = 10711
gen hcc_predict = score_community*cost2012 if nhres==0
replace hcc_predict = score_institutional*cost2012 if nhres==1

summ hcc_predict
summ hcc_predict if criteria_a==1,d
summ hcc_predict if criteria_b==1,d
summ hcc_predict if criteria_c==1,d
summ hcc_predict if criteria_a!=1 & criteria_b!=1 & criteria_c!=1, d

*Total paid by Medicare 12 months following interview

summ tot_paid_by_mc_12m if criteria_a==1
summ tot_paid_by_mc_12m if criteria_b==1
summ tot_paid_by_mc_12m if criteria_c==1

* get top 20% 10% 5% cut offs

tab tot_paid_by_mc_12m

/*
5% >= 47681.3
10% >= 28871.06 
20% >= 13784.35 
*/

gen top1 = 0
gen top5 = 0
gen top10 = 0
gen top20 = 0

replace top1 = 1 if tot_paid_by_mc_12m>=94825.22
replace top5 = 1 if tot_paid_by_mc_12m>=47681.3
replace top10 = 1 if tot_paid_by_mc_12m>=28871.06
replace top20 = 1 if tot_paid_by_mc_12m>=13784.35

/* Sensitivity and Specificity for Top 5 */

tab top5 if criteria_a==1
tab top5 if criteria_a==0

tab top5 if criteria_b==1
tab top5 if criteria_b==0

tab top5 if criteria_c==1
tab top5 if criteria_c==0



/* Any hospital admission */

tab ind_hosp_adm_p12m if criteria_a==1
tab ind_hosp_adm_p12m if criteria_b==1
tab ind_hosp_adm_p12m if criteria_c==1
tab ind_hosp_adm_p12m if criteria_a!=1 & criteria_b!=1 & criteria_c!=1

/* Total Medicare Spending */

sum tot_paid_by_mc_12m if criteria_a==1, d
sum tot_paid_by_mc_12m if criteria_b==1, d
sum tot_paid_by_mc_12m if criteria_c==1, d
sum tot_paid_by_mc_12m if criteria_a!=1 & criteria_b!=1 & criteria_c!=1, d



/* Died */

tab died_12 if criteria_a==1
tab died_12 if criteria_b==1
tab died_12 if criteria_c==1
tab died_12 if criteria_a!=1 & criteria_b!=1 & criteria_c!=1


gen died_post_ivw = (death_month-index_month) if death_year==2011
replace died_post_ivw = death_month if death_year==2012 & died_12==1
replace died_post_ivw = died_post_ivw + (12 - index_month) if death_year==2012 & died_12==1

/* Total Medicare Spending Per Month */

gen tot_per_m = tot_paid_by_mc_12m/12 if died_12!=1
replace tot_per_m = tot_paid_by_mc_12m/died_post_ivw if died_12==1

sum tot_per_m if criteria_a==1
sum tot_per_m if criteria_b==1
sum tot_per_m if criteria_c==1
sum tot_per_m if criteria_a!=1 & criteria_b!=1 & criteria_c!=1

/* HCC predicted Spending Per Month */

gen died_post_ivw = (death_month-index_month) if death_year==2011
replace died_post_ivw = death_month if death_year==2012 & died_12==1
replace died_post_ivw = died_post_ivw + (12 - index_month) if death_year==2012 & died_12==1


gen hcctot_per_m = hcc_predict/12 if died_12!=1
replace hcctot_per_m = hcc_predict/died_post_ivw if died_12==1

sum hcctot_per_m if criteria_a==1
sum hcctot_per_m if criteria_b==1
sum hcctot_per_m if criteria_c==1
sum hcctot_per_m if criteria_a!=1 & criteria_b!=1 & criteria_c!=1

/* Top 5% Predicted by HCC */

tab hcc_predict

* top5% =  53715.66 

gen top5hcc = 0
replace top5hcc = 1 if hcc_predict>=53715.66



tab ind_hosp_adm_p12m if top5hcc==1
tab ind_hosp_adm_p12m if top5hcc==0

di 216/(216+1000) // sensitivity
di 4008/(4008+48) // specificity

tab top5 if top5hcc==1 
tab top5 if top5hcc==0

di 140/(140+157) // sensitivity
di 4851/(4851+124) // specificity


tab died_12 if top5hcc==1  // sensitivity
tab died_12 if top5hcc==0  // specificity

di 89/(89+289) // sensitivity
di 4719/(4719+175)// specificity


H="get contact days"
note: this is the contact days template for 2012

libname medi 'E:\nhats\data\CMS_DUA_28016\Merged';
libname proj_int 'E:\data\Dartmouth_misc\contact days working data';

data dna;
set medi.mbsf_06_12(keep=bene_id hmoind12 buyin12 year bene_age_at_end_ref_yr birth_date);
where year=2012 and bene_age_at_end_ref_yr>=65;
if indexc(buyin12,"0","1","2","A","B") then part_ab=0;
if indexc(buyin12,"0","1","2","A","B")=0 then part_ab=1;
if indexc(hmoind12,"1","2","4","A","B","C")=0 then hmo=0;
if indexc(hmoind12,"1","2","4","A","B","C") then hmo=1;
run;

data dn;
set dna;
where part_ab=1 and hmo=0;
run;

%macro mp(source=);
proc sql;
create table mpa as select * from
dn a left join
medi.&source._06_12 b
on a.bene_id=b.bene_id;
quit;

data mpb;
set mpa(keep=bene_id admit_date disch_date);
where (year(disch_date)=2012 | year(admit_date)=2012);
if admit_date<'01jan2012'd then admit_date='01jan2012'd;
if disch_date>'31DEC2012'd then disch_date='31DEC2012'd;
los=disch_date-admit_date+1;
run;

proc sort data=mpb out=mpc nodupkey; 
by bene_id admit_date disch_date; 
run;


%macro dates();
data mpd;
set mpc;
%do i=1 %to 366;
%let l=%eval(&i-1);
if los>=&i. then date&i.=admit_date+&l.;
format date&i. date9.;
%end;
run;
%mend;

%dates();

data mpe;
set mpd;
array adate(1:366) date1-date366;
do datenum = 1 to 366;
date=adate(datenum);
output;
end;
format date date9.;
drop date1-date366;
run;

data mpf;
set mpe;
where date~=.;
run;

proc sort data=mpf out=mpg nodupkey;
by bene_id date;
run;

data &source.;
set mpg(keep= bene_id date admit_date);
where date~=.;
mp=1;
run;

proc sql;
create table &source._cd as select distinct
bene_id,
count(date) as &source._contact_days
from &source. group by bene_id;
quit;

%mend;

%mp(source=ip);
%mp(source=snf);

proc sql;
create table pba as select * from
dn a left join
medi.pb_06_12 b
on a.bene_id=b.bene_id;
quit;

data pba1;
set pba;

data pbb;
set pba(keep=bene_id admit_date disch_date expnsdt11-expnsdt19 expnsdt110-expnsdt113 hcpcscd1-hcpcscd13);
where year(admit_date)=2012;
run;

data pbc(keep=bene_id admit_date linedate1);
set pbb;
array adate(1:13) expnsdt11-expnsdt19 expnsdt110-expnsdt113;
do datenum = 1 to 13;
linedate1=adate(datenum);
output;
end;
run;

data pbc2(drop=linedate1);
set pbc;
where linedate1~=.;
date=linedate1;
format date date9.;
run;

proc sort data=pbc2 out=pbd nodupkey;
by bene_id date;
run;

data pbe(keep=bene_id date);
set pbb;
date=admit_date;
pb=1;
run;

proc sort data=pbe out=pbe2 nodupkey;
by bene_id date; 
run;

proc sql;
create table pb_adm as select distinct
bene_id,
count(date) as pb_adm_days
from pbe2 group by bene_id;
quit;

data pbf;
set pbe pbd;
where date~=.; 
format date date9.;
if date<'01jan2012'd then date='01jan2012'd;
if date>'31DEC2012'd then date='31DEC2012'd;
pb=1;
run;

proc sort data=pbf out=pb nodupkey;
by bene_id date;
run;

proc sql;
create table pb_cd as select distinct
bene_id,
count(date) as pb_contact_days
from pb group by bene_id;
quit;

proc sql;
create table opa as select * from
dn a left join
medi.op_06_12 b
on a.bene_id=b.bene_id;
quit;

data opb;
set opa(keep=bene_id admit_date disch_date rev_dt1-rev_dt45);
where year(admit_date)=2012;
if admit_date<'01jan2012'd then admit_date='01jan2012'd;
if disch_date>'31DEC2012'd then disch_date='31DEC2012'd;
run;

data opc(keep=bene_id admit_date linedate1);
set opb;
array adate(1:45) rev_dt01-rev_dt45;
do datenum = 1 to 45;
linedate1=adate(datenum);
output;
end;
drop rev_dt01-rev_dt45;
run;

data opc2(drop=linedate1);
set opc;
where linedate1~=.;
date=linedate1;
format date date9.;
run;

proc sort data=opc2 out=opd nodupkey;
by bene_id date;
run;

data ope(keep=bene_id date);
set opb;
date=admit_date;
op=1;
run;

proc sort data=ope out=ope2 nodupkey;
by bene_id date; 
run;

proc sql;
create table op_adm as select distinct
bene_id,
count(date) as op_adm_days
from ope2 group by bene_id;
quit;

data opf;
set ope opd;
where date~=.;
if date<'01jan2012'd then date='01jan2012'd;
if date>'31DEC2012'd then date='31DEC2012'd;
op=1;
run;

proc sort data=opf out=op nodupkey;
by bene_id date;
run;

proc sql;
create table op_cd as select distinct
bene_id,
count(date) as op_contact_days
from op group by bene_id;
quit;

data alla;
set ip snf pb /*op*/;
where date~=.;
format date date9.;
run;

proc sort data=alla out=allb nodupkey;
by bene_id date;
run;

proc sql;
create table allc as select distinct
bene_id,
count(date) as contact_days
from allb group by bene_id;
quit;

proc sql; 
create table alld as select * from 
dn a left join
allc b
on a.bene_id=b.bene_id
left join ip_cd c
on a.bene_id=c.bene_id
/*left join op_adm d
on a.bene_id=d.bene_id
left join op_cd e
on a.bene_id=e.bene_id*/
left join pb_adm f
on a.bene_id=f.bene_id
left join pb_cd g
on a.bene_id=g.bene_id
left join snf_cd h
on a.bene_id=h.bene_id;
run;

data all;
set alld;
array list ip_contact_days snf_contact_days /*op_adm_days op_contact_days*/ pb_adm_days pb_contact_days contact_days;
do over list;
if list=. then list=0;
end;
run;

proc export data=all outfile="E:\data\\Dartmouth_misc\contact days working data\nhats_ip_snf_and_pb.dta" replace; run;


H="stata compare to hrs"
clear all
set more off
capture log close

local datapath "E:\nhats\data\projects\serious_ill\int_data"
local logpath "E:\nhats\data\projects\serious_ill\logs"

log using "`logpath'\comparison_nhats_hrs", replace

cd `datapath'

use serious_ill_int_dataset1
keep if sp_ivw_yes==1
keep if wave==1 | wave==2
gen ffs_12m=cont_ffs_n_mos>=12

drop if lml_ivw==1

foreach x of varlist smi_* criteria_* ser_med_illness {
replace `x'=0 if `x'==.
}
local cvars age

replace white=race==1
replace black=race==2
replace other_race=race==3
replace hisp=race==4

local ivars female white black hisp other_race married proxy  ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
smi_hiv_ind smi_als_ind smi_hip_ind ser_med_illness smi_ge3_ind nhres ///
criteria_a criteria_b criteria_c

foreach x of local ivars {
drop if `x'==.
}

local rn : word count `cvars' `ivars' 1
local r=1
local c=1

mat tab=J(`rn',7,.)
svyset [pw=anfinwgt]
sum ffs_12m
mat tab[`r',`c']=r(N)*r(mean)
mat tab[`r',`c'+1]=r(mean)*100
sum ffs_12m [aw=anfinwgt]
mat tab[`r',`c'+2]=r(mean)*100

keep if ffs_12m==1
foreach x of local cvars {
	local r=`r'+1
	sum `x' 
	mat tab[`r',`c']=r(mean)
	mat tab[`r',`c'+1]=r(sd)
	sum `x' [aw=anfinwgt]
	mat tab[`r',`c'+2]=r(mean)
}
foreach x of local ivars {
	local r=`r'+1
	sum `x' 
	mat tab[`r',`c']=r(N)*r(mean)
	mat tab[`r',`c'+1]=r(mean)*100
	sum `x' [aw=anfinwgt]
	mat tab[`r',`c'+2]=r(mean)*100
}

use "E:\data\serious_ill\int_data\core_ids_1yr_criteria_5.dta", clear

svyset [pw=wgtr]
keep if core_year==2010 | core_year==2012
keep if age_ge_65==1 & xwalk_yes==1
local cvars age_at_core 

label var age_at_core "Age at ivw (mean,sd)"

local ivars female white black hisp_eth other_race married proxy  ///
medicaid medigap srh_pf adl_e_core adl_bh_core adl_t_core adl_dr_core ///
adl_wk_core adl_tx_core  adl_independent_core smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
smi_hiv_ind smi_als_ind smi_hip_ind ser_med_illness smi_ge3_ind nhres ///
criteria_a criteria_b criteria_c

foreach x of local ivars {
drop if `x'==.
}
sum `ivars'
gen ffs_12m=part_ab_12m==1 & hmo_d_12m==0
local c=4
local r=1

sum ffs_12m
mat tab[`r',`c']=r(N)*r(mean)
mat tab[`r',`c'+1]=r(mean)*100
sum ffs_12m [aw=wgtr]
mat tab[`r',`c'+2]=r(mean)*100
preserve
keep if ffs_12m==1

foreach x of local cvars {
	local r=`r'+1
	sum `x' 
	mat tab[`r',`c']=r(mean)
	mat tab[`r',`c'+1]=r(sd)
	sum `x' [aw=wgtr]
	mat tab[`r',`c'+2]=r(mean)
}
foreach x of local ivars {
	local r=`r'+1
	sum `x' 
	mat tab[`r',`c']=r(N)*r(mean)
	mat tab[`r',`c'+1]=r(mean)*100
	sum `x' [aw=wgtr]
	mat tab[`r',`c'+2]=r(mean)*100
}

mat rownames tab = "FFS 12m pre-ivw" `cvars' `ivars' 

frmttable using `logpath'\serious_ill_nhats_hrs, statmat(tab) replace ///
title("Comparison of SMI & function, NHATS & HRS") ///
ctitles("" "N Yes" "% Yes" "Weighted %" "N Yes" "% Yes" "Weighted %") ///
note("Restricted to those alive at ivw with FFS MC 12+ months before" ///
"NHATS ivw years 2010 & 2011; HRS ivw years 2010 & 2012" ///
"Weighted values with person-level weights, NHATS anfinwgt, HRS wgtr") ///
varlabels sdec(0,2,2,0,2,2) 
restore
/*append using serious_ill_int_dataset1

keep if sp_ivw_yes==1 | sp_ivw_yes==.
keep if wave==1 | wave==2 | wave==.
replace ffs_12m=cont_ffs_n_mos>=12 if ffs_12m==.

drop if lml_ivw==1

foreach x of varlist smi_* criteria_* ser_med_illness {
replace `x'=0 if `x'==.
}

replace age_at_core=age if age_at_core==.
replace srh_pf=srh_fp if srh_pf==.
replace adl_e_core=adl_eat_help if adl_e_core==.
replace adl_wk_core=adl_ins_help if adl_wk_core==.
replace adl_tx_core=adl_bed_help if adl_tx_core==.
replace adl_dr_core=adl_dres_help if adl_dr_core==.
replace adl_t_core=adl_toil_help if adl_t_core==.
replace adl_bh_core=adl_bath_help if adl_bh_core==.

gen nhats=sp_ivw_yes==1

gen weight=wgtr
replace weight=anfinwgt if weight==.

svyset [pw=weight]

svy: tab ffs_12m nhats
mat tab[`r',7]=r(p_Pear)
local r=`r'+1
svy: mean age_at_core, over(nhats)
test [age_at_core]0=[age_at_core]1
mat tab[`r',7]=r(p)

foreach x of local ivars {
local r=`r'+1
svy: tab `x' nhats 
mat tab[`r',7]=r(p_Pear)
}




H="treatment burden info"
clear all

use "E:\data\\Dartmouth_misc\contact days working data\nhats_ip_snf_and_pb.dta", clear
gen wave=index_y-2010
keep if wave==2
by spid, sort: gen dup=_N>1
drop if dup
merge 1:1 spid wave using "E:\nhats\data\NHATS cleaned\sp_round_1_4.dta", keep(match master)
drop _m
merge 1:1 spid wave using "E:\nhats\data\projects\serious_ill\int_data\treatment_burdennpi.dta"
tab _m group
sum contact
sum contact, d
sum pb_con
sum ip_con
merge 1:m spid wave using "E:\nhats\data\projects\serious_ill\int_data\serious_ill_int_dataset1.dta", keep(match master) gen(thism)
gen ffs_12=cont_ffs_n>=12
sum contact if ffs_12
sum pb_contact if ffs_12
sum ip_contact if ffs_12
keep if !lml & sp_ivw_yes==1
tab ind_t ind_meds_pr, chi2
*tab group, gen(criteria_)
*recode group (2/3 = .)
*replace group = 2 if meddif>=2
*replace group = 3 if medfamdif>=2
*replace group = 4 if meddelay>=2
*replace group = 5 if medtoomch>=2

*la define grouplbl 1"Did not receive module"2"Diff. manage med care"3"Diff. family manage care"4"Delay in manage med care"5"Too much manage med care"
*la values group grouplbl

gen criteria_1 = 0 // did not receive module
replace criteria_1 = 1 if group==1

gen criteria_2 = 0 // no treatment burden
replace criteria_2 = 1 if group==2

gen criteria_3 = 0 
replace criteria_3 = 1 if meddif>=3 & meddif!=.

gen criteria_4 = 0
replace criteria_4 = 1 if medfamdif>=3 & medfamdif!=.

gen criteria_5 = 0
replace criteria_5 = 1 if meddelay>=3 & meddelay!=.

gen criteria_6 = 0 
replace criteria_6 = 1 if medtoomch>=3 & medtoomch!=.

gen cgroup1=criteria_1
gen cgroup2=criteria_2
gen cgroup3=criteria_3
gen cgroup4=criteria_4
gen cgroup5=criteria_5
gen cgroup6=criteria_6
gen ind=1
local coutcomes 
gen missingany=0
foreach x in `cvars1' `cvars2' `ivars1' `ivars2' {
qui sum ind if missing(`x')
if r(N)>0 {
di "`x'"
di r(N)
}
qui replace missingany=1 if `x'==.
}
local cvars1 age
local cvars2 n_helpers
local ivars1 female white black hisp other_race married educ_hs_ind
local ivars2 proxy ffs_12 ///
medicaid medigap srh_fp adl_eat_help adl_bath_help adl_toil_help adl_dres_help ///
adl_ins_help adl_bed_help adl_independent adl_diff_wk adl_diff_tx adl_diff_e adl_diff_bh adl_diff_dr adl_diff_t smi_dem_ind smi_cancer_ind ///
smi_esrd_ind smi_chf_ind smi_copd_ind smi_diab_compl_ind smi_liver_ind ///
/*smi_hiv_ind smi_als_ind*/ smi_hip_ind ser_med_illness el_ge3_comorb_1yr nhres ///
criteria_a criteria_b criteria_c 
local cvars3 contact_days npi_count
local ivars3 ind_treatment_burden ind_meds_problem
local ioutcomes 


capture log close

log using "E:\nhats\data\projects\serious_ill\logs\treatment_burden_xtabs3npi.txt", text replace

local mod meddif medfamdif meddelay medtoomch
foreach now in 0 1 {
foreach x in `mod' {
	tab `x'
}
tab ind_t
tab group
tab1 ind_meds_diff ind_meds_mi ind_meds_pr
tab ind_meds_pr ind_trea, chi2
keep if ffs_12
}

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `cvars3' `ivars3' n `coutcomes' `ioutcomes'
/*
local r=1
local c=1
mat miss=J(`rn',3,.)

foreach x in `cvars1' `cvars2' `ivars1' `ivars2' `cvars3' `ivars3' `coutcomes' `ioutcomes' {
sum `x' 
mat miss[`r',1]=r(mean)
mat miss[`r',2]=r(N)
sum ind if missing(`x')
mat miss[`r',3]=r(N)
local r=`r'+1
}
sum ind
mat miss[`r',1]=r(N)

mat rownames miss=`cvars1' `cvars2' `ivars1' `ivars2' `coutcomes' `ioutcomes' N

frmttable, statmat(miss) varlabels title("Missing values") ///
ctitles("" "Variable" "mean" "N" "N missing") sdec(2,0,0)
tab missingany*/
*drop if missingany
local r=1
local c=1

local rn : word count `cvars1' `cvars2' `ivars1' `ivars2' `cvars3' `ivars3' `coutcomes' `coutcomes' `ioutcomes' a
di `rn'
mat tab1=J(`rn',6,.)
mat stars=J(`rn',6,0)
local r=1
local c=1
foreach i in 1 2 3 4 5 6 {
	foreach round in 1 2 3 {
		foreach x of local cvars`round' {
			qui sum `x' if criteria_`i'==1 
			mat tab1[`r',`c']=r(mean)
			if `i' > 2 {
				ttest `x' if criteria_`i'==1 | criteria_2==1, by(ind_t) 
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
		foreach x of local ivars`round' {
			qui sum `x' if criteria_`i'==1
			mat tab1[`r',`c']=r(mean)*100
		        if `i' > 2 {
				tab `x' cgroup`i' if criteria_`i'==1 | criteria_2==1, chi2
				mat stars[`r',`c']=(r(p)<.01) + (r(p)<.05)
}
			local r=`r'+1
}
}
	sum ind if criteria_`i'==1
	mat tab1[`r',`c']=r(N)
	local r=1
	local c=`c'+1
}



mat rownames tab1=`cvars1' `ivars1' `cvars2' `ivars2' `cvars3' `ivars3' N

frmttable using "E:\nhats\data\projects\serious_ill\logs\treatment_burden3npi.doc", replace statmat(tab1) ///
 title("Sample Characteristics by Treatment Burden group, 2nd wave") ///
 ctitles("" "No module" "No burden" "Diff. manage med care" "Diff. fam manage care" "Delay in manage med care" "Too much manage med care") ///
 sdec(1) annotate(stars) asymbol(*,*) ///
 varlabels note(*p<.05 difference by treatment burden, t-test or chi2)

log close


H="Pulling NPI from Claims"
libname merged "E:\nhats\data\CMS_DUA_28016\Cumulative Years";

/* Outpatient file construction */

%macro mp(source=);
data mpwide (keep= bene_id at_physn_npi op_physn_npi ot_physn_npi admit_date disch_date clm_id);
set merged.outpatient_base_claims_j_09_12;
run;

data &source.long(keep= bene_id admit_date disch_date NPI clm_id);
set &source.wide;
array dx at_physn_npi op_physn_npi ot_physn_npi;
do over dx;
NPI=dx;
output;
end;
run;
%mend;

%mp (source=mp);


data oprev; keep bene_id clm_id hcpcs_cd;
set merged.Outpatient_rev_center_j_09_12;
run;


proc sort data=mplong nodupkey;
by bene_id clm_id NPI;
run;

proc sort data=oprev;
by bene_id clm_id;
run;

proc sql;
create table op_file as SELECT a.*, b.*
FROM mplong as a
LEFT JOIN oprev as b 
ON a.bene_id = b.bene_id AND a.clm_id = b.clm_id
ORDER BY a.bene_id;
quit;


data op_file;
set op_file;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;


data op_file;
set op_file;
cptflag = 0;
IF (99200 < cptcodes= < 99206) or (99210 < cptcodes <99216) or (99380 < cptcodes <99388) or (99303 < cptcodes < 99351) THEN cptflag = 1;
run;


data op_file;
set op_file;
gflag = indexc(hcpcs_cd, "G");
run;

data op_file;
set op_file;
IF (gflag = 1) and (437 < cptcodes < 440) then cptflag = 1;
IF (gflag = 1) and (cptcodes = 402) then cptflag = 1;
run; 


data op_file2 (keep = bene_id admit_date disch_date NPI);
set op_file;
where cptflag = 1;
run;

/* Carrier file construction */

data bclaims (keep= bene_id NPI admit_date disch_date clm_id);
set merged.bcarrier_claims_j_09_12 (rename=(rfr_physn_npi=NPI));
run;

data bline (keep = bene_id NPI HCPCS_CD clm_id);
set merged.bcarrier_line_j_09_12 (rename=(prf_physn_npi=NPI));
run;

proc sort data=bline; by bene_id clm_id; run;

data bclaims (keep= bene_id admit_date disch_date clm_id);
set merged.bcarrier_claims_j_09_12;
run;

proc sort data=bclaims; by bene_id clm_id; run;




proc sql;
create table carrier_file as SELECT a.*, b.*
FROM bline as a
LEFT JOIN bclaims as b 
ON a.bene_id = b.bene_id AND a.clm_id = b.clm_id
ORDER BY a.bene_id;
quit;


proc sort data=carrier_file nodupkey;
by bene_id clm_id admit_date disch_date NPI;
run;

data carrier_file;
set carrier_file;
cptcodes = input(compress(hcpcs_cd,'ABCDEFGHIJKLMNOPQRSTUVWXYZ/',),8.);
run;

data carrier_file;
set carrier_file;
cptflag = 0;
IF (99200 < cptcodes= < 99206) or (99210 < cptcodes <99216) or (99380 < cptcodes <99388) or (99303 < cptcodes < 99351) THEN cptflag = 1;
run;

data carrier_file;
set carrier_file;
gflag = indexc(hcpcs_cd, "G");
run;

data carrier_file;
set carrier_file;
IF (gflag = 1) and (437 < cptcodes < 440) then cptflag = 1;
IF (gflag = 1) and (cptcodes = 402) then cptflag = 1;
run; 

/*proc means data=carrier_file; var cptflag; run;*/


/*proc sort data=carrier_file; by HCPCS_CD; run;

data carrier_fi;
set carrier_file;
where cptflag = 0;
run;

proc freq data=carrier_fi order=freq; tables HCPCS_CD; run;
*/

data carrier_file2;
set carrier_file;
where cptflag = 1;
run;

data carrier_file2 (keep = bene_id admit_date disch_date NPI);
set carrier_file2;
run; 


*proc freq data=carrier_file;

data npi_count;
set carrier_file2 op_file2;
run;

proc sort data = npi_count nodup; by bene_id; run; /* cleaned data claims data, ready to be matched with NHATS to filter out wave2 */

**save "E:\nhats\data\Projects\serious_ill\int_data\npi_countv2.dta", replace


H="# Unique Providers (wave 2)"
use "E:\nhats\data\Projects\serious_ill\int_data\npi_countv2.dta", clear

merge m:1 bene_id using "E:\nhats\data\CMS_DUA_28016\xwalk.dta"
cap drop _m
destring nhats_cms_num, replace
recast long nhats_cms_num
merge m:1 nhats_cms_num using "E:\nhats\data\CMS_DUA_28016\Kelley_crosswalk_NHATS.dta" 
cap drop _m
save "E:\nhats\data\Projects\serious_ill\int_data\npi_countv2.dta", replace



merge m:1 spid using "E:\nhats\data\projects\serious_ill\int_data\treatment_burden.dta"

keep if wave==2
keep if _merge==3

gen count = ivw_date - admit_date 
keep if (count>=0 & count <=366)
drop _m

drop count
duplicates drop spid npi, force
duplicates report

bysort spid: gen npi_cnt = _N
destring npi, replace


*egen npi_count = max(npi_cnt), by(bene_id)
egen npi_count = count(npi), by(bene_id)
merge m:1 spid using "E:\nhats\data\projects\serious_ill\int_data\treatment_burden.dta"

duplicates drop spid ,force

**save "E:\nhats\data\projects\serious_ill\int_data\treatment_burdennpi.dta", replace

H="npi count (evan)"
use spid bene_id ivw_date wave sp_ivw lml using "E:\nhats\data\Projects\serious_ill\int_data\serious_ill_int_dataset1.dta" if wave==2 & sp_ivw==1 & lml==0, clear
tempfile surv
save `surv'

use bene_id clm_id admit_date *npi* using  "E:\nhats\data\Projects\serious_ill\int_data\nhats_op_06_12.dta", clear
tempfile op
save `op'

use bene_id clm_id hcpcs_cd using  "E:\nhats\data\Projects\serious_ill\int_data\nhats_op_rc_06_12.dta", clear

gen ambul=((real(hcpcs_cd)>=99201) & real(hcpcs_cd)<=99205) ///
| ((real(hcpcs_cd)>=99211) & real(hcpcs_cd)<=99215) ///
| ((real(hcpcs_cd)>=99381) & real(hcpcs_cd)<=99387) ///
| ((real(hcpcs_cd)>=99391) & real(hcpcs_cd)<=99397) ///
| ((real(hcpcs_cd)>=99304) & real(hcpcs_cd)<=99350) ///
| inlist(trim(hcpcs_cd),"G0402","G0438","G0439")
by bene_id clm_id, sort: egen ambulatory=max(ambul)
drop ambul hcp
duplicates drop
merge 1:1 bene_id clm_id using `op'
rename at npi1
rename op npi2
rename ot npi3
reshape long npi, i(bene_id clm_id) j(num)
drop num _m org
*drop if !ambulatory
tempfile op
gen op=1
save `op'

use bene_id clm_id admit_date using  "E:\nhats\data\Projects\serious_ill\int_data\nhats_pb_06_12.dta", clear
tempfile pb
save `pb'

use bene_id clm_id prf_physn_npi hcpcs_cd using ///
 "E:\nhats\data\Projects\serious_ill\int_data\nhats_pb_line_06_12.dta", clear
gen ambulatory=((real(hcpcs_cd)>=99201) & real(hcpcs_cd)<=99205) ///
| ((real(hcpcs_cd)>=99211) & real(hcpcs_cd)<=99215) ///
| ((real(hcpcs_cd)>=99381) & real(hcpcs_cd)<=99387) ///
| ((real(hcpcs_cd)>=99391) & real(hcpcs_cd)<=99397) ///
| ((real(hcpcs_cd)>=99304) & real(hcpcs_cd)<=99350) ///
| inlist(trim(hcpcs_cd),"G0402","G0438","G0439")
drop if !ambulatory
merge m:1 bene_id clm_id using `pb', nogen
gen pb=1
rename prf npi
append using `op'

merge m:1 bene_id using `surv', keep(match) nogen
drop if ivw_date-admit_date>365 | ivw_date<admit_date
drop if missing(npi)

//might be useful at some point to get a count by source &ambulatory and total, but not going to here
keep if ambulatory==1
duplicates drop spid npi, force
by spid, sort: gen npi_count=_N
keep spid npi_count wave
duplicates drop
merge 1:m spid wave using "E:\nhats\data\Projects\serious_ill\int_data\serious_ill_int_dataset1.dta", ///
gen(survmerge) 
keep if wave==2 & sp_ivw==1 & lml==0 & cont_ffs_n_mos>=12
replace npi=0 if missing(npi)
save "E:\nhats\data\Projects\serious_ill\int_data\npi_ebl.dta", replace




H="HCC"
libname hcc 'E:\nhats\data\Projects\pal_perf_scale\int_data\hcc';

%macro gethcc (year=,wave=);

data persa(keep=bene_id dob orec);
set medi.mbsf_06_14;
if year=&year.;
dob=birth_date;
orec=BENE_ENTLMT_RSN_ORIG;
run;

option nofmterr;

data pers1 (keep=bene_id mcaid nemcaid sex);
set proj_int.serious_ill_int_dataset;
if bene_id~='' and wave=&wave.;
sex=female+1;
mcaid=0<indexc(buyin_2y_r,"C","B","A")<=12;
nemcaid=mcaid=1 and indexc(substr(buyin_2y_r,13,12),"C","B","A")=0;
run;


proc sql;
create table person as select * from
pers1 a 
left join 
persa b
on a.bene_id=b.bene_id;
quit;

proc sort nodup data=person out=hcc.person;
by bene_id;
run;

data diag(keep=bene_id diag);
set proj_int.dx_0_1yr;
if index_year=&year.;
run;

proc sort nodup data=diag out=hcc.diag;
by bene_id;
run;





 /*
    The following is JCL if you are using an IBM-type mainframe:

   //JOBCARD
   //V1210F1P EXEC SAS9,REGION=8M,
   // OPTIONS='ERRORS=0,NOCENTER,NEWS'
   //WORK  DD SPACE=(CYL,(1000,2))
   //WORK1   DD SPACE=(CYL,(2000,2))
   //* user-defined the location of formats
   //LIBRARY DD DISP=SHR,DSN=XXXX.XXXXXXX
   //*user-defined the location of macros
   //IN0 DD DISP=SHR,DSN=XXXX.XXXXXX
   //*the location of person-level file
   //IN1 DD DISP=SHR,DSN=XXXX.PERSON
   //*the location of the diagnosis file
   //IN2 DD DISP=SHR,DSN=XXXX.DIAG
   //*the location of the file containing all coefficients
   //INCOEF DD DISP=SHR,DSN=XXXX.HCCCOEFN
   //*the output file containing person-level scores
   //OUT DD DISP=(NEW,CATLG,KEEP),
   //    DSN=XXX.V1210F1P.PERSON,
   //    SPACE=(TRK,(20,10),RLSE)
   //SYSIN  DD *

   ******************************************************************
  If you are using PC-SAS, you must specify the location of the files
  on your PC in a libname/filename statement.
 */
  LIBNAME LIBRARY "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  FILENAME IN0 "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  LIBNAME  IN1 "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  LIBNAME  IN2 "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  LIBNAME  INCOEF "E:\nhats\data\Projects\pal_perf_scale\int_data\hcc";
  LIBNAME  OUT "E:\nhats\data\Projects\pal_perf_scale\int_data\";
 ***********************************************************************
 *
 *   DESCRIPTION:
 *
 * V1210F1P program creates seventy HCC variables (&CMSHCC) and four
 * score variables for each person who is present in a person file
 * supplied by a user.
 * If a person has at least one diagnosis in DIAG file (supplied by a
 * user) then HCC variables are created, otherwise HCCs are set to 0 .
 * Score variables are created using coefficients from 4 final models:
 * community, institutional, new enrollees, and SNP new enrollees.
 *
 * Assumptions about input files:
 *   - both files are sorted by person ID
 *
 *   - person level file has the following variables:
 *     :&IDVAR   - person ID variable (it is a macro parameter, HICNO
 *                 for Medicare data)
 *     :DOB      - date of birth
 *     :SEX      - sex
 *     :OREC     - original reason for entitlement
 *     :MCAID    - Medicaid dummy variable (base year)
 *     :NEMCAID  - Medicaid dummy variable for new enrollees (predicted
 *                 year)
 *
 *   - diagnosis level file has the following vars:
 *     :&IDVAR   - person ID variable (it is a macro parameter, HICNO
 *                 for Medicare data)
 *     :DIAG     - diagnosis
 *
 * The program supplies parameters to a main macro %V1210F1M that calls
 * other external macros:
 *
 *      %AGESEXNV  - create age/sex, originally disabled, disabled vars
 *      %EDITICD9  - perform edits to diagnosis
 *      %V12H70M   - assign one ICD9 to multiple CCs
 *      %V12H70L   - assign labels to HCCs
 *      %V12H70H   - set HCC=0 according to hierarchies
 *      %SCOREVAR  - calculate a score variable
 *
 *
 * Program steps:
 *         step1: include external macros
 *         step2: define internal macro variables
 *         step3: merge person and diagnosis files outputting one
 *                record per person for each input person level record
 *         step3.1: declaration section
 *         step3.2: bring regression coefficients
 *         step3.3: merge person and diagnosis file
 *         step3.4: for the first record for a person set CC to 0
 *                  and calculate age
 *         step3.5: if there are any diagnoses for a person
 *                  then do the following:
 *                   - create CC using format $I12101Y09Y10YC
 *                   - perform ICD9 edits using macro EDITICD9
 *                   - create additional CC using V12H70M macro
 *         step3.6: for the last record for a person do the
 *                  following:
 *                   - create demographic variables needed
 *                     for regressions (macro AGESEXNV)
 *                   - create HCC using hierarchies (macro V12H70H)
 *                   - create HCC interaction variables
 *                   - create HCC and DISABL interaction variables
 *                   - set HCCs and interaction vars to zero if there
 *                     are no diagnoses for a person
 *                   - create score for community model
 *                   - create score for institutional model
 *                   - create score for new enrollee model
 *                   - create score for SNP new enrollee model
 *                   - normalize score if needed
 *         step4: data checks and proc contents
 *
 *   USER CUSTOMIZATION:
 * A user must supply 2 files with the variables described above and
 * set the following parameters:
 *      INP      - SAS input person dataset
 *      IND      - SAS input diagnosis dataset
 *      OUTDATA  - SAS output dataset
 *      IDVAR    - name of person id variable (HICNO for medicare data)
 *      KEEPVAR  - variables to keep in the output dataset
 *      SEDITS   - a switch that controls whether to perform edits on 
 *                 ICD9. 1-YES, 0-NO
 *      DATE_ASOF- reference date to calculate age. Set to February 1 of 
 *                 the payment year for consistency with CMS. 
 *                 The default value in the code below is 1FEB2010.
 *      FMNAME   - format name (set to I12101Y09Y10YC by default)
 *      DF       - normalization factor (set to 1 by default)
 ***********************************************************************;

 %LET INPUTVARS=%STR(DOB MCAID NEMCAID OREC);

 %*demographic variables;
 %LET DEMVARS  =%STR(AGEF ORIGDS DISABL
                     F0_34  F35_44 F45_54 F55_59 F60_64 F65_69
                     F70_74 F75_79 F80_84 F85_89 F90_94 F95_GT
                     M0_34  M35_44 M45_54 M55_59 M60_64 M65_69
                     M70_74 M75_79 M80_84 M85_89 M90_94 M95_GT
                     NEF0_34  NEF35_44 NEF45_54 NEF55_59 NEF60_64
                     NEF65    NEF66    NEF67    NEF68    NEF69
                     NEF70_74 NEF75_79 NEF80_84 NEF85_89 NEF90_94
                     NEF95_GT
                     NEM0_34  NEM35_44 NEM45_54 NEM55_59 NEM60_64
                     NEM65    NEM66    NEM67    NEM68    NEM69
                     NEM70_74 NEM75_79 NEM80_84 NEM85_89 NEM90_94
                     NEM95_GT);

 %*list of HCCs included in models;
 %LET CMSHCC = %STR(
      HCC1      HCC2      HCC5     HCC7       HCC8
      HCC9      HCC10     HCC15    HCC16      HCC17
      HCC18     HCC19     HCC21    HCC25      HCC26
      HCC27     HCC31     HCC32    HCC33      HCC37
      HCC38     HCC44     HCC45    HCC51      HCC52
      HCC54     HCC55     HCC67    HCC68      HCC69
      HCC70     HCC71     HCC72    HCC73      HCC74
      HCC75     HCC77     HCC78    HCC79      HCC80
      HCC81     HCC82     HCC83    HCC92      HCC95
      HCC96     HCC100    HCC101   HCC104     HCC105
      HCC107    HCC108    HCC111   HCC112     HCC119
      HCC130    HCC131    HCC132   HCC148     HCC149
      HCC150    HCC154    HCC155   HCC157     HCC158
      HCC161    HCC177    HCC164   HCC174     HCC176);

 %*list of CCs that correspond to model HCCs;
 %LET CMSCC = %STR(
      CC1       CC2       CC5      CC7        CC8
      CC9       CC10      CC15     CC16       CC17
      CC18      CC19      CC21     CC25       CC26
      CC27      CC31      CC32     CC33       CC37
      CC38      CC44      CC45     CC51       CC52
      CC54      CC55      CC67     CC68       CC69
      CC70      CC71      CC72     CC73       CC74
      CC75      CC77      CC78     CC79       CC80
      CC81      CC82      CC83     CC92       CC95
      CC96      CC100     CC101    CC104      CC105
      CC107     CC108     CC111    CC112      CC119
      CC130     CC131     CC132    CC148      CC149
      CC150     CC154     CC155    CC157      CC158
      CC161     CC177     CC164    CC174      CC176);

 %LET SCOREVARS=%STR(SCORE_COMMUNITY
                     SCORE_INSTITUTIONAL
                     SCORE_NEW_ENROLLEE
                     SCORE_SNP_NEW_ENROLLEE);


 %* include main macro;
 %INCLUDE IN0(V1210F1M)/SOURCE2;

  %V1210F1M(INP      =IN1.PERSON,
            IND      =IN2.DIAG,
            OUTDATA  =PERSONout,
            IDVAR    =bene_id,
            KEEPVAR  =bene_id &SCOREVARS,
            SEDITS   =1,
            DATE_ASOF="1FEB&wave."D);


data out.personout_&wave.;
set personout;
wave=&wave.;
run;


%mend;

%gethcc(year=2011,wave=1);
%gethcc(year=2012,wave=2);
%gethcc(year=2013,wave=3);

data out.personout;
set out.personout_1 out.personout_2 out.personout_3;
run;

proc export data=out.personout outfile="E:\nhats\data\Projects\serious_ill\int_data\personout.dta" replace; run;

H="table of comorbidity combos"
putexcel set "E:\nhats\data\Projects\serious_ill\logs\dartmouth_freq.xls", replace
tokenize A B C D E F G H I J K L M N
local lab1 Cancer
local lab2 COPD
local lab3 CAD
local lab4 CHF
local lab5 PVD
local lab6 Liver
local lab7 Diabetes
local lab8 Renal
local lab9 Dementia
forvalues i=1/9{
putexcel ``i''1="`lab`i''"
}
local row=2
putexcel `10'1="Combo Name" `11'1="Frequency" `12'1="Mean spending" `13'1="% Hospitalized" `14'1="% mortality"
forvalues i=1/9 {
forvalues j=1/9 {
forvalues k=1/9 {
if `i'<`j' & `j'<`k' {
gen dart`i'`j'`k'= dmouth_`i'==1 & dmouth_`j'==1 & dmouth_`k'==1 if !missing(dmouth_1)
label var dart`i'`j'`k' "`lab`i'', `lab`j'', `lab`k''"
qui sum dart`i'`j'`k'
if r(mean)==0 drop dart`i'`j'`k'
if r(mean)!=0 {
putexcel ``i''`row'="" ``j''`row'="" ``k''`row'="", fpattern(solid, yellow)
local lab : var label dart`i'`j'`k'
putexcel `10'`row'="`lab'"
putexcel `11'`row'=`r(mean)'*`r(N)'
sum tot_paid_by_mc_12m if dart`i'`j'`k'==1
putexcel `12'`row'=`r(mean)'
sum ind_hosp_adm_p12m if dart`i'`j'`k'==1
putexcel `13'`row'=`r(mean)'*100
sum died_12 if dart`i'`j'`k'==1
putexcel `14'`row'=`r(mean)'*100
local row=`row'+1
}
}
}
}
}

putexcel set "E:\nhats\data\Projects\serious_ill\logs\charls_freq.xls", replace
tokenize A B C D E F G H I J K L M N O P Q R S T U V W X Y Z


local lab1 "AMI"
local lab2 "CHF"
local lab3 "PVD"
local lab4 Cerebrovascular
local lab5 Dementia
local lab6 COPD
local lab7 Rheumatic
local lab8 Peptic ulceer
local lab9 Diabetes w/o complications
local lab10 Diabetes w/ complications
local lab14 Cancer
local lab16 Metastatic cancer
local lab17 HIV/AIDS
local lab12 Hemi-/paraplegia
local lab13 Renal
local lab14 Malignancy
local lab11 `lab10'
local lab10 `lab9'
local lab9 Liver
local lab9 Mild liver
local lab15 Mod/sev liver
forvalues i=1/17{
putexcel ``i''1="`lab`i''"
}
local row=2
capture drop dart*

putexcel `18'1="Combo Name" `19'1="Frequency" `20'1="Mean spending" `21'1="% Hospitalized" `22'1="% mortality"
forvalues i=1/17 {
forvalues j=1/17 {
forvalues k=1/17 {
if `i'<`j' & `j'<`k' {
gen dart`i'`j'`k'= charls_`i'_==1 & charls_`j'_==1 & charls_`k'_==1 if !missing(charls_1_)
label var dart`i'`j'`k' "`lab`i'', `lab`j'', `lab`k''"
qui sum dart`i'`j'`k'
if r(mean)==0 drop dart`i'`j'`k'
if r(mean)!=0 {
putexcel ``i''`row'="" ``j''`row'="" ``k''`row'="", fpattern(solid, yellow)
local lab : var label dart`i'`j'`k'
putexcel `18'`row'="`lab'"
putexcel `19'`row'=`r(mean)'*`r(N)'
sum tot_paid_by_mc_12m if dart`i'`j'`k'==1
putexcel `20'`row'=`r(mean)'
sum ind_hosp_adm_p12m if dart`i'`j'`k'==1
putexcel `21'`row'=`r(mean)'*100
sum died_12 if dart`i'`j'`k'==1
putexcel `22'`row'=`r(mean)'*100
local row=`row'+1
}
}
}
}
}




H="check on SMI for Claire 11/2/17"
capture log close
clear all
set more off
local logs E:\nhats\nhats_code\NHATS data setup\logs\

local r1raw E:\nhats\data\NHATS Public\round_1\
local r2raw E:\nhats\data\NHATS Public\round_2\
local r3raw E:\nhats\data\NHATS Public\round_3\
local r4raw E:\nhats\data\NHATS Public\round_4\
local r5raw E:\nhats\data\NHATS Public\round_5\
local r6raw E:\nhats\data\NHATS Public\round_6\
local work E:\nhats\data\NHATS working data
local r1s E:\nhats\data\NHATS Sensitive\r1_sensitive\
local r2s E:\nhats\data\NHATS Sensitive\r2_sensitive\
local r3s E:\nhats\data\NHATS Sensitive\r3_sensitive\
local r4s E:\nhats\data\NHATS Sensitive\r4_sensitive\
local r5s E:\nhats\data\NHATS Sensitive\r5_sensitive\
local r6s E:\nhats\data\NHATS Sensitive\r6_sensitive\
local logs E:\nhats\nhats_code\NHATS data setup\logs\

cd "`work'"

//7/13/17--add in metro/nonmetro var
use "E:\nhats\data\NHATS Public\NHATS_Round_1_4_MetNonmet_STATA\NHATS_Round_1_4_MetNonmet.dta", clear
forvalues i=1/4 {
gen metro_ind`i'=r`i'd==1 if inrange(r`i'd,1,2)
}
reshape long metro_ind, i(spid) j(wave)
label var metro_ind "Lives in metropolitan area"
tempfile metro
save `metro'


use round_1_6_clean_helper_added.dta
merge 1:1 spid wave using `metro', keep(match master) nogen

//recoding all refuse, dk, na, as missing
destring *, replace
foreach x of varlist * {
	replace `x'=. if inlist(`x',-1,-7,-8,-9)
}

//how do you get to the doctor?
gen howgetdoc=.
forvalues i=1/9 {
	forvalues j=1/6 {
		replace howgetdoc=`i' if mc`j'hwgtregd`i'==1 & wave==`j'
}
}
label define howgetdoc 1 "Drove" 2 "Got a Ride" 3 "Van/Shuttle from place lives" 4 "Van/Shuttle for seniors & disabled" 5 "Pulic transit" 6 "Taxi" 7 "Walked" 8 "Home visit" 9 "Other" 0 "Did not See Doctor" 10 "Refused/DK"
label values howgetdoc howgetdoc
//marital status-3 vars: married, married_or_partnered

gen married=maritalstat==1 if maritalstat!=. //married
gen marital_sep=maritalstat==3 if !mi(maritalstat)
gen marital_div=maritalstat==4 if !mi(maritalstat)
gen marital_wid=maritalstat==5 if !mi(maritalstat)
gen marital_nev=maritalstat==6 if !mi(maritalstat)
gen marriedpartnered=married
replace marriedpartnered=1 if maritalstat==2 //living with a partner
gen marital_sd=marital_sep
replace marital_sd=1 if marital_div==1

label var married "Married"
label var marriedpartnered "Married or Live w/ Partner"

//lives with spouse
gen resspouse=.
forvalues i=1/6 {
	replace resspouse=hh`i'livwthspo==1 if wave==`i' & hh`i'livwthspo>0
	replace resspouse=0 if marriedpart==0
}
label var resspouse "Lives with Spouse/Partner"

//household members
gen hhm=.
forvalues i=1/6 {
	replace hhm=hh`i'dhshldnum if hh`i'dhshldnum>0 & wave==`i'
}
label var hhm "Number of household members"

//age categorical

gen agecat = .
forvalues i=1/6 {
replace agecat= r`i'd2intvrage if wave==`i'
}
replace agecat=. if agecat==-1
label values agecat r1d2intvrage
label var agecat "Age, 5 yr categories"

//activities past month

gen attrelig=. //attend services
gen imprelig=. //importance of religious services
gen visitfrfam=. //visit fr. fam.
gen impvisit=. //importance of visiting friends & fam
gen attclub=. //participate in club, organized activity, class, etc.
gen impclub=. //importance of such activities
gen vigact=. //vigorous activities

forvalues i=1/6 {
	replace attrelig=pa`i'attrelser==1 if pa`i'attrelser>0 & wave==`i'
	replace imprelig=pa`i'imprelser if pa`i'imprelser>0 & wave==`i' 
	replace visitfrfam=pa`i'vistfrfam==1 if pa`i'vistfrfam>0 & wave==`i'
	replace impvisit=pa`i'impvstfam if pa`i'impvstfam>0 & wave==`i'
	replace attclub=pa`i'clbmtgrac==1 if pa`i'clbmtgrac>0 & wave==`i'
	replace impclub=pa`i'imparclub if pa`i'imparclub>0 & wave==`i'
	replace vigact=pa`i'vigoractv==1 if pa`i'vigoractv>0 & wave==`i'
}

gen religvimp=imprelig==1 if imprelig!=. //very important binary

label var attrelig "Past mo. Attend religious services"
label var imprelig "Importance of religious services"
label var religvimp "Religious services very important, yes/no"
label var visitfrfam "Past mo. visit friends or family"
label var impvisit "Importance of visiting friends/family"
label var attclub "Past mo. participate in clubs/classes/organized activities"
label var impclub "Importance of club/class/etc. participation"
label var vigact "Past mo. engage in vigorous activity"

label values imprelig pa1imprelser
label values impvisit pa1impvstfam
label values impclub pa1imparclub

//smokin'
gen smokedever=. 
gen smoke_start_age=.
gen smoke_stop_age=.
forvalues i=1(4)5 {
	replace smokedever=sd`i'smokedreg==1 if wave==`i' & sd`i'smokedreg>0
	replace smoke_start_age=sd`i'agesrtsmk if wave==`i' & sd`i'agesrtsmk>0
	replace smoke_stop_age=sd`i'agelstsmk if wave==`i' & sd`i'agelstsmk>0
}

sort spid wave
by spid: carryforward smoke*, replace
gen smokesnow=.
by spid, sort: egen numcigsever=max(sd1numcigday)
gen numcigsnow=.


forvalues i=1/6 {
	replace smokesnow=sd`i'smokesnow==1 if wave==`i' & sd`i'smokesnow>0
	replace numcigsnow=sd`i'numcigday if wave==`i' & smokesnow==1
}
replace smokedever=1 if smokesnow==1
replace smokesnow=0 if smokedever==0
replace numcigsnow=0 if smokesnow==0

label var smokedever "Ever smoked"
label var smokesnow "Smokes now"
label var numcigsever "Number of cigarettes/day when smoked"
label var numcigsnow "Number of cigarettes/day currently"
label var smoke_start_age "Age started smoking"
label var smoke_stop_age "Age stopped smoking"

//weight

gen wgt_curr=.
gen height_ft=.
gen height_in=.

forvalues i=1/6 {
	replace wgt_curr=hw`i'currweigh if hw`i'currweigh>0 & wave==`i'
	replace height_ft=hw`i'howtallft if hw`i'howtallft>0 & wave==`i'
	replace height_in=hw`i'howtallin if hw`i'howtallin>0 & wave==`i'
}

label var wgt_curr "Current weight, lbs."
label var height_ft "Current height, feet"
label var height_in "Current height, inches"

gen bmi=(wgt_curr/((height_ft*12+height_in)^2))*703

label var bmi "Current BMI"

//get the per round weight, cluster, and strata vars (and why is moved created like that?)
gen moved=.
rename w1varunit varunit
rename w1varstrat varstrat
rename w1anfinwgt0 anfinwgt

forvalues i=2/6 {
	replace moved=w`i'_moved if wave==`i'
	foreach x in anfinwgt varstrat varunit {
		replace `x'=w`i'`x' if wave==`i'
}
drop w`i'_moved w`i'anfinwgt0 w`i'varstrat w`i'varunit 
}

******************************************
/*these are taken from Rebecca's code*/

gen community_dwelling = 0
replace community_dwelling = 1 if r1dresid == 1 | r1dresid == 2 | r2dresid == 1 | r2dresid == 2 | r3dresid == 1 | r3dresid == 2 | r4dresid == 1 | r4dresid == 2 
gen SP_completed = 0
replace SP_completed = 1 if r1dresid == 1 | r1dresid == 2 | r2dresid == 1 | r2dresid == 2 | r2dresid == 4 | r3dresid == 1 | r3dresid == 2 | r3dresid == 4 | r4dresid == 1 | r4dresid == 2 | r4dresid == 4

gen nhres=r1dresid==4 if r1dresid!=.
gen rcfres=inlist(r1dresid,2,3) if r1dresid!=.
gen res_care=r1dresid>1 if r1dresid!=.
gen sp_status=1 
gen deceased=0
gen prob_dem=dem_3_cat==1 if !missing(dem_3_cat)
label var prob_dem "Indicator probable dementia"
forvalues i=2/6 {
	replace nhres=inlist(r`i'dresid,4,5,8) if wave==`i'
	replace res_care=inlist(r`i'dresid,2,3,4,5,7,8) if wave==`i'
	replace rcfres=inlist(r`i'dresid,2,3,7) if wave==`i'
	replace deceased=inlist(r`i'status,62,86) if wave>=`i'
}

replace sp_status=2 if res_care==1
replace sp_status=3 if nhres==1
replace sp_status=4 if deceased==1
label var sp_status "Residential status"
label var nhres "Nursing Home Resident"
label var rcfres "Residential Care, excl. NH"
label var res_care "Residential Care, incl. NH"
label define sp_status 1 "Non-res care community" 2 "Res-care not NH" 3 "NH resident" ///
4 "Deceased"
label values sp_status sp_status

//these ADL variables were missing previously
gen adl_ins_help = .
gen adl_ins_diff=.
gen adl_ins_not_done=.

foreach w in 1 2 3 4 5 6{
	replace adl_ins_help=1 if mo`w'insdhlp==1 & wave==`w'
	replace adl_ins_help=0 if mo`w'insdhlp==2 & wave==`w'
	replace adl_ins_help=0 if mo`w'insdhlp==-1 & sp_ivw==1 & wave==`w'
	replace adl_ins_help=-7 if mo`w'insdhlp==-7 & wave==`w'
	replace adl_ins_help=-8 if mo`w'insdhlp==-8 & wave==`w'
	replace adl_ins_diff=0 if mo`w'insddif==1 & wave==`w'
	replace adl_ins_diff=1 if mo`w'insddif>1 & !missing(mo`w'insddif) & wave==`w'
	replace adl_ins_diff=0 if mo`w'insddif==-1 & sp_ivw==1 & wave==`w'
	replace adl_ins_diff=-7 if mo`w'insddif==-7 & wave==`w'
	replace adl_ins_diff=-8 if mo`w'insddif==-8 & wave==`w'
	replace adl_ins_not_done=inlist(mo`w'dinsdsfdf,1,8) if wave==`w'
}

*replace adl_ins_dif=1 if adl_ins_help==1
label var adl_ins_help "Received help getting around inside"

gen adl_bed_help = .
gen adl_bed_diff=.
gen adl_bed_not_done=.
foreach w in 1 2 3 4 5 6{
	replace adl_bed_help=1 if mo`w'bedhlp==1 & wave==`w'
	replace adl_bed_help=0 if mo`w'bedhlp==2 & wave==`w'
	replace adl_bed_help=0 if mo`w'bedhlp==-1 & sp_ivw==1 & wave==`w'
	replace adl_bed_help=-7 if mo`w'bedhlp==-7 & wave==`w'
	replace adl_bed_help=-8 if mo`w'bedhlp==-8 & wave==`w'
	replace adl_bed_diff=0 if mo`w'beddif==1 & wave==`w'
	replace adl_bed_diff=1 if mo`w'beddif>1  & !missing(mo`w'beddif) & wave==`w'
	replace adl_bed_diff=0 if mo`w'beddif==-1 & sp_ivw==1 & wave==`w'
	replace adl_bed_diff=-7 if mo`w'beddif==-7 & wave==`w'
	replace adl_bed_diff=-8 if mo`w'beddif==-8 & wave==`w'
	replace adl_bed_not_done=inlist(mo`w'dbedsfdf,1,8) if wave==`w'
}
label var adl_bed_help "Received help getting out of bed"
*replace adl_bed_diff=1 if adl_bed_help==1
//construct date of ivw--use 1st of month for all, because only have mo & yr

gen ivw_day=1
label define ivw_day 1 "Not provided" 
label values ivw_day ivw_day
gen ivw_month=.
gen ivw_year=.
forvalues i=1/6 {
	replace ivw_month=r`i'spstatdtmt if wave==`i'
	replace ivw_month=r`i'fqstatdtmt if wave==`i' & r`i'spstatdtmt==.
	replace ivw_year=r`i'spstatdtyr if wave==`i'
	replace ivw_year=201`i' if wave==`i' & r`i'spstatdtyr==.
}
replace ivw_month=r1fqstatdtmt if wave==1 & ivw_month==.
replace ivw_year=r1fqstatdty if wave==1 & ivw_year==.


gen adl_index=0
foreach i in eat bath toil dres bed ins {
replace adl_index=adl_index+adl_`i'_help if adl_`i'_help>0
}
*gen adl_index=adl_eat_help+adl_bath_help+adl_toil_help+adl_dres_help+adl_ins_help+adl_bed_help
replace adl_index=. if adl_index<0
gen adl_independent=adl_index==0 if adl_index!=.
gen adl_impair=adl_index>0 if adl_index!=.
gen iadl_index=iadl_laun_help+iadl_shop_help+iadl_bank_help+iadl_meal_help+iadl_meds_help
replace iadl_index=. if iadl_index<0
gen iadl_independent=iadl_index==0 if iadl_index!=.
gen iadl_impair=iadl_index>0 if iadl_index!=.
foreach x in adl iadl {
	egen `x'_diff_index=rowtotal(`x'*diff)
	gen `x'_diff_ind=`x'_diff_index>=1 if !missing(`x'_diff_index)
}
label var adl_independent "Independent in ADLs"
label var adl_impair "Help with 1+ ADL"
label var adl_index "Index of help w/ ADLs"
label var iadl_independent "Independent in IADLs"
label var iadl_impair "Help with 1+ IADL"
label var iadl_index "Index of help w/ IADLs"

gen ivw_date=mdy(ivw_month,ivw_day,ivw_year)
format ivw_date %td

//addition of variables from Eric's homebound code
gen meals_wheels=.
gen noone_talk=.
gen restrnt_takeout=.

forvalues i=1/6 {
replace meals_wheels=ha`i'dmealwhl if wave==`i'
replace noone_talk=fl`i'noonetalk if wave==`i'
replace restrnt_takeout=ha`i'dmealtkot if wave==`i'
foreach x in meals_wheels noone_talk restrnt_takeout {
replace `x'=0 if `x'==.
}
}

//pull in date of death, constructed from claims and nhats
merge m:1 spid using "E:\nhats\data\CMS_DUA_28016\death_date.dta", nogen

gen died_12=mofd(death_date)-mofd(ivw_date)<=12
gen died_24=mofd(death_date)-mofd(ivw_date)<=24
//note-the following has been superseded by the death date using claims
/*

//use status to get death
gen died_12=.
gen died_24=.
forvalues i=1/3 {
replace died_12=inlist(r`=`i'+1'status,62,86) if wave==`i' & r`=`i'+1'status!=79
}
forvalues i=1/2 {
replace died_24=inlist(r`=`i'+2'status,62,86) if wave==`i' & !inlist(r`=`i'+2'status,79,.)
}
replace died_24=1 if died_12==1

foreach i in 12 24 {
label var died_`i' "SP died w/in `i' months, per future wave status"
}*/

//update 8/2/17--pulled in nhats dod to share off server

//look at death month & year. don't have, so set date to last of month
gen dd=.
replace pd2yrdied=pd2yrdied+2010 if pd2yrdied>0
gen nhats_death_day=. 
forvalues i=2/4 {
	foreach j in mth yr {
		replace pd`i'`j'died=. if pd`i'`j'<0
}
	replace nhats_death_day=31 if inlist(pd`i'm,1,3,5,7,8,10,12)
	replace nhats_death_day=30 if inlist(pd`i'm,4,6,9,11)
	replace nhats_death_day=28 if inlist(pd`i'm,2)
	replace dd=mdy(pd`i'mthdied,nhats_death_day,pd`i'yrdied) if pd`i'yrdied>0 & pd`i'yrdied!=.
}

by spid, sort: egen nhats_death_date=max(dd)
label var nhats_death_date "SP death date, from tracker (day imputed)"
format nhats_death_date %td
gen nhats_death_month=month(nhats_death_date)
gen nhats_death_year=year(nhats_death_date)
foreach x in month year {
label var nhats_death_date "SP death `x', from tracker"
}

drop dd

gen eligible_nsoc=fl1dnsoc==1
gen completed_nsoc=fl1dnsoccomp>0 if fl1dnsoccomp!=.
gen total_caregiver_comp=fl1dnsoccomp if fl1dnsoccomp>0 & fl1dnsoccomp!=.
gen total_caregiver_elig=fl1dnsoccnt if fl1dnsoccnt>0 & fl1dnsoccnt!=.
label var eligible  "Eligible for NSOC interview, wave 1 tracker"
label var complete  "Completed Interview"
label var total_caregiver_comp "Total Caregivers that Completed Interview"
label var total_caregiver_elig "Total Caregivers Eligible for NSOC"
rename r*status round*status

//adverse consequences of unmet need

gen adverse=0
forvalues i=1/6 {
	foreach x of varlist ha`i'*out sc`i'*out {
		replace adverse=1 if `x'==1 & wave==`i'
}
}
label var adverse "Any adverse consequence of unmet need (excluding mobility)"

//limited favorite activity
capture drop lim_fav
gen lim_fav=.

forvalues i=1/5 { 
	replace lim_fav=pa`i'helmfvact==1 if pa`i'helmfvact>=0 & wave==`i'
}
label var lim_fav "Last month ever kept from favorite activity by health/function"


capture drop lim_fav_yr
////NEW limited favorite activity
gen lim_fav_yr=.
//forvalues i=6 {
	replace lim_fav_yr=pa6fvactlimyr==1 if pa6fvactlimyr>=0 & wave==6
//}
label var lim_fav_yr "Last year ever kept from favorite activity by health/function"


//social cohesion
gen cohesion_knowwell=.
gen cohesion_willing=.
gen cohesion_peop=.

forvalues i=1/6 {
	foreach x in know will peop {
		replace cohesion_`x'=cm`i'`x' if !missing(cm`i'`x') & wave==`i'
}
}
gen cohesion=(cohesion_p+cohesion_k+cohesion_w==3) ///
if missing(cohesion_k)|missing(cohesion_w) | missing(cohesion_p)

label var cohesion_knowwell "People know each other well in the community"
label var cohesion_w "People are willing to help each other in the commmunity"
label var cohesion_p "People can be trusted in the community"
label define cohesion_ 1 "Agree a lot" 2 "Agree a little" 3 "Do not agree"
label values cohesion_* cohesion_
label var cohesion "High community cohesion (Highest on all 3 statements)"

gen home_disorder_insd=.
gen home_disorder_outsd=.
gen home_disorder_area=.
gen home_disorder_clutter=.

forvalues i=1/6 {
	foreach x of varlist ir`i'condihom* ir`i'condhome* ir`i'areacond* ir`i'clutter* {
		replace `x'=. if `x'==7
		qui sum `x'
		if r(max)==2 replace `x'=`x'==1 if !missing(`x')
		if inlist(r(max),3,4) replace `x'=`x'>1 if !missing(`x')
}

	egen insd=rowtotal(ir`i'condihom*)
	egen outsd=rowtotal(ir`i'condhome*)
	egen area=rowtotal(ir`i'areacond*)
	egen clutter=rowtotal(ir`i'clutter*)
	foreach x in insd outsd area clutter {
		replace home_disorder_`x'=`x'>=1 if wave==`i' & !missing(`x')
		drop `x'
}
}

label var home_disorder_insd "Disorder in home (peelng paint, pests, brkn furniture or floorbrds, trippng hazards)"
label var home_disorder_outsd "Disorder outside (brkn windows, foundation, bricks/siding, roof, steps)"
label var home_disorder_clutter "Disorder in home (clutter in interview or other rooms)"
label var home_disorder_area "Disorder in immed area (litter/glass/graffiti/vacant houses/stores/foreclosures)"	

//economic well-being
foreach x of varlist ew* {
	replace `x'=. if `x'<0
}

foreach x in creditdebt medcreditdebt medbillsovertime medpaynotcash finhlpfam ///
fingftfam govtasst {
	gen `x'=.
}

forvalues i=1/6 {
gen creditdebt`i'=inlist(ew`i'pycredbal,2,3) | !missing(ew`i'crecardeb) if ///
 !missing(ew`i'pycredbal) | !missing(ew`i'crecardeb)
gen medcreditdebt`i'=ew`i'credcdmed==1 if !missing(ew`i'credcdmed)
gen medbillsovertime`i'=ew`i'medpaovtm==1 if !missing(ew`i'medpaovtm)
gen medpaynotcash`i'=medbillsovertime==1 | medcreditdebt==1 if !missing(medbillsovertime) | ///
!missing(medcreditdebt)

gen finhlpfam`i'=ew`i'finhlpfam==1 if !missing(ew`i'finhlpfam)
gen fingftfam`i'= ew`i'fingftfam==1 if !missing(ew`i'finhlpfam)
gen govtasst`i'=ew`i'progneed1==1 | ew`i'progneed2==1 | ew`i'progneed3==1 if !missing(ew`i'progneed1) ///
| !missing(ew`i'progneed2) | !missing(ew`i'progneed3)
foreach x in creditdebt medcreditdebt medbillsovertime medpaynotcash finhlpfam ///
fingftfam govtasst {
	replace `x'=`x'`i' if wave==`i'
	drop `x'`i'
}
}
replace medpaynotcash=medbillsovertime==1 | medcreditdebt==1 if !missing(medbillsovertime) | !missing(medcreditdebt)

label var creditdebt "Has credit card debt or does not pay off in full monthly"
label var medpaynotcash "Has medical credit card debt or pays bills over time"
label var govtasst "Receives foodstamps or other food or gas/energy assistance"

//home ownership

local homevars ownhome rent mortgagepaidoff paysmortgage mortpaymt ///
timeinmort owedonmort homevalue rentpaid section8

foreach x of local homevars {
	gen `x'=.
}

label var ownhome "SP owns home"
label var rent "SP rents"
label var mortgagepaidoff "Mortgage is paid off"
label var mortpaymt "Mortgage payment"
label define mortpaymt 1 "<$250" 2 "$250-499" 3 "$500-999" 4 "$1000+"
label values mortpaymt mortpaymt
label var timeinmort "Time left in mortgage"
label define timeinmort 1 "5 years" 2 "10 years" 3 "Longer than 10 years"
label values timeinmort timeinmort
label var owedonmort "Amount left on mortgage"
label define owedonmort 1 "<$50,000" 2 "$50,000-99,999.99" 3 "$100,000+"
label values owedonmort owedonmort
label var homevalue "Home value"
label define homevalue 1 "<$50K" 2 "50-75K" 3 "75-100K" 4 "100-200K" 5 "200-300K" ///
6 "300-500K" 7 "500-750K" 8 "$750K+"
label values homevalue homevalue

forvalues i=1/6 {
tab hp`i'ownrentot 
replace ownhome=hp`i'ownrentot==1 if wave==`i' & (!missing(hp`i'ownrento) | res_care==1)
replace rent=hp`i'ownrentot==2 if wave==`i' & (!missing(hp`i'ownrento) | res_care==1)
tab hp`i'mrtpadoff 
replace mortgagepaidoff=hp`i'mrtpadoff==1 if !missing(hp`i'mrtpadoff)
replace paysmortgage=hp`i'mrtpadoff==2 if !missing(hp`i'mrtpadoff)
tab hp`i'mortpaymt 
replace mortpaymt= hp`i'mortpaymt if wave==`i'
qui replace mortpaymt=1 if wave==`i' & hp`i'mthlymort<250
qui replace mortpaymt=2 if wave==`i' & hp`i'mthlymort>=250 & hp`i'mthlymort<=499
qui replace mortpaymt=3 if wave==`i' & hp`i'mthlymort>=500 & hp`i'mthlymort<1000
qui replace mortpaymt=4 if wave==`i' & hp`i'mthlymort>=1000 & !missing(hp`i'mthlymort)
tab hp`i'whnpayoff 
replace timeinmort=hp`i'whnpayoff if wave==`i'
tab hp`i'amoutowed 
replace owedonmort=hp`i'amoutowed if wave==`i'
qui replace owedonmort=1 if wave==`i' & hp`i'amtstlowe<50000 
qui replace owedonmort=2 if wave==`i' & hp`i'amtstlowe>=50000 & hp`i'amtstlowe<=100000
qui replace owedonmort=3 if wave==`i' & hp`i'amtstlowe>=100000 & !missing(hp`i'amtstlowe)
tab hp`i'homvalamt 
replace homevalue= hp`i'homvalamt if wave==`i'
qui replace homevalue=1 if wave==`i' & hp`i'homevalue<50000 & hp`i'homevalue>=0
qui replace homevalue=2 if wave==`i' & hp`i'homevalue>=50000 & hp`i'homevalue<75000
qui replace homevalue=3 if wave==`i' & hp`i'homevalue>=75000 & hp`i'homevalue<100000
qui replace homevalue=4 if wave==`i' & hp`i'homevalue>=100000 & hp`i'homevalue<200000
qui replace homevalue=5 if wave==`i' & hp`i'homevalue>=200000 & hp`i'homevalue<300000
qui replace homevalue=6 if wave==`i' & hp`i'homevalue>=300000 & hp`i'homevalue<500000
qui replace homevalue=7 if wave==`i' & hp`i'homevalue>=500000 & hp`i'homevalue<750000
qui replace homevalue=8 if wave==`i' & hp`i'homevalue>=750000 & !missing(hp`i'homevalue)

tab hp`i'rentamou 
replace rentpaid =hp`i'rentamou if wave==`i'
qui replace rentpaid=1 if wave==`i' & hp`i'rentamt<250 & hp`i'rentamt>=0
qui replace rentpaid=2 if wave==`i' & hp`i'rentamt>=250 & hp`i'rentamt<=499
qui replace rentpaid=3 if wave==`i' & hp`i'rentamt>=500 & hp`i'rentamt<1000
qui replace rentpaid=4 if wave==`i' & hp`i'rentamt>=1000 & !missing(hp`i'rentamt)
qui replace rentpaid=4 if inlist(rentpaid,5,6)
replace mortpaymt=4 if inlist(mortpaymt,5,6)
tab hp1sec8pubsn
replace section8=hp`i'sec8pubsn==1 if wave==`i' & (!missing(hp`i'sec8pubsn) |ownhome==1 | rent==1)
}

label var rentpaid "Amount rent paid"
label define rentpaid 1 "<$250" 2 "250-499" 3 "500-999" 4 "$1000+"
label values rentpaid rentpaid
label var section8 "Indicator lives in Section 8 housing"
label var medcreditdebt "Has Medical credit card debt"
label var medbillsovertime "Pays Medical bills over time"
label var finhlpfam "Received financial help/gifts from family"
label var fingftfam "Provided financial help/gifts to family"
label var paysmortgage "Pays a mortgage"
gen n_social_network=.
forvalues i=1/6 {
	replace n_social_network=sn`i'dnumsn if sn`i'dnumsn>=0 & wave==`i'
}
label var n_social_network "Number in social network"

gen division=.
forvalues w=1/6 {
	replace division=re`w'dcensdiv if re`w'dcensdiv>0 & wave==`w'
}
gen region=division 
recode region (1 2=1) (3 4=2) (5/7=3) (8 9=4)

la define region 1 "Northeast" 2 "Midwest" 3 "South" 4 "West"
label values region region

gen adlclaire=0
forvalues w=1/6 {
	foreach x in mo`w'outhlp mo`w'insdhlp mo`w'bedhlp sc`w'eathlp sc`w'bathhlp ///
	sc`w'toilhlp sc`w'dreshlp {
		replace adlclaire=1 if `x'==1
}
	foreach x in mo`w'outdif mo`w'insddif mo`w'beddif sc`w'eatdif sc`w'bathdif ///
	sc`w'toildif sc`w'dresdif {
		replace adlclaire=1 if inlist(`x',2,3,4)
}
}

//and now drop all raw variables
forvalues i=1/6 {
	drop r`i'* ip`i'* is`i'* re`i'* hc`i'* ht`i'* hh`i'* ss`i'* fl`i'* ///
	 pc`i'* cp`i'* cg`i'* mo`i'* ha`i'* sc`i'* mc`i'* pa`i'* sd`i'* hw`i'* ///
	 cm`i'* sn`i'* hp`i'* ew`i'* ir`i'*
}

drop el1* rl1* ia1* pd2* pd3* pd4* ia3* ia5*

rename round*status r*status

svyset varunit [pw=anfinwgt], strat(varstrat)

sort spid wave
by spid: carryforward educ*, replace
label var educ_hs_ind "Education: HS+"
/*
*saveold "E:\nhats\data\NHATS cleaned\sp_round_1_6", replace

drop death_* died_12 died_24

gen time2d=mofd(nhats_death_date)-mofd(ivw_date)

foreach x in 12 24 {
	gen nhats_died_`x'=time2d<=`x' if !lml
}

drop time2d 

*save "E:\nhats\data\NHATS cleaned\sp_round_1_6_public_sens_only.dta", replace
*/

merge 1:m spid wave using "E:\nhats\data\projects\serious_ill\final_data\serious_ill_nhats_sample.dta"
preserve


sort spid wave
by spid: egen fadl=min(cond(adlclaire==1,wave,.))
gen inci=wave==fadl & inrange(wave,2,4)
cap by spid: gen recovered=adlclaire[_n+1]==0
label var recovered "No ADL impairment next wave (Claire's definition)"
by spid: gen rec2=adl_impair[_n+1]==0
label var rec2 "No ADL dependence (help) next wave"
keep if ffs_12==1
label var adl_impair "Dependence in 1+ ADL"
label var adlclaire "Impairment in 1+ ADL"

local vars n died_12 adlclaire adl_impair rec2 recovered female age1 age2 age4 age6 white black hisp other_race ///
educ_hs_ind nhres type1 type2 type3 marriedpartnered livealone smi_cancer_ind smi_esrd_ind smi_copd_ind ///
smi_chf_ind smi_dem_ind smi_diab_compl_ind smi_liver_ind el_ge3_comorb_1yr ///
 sr_phq2_depressed sr_gad2_anxiety
recode agecat (3=2) (5=4)
label define agecat 1 "<70" 2 "70-79" 4 "80-89" 6 "90+", modify
foreach i in 1 2 4 6 {
cap gen age`i'=agecat==`i'
local lab : label agecat `i'
label var age`i' "`lab'"
}

gen va_private=medigap==1 | tricare==1
gen type=3 if va_private==1
replace type=1 if medicaid==1
replace type=2 if missing(type)
label define type 1 "Medicaid" 2 "Medicare only" 3 "Other"
label values type type
foreach i in 1 2 3 {
gen type`i'=type==`i'
local lab : label type `i'
label var type`i' "`lab'"
}
gen n=1
*gen ffs_12m=cont_ffs_n_mos>=6 if !missing(cont_ffs_n_mos)
*keep if ffs_12m==1
drop if wave==5
local rn : word count `vars'

mat tab=J(`rn',4,.)
local r=1
local c=1

foreach x of local vars {
foreach y in 1 "0,1" { 
	qui sum `x' if inlist(inci,`y')
	mat tab[`r',`c']=r(mean)*r(N)
	qui sum `x' if inlist(inci,`y') [aw=anfinw]
	mat tab[`r',`c'+1]=r(mean)*100
	local c=`c'+2
}
	local c=1 
	local r=`r'+1
}

mat rownames tab=`vars'

frmttable using "E:\nhats\data\projects\serious_ill\logs\incident_adl_for_claire.rtf", ///
replace  statmat(tab) title(Observations of incident ADL disability) ///
ctitles("" "Incident ADL"""  "All 12m FFS" \"""n" "Weighted %" "n" "Weighted %") sdec(0,2,0,2) varlabels ///
note("Restricted to those with 12m FFS prior to interview (waves 1-4)")

tab wave
